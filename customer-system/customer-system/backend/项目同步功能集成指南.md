"""
项目同步功能 - 应用集成指南
说明: 如何在FastAPI应用中集成项目同步功能
"""

# ============================================================================
# 1. 在 app/main.py 中添加以下代码
# ============================================================================

"""
from fastapi import FastAPI
from app.routers import project_sync_router
from app.tasks.project_sync_scheduler import init_project_sync_scheduler, shutdown_project_sync_scheduler

app = FastAPI()

# 包含项目同步路由
app.include_router(project_sync_router.router)

# 启动事件：初始化定时任务
@app.on_event("startup")
async def startup_event():
    await init_project_sync_scheduler()
    print("Project sync scheduler initialized")

# 关闭事件：关闭定时任务
@app.on_event("shutdown")
async def shutdown_event():
    await shutdown_project_sync_scheduler()
    print("Project sync scheduler shutdown")
"""

# ============================================================================
# 2. 在 app/models.py 中添加以下数据模型
# ============================================================================

"""
from sqlalchemy import Column, Integer, String, DateTime, Text, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from datetime import datetime
from app.database import Base

class ProjectCache(Base):
    __tablename__ = "project_cache"
    
    id = Column(Integer, primary_key=True)
    project_id = Column(String(50), unique=True, nullable=False, index=True)
    project_type = Column(String(20), nullable=False, index=True)
    title = Column(String(255))
    status = Column(String(50), index=True)
    data = Column(Text, nullable=False)  # JSON
    remote_updated_at = Column(DateTime, nullable=True)
    cached_at = Column(DateTime, default=datetime.utcnow, index=True)
    expires_at = Column(DateTime, nullable=True, index=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class ProjectSyncHistory(Base):
    __tablename__ = "project_sync_history"
    
    id = Column(Integer, primary_key=True)
    sync_time = Column(DateTime, default=datetime.utcnow, index=True)
    sync_type = Column(String(10), nullable=False)  # auto | manual
    total_projects = Column(Integer, default=0)
    updated_count = Column(Integer, default=0)
    unchanged_count = Column(Integer, default=0)
    failed_count = Column(Integer, default=0)
    duration = Column(Float, default=0)
    status = Column(String(20), default='success')  # success | failed | partial
    message = Column(Text)
    error_detail = Column(Text)
    changes = Column(Text)  # JSON
    triggered_by = Column(String(100))
    sync_config = Column(Text)  # JSON
    created_at = Column(DateTime, default=datetime.utcnow)

class ProjectSyncConfig(Base):
    __tablename__ = "project_sync_config"
    
    id = Column(Integer, primary_key=True)
    config_key = Column(String(100), unique=True, nullable=False, index=True)
    config_value = Column(Text, nullable=False)  # JSON
    description = Column(String(500))
    updated_by = Column(String(100))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

class ProjectAccessTokens(Base):
    __tablename__ = "project_access_tokens"
    
    id = Column(Integer, primary_key=True)
    token = Column(String(500), unique=True, nullable=False, index=True)
    project_id = Column(String(50), nullable=False, index=True)
    user_id = Column(String(100), index=True)
    user_type = Column(String(50))  # customer | engineer | salesman
    user_name = Column(String(255))
    user_phone = Column(String(20))
    access_type = Column(String(50))  # read | read_write
    ip_address = Column(String(50))
    expires_at = Column(DateTime, nullable=False, index=True)
    last_accessed_at = Column(DateTime, nullable=True)
    access_count = Column(Integer, default=0)
    revoked = Column(Boolean, default=False, index=True)
    revoked_at = Column(DateTime, nullable=True)
    revoke_reason = Column(String(500))
    created_at = Column(DateTime, default=datetime.utcnow)

class ProjectStatusNotifications(Base):
    __tablename__ = "project_status_notifications"
    
    id = Column(Integer, primary_key=True)
    project_id = Column(String(50), nullable=False, index=True)
    old_status = Column(String(50))
    new_status = Column(String(50), nullable=False)
    notify_to = Column(String(100), index=True)
    notify_type = Column(String(20), nullable=False)  # wechat | sms | email
    notify_content = Column(Text)
    send_status = Column(String(20), default='pending', index=True)  # pending | sent | failed
    send_time = Column(DateTime, nullable=True)
    send_message = Column(String(500))
    retry_count = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
"""

# ============================================================================
# 3. requirements.txt 添加依赖
# ============================================================================

"""
apscheduler==3.10.4
httpx==0.24.1
pydantic==2.0.3
SQLAlchemy==2.0.23
PyJWT==2.8.0
python-dateutil==2.8.2
"""

# ============================================================================
# 4. 配置文件 (config.py)
# ============================================================================

"""
import os
from dotenv import load_dotenv

load_dotenv()

# 远程API配置
REMOTE_API_BASE = os.getenv('REMOTE_API_BASE', 'https://remote-api.example.com')
REMOTE_API_KEY = os.getenv('REMOTE_API_KEY', 'your-api-key')

# JWT配置
SECRET_KEY = os.getenv('SECRET_KEY', 'your-secret-key-here')
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_DAYS = 7

# 数据库配置
DATABASE_URL = os.getenv('DATABASE_URL', 'mysql+aiomysql://user:password@localhost/customer_system')

# 日志配置
LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')

# 项目同步配置
PROJECT_SYNC = {
    'AUTO_SYNC_ENABLED': True,
    'SYNC_FREQUENCY': '*/15 * * * *',  # 每15分钟
    'CACHE_TTL': 30,  # 分钟
    'SYNC_TYPES': ['presale', 'aftersales', 'sales'],
    'NOTIFY_ON_CHANGE': True,
    'NOTIFY_CHANNELS': ['wechat', 'sms'],
}
"""

# ============================================================================
# 5. 创建环境变量文件 (.env)
# ============================================================================

"""
# 数据库
DATABASE_URL=mysql+aiomysql://root:password@localhost/customer_system

# 远程API
REMOTE_API_BASE=https://your-remote-api.example.com
REMOTE_API_KEY=your-api-key

# JWT
SECRET_KEY=your-super-secret-key-change-this

# 应用
LOG_LEVEL=INFO
ENVIRONMENT=development
"""

# ============================================================================
# 6. 初始化数据库表
# ============================================================================

"""
在FastAPI应用启动前，运行以下命令初始化数据库：

# 方法1：使用MySQL客户端执行SQL脚本
mysql -u root -p customer_system < project_sync_init.sql

# 方法2：在Python中执行
from sqlalchemy import create_engine
from app.database import Base
from app.models import ProjectCache, ProjectSyncHistory, ProjectSyncConfig, ProjectAccessTokens

engine = create_engine(DATABASE_URL)
Base.metadata.create_all(bind=engine)
"""

# ============================================================================
# 7. 生成访问令牌
# ============================================================================

"""
使用以下代码生成访问令牌，在创建项目详情链接时使用：

import jwt
from datetime import datetime, timedelta

def generate_access_token(project_id: str, user_id: str, user_type: str, user_name: str) -> str:
    payload = {
        'project_id': project_id,
        'user_id': user_id,
        'user_type': user_type,
        'user_name': user_name,
        'exp': datetime.utcnow() + timedelta(days=7)
    }
    token = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)
    return token

# 使用示例
token = generate_access_token(
    project_id='P123456',
    user_id='customer_123',
    user_type='customer',
    user_name='张三'
)

# 生成链接
link = f'http://localhost:3000/project/P123456?type=aftersales&token={token}'
"""

# ============================================================================
# 8. 添加通知发送逻辑 (app/services/notification_service.py)
# ============================================================================

"""
from typing import Dict, Any
import httpx
import logging

logger = logging.getLogger(__name__)

class NotificationService:
    '''通知服务'''
    
    @staticmethod
    async def send_wechat(phone: str, content: str, project_id: str) -> bool:
        '''发送微信通知'''
        try:
            # 调用微信API或企业微信API
            # 这里需要根据实际的微信集成方式实现
            logger.info(f"WeChat notification sent to {phone}: {content}")
            return True
        except Exception as e:
            logger.error(f"Failed to send WeChat notification: {e}")
            return False
    
    @staticmethod
    async def send_sms(phone: str, content: str, project_id: str) -> bool:
        '''发送短信通知'''
        try:
            # 调用短信API（如阿里云、腾讯云等）
            logger.info(f"SMS notification sent to {phone}: {content}")
            return True
        except Exception as e:
            logger.error(f"Failed to send SMS notification: {e}")
            return False
    
    @staticmethod
    async def send_email(email: str, content: str, project_id: str, subject: str) -> bool:
        '''发送邮件通知'''
        try:
            # 调用邮件API
            logger.info(f"Email notification sent to {email}: {subject}")
            return True
        except Exception as e:
            logger.error(f"Failed to send email notification: {e}")
            return False
    
    @staticmethod
    async def send_notification(notify_type: str, recipient: str, content: str, 
                               project_id: str, subject: str = None) -> bool:
        '''统一通知接口'''
        if notify_type == 'wechat':
            return await NotificationService.send_wechat(recipient, content, project_id)
        elif notify_type == 'sms':
            return await NotificationService.send_sms(recipient, content, project_id)
        elif notify_type == 'email':
            return await NotificationService.send_email(recipient, content, project_id, subject)
        else:
            logger.error(f"Unknown notification type: {notify_type}")
            return False
"""

# ============================================================================
# 9. 监控和日志
# ============================================================================

"""
# 添加结构化日志
import logging
import logging.handlers
import json
from datetime import datetime

class JsonFormatter(logging.Formatter):
    def format(self, record):
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'module': record.module,
            'function': record.funcName,
            'line': record.lineno,
        }
        return json.dumps(log_data)

# 配置日志
def setup_logging():
    logger = logging.getLogger()
    
    # 文件处理器
    file_handler = logging.handlers.RotatingFileHandler(
        'logs/project_sync.log',
        maxBytes=10485760,  # 10MB
        backupCount=10
    )
    file_handler.setFormatter(JsonFormatter())
    logger.addHandler(file_handler)
    
    # 控制台处理器
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
    logger.addHandler(console_handler)
    
    logger.setLevel(logging.INFO)

# 在应用启动时调用
setup_logging()
"""

# ============================================================================
# 10. API使用示例
# ============================================================================

"""
# 1. 验证访问权限
GET /api/projects/P123456/verify-access?token=xxx

响应:
{
    "has_access": true,
    "user_id": "customer_123",
    "user_type": "customer",
    "user_name": "张三"
}

# 2. 获取项目详情（使用缓存）
GET /api/projects/P123456?token=xxx&use_cache=true

响应:
{
    "project": {...},
    "from_cache": true,
    "cache_time": "5分钟前"
}

# 3. 刷新项目状态（强制同步）
GET /api/projects/P123456?token=xxx&use_cache=false&force_sync=true

# 4. 手动同步所有项目
POST /api/projects/sync
{
    "sync_type": "manual",
    "force": true
}

响应:
{
    "success": true,
    "total": 150,
    "updated": 5,
    "unchanged": 145,
    "failed": 0,
    "sync_time": "2024-02-02T16:00:00",
    "duration": 5.6
}

# 5. 获取同步历史
GET /api/projects/sync-history?page=1&page_size=20

# 6. 获取同步配置
GET /api/config/project-sync

# 7. 保存同步配置
POST /api/config/project-sync
{
    "auto_sync_enabled": true,
    "sync_frequency": "*/15 * * * *",
    "cache_ttl": 30,
    "sync_types": ["presale", "aftersales", "sales"],
    "notify_on_change": true,
    "notify_channels": ["wechat", "sms"]
}

# 8. 保存时间显示配置
POST /api/config/time-display
{
    "aftersales_time_format": "YYYY-MM-DD HH:mm",
    "sales_time_format": "YYYY-MM-DD HH:mm",
    "show_payment_time": true,
    "timezone": "Asia/Shanghai"
}
"""
