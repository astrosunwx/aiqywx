# 🎯 客户身份动态管理方案 - 完整实施指南

## 📊 客户身份类型与权限

### 三种客户身份

| 身份类型 | 说明 | 查询项目 | 售后服务 | 如何获得 |
|---------|------|---------|---------|----------|
| **商机用户**<br>`prospect` | 只询价，未成交 | ❌ 不可以 | ❌ 不可以 | 公众号咨询 |
| **正式客户**<br>`customer` | 已下单购买 | ✅ 可查询**自己的** | ✅ 可以（需验证） | 首次下单 / 企业微信添加 |
| **取消客户**<br>`cancelled` | 订单已取消 | ❌ 不可以 | ❌ 不可以 | 所有订单取消 |

---

## 🔄 身份转换流程

### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    客户身份动态转换                           │
└─────────────────────────────────────────────────────────────┘

第一阶段：商机用户（Prospect）
┌───────────────────┐
│ 客户在公众号咨询   │
│ "我想了解XX产品"   │
└──────┬────────────┘
       │
       ▼
┌─────────────────────────────┐
│ API自动对话收集信息：         │
│ 1. "请问怎么称呼您？"         │
│ 2. "您的电话是多少？"         │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 创建商机记录                 │
│ - customer_type = 'prospect' │
│ - has_active_order = FALSE   │
│ - is_verified = FALSE        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 分配销售顾问                 │
│ 推送企业微信通知             │
└──────┬──────────────────────┘
       │
       ▼
【权限状态】
❌ 不能查询项目（没有订单）
❌ 不能提交售后（不是正式客户）

┌─────────────────────────────────────────────────────────────┐
│              身份转换路径1：企业微信添加                      │
└─────────────────────────────────────────────────────────────┘

       │
       ▼
┌─────────────────────────────┐
│ 销售顾问在企业微信           │
│ 搜索手机号添加客户           │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 企业微信回调事件             │
│ add_way = 2（搜索手机号）    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ 【自动绑定服务】                         │
│ 1. 创建/更新客户记录                     │
│ 2. is_verified = TRUE ✅                 │
│ 3. customer_type = 'prospect' → 'customer' │
│ 4. 记录身份变更日志                      │
│    - change_reason: 'wework_added'       │
└──────┬──────────────────────────────────┘
       │
       ▼
【正式客户】customer_type = 'customer'

┌─────────────────────────────────────────────────────────────┐
│              身份转换路径2：首次下单                          │
└─────────────────────────────────────────────────────────────┘

商机用户
       │
       ▼
┌─────────────────────────────┐
│ 客户首次下单                 │
│ project.status = 'signed'    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ 【数据库触发器自动执行】                 │
│ 1. customer_type = 'customer'            │
│ 2. has_active_order = TRUE               │
│ 3. first_order_at = NOW()                │
│ 4. 记录身份变更日志                      │
│    - change_reason: 'first_order'        │
└──────┬──────────────────────────────────┘
       │
       ▼
【正式客户】customer_type = 'customer'

第二阶段：正式客户（Customer）
┌─────────────────────────────┐
│ customer_type = 'customer'   │
│ has_active_order = TRUE      │
│ is_verified = TRUE           │
└──────┬──────────────────────┘
       │
       ▼
【权限状态】
✅ 可以查询自己的项目（不能查询他人的）
✅ 可以提交售后工单
✅ 可以订单修改/取消申请

┌─────────────────────────────────────────────────────────────┐
│              身份降级：订单取消                               │
└─────────────────────────────────────────────────────────────┘

       │
       ▼
┌─────────────────────────────┐
│ 客户取消所有订单             │
│ project.status = 'cancelled' │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ 【数据库触发器自动执行】                 │
│ 检查：是否还有有效订单？                 │
│ IF 有效订单数 = 0 THEN                   │
│   1. customer_type = 'cancelled'         │
│   2. has_active_order = FALSE            │
│   3. last_order_cancel_at = NOW()        │
│   4. 记录身份变更日志                    │
│      - change_reason: 'order_cancelled'  │
└──────┬──────────────────────────────────┘
       │
       ▼
第三阶段：取消客户（Cancelled）
┌─────────────────────────────┐
│ customer_type = 'cancelled'  │
│ has_active_order = FALSE     │
└──────┬──────────────────────┘
       │
       ▼
【权限状态】
❌ 失去所有项目查询权限
❌ 失去所有售后服务权限
💡 如需恢复，重新下单即可
```

---

## 🛡️ 权限控制规则

### 1. 查询项目权限

```python
# 权限要求：
✅ customer_type = 'customer'  # 必须是正式客户
✅ has_active_order = TRUE     # 必须有有效订单
✅ 只能查询自己的项目（customer_id匹配）

# 拒绝情况：
❌ 商机用户（prospect）→ "您还不是正式客户，请先下单"
❌ 取消客户（cancelled）→ "您的订单已取消，无法查询"
❌ 无有效订单 → "您暂无有效订单"
❌ 尝试查询他人项目 → "无权限访问"
```

### 2. 提交售后权限

```python
# 权限要求：
✅ customer_type = 'customer'  # 必须是正式客户
✅ has_active_order = TRUE     # 必须有有效订单
✅ is_verified = TRUE          # 必须通过企业微信验证

# 拒绝情况：
❌ 商机用户 → "只有正式客户才能提交售后"
❌ 取消客户 → "订单已取消，无法售后"
❌ 未验证 → "请先通过企业微信员工添加验证"
```

---

## 💬 公众号对话示例

### 场景1：商机用户咨询

```
客户：我想了解你们的设备

系统：您好！感谢您的咨询。
     为了更好地为您服务，请问怎么称呼您？

客户：张三

系统：好的，张先生/女士。
     方便提供您的电话吗？我们的销售顾问会联系您。

客户：13800138000

系统：已记录您的信息！
     咨询单号：INQ20240202123456ABC
     我们的销售顾问会尽快联系您。
     
     💡 如需更快服务，可添加我们的企业微信：XXX

[同时]
→ 企业微信推送给销售顾问：
  【新商机提醒】
  咨询单号：INQ20240202123456ABC
  客户：张三（13800138000）
  内容：我想了解你们的设备
  请及时跟进联系！
```

### 场景2：销售顾问添加客户

```
销售顾问操作：
1. 打开企业微信
2. 点击"添加客户"
3. 搜索手机号：13800138000
4. 点击添加

[系统自动处理]
→ 企业微信回调事件（add_way=2）
→ 自动绑定服务执行
→ 客户身份转换：prospect → customer
→ is_verified = TRUE
→ 记录变更日志

[客户收到公众号消息]
系统：您好，张先生/女士！
     您已成为我们的正式客户。
     现在您可以：
     - 发送"项目"查询订单进度
     - 发送"售后"提交工单
     - 享受完整的客户服务
```

### 场景3：正式客户查询项目

```
客户：项目

系统：[检查权限：customer_type=customer ✅]
     
     您的项目列表：
     
     1️⃣ XX设备安装项目
        状态：进行中
        进度：60%
        负责人：程红
        
     2️⃣ YY设备维护项目
        状态：已完成
        进度：100%
        负责人：李四
     
     查看详情请点击：https://xxx.com/project/abc123
```

### 场景4：订单取消后查询

```
客户：项目

系统：[检查权限：customer_type=cancelled ❌]
     
     抱歉，您的订单已取消，暂无法查询项目。
     如需帮助请联系客服：400-XXX-XXXX
     或添加企业微信：XXX
```

---

## 🗄️ 数据库设计

### 新增字段（customers表）

```sql
-- 客户类型管理
customer_type VARCHAR(20) DEFAULT 'prospect'  -- 商机/正式/取消
has_active_order BOOLEAN DEFAULT FALSE        -- 是否有有效订单
first_order_at TIMESTAMP                      -- 首次下单时间
last_order_cancel_at TIMESTAMP                -- 最后取消时间
```

### 新增表

#### 1. prospect_inquiries（商机咨询表）

```sql
CREATE TABLE prospect_inquiries (
    id SERIAL PRIMARY KEY,
    inquiry_no VARCHAR(50) UNIQUE NOT NULL,  -- INQ20240202123456ABC
    
    -- 客户信息
    customer_phone VARCHAR(20),
    customer_name VARCHAR(100),
    customer_id INTEGER REFERENCES customers(id),
    
    -- 咨询内容
    inquiry_content TEXT,
    product_interest VARCHAR(200),
    
    -- 处理状态
    status VARCHAR(20) DEFAULT 'pending',  -- pending/assigned/following/converted/lost
    assigned_to VARCHAR(100),              -- 销售顾问UserID
    assigned_to_name VARCHAR(100),
    
    -- 转化记录
    converted_to_customer BOOLEAN DEFAULT FALSE,
    converted_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. customer_type_change_logs（身份变更日志表）

```sql
CREATE TABLE customer_type_change_logs (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(id),
    customer_phone VARCHAR(20),
    
    -- 变更信息
    old_type VARCHAR(20),  -- prospect/customer/cancelled
    new_type VARCHAR(20),
    change_reason VARCHAR(100),  -- first_order/order_cancelled/wework_added
    
    -- 触发事件
    trigger_event VARCHAR(50),
    project_id INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 🚀 API接口

### 1. 创建商机咨询

**POST** `/api/prospect/inquiry`

```json
{
  "phone": "13800138000",
  "name": "张三",
  "inquiry_content": "我想了解XX设备",
  "product_interest": "工业设备",
  "source": "wechat",
  "source_openid": "oABC123..."
}
```

**响应**：
```json
{
  "success": true,
  "message": "我已记录您的信息，销售顾问会联系您",
  "inquiry_no": "INQ20240202123456ABC",
  "need_input": "phone"  // 如果缺少信息
}
```

### 2. 检查客户权限

**POST** `/api/customer/permission/check`

```json
{
  "customer_phone": "13800138000",
  "permission_type": "query_project"  // 或 "submit_aftersales"
}
```

**响应**：
```json
{
  "has_permission": true,
  "customer_id": 123,
  "customer_type": "customer",
  "message": "您可以查询项目"
}
```

### 3. 查询客户类型

**GET** `/api/customer/{phone}/type`

**响应**：
```json
{
  "exists": true,
  "customer_type": "customer",
  "is_verified": true,
  "has_active_order": true,
  "permissions": {
    "can_query_projects": true,
    "can_submit_aftersales": true
  }
}
```

### 4. 查询客户项目（带权限检查）

**GET** `/api/customer/{phone}/projects`

**响应**：
```json
{
  "success": true,
  "customer_type": "customer",
  "projects": [
    {
      "id": 123,
      "title": "XX设备安装项目",
      "status": "in_progress",
      "progress": 60
    }
  ],
  "count": 1
}
```

---

## 🔧 实施步骤

### 步骤1：执行数据库迁移

```bash
cd backend
psql -U postgres -d customer_db -f after_sales_extension.sql
```

**检查点**：
- ✅ customers表新增4个字段
- ✅ prospect_inquiries表创建
- ✅ customer_type_change_logs表创建
- ✅ 触发器创建（订单状态变更时自动更新客户类型）

### 步骤2：重启后端服务

```bash
docker-compose restart backend
```

### 步骤3：测试完整流程

#### 测试1：商机收集

```python
# 客户在公众号咨询
POST /api/prospect/inquiry
{
    "phone": "13800138000",
    "name": "张三",
    "inquiry_content": "我想了解设备",
    "source": "wechat"
}

# 检查数据库
SELECT * FROM customers WHERE phone = '13800138000';
# customer_type应该是'prospect'

SELECT * FROM prospect_inquiries WHERE customer_phone = '13800138000';
# 应该有咨询记录
```

#### 测试2：企业微信添加（身份自动转换）

```python
# 销售顾问在企业微信搜索13800138000并添加
# 系统收到回调后自动处理

# 检查数据库
SELECT customer_type, is_verified FROM customers WHERE phone = '13800138000';
# customer_type应该从'prospect'变为'customer'
# is_verified应该是TRUE

SELECT * FROM customer_type_change_logs WHERE customer_phone = '13800138000';
# 应该有变更日志，change_reason='wework_added'
```

#### 测试3：权限检查

```python
# 检查查询项目权限
POST /api/customer/permission/check
{
    "customer_phone": "13800138000",
    "permission_type": "query_project"
}

# 如果是商机用户，应该返回has_permission=false
# 如果是正式客户且有订单，应该返回has_permission=true
```

#### 测试4：订单取消（身份自动降级）

```sql
-- 模拟订单取消
UPDATE projects 
SET status = 'cancelled' 
WHERE customer_phone = '13800138000';

-- 检查客户类型（触发器自动执行）
SELECT customer_type, has_active_order FROM customers 
WHERE phone = '13800138000';
-- 如果这是唯一订单，customer_type应该变为'cancelled'

-- 检查变更日志
SELECT * FROM customer_type_change_logs 
WHERE customer_phone = '13800138000'
ORDER BY created_at DESC LIMIT 1;
-- change_reason应该是'order_cancelled'
```

---

## 📈 统计查询

### 商机转化率统计

```sql
SELECT * FROM prospect_conversion_stats;
```

**结果示例**：
| month | total_inquiries | converted_count | conversion_rate | avg_days_to_convert |
|-------|----------------|-----------------|-----------------|---------------------|
| 2024-02 | 50 | 15 | 30.00% | 3.5 |
| 2024-01 | 45 | 12 | 26.67% | 4.2 |

### 客户权限视图

```sql
SELECT * FROM customer_permissions 
WHERE phone = '13800138000';
```

**结果示例**：
| phone | customer_type | can_query_projects | can_submit_aftersales |
|-------|---------------|--------------------|-----------------------|
| 13800138000 | customer | true | true |

---

## ✅ 总结

### 您的所有需求都已实现：

| 需求 | 状态 | 实现方式 |
|------|------|----------|
| 商机用户不能查询他人项目 | ✅ | 权限检查 + 只返回customer_id匹配的项目 |
| 订单取消后失去权限 | ✅ | 数据库触发器自动更新customer_type='cancelled' |
| API自动询问称呼和电话 | ✅ | 分步收集信息，need_input提示 |
| 记录商机信息 | ✅ | prospect_inquiries表 |
| 推送给销售顾问 | ✅ | 自动分配并推送企业微信消息 |
| 企业微信添加后身份自动转换 | ✅ | 自动绑定服务：prospect → customer |
| 获取客户信息（姓名电话等） | ✅ | 企业微信API get_external_contact_info() |

**整个系统已完整实现客户身份动态管理，可以立即部署！** 🚀
