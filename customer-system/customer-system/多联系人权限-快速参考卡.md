# å¤šè”ç³»äººæƒé™å¤„ç† - å¿«é€Ÿå‚è€ƒå¡

## ğŸ¯ 3ç§å…¸å‹åœºæ™¯

### åœºæ™¯Aï¼šAæŸ¥è¯¢Açš„é¡¹ç›®
```
å®¢æˆ·ï¼šå¼ ä¸‰ï¼ˆä¸»å®¢æˆ·ï¼‰
æ‰‹æœºï¼š13800138000
æ“ä½œï¼šæŸ¥è¯¢è‡ªå·±çš„é¡¹ç›®

âœ… ç›´æ¥å…è®¸
åŸå› ï¼šcustomer_idåŒ¹é…
è¿”å›ï¼šæ‰€æœ‰è‡ªå·±çš„é¡¹ç›®
```

### åœºæ™¯Bï¼šBæŸ¥è¯¢Açš„é¡¹ç›®ï¼ˆä¸åœ¨è”ç³»äººåˆ—è¡¨ï¼‰
```
å®¢æˆ·ï¼šèµµå…­ï¼ˆå…¶ä»–å®¢æˆ·ï¼‰
æ‰‹æœºï¼š13600136000
æ“ä½œï¼šæŸ¥è¯¢é¡¹ç›®123ï¼ˆèµµå…­ä¸æ˜¯è”ç³»äººï¼‰

âŒ æ— æƒé™ï¼Œä½†ä¸æ‹’ç»
å¤„ç†æµç¨‹ï¼š
1. âœ… è®°å½•æœåŠ¡è¯·æ±‚ï¼ˆCustomerServiceRequestï¼‰
2. ğŸ“± æ¨é€ä¼ä¸šå¾®ä¿¡å†…éƒ¨ç¾¤
3. ğŸ‘¥ é”€å”®é¡¾é—®äººå·¥å¤„ç†
4. ğŸ¤– å›å¤ï¼š"å·²è®°å½•è¯·æ±‚ï¼Œä¸“å‘˜ä¼šè”ç³»æ‚¨"
```

### åœºæ™¯Cï¼šBæŸ¥è¯¢Açš„é¡¹ç›®ï¼ˆåœ¨è”ç³»äººåˆ—è¡¨ä¸­ï¼‰
```
å®¢æˆ·ï¼šæå››ï¼ˆæŠ€æœ¯è´Ÿè´£äººï¼‰
æ‰‹æœºï¼š13900139000
æ“ä½œï¼šæŸ¥è¯¢é¡¹ç›®123

æ£€æŸ¥æµç¨‹ï¼š
1. customer_id â‰  æå››çš„ID âŒ
2. additional_contactsåŒ…å«13900139000 âœ…
3. æœ‰æƒé™ï¼Œè¿”å›é¡¹ç›®

âœ… ç›´æ¥å…è®¸
åŸå› ï¼šé¢å¤–è”ç³»äºº
è¿”å›ï¼šé¡¹ç›®123ä¿¡æ¯ï¼ˆæ ‡æ³¨è§’è‰²ï¼šæŠ€æœ¯è´Ÿè´£äººï¼‰
```

---

## ğŸ¤– AIå¯¹è¯è‡ªåŠ¨å¤„ç†

### å¾®ä¿¡å…¬ä¼—å·/ä¼ä¸šå¾®ä¿¡å¯¹è¯

#### å¯¹è¯1ï¼šé¢å¤–è”ç³»äººæŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
```
æå››ï¼šæŸ¥è¯¢é¡¹ç›®è¿›åº¦ 13900139000

ğŸ¤–ç³»ç»Ÿè‡ªåŠ¨ï¼š
âœ“ æå–æ‰‹æœºå·ï¼š13900139000
âœ“ æŸ¥è¯¢å®¢æˆ·ï¼šcustomer_type='customer'
âœ“ æŸ¥è¯¢é¡¹ç›®ï¼šWHERE customer_id = xxx 
          OR additional_contacts @> '[{"phone":"13900139000"}]'
âœ“ æ‰¾åˆ°2ä¸ªé¡¹ç›®ï¼ˆ1ä¸ªä¸»å®¢æˆ·ï¼Œ1ä¸ªé¢å¤–è”ç³»äººï¼‰

ğŸ¤–å›å¤ï¼š
æ‚¨çš„é¡¹ç›®è¿›åº¦ï¼š
â€¢ ä¸­å¤®ç©ºè°ƒå®‰è£…é¡¹ç›®: å¤„ç†ä¸­
  ï¼ˆæ‚¨çš„è§’è‰²ï¼šæŠ€æœ¯è´Ÿè´£äººï¼‰
â€¢ æˆ‘çš„è®¢å•é¡¹ç›®: å·²å®Œæˆ
  ï¼ˆä¸»å®¢æˆ·ï¼‰
```

#### å¯¹è¯2ï¼šéè”ç³»äººæŸ¥è¯¢ï¼ˆåŒ…å®¹å¤„ç†ï¼‰
```
èµµå…­ï¼šæŸ¥è¯¢é¡¹ç›®123

ğŸ¤–ï¼šè¯·é—®æ‚¨çš„æ‰‹æœºå·ï¼Ÿ

èµµå…­ï¼š13600136000

ğŸ¤–ç³»ç»Ÿè‡ªåŠ¨ï¼š
âœ“ æŸ¥è¯¢å®¢æˆ·ï¼šå­˜åœ¨
âœ“ æ£€æŸ¥æƒé™ï¼šcustomer_idä¸åŒ¹é…
âœ“ æ£€æŸ¥è”ç³»äººï¼šadditional_contactsä¸åŒ…å«
âœ— æ— æƒé™

ğŸ¤–ä¸æ‹’ç»ï¼Œè€Œæ˜¯ï¼š
âœ“ åˆ›å»ºCustomerServiceRequest
âœ“ request_type='query_order', needs_verification=true
âœ“ æ¨é€ä¼ä¸šå¾®ä¿¡ï¼š"éœ€è¦éªŒè¯ï¼Œè¯·é”€å”®æ·»åŠ "

ğŸ¤–å›å¤ï¼š
âœ… å·²è®°å½•æ‚¨çš„æŸ¥è¯¢é¡¹ç›®è¯·æ±‚
   æˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†
   è¯·ä¿æŒç”µè¯ç•…é€š
   ğŸ“‹ è¯·æ±‚å•å·ï¼šREQ20240202123456ABC
```

#### å¯¹è¯3ï¼šé¢å¤–è”ç³»äººå”®åï¼ˆè‡ªåŠ¨åŒ¹é…é¡¹ç›®ï¼‰
```
æå››ï¼šç©ºè°ƒä¸åˆ¶å†·

ğŸ¤–ï¼šè¯·é—®æ‚¨çš„æ‰‹æœºå·ï¼Ÿ

æå››ï¼š13900139000

ğŸ¤–ç³»ç»Ÿè‡ªåŠ¨ï¼š
âœ“ æŸ¥è¯¢æ‰€æœ‰å¯è®¿é—®é¡¹ç›®
âœ“ æ‰¾åˆ°"ä¸­å¤®ç©ºè°ƒå®‰è£…é¡¹ç›®"
âœ“ additional_contactsåŒ…å«æå››
âœ“ æœ‰å”®åæƒé™

ğŸ¤–å›å¤ï¼š
ä¿¡æ¯å·²è®°å½•ï¼
å·¥å•å·ï¼šSV20240202001
é¡¹ç›®ï¼šä¸­å¤®ç©ºè°ƒå®‰è£…é¡¹ç›®
æ‚¨çš„è§’è‰²ï¼šæŠ€æœ¯è´Ÿè´£äºº
æŠ€æœ¯æ”¯æŒå°†åœ¨30åˆ†é’Ÿå†…è”ç³»æ‚¨
ğŸ“Š æŸ¥çœ‹è¯¦æƒ…ï¼šhttps://xxx/secure/project/abc123
```

---

## ğŸ“± ä¼ä¸šå¾®ä¿¡å†…éƒ¨ç¾¤é€šçŸ¥

### é€šçŸ¥1ï¼šé¢å¤–è”ç³»äººæ“ä½œï¼ˆæ­£å¸¸ï¼‰
```
ğŸ’¼ ã€å”®åå·¥å•ã€‘
å·¥å•å·ï¼šSV20240202001
å®¢æˆ·ï¼šæå››ï¼ˆ13900139000ï¼‰
é¡¹ç›®ï¼šä¸­å¤®ç©ºè°ƒå®‰è£…é¡¹ç›®
è§’è‰²ï¼šé¡¹ç›®é¢å¤–è”ç³»äººï¼ˆæŠ€æœ¯è´Ÿè´£äººï¼‰
é—®é¢˜ï¼šç©ºè°ƒä¸åˆ¶å†·

âœ… æƒé™å·²éªŒè¯ï¼Œè¯·æŠ€æœ¯æ”¯æŒåŠæ—¶å¤„ç†
```

### é€šçŸ¥2ï¼šéè”ç³»äººè¯·æ±‚ï¼ˆéœ€éªŒè¯ï¼‰
```
ğŸ“ ã€å®¢æˆ·æœåŠ¡è¯·æ±‚ - éœ€è¦éªŒè¯ã€‘
è¯·æ±‚å•å·ï¼šREQ20240202123456ABC
è¯·æ±‚ç±»å‹ï¼šæŸ¥è¯¢è®¢å•ï¼ˆNORMALï¼‰
å®¢æˆ·ï¼šèµµå…­ï¼ˆ13600136000ï¼‰
è¯·æ±‚å†…å®¹ï¼šæŸ¥è¯¢é¡¹ç›®123

âš ï¸ æ¸©é¦¨æç¤ºï¼š
è¯¥å®¢æˆ·ä¸æ˜¯é¡¹ç›®123çš„è”ç³»äºº

å¯èƒ½åŸå› ï¼š
â€¢ é¡¹ç›®è”ç³»äººå˜æ›´äº†
â€¢ å®¢æˆ·è®°é”™äº†é¡¹ç›®ç¼–å·
â€¢ éœ€è¦æ·»åŠ ä¸ºé¢å¤–è”ç³»äºº

ğŸ“± è¯·é”€å”®é¡¾é—®å…ˆè”ç³»å®¢æˆ·æ ¸å®æƒ…å†µ

ğŸ’¡ å¿«é€Ÿæ“ä½œï¼ˆéœ€è¦@æ™ºèƒ½åŠ©æ‰‹ï¼‰ï¼š
å¦‚éœ€æ·»åŠ ä¸ºè”ç³»äººï¼š
@æ™ºèƒ½åŠ©æ‰‹ /æ·»åŠ è”ç³»äºº é¡¹ç›®123 æ‰‹æœº13600136000 å§“åèµµå…­ è§’è‰²è”ç³»äºº

æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯ï¼š
@æ™ºèƒ½åŠ©æ‰‹ #æŸ¥è¯¢è¿›åº¦ æ‰‹æœºå·13600136000

è®°å½•æ–°å®¢æˆ·ï¼š
@æ™ºèƒ½åŠ©æ‰‹ #è®°å½•å®¢æˆ· æ‰‹æœºå·13600136000 æ„å‘äº§å“XX
```

---

## ğŸ”Œ APIå¿«é€Ÿè°ƒç”¨

### API1ï¼šæŸ¥è¯¢å¯è®¿é—®é¡¹ç›®ï¼ˆè‡ªåŠ¨åŒ…å«å¤šè”ç³»äººï¼‰
```bash
# è¿”å›ï¼šä¸»å®¢æˆ·é¡¹ç›® + é¢å¤–è”ç³»äººé¡¹ç›®
GET /api/customer/13900139000/projects

å“åº”ï¼š
{
  "total_projects": 2,
  "projects": [
    {
      "id": 123,
      "title": "ä¸­å¤®ç©ºè°ƒå®‰è£…",
      "access_type": "additional_contact",  # é¢å¤–è”ç³»äºº
      "my_role": "æŠ€æœ¯è´Ÿè´£äºº"
    },
    {
      "id": 456,
      "title": "æˆ‘çš„è®¢å•",
      "access_type": "primary_customer"  # ä¸»å®¢æˆ·
    }
  ]
}
```

### API2ï¼šæ·»åŠ é¡¹ç›®è”ç³»äºº
```bash
POST /api/project/contact/add
Content-Type: application/json

{
  "project_id": 123,
  "phone": "13900139000",
  "name": "æå››",
  "role": "æŠ€æœ¯è´Ÿè´£äºº"
}

å“åº”ï¼š
{
  "success": true,
  "message": "å·²æ·»åŠ è”ç³»äºº æå››"
}
```

### API3ï¼šæ£€æŸ¥é¡¹ç›®è®¿é—®æƒé™
```bash
POST /api/project/access/check
Content-Type: application/json

{
  "customer_phone": "13900139000",
  "project_id": 123
}

å“åº”ï¼ˆæœ‰æƒé™ï¼‰ï¼š
{
  "has_access": true,
  "access_type": "additional_contact",
  "contact_role": "æŠ€æœ¯è´Ÿè´£äºº",
  "message": "é¡¹ç›®è”ç³»äººï¼Œæ‹¥æœ‰æŸ¥è¯¢æƒé™"
}

å“åº”ï¼ˆæ— æƒé™ï¼‰ï¼š
{
  "has_access": false,
  "reason": "not_project_contact",
  "message": "æ‚¨ä¸æ˜¯è¯¥é¡¹ç›®çš„è”ç³»äºº",
  "suggestion": "æ‚¨å¯ä»¥æäº¤æœåŠ¡è¯·æ±‚ï¼Œæˆ‘ä»¬çš„é”€å”®é¡¾é—®ä¼šå¸®æ‚¨å¤„ç†",
  "action": "create_service_request"
}
```

### API4ï¼šè·å–é¡¹ç›®æ‰€æœ‰è”ç³»äºº
```bash
GET /api/project/123/contacts

å“åº”ï¼š
{
  "project_id": 123,
  "primary_customer": {
    "phone": "13800138000",
    "name": "å¼ ä¸‰",
    "role": "ä¸»å®¢æˆ·"
  },
  "additional_contacts": [
    {
      "phone": "13900139000",
      "name": "æå››",
      "role": "æŠ€æœ¯è´Ÿè´£äºº"
    },
    {
      "phone": "13700137000",
      "name": "ç‹äº”",
      "role": "é‡‡è´­è´Ÿè´£äºº"
    }
  ],
  "total_contacts": 3
}
```

---

## ğŸ“Š æƒé™çŸ©é˜µ

| æ“ä½œ | ä¸»å®¢æˆ· | é¢å¤–è”ç³»äºº | å…¶ä»–å®¢æˆ· |
|------|--------|-----------|---------|
| **æŸ¥è¯¢è‡ªå·±çš„é¡¹ç›®** | âœ… | âœ…ï¼ˆåœ¨åˆ—è¡¨çš„ï¼‰ | âŒ æœåŠ¡è¯·æ±‚ |
| **æŸ¥è¯¢å…¶ä»–é¡¹ç›®** | âŒ æœåŠ¡è¯·æ±‚ | âœ…ï¼ˆåœ¨åˆ—è¡¨çš„ï¼‰ | âŒ æœåŠ¡è¯·æ±‚ |
| **æäº¤å”®åå·¥å•** | âœ… | âœ… | âŒ æœåŠ¡è¯·æ±‚ |
| **æ›´æ”¹è®¢å•** | âœ… | âŒ æœåŠ¡è¯·æ±‚ | âŒ æœåŠ¡è¯·æ±‚ |
| **å–æ¶ˆè®¢å•** | âœ… | âŒ æœåŠ¡è¯·æ±‚ | âŒ æœåŠ¡è¯·æ±‚ |

---

## ğŸ’¡ æ ¸å¿ƒæŠ€æœ¯

### SQLæŸ¥è¯¢ï¼ˆPostgreSQL JSONBï¼‰
```sql
-- æŸ¥è¯¢å®¢æˆ·å¯è®¿é—®çš„æ‰€æœ‰é¡¹ç›®
SELECT * FROM projects 
WHERE customer_id = :customer_id  -- ä¸»å®¢æˆ·çš„é¡¹ç›®
   OR additional_contacts @> '[{"phone":"13900139000"}]'  -- é¢å¤–è”ç³»äººçš„é¡¹ç›®
ORDER BY created_at DESC;
```

### PythonæœåŠ¡
```python
# multi_contact_permission.py
from app.services.multi_contact_permission import MultiContactPermissionService

# æ£€æŸ¥æƒé™
result = await MultiContactPermissionService.check_project_access(
    db, customer_phone='13900139000', project_id=123
)

# è·å–å¯è®¿é—®é¡¹ç›®
projects = await MultiContactPermissionService.get_accessible_projects(
    db, customer_phone='13900139000'
)

# æ·»åŠ è”ç³»äºº
result = await MultiContactPermissionService.add_project_contact(
    db, project_id=123, phone='13900139000', name='æå››', role='æŠ€æœ¯è´Ÿè´£äºº'
)
```

---

## âœ… éƒ¨ç½²æ¸…å•

- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š`psql -U postgres -d customer_db -f backend/after_sales_extension.sql`
- [ ] é‡å¯åç«¯æœåŠ¡ï¼š`docker-compose restart backend`
- [ ] æµ‹è¯•æ·»åŠ è”ç³»äººAPI
- [ ] æµ‹è¯•æƒé™æ£€æŸ¥API
- [ ] æµ‹è¯•AIå¯¹è¯è‡ªåŠ¨è¯†åˆ«
- [ ] éªŒè¯ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ ¼å¼

---

## ğŸ¯ è®°ä½è¿™3ç‚¹

1. **ä¸ç›´æ¥æ‹’ç»** - æ— æƒé™èµ°æœåŠ¡è¯·æ±‚ï¼ŒğŸ¤–æ¨é€ç»™é”€å”®å¤„ç†
2. **è‡ªåŠ¨è¯†åˆ«** - AIå¯¹è¯è‡ªåŠ¨æ£€æŸ¥å¤šè”ç³»äººæƒé™ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
3. **çµæ´»æ·»åŠ ** - é”€å”®å¯éšæ—¶ä¸ºé¡¹ç›®æ·»åŠ é¢å¤–è”ç³»äºº

**è®©æ¯ä¸ªé¡¹ç›®å¯¹æ¥äººéƒ½èƒ½é«˜æ•ˆåä½œï¼** ğŸš€
