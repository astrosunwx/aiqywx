# 配置中心 - 微信公众号和企业微信配置指南

## 📍 访问地址

```
http://localhost:3000/config-center
或
http://localhost:3000/config
```

点击左侧菜单 → **配置概览**

---

## ✅ 已添加的配置分组

### 1️⃣ 企业微信配置

包含以下配置项:
- **企业ID (CorpID)**: 从企业微信管理后台获取
- **应用AgentID**: 应用的唯一标识
- **应用Secret**: 应用密钥(敏感信息,自动隐藏)
- **消息Token**: 接收消息的Token
- **EncodingAESKey**: 消息加解密密钥(敏感信息)
- **企业微信接收消息URL**: 自动生成,可一键复制

### 2️⃣ 微信公众号配置 (新增)

包含以下配置项:
- **AppID**: 微信公众号的AppID
- **AppSecret**: 微信公众号的AppSecret(敏感信息,自动隐藏)
- **Token**: 服务器配置的Token
- **EncodingAESKey**: 消息加解密密钥(可选,敏感信息)
- **服务器地址(URL)**: 自动生成,可一键复制

### 3️⃣ AI模型配置

- AI提供商选择
- API密钥
- 模型名称

### 4️⃣ 数据库配置

- 数据库类型
- 数据库主机

---

## 🚀 使用步骤

### 第一步: 初始化配置数据

运行初始化脚本创建配置项:

```bash
cd G:\aiqywx\customer-system\customer-system\backend
python init_config.py
```

输出:
```
✅ 配置初始化完成！
   创建了 4 个配置分组
   创建了 XX 个配置项
```

### 第二步: 启动前后端服务

```bash
# 启动后端 (端口 8000)
cd backend
uvicorn app.main:app --reload --port 8000

# 启动前端 (端口 3000)
cd frontend
npm run dev
```

### 第三步: 访问配置中心

打开浏览器访问:
```
http://localhost:3000/config-center
```

### 第四步: 配置微信公众号

1. 在配置概览页面,找到 **"微信公众号配置"** 分组

2. 填写以下信息:
   - **AppID**: 从微信公众平台获取
   - **AppSecret**: 从微信公众平台获取
   - **Token**: 自定义设置(与微信公众平台一致)
   - **EncodingAESKey**: (可选)自动生成或自定义

3. **复制服务器URL**: 
   - 点击"服务器地址(URL)"右侧的 **复制** 按钮
   - 示例: `http://localhost:8000/api/wechat/official`

4. **配置到微信公众平台**:
   - 登录 [微信公众平台](https://mp.weixin.qq.com)
   - 进入 **开发 → 基本配置**
   - 粘贴服务器URL到 **服务器地址(URL)** 字段
   - 填写与系统中相同的Token
   - 点击 **提交**

5. 点击页面顶部的 **"一键保存配置"** 按钮

### 第五步: 配置企业微信 (如果需要)

1. 在配置概览页面,找到 **"企业微信配置"** 分组

2. 填写以下信息:
   - **企业ID (CorpID)**: 从企业微信管理后台获取
   - **应用AgentID**: 应用ID
   - **应用Secret**: 应用密钥

3. **复制回调URL**: 
   - 点击"企业微信接收消息URL"右侧的 **复制** 按钮
   - 示例: `http://localhost:8000/api/wechat/callback`

4. **配置到企业微信后台**:
   - 登录 [企业微信管理后台](https://work.weixin.qq.com)
   - 进入 **应用管理 → 选择应用 → 接收消息服务器**
   - 粘贴回调URL
   - 填写Token和EncodingAESKey

5. 点击 **"一键保存配置"** 按钮

---

## 🔧 配置说明

### 配置类型

| 类型 | 说明 | 示例 |
|------|------|------|
| string | 普通文本 | AppID, CorpID |
| password | 敏感信息(自动隐藏) | AppSecret, Secret |
| boolean | 开关选项 | 是否启用 |
| select | 下拉选择 | AI提供商 |

### 敏感信息保护

- 密码类型的配置项会自动显示为 `******`
- 保存时会加密存储
- 前端展示时自动脱敏

### URL自动生成

系统会根据当前访问地址自动生成回调URL:

```javascript
// 如果你的后端运行在 http://localhost:8000
企业微信回调URL: http://localhost:8000/api/wechat/callback
微信公众号URL: http://localhost:8000/api/wechat/official

// 如果你的后端运行在 https://yourdomain.com
企业微信回调URL: https://yourdomain.com/api/wechat/callback
微信公众号URL: https://yourdomain.com/api/wechat/official
```

---

## 📋 配置完成检查清单

- [ ] 运行 `python init_config.py` 初始化配置
- [ ] 启动后端服务 (端口 8000)
- [ ] 启动前端服务 (端口 3000)
- [ ] 访问配置中心页面
- [ ] 填写微信公众号AppID和AppSecret
- [ ] 复制并配置微信公众号服务器URL
- [ ] (可选) 填写企业微信配置
- [ ] (可选) 复制并配置企业微信回调URL
- [ ] 点击 "一键保存配置"
- [ ] 验证配置是否生效

---

## 🎯 生产环境部署

### 修改服务器URL

生产环境需要使用HTTPS域名:

1. **更新服务器配置**:
   ```env
   # .env
   APP_DOMAIN=https://yourdomain.com
   ```

2. **微信公众平台配置**:
   ```
   服务器地址(URL): https://yourdomain.com/api/wechat/official
   ```

3. **企业微信后台配置**:
   ```
   URL: https://yourdomain.com/api/wechat/callback
   ```

### 安全建议

1. **修改默认密钥**:
   ```bash
   JWT_SECRET_KEY=生成一个复杂的随机密钥
   ```

2. **启用HTTPS**:
   - 微信要求必须使用HTTPS
   - 可使用Let's Encrypt免费证书

3. **限制CORS**:
   ```python
   # main.py
   allow_origins=[
       "https://yourdomain.com",
       "https://work.weixin.qq.com"
   ]
   ```

---

## 🐛 常见问题

### Q1: 配置保存后不生效?

A: 配置是实时生效的,无需重启。如果不生效:
1. 检查浏览器控制台是否有错误
2. 检查后端日志
3. 确认数据库连接正常

### Q2: 回调URL复制后不能用?

A: 确保:
1. 后端服务正在运行
2. 使用的端口与配置一致 (默认8000)
3. 生产环境必须使用HTTPS

### Q3: 微信公众号配置项不显示?

A: 需要先运行 `python init_config.py` 初始化配置数据

### Q4: 如何查看已保存的配置?

A: 配置保存在数据库中:
```sql
SELECT * FROM enhanced_system_configs;
SELECT * FROM config_groups;
```

---

## 📞 技术支持

如有问题,请:
1. 查看系统日志
2. 检查网络连接
3. 确认微信平台配置正确
4. 联系系统管理员

---

**最后更新**: 2026-02-03
