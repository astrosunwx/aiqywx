# 网页配置管理系统 - 技术架构图

## 🏗️ 系统整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (Vue 3)                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  配置概览    │  │  群机器人    │  │  业务流程    │         │
│  │  ConfigCenter│  │  Webhooks    │  │  Workflows   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  权限管理    │  │  用户管理    │  │  操作日志    │         │
│  │  Permissions │  │  Users       │  │  Logs        │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP/REST API
┌─────────────────────────────────────────────────────────────────┐
│                      API网关层 (FastAPI)                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────┐    │
│  │  /api/admin/config-center/*  配置中心路由              │    │
│  │  ├─ GET  /overview           获取配置概览              │    │
│  │  ├─ POST /batch-update       批量更新配置              │    │
│  │  ├─ GET  /webhooks           获取Webhook列表           │    │
│  │  ├─ POST /webhooks           创建Webhook               │    │
│  │  ├─ GET  /workflows          获取业务流程模板          │    │
│  │  ├─ POST /workflows/activate 激活业务流程              │    │
│  │  ├─ GET  /roles              获取角色列表              │    │
│  │  ├─ GET  /permissions        获取权限列表              │    │
│  │  ├─ GET  /users              获取用户列表              │    │
│  │  ├─ POST /users              创建用户                  │    │
│  │  ├─ GET  /logs               获取操作日志              │    │
│  │  └─ ...更多API                                         │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  中间件层                                               │    │
│  │  ├─ CORS中间件              跨域处理                   │    │
│  │  ├─ 认证中间件              JWT验证（待实现）          │    │
│  │  ├─ 权限检查中间件          权限验证                   │    │
│  │  └─ 操作日志中间件          自动记录日志               │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ORM
┌─────────────────────────────────────────────────────────────────┐
│                   数据访问层 (SQLAlchemy)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                    │
│  │  配置管理模型    │  │  权限管理模型    │                    │
│  │  ├─ ConfigGroup  │  │  ├─ Role         │                    │
│  │  ├─ Enhanced     │  │  ├─ AdminUser    │                    │
│  │  │   SystemConfig│  │  └─ Permission   │                    │
│  │  ├─ RobotWebhook │  │                  │                    │
│  │  └─ Workflow     │  │                  │                    │
│  │     Template     │  │                  │                    │
│  └──────────────────┘  └──────────────────┘                    │
│  ┌──────────────────┐                                           │
│  │  业务模型        │                                           │
│  │  ├─ Customer     │  (复用现有模型)                          │
│  │  ├─ Project      │                                           │
│  │  ├─ Opportunity  │                                           │
│  │  └─ ...          │                                           │
│  └──────────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓ SQL
┌─────────────────────────────────────────────────────────────────┐
│                    数据存储层 (PostgreSQL)                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────┐    │
│  │  配置管理相关表                                         │    │
│  │  ├─ roles                  角色表                      │    │
│  │  ├─ admin_users            管理员用户表                │    │
│  │  ├─ permissions            权限表                      │    │
│  │  ├─ config_groups          配置分组表                  │    │
│  │  ├─ enhanced_system_config 增强系统配置表              │    │
│  │  ├─ workflow_templates     业务流程模板表              │    │
│  │  ├─ robot_webhooks         群机器人配置表              │    │
│  │  └─ operation_logs         操作日志表                  │    │
│  └────────────────────────────────────────────────────────┘    │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  业务数据表 (现有)                                      │    │
│  │  ├─ customers              客户表                      │    │
│  │  ├─ projects               项目表                      │    │
│  │  ├─ opportunities          商机表                      │    │
│  │  ├─ orders                 订单表                      │    │
│  │  └─ ...更多业务表                                       │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↑↓ 缓存
                        ┌──────────────┐
                        │    Redis     │
                        │  ├─ 会话缓存 │
                        │  ├─ 配置缓存 │
                        │  └─ 权限缓存 │
                        └──────────────┘
```

## 🔄 数据流向

### 1. 配置更新流程

```
用户操作
   ↓
前端表单收集数据
   ↓
POST /api/admin/config-center/batch-update
   ↓
权限验证（检查用户是否有config:write权限）
   ↓
数据验证（格式、必填项检查）
   ↓
批量更新数据库
   ↓
清除Redis配置缓存
   ↓
记录操作日志
   ↓
返回成功响应
   ↓
前端显示成功提示
```

### 2. 业务流程激活流程

```
用户选择流程模板
   ↓
前端发送激活请求
   ↓
POST /api/admin/config-center/workflows/activate/{template_code}
   ↓
权限验证
   ↓
检查模板是否存在
   ↓
更新系统配置（active_workflow_template）
   ↓
加载模板配置到内存
   ↓
智能路由器重新初始化
   ↓
记录操作日志
   ↓
返回成功响应
```

### 3. 权限检查流程

```
API请求到达
   ↓
从JWT Token获取用户信息
   ↓
从Redis缓存获取用户权限（如果有）
   │  │
   │  └─ 缓存未命中
   │       ↓
   │    从数据库加载用户角色和权限
   │       ↓
   │    缓存到Redis（TTL: 1小时）
   ↓
检查用户是否有所需权限
   ↓
有权限：继续执行业务逻辑
无权限：返回403 Forbidden
```

## 🎯 关键设计模式

### 1. 策略模式 - 业务流程模板

```python
class WorkflowStrategy:
    """业务流程策略基类"""
    async def handle(self, message: str, context: dict):
        raise NotImplementedError

class PresaleWorkflow(WorkflowStrategy):
    """售前流程"""
    async def handle(self, message: str, context: dict):
        # 售前处理逻辑
        pass

class AftersaleWorkflow(WorkflowStrategy):
    """售后流程"""
    async def handle(self, message: str, context: dict):
        # 售后处理逻辑
        pass

class MixedWorkflow(WorkflowStrategy):
    """混合流程"""
    async def handle(self, message: str, context: dict):
        # AI分类 → 路由到对应流程
        pass
```

### 2. 工厂模式 - 动态路由生成

```python
class WorkflowFactory:
    """业务流程工厂"""
    
    @staticmethod
    def create_workflow(template_code: str) -> WorkflowStrategy:
        workflows = {
            'standard_presale': PresaleWorkflow,
            'standard_aftersale': AftersaleWorkflow,
            'mixed_workflow': MixedWorkflow
        }
        return workflows.get(template_code)()
```

### 3. 装饰器模式 - 权限检查

```python
def require_permission(permission: str):
    """权限检查装饰器"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 检查权限
            if not has_permission(current_user, permission):
                raise HTTPException(status_code=403)
            return await func(*args, **kwargs)
        return wrapper
    return decorator

@router.post("/config")
@require_permission("config:write")
async def update_config(...):
    pass
```

### 4. 观察者模式 - 配置变更通知

```python
class ConfigObserver:
    """配置变更观察者"""
    
    async def on_config_changed(self, config_key: str, new_value: str):
        # 配置变更时的处理逻辑
        if config_key == 'active_workflow_template':
            # 重新加载工作流
            await reload_workflow(new_value)
        elif config_key.startswith('wework_'):
            # 重新初始化企业微信客户端
            await reinit_wework_client()
```

## 🔐 安全架构

### 多层安全防护

```
┌─────────────────────────────────────────┐
│  第1层：网络层安全                      │
│  ├─ HTTPS加密传输                       │
│  ├─ CORS跨域限制                        │
│  └─ IP白名单（可选）                    │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  第2层：认证层                          │
│  ├─ JWT Token认证                       │
│  ├─ 密码Bcrypt加密                      │
│  └─ 企业微信单点登录（可选）            │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  第3层：授权层                          │
│  ├─ 基于角色的权限控制(RBAC)            │
│  ├─ 权限细粒度控制                      │
│  └─ 资源级别权限检查                    │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  第4层：数据层                          │
│  ├─ SQL注入防护（ORM参数化）            │
│  ├─ 敏感数据加密存储                    │
│  └─ 数据脱敏显示                        │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  第5层：审计层                          │
│  ├─ 完整操作日志                        │
│  ├─ 敏感操作审计                        │
│  └─ 异常行为检测                        │
└─────────────────────────────────────────┘
```

## 📊 性能优化策略

### 1. 缓存策略

```python
# 三级缓存架构
┌─────────────┐
│  浏览器缓存 │  (配置数据: 5分钟)
└─────────────┘
       ↓ 缓存未命中
┌─────────────┐
│  Redis缓存  │  (用户权限: 1小时, 配置: 10分钟)
└─────────────┘
       ↓ 缓存未命中
┌─────────────┐
│  数据库     │  (持久化存储)
└─────────────┘
```

### 2. 数据库优化

- 合理的索引设计
- 查询结果分页
- 连接池管理
- 异步数据库操作

### 3. 前端优化

- 组件懒加载
- 虚拟滚动（大列表）
- 防抖/节流
- 请求合并

## 🚀 部署架构

```
┌──────────────────────────────────────────────┐
│              负载均衡器 (Nginx)              │
└──────────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        ↓                         ↓
┌───────────────┐         ┌───────────────┐
│  前端服务器1   │         │  前端服务器2   │
│  (Nginx)      │         │  (Nginx)      │
└───────────────┘         └───────────────┘
        │                         │
        └────────────┬────────────┘
                     ↓
        ┌────────────────────────┐
        │   API网关 (FastAPI)    │
        └────────────────────────┘
                     │
        ┌────────────┴────────────┐
        ↓                         ↓
┌───────────────┐         ┌───────────────┐
│  后端服务1    │         │  后端服务2    │
│  (Uvicorn)    │         │  (Uvicorn)    │
└───────────────┘         └───────────────┘
        │                         │
        └────────────┬────────────┘
                     │
        ┌────────────┴────────────┐
        ↓                         ↓
┌───────────────┐         ┌───────────────┐
│  PostgreSQL   │         │     Redis     │
│  (主从复制)    │         │  (哨兵模式)   │
└───────────────┘         └───────────────┘
```

## 📈 监控与告警

### 监控指标

1. **系统指标**
   - CPU使用率
   - 内存使用率
   - 磁盘I/O
   - 网络流量

2. **应用指标**
   - API响应时间
   - 请求成功率
   - 并发用户数
   - 数据库连接数

3. **业务指标**
   - 配置变更次数
   - 用户登录次数
   - 权限拒绝次数
   - 异常操作次数

### 告警策略

- API响应时间 > 1秒 → 警告
- 错误率 > 1% → 严重警告
- 数据库连接池满 → 紧急
- 未授权访问尝试 > 10次/分钟 → 安全警报

---

**系统设计原则**
- ✅ 简单易用（零代码配置）
- ✅ 安全可靠（多层防护）
- ✅ 高性能（多级缓存）
- ✅ 可扩展（模块化设计）
- ✅ 可维护（完整日志）
