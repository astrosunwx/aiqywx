# é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²

### å‰ç½®è¦æ±‚

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹æœåŠ¡ï¼š
- âœ… PostgreSQL 12+
- âœ… Redis 6+
- âœ… RabbitMQ 3.8+
- âœ… Python 3.9+
- âœ… Node.js 16+

---

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

### åç«¯ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

**é¢„è®¡è€—æ—¶**ï¼š2-3åˆ†é’Ÿ

### å‰ç«¯ä¾èµ–
```bash
cd frontend
npm install
```

**é¢„è®¡è€—æ—¶**ï¼š1-2åˆ†é’Ÿ

---

## ğŸ—„ï¸ ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

### 1. åˆ›å»ºæ•°æ®åº“
```bash
psql -U postgres
CREATE DATABASE customer_system;
\q
```

### 2. æ‰§è¡Œæ‰€æœ‰è¿ç§»è„šæœ¬
```bash
# åŸºç¡€è¡¨
psql -U postgres -d customer_system -f backend/init.sql

# å”®åæ‰©å±•
psql -U postgres -d customer_system -f backend/after_sales_extension.sql

# è®¾å¤‡æ‰©å±•
psql -U postgres -d customer_system -f backend/equipment_extension.sql

# æ¶ˆæ¯ç³»ç»Ÿæ‰©å±•ï¼ˆæ–°å¢ï¼‰
psql -U postgres -d customer_system -f backend/messaging_extension.sql
```

**éªŒè¯æ•°æ®åº“**ï¼š
```sql
-- åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–°è¡¨
\dt message*

-- è¾“å‡ºï¼š
-- message_templates
-- message_tasks
-- message_records
-- message_traces
-- message_statistics
```

---

## âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `backend/.env` æ–‡ä»¶ï¼š

```ini
# === æ•°æ®åº“é…ç½® ===
DATABASE_URL=postgresql://postgres:your_password@localhost/customer_system

# === Redisé…ç½® ===
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# === RabbitMQé…ç½® ===
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USER=guest
RABBITMQ_PASSWORD=guest
RABBITMQ_VHOST=/

# === ä¼ä¸šå¾®ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰===
WEWORK_CORP_ID=your_corp_id
WEWORK_SECRET=your_secret

# === å¾®ä¿¡å…¬ä¼—å·é…ç½®ï¼ˆå¯é€‰ï¼‰===
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# === JWTå¯†é’¥ ===
SECRET_KEY=your-secret-key-here-change-me
```

**é‡è¦**ï¼šè¯·æ›¿æ¢ `your_password`ã€`your_corp_id` ç­‰ä¸ºå®é™…å€¼ï¼

---

## ğŸ”§ ç¬¬å››æ­¥ï¼šå¯åŠ¨æœåŠ¡

### å¯åŠ¨Redis
```bash
# Windows
redis-server

# Linux/Mac
sudo systemctl start redis
```

### å¯åŠ¨RabbitMQ
```bash
# Windows
rabbitmq-server.bat

# Linux/Mac
sudo systemctl start rabbitmq-server
```

**éªŒè¯RabbitMQ**ï¼š
æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:15672
- ç”¨æˆ·åï¼šguest
- å¯†ç ï¼šguest

### å¯åŠ¨åç«¯
```bash
cd backend
uvicorn app.main:app --reload --port 8000
```

**å¯åŠ¨æˆåŠŸæ ‡å¿—**ï¼š
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### å¯åŠ¨å‰ç«¯
æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼š
```bash
cd frontend
npm run dev
```

**å¯åŠ¨æˆåŠŸæ ‡å¿—**ï¼š
```
VITE v5.0.5  ready in 500 ms

âœ  Local:   http://localhost:5173/
âœ  Network: use --host to expose
```

---

## âœ… ç¬¬äº”æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 1. è®¿é—®APIæ–‡æ¡£
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8000/docs

**æ£€æŸ¥è¦ç‚¹**ï¼š
- âœ… èƒ½çœ‹åˆ°"æ¶ˆæ¯å¤„ç†"æ ‡ç­¾
- âœ… èƒ½çœ‹åˆ°ä»¥ä¸‹æ¥å£ï¼š
  - POST /api/messages/send
  - POST /api/messages/send-batch
  - GET /api/messages/traces/{trace_id}
  - GET /api/messages/statistics/overview

### 2. è®¿é—®ç›‘æ§å¤§å±
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5173/monitor

**æ£€æŸ¥è¦ç‚¹**ï¼š
- âœ… èƒ½çœ‹åˆ°4ä¸ªæ•°æ®å¡ç‰‡ï¼ˆä»Šæ—¥å‘é€æ€»æ•°ã€æˆåŠŸç‡ç­‰ï¼‰
- âœ… èƒ½çœ‹åˆ°4ä¸ªå›¾è¡¨ï¼ˆè¶‹åŠ¿å›¾ã€é¥¼å›¾ã€æŸ±çŠ¶å›¾ã€ä»ªè¡¨ç›˜ï¼‰

### 3. æµ‹è¯•å‘é€æ¶ˆæ¯

#### ä½¿ç”¨Swagger UIæµ‹è¯•
1. è®¿é—® http://localhost:8000/docs
2. æ‰¾åˆ° `POST /api/messages/send`
3. ç‚¹å‡»"Try it out"
4. è¾“å…¥æµ‹è¯•æ•°æ®ï¼š
```json
{
  "template_id": 1,
  "recipient": "test@example.com",
  "variables": {
    "order_no": "202401010001",
    "express_no": "SF1234567890",
    "delivery_days": "3"
  },
  "priority": 8
}
```
5. ç‚¹å‡»"Execute"

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "message": "æ¶ˆæ¯å·²åŠ å…¥å‘é€é˜Ÿåˆ—",
  "data": {
    "record_id": 1,
    "trace_id": "msg_abc123..."
  }
}
```

#### æŸ¥çœ‹æ¶ˆæ¯è¿½è¸ª
å¤åˆ¶ä¸Šé¢è¿”å›çš„ `trace_id`ï¼Œè®¿é—®ï¼š
```
GET /api/messages/traces/{trace_id}
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "data": {
    "trace_id": "msg_abc123...",
    "trace_data": {
      "nodes": [
        {"name": "queue", "status": "success", "duration_ms": 50}
      ]
    }
  }
}
```

---

## ğŸ¯ ç¬¬å…­æ­¥ï¼šæ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### ä½¿ç”¨Apache Benchå‹æµ‹
```bash
# å®‰è£…abå·¥å…·ï¼ˆWindowséœ€è¦å•ç‹¬ä¸‹è½½ï¼‰
# Linux/Macé€šå¸¸è‡ªå¸¦

# æµ‹è¯•ï¼š1000ä¸ªå¹¶å‘è¯·æ±‚
ab -n 1000 -c 50 -p test_data.json -T application/json \
   http://localhost:8000/api/messages/send
```

**test_data.json**ï¼š
```json
{
  "template_id": 1,
  "recipient": "test@example.com",
  "variables": {"order_no": "TEST001"},
  "priority": 5
}
```

**é¢„æœŸç»“æœ**ï¼š
```
Requests per second:    500.00 [#/sec] (mean)
Time per request:       100.000 [ms] (mean)
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡æ£€æŸ¥

è®¿é—®ç›‘æ§å¤§å±åï¼ŒéªŒè¯ä»¥ä¸‹æŒ‡æ ‡ï¼š

### 1. å®æ—¶ç»Ÿè®¡
```bash
curl http://localhost:8000/api/messages/statistics/realtime
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 0,
  "data": {
    "thread_pool_stats": {
      "message_sender": {
        "active_count": 20,
        "queue_size": 0,
        "queue_usage_percent": 0.0
      }
    }
  }
}
```

### 2. çº¿ç¨‹æ± çŠ¶æ€
- âœ… `active_count` > 0ï¼ˆæœ‰æ´»è·ƒçº¿ç¨‹ï¼‰
- âœ… `queue_usage_percent` < 50%ï¼ˆé˜Ÿåˆ—æœªç§¯å‹ï¼‰

### 3. Redisè¿æ¥
```bash
redis-cli
> KEYS msg_trace:*
> GET "msg_trace:abc123..."
```

**åº”è¯¥çœ‹åˆ°**ï¼šè¿½è¸ªæ•°æ®çš„JSON

### 4. RabbitMQé˜Ÿåˆ—
è®¿é—® http://localhost:15672/#/queues

**åº”è¯¥çœ‹åˆ°ä»¥ä¸‹é˜Ÿåˆ—**ï¼š
- message.send
- ai.process
- notification
- delayed

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šåç«¯å¯åŠ¨å¤±è´¥ - æ•°æ®åº“è¿æ¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
sqlalchemy.exc.OperationalError: could not connect to server
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥PostgreSQLæ˜¯å¦å¯åŠ¨
```bash
# Windows
services.mscï¼ˆæŸ¥çœ‹PostgreSQLæœåŠ¡ï¼‰

# Linux
sudo systemctl status postgresql
```

2. éªŒè¯æ•°æ®åº“è¿æ¥
```bash
psql -U postgres -d customer_system -c "SELECT 1"
```

3. æ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL`

---

### é—®é¢˜2ï¼šå‰ç«¯æ— æ³•è¿æ¥åç«¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Network Error / Failed to fetch
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ï¼ˆè®¿é—® http://localhost:8000/healthï¼‰
2. æ£€æŸ¥CORSé…ç½®ï¼ˆmain.pyä¸­çš„ `allow_origins`ï¼‰
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

---

### é—®é¢˜3ï¼šRedisè¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
redis.exceptions.ConnectionError: Error connecting to Redis
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥Redisæ˜¯å¦å¯åŠ¨
redis-cli ping
# åº”è¯¥è¿”å›ï¼šPONG

# å¦‚æœæ²¡å¯åŠ¨
# Windows
redis-server

# Linux
sudo systemctl start redis
```

---

### é—®é¢˜4ï¼šRabbitMQè¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
pika.exceptions.AMQPConnectionError
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥RabbitMQçŠ¶æ€
rabbitmqctl status

# å¦‚æœæ²¡å¯åŠ¨
# Windows
rabbitmq-server.bat

# Linux
sudo systemctl start rabbitmq-server

# æ£€æŸ¥ç”¨æˆ·æƒé™
rabbitmqctl list_users
```

---

### é—®é¢˜5ï¼šæ¶ˆæ¯å‘é€åæ²¡æœ‰è¿½è¸ªæ•°æ®

**åŸå› **ï¼šRabbitMQæ¶ˆè´¹è€…æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
åˆ›å»ºå¹¶å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆåç»­ä¼šé›†æˆåˆ°ä¸»ç¨‹åºï¼‰ï¼š

```python
# backend/consumer.py
from app.services.rabbitmq_service import RabbitMQService, MessageQueue

def callback(ch, method, properties, body):
    print(f"æ”¶åˆ°æ¶ˆæ¯: {body}")
    # å¤„ç†æ¶ˆæ¯é€»è¾‘
    ch.basic_ack(delivery_tag=method.delivery_tag)

if __name__ == "__main__":
    rabbitmq = RabbitMQService()
    queue = MessageQueue()
    
    rabbitmq.consume_messages(
        queue=queue.QUEUE_MESSAGE_SEND,
        callback=callback
    )
```

å¯åŠ¨æ¶ˆè´¹è€…ï¼š
```bash
python backend/consumer.py
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ç³»ç»Ÿå·²ç»å¯åŠ¨æˆåŠŸï¼æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. **æŸ¥çœ‹å®Œæ•´æ–‡æ¡£**
   - [é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ-å®Œæ•´å®æ–½æ–¹æ¡ˆ.md](./é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ-å®Œæ•´å®æ–½æ–¹æ¡ˆ.md)

2. **æµè§ˆAPIæ–‡æ¡£**
   - http://localhost:8000/docs

3. **ä½“éªŒç›‘æ§å¤§å±**
   - http://localhost:5173/monitor

4. **å­¦ä¹ æ ¸å¿ƒç»„ä»¶**
   - åŠ¨æ€çº¿ç¨‹æ± ï¼š`backend/app/services/thread_pool_service.py`
   - æ¶ˆæ¯è¿½è¸ªï¼š`backend/app/services/message_trace_service.py`
   - é™æµæœåŠ¡ï¼š`backend/app/services/sentinel_service.py`

5. **è‡ªå®šä¹‰é…ç½®**
   - ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°
   - è°ƒæ•´é™æµè§„åˆ™
   - æ·»åŠ æ–°æ¶ˆæ¯æ¨¡æ¿

---

## ğŸ“ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. **æŸ¥çœ‹æ—¥å¿—**
```bash
# åç«¯æ—¥å¿—
tail -f backend/logs/app.log

# å‰ç«¯æ§åˆ¶å°
F12 æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
```

2. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
```bash
# PostgreSQL
psql -U postgres -c "SELECT version()"

# Redis
redis-cli ping

# RabbitMQ
rabbitmqctl status
```

3. **é‡å¯æ‰€æœ‰æœåŠ¡**
```bash
# åœæ­¢æ‰€æœ‰ï¼ˆCtrl+Cï¼‰

# é‡æ–°å¯åŠ¨
# Terminal 1: Redis
redis-server

# Terminal 2: RabbitMQ
rabbitmq-server

# Terminal 3: åç«¯
cd backend && uvicorn app.main:app --reload

# Terminal 4: å‰ç«¯
cd frontend && npm run dev
```

---

**æ­å–œï¼** ğŸ‰ ä½ å·²ç»æˆåŠŸéƒ¨ç½²äº†é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†ç³»ç»Ÿï¼

**éƒ¨ç½²æ—¶é—´**ï¼šçº¦5-10åˆ†é’Ÿ  
**ç³»ç»Ÿç‰ˆæœ¬**ï¼šv1.0.0  
**æ›´æ–°æ—¶é—´**ï¼š2024-01-01
