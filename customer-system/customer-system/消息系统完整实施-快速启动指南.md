# ğŸ“¦ æ¶ˆæ¯ç³»ç»Ÿå®Œæ•´å®æ–½ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## âœ… å®æ–½å®Œæˆæ€»ç»“

**å®æ–½æ—¶é—´ï¼š** 2024-02-03  
**å®æ–½å†…å®¹ï¼š** æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„ + å®šæ—¶æ¨é€åŠŸèƒ½

---

## ğŸ“‹ å·²å®æ–½å†…å®¹

### 1ï¸âƒ£ æ•°æ®åº“æ¶æ„ âœ…

**æ–°å¢è¡¨ï¼š**
- âœ… `customer_channel_identifiers` - å®¢æˆ·å¤šæ¸ é“æ ‡è¯†ç¬¦è¡¨
- âœ… `channel_configs` - æ¸ é“é…ç½®è¡¨

**æ‰©å±•è¡¨ï¼š**
- âœ… `message_templates` - æ–°å¢7ä¸ªå­—æ®µï¼ˆpush_modeã€keywordsã€schedule_timeç­‰ï¼‰
- âœ… `messages` - æ–°å¢17ä¸ªå­—æ®µï¼ˆmessage_noã€channel_typeã€statusç­‰ï¼‰

**æ•°æ®ä¿ç•™ï¼š**
- âœ… æ‰€æœ‰ç°æœ‰æ•°æ®å®Œæ•´ä¿ç•™
- âœ… é“¾è·¯è¿½è¸ªåŠŸèƒ½å®Œæ•´å¯ç”¨

---

### 2ï¸âƒ£ åç«¯æœåŠ¡ âœ…

**æ ¸å¿ƒæœåŠ¡ï¼š**
- âœ… `UnifiedMessageSender` - ç»Ÿä¸€æ¶ˆæ¯å‘é€æœåŠ¡
- âœ… `TemplateRenderer` - æ¨¡æ¿æ¸²æŸ“å¼•æ“
- âœ… `MessageScheduler` - å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨

**æ¸ é“å‘é€å™¨ï¼š**
- âœ… `GroupBotSender` - ç¾¤æœºå™¨äººå‘é€å™¨ï¼ˆå·²å®ç°ï¼‰
- âœ… `AIBotSender` - @æ™ºèƒ½åŠ©æ‰‹å‘é€å™¨ï¼ˆå ä½ç¬¦ï¼‰
- âœ… `WorkWechatSender` - ä¼ä¸šå¾®ä¿¡å®¢æœå‘é€å™¨ï¼ˆå ä½ç¬¦ï¼‰
- âœ… `WechatSender` - å¾®ä¿¡å…¬ä¼—å·å‘é€å™¨ï¼ˆå ä½ç¬¦ï¼‰
- âœ… `SMSSender` - çŸ­ä¿¡å‘é€å™¨ï¼ˆå ä½ç¬¦ï¼‰
- âœ… `EmailSender` - é‚®ä»¶å‘é€å™¨ï¼ˆå ä½ç¬¦ï¼‰

---

### 3ï¸âƒ£ APIæ¥å£ âœ…

**æ¨¡æ¿ç®¡ç†ï¼š**
- âœ… `POST /api/template/create` - åˆ›å»ºæ¨¡æ¿
- âœ… `GET /api/template/list` - æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨
- âœ… `GET /api/template/{id}` - æŸ¥è¯¢æ¨¡æ¿è¯¦æƒ…
- âœ… `PUT /api/template/{id}` - æ›´æ–°æ¨¡æ¿
- âœ… `DELETE /api/template/{id}` - åˆ é™¤æ¨¡æ¿
- âœ… `POST /api/template/test-send` - æµ‹è¯•å‘é€
- âœ… `GET /api/template/preview/{id}` - é¢„è§ˆæ¨¡æ¿

---

### 4ï¸âƒ£ å®šæ—¶ä»»åŠ¡ âœ…

**åŠŸèƒ½ï¼š**
- âœ… æ”¯æŒæ¯æ—¥/æ¯å‘¨/æ¯æœˆå®šæ—¶æ¨é€
- âœ… å¤±è´¥æ¶ˆæ¯è‡ªåŠ¨é‡è¯•ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- âœ… è¿‡æœŸæ¶ˆæ¯è‡ªåŠ¨æ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹ï¼‰
- âœ… ä»»åŠ¡åŠ¨æ€åŠ è½½å’Œé‡è½½

---

### 5ï¸âƒ£ æ–‡æ¡£ âœ…

- âœ… `æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è®¾è®¡.md` - å®Œæ•´æ¶æ„æ–‡æ¡£
- âœ… `æ¶ˆæ¯æ¨¡æ¿é…ç½®-å¯è§†åŒ–é¢„è§ˆæŒ‡å—.md` - é…ç½®é¢„è§ˆæŒ‡å—
- âœ… `æ¶ˆæ¯ç³»ç»Ÿå®Œæ•´å®æ–½-å¿«é€Ÿå¯åŠ¨æŒ‡å—.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨æ­¥éª¤

### æ­¥éª¤1ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

```powershell
# æ¿€æ´»Pythonç¯å¢ƒ
& G:/aiqywx/customer-system/customer-system/backend/venv/Scripts/Activate.ps1

# è¿›å…¥backendç›®å½•
cd G:\aiqywx\customer-system\customer-system\backend

# è¿è¡Œè¿ç§»è„šæœ¬
python message_system_migration.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
æ­£åœ¨è¿æ¥æ•°æ®åº“...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

===========================================================
å¼€å§‹æ‰§è¡Œæ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è¿ç§»
============================================================

[1/4] åˆ›å»º customer_channel_identifiers è¡¨...
âœ… customer_channel_identifiers è¡¨åˆ›å»ºæˆåŠŸ

[2/4] åˆ›å»º channel_configs è¡¨...
âœ… channel_configs è¡¨åˆ›å»ºæˆåŠŸ

[3/4] æ‰©å±• message_templates è¡¨...
âœ… message_templates è¡¨æ‰©å±•æˆåŠŸ

[4/4] æ‰©å±• messages è¡¨...
âœ… messages è¡¨æ‰©å±•æˆåŠŸ

[5/5] æ’å…¥é»˜è®¤æ¸ é“é…ç½®...
âœ… é»˜è®¤æ¸ é“é…ç½®æ’å…¥æˆåŠŸ

============================================================
âœ… æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è¿ç§»å®Œæˆï¼
============================================================
```

---

### æ­¥éª¤2ï¼šé…ç½®æ¸ é“ä¿¡æ¯

#### 2.1 é…ç½®ç¾¤æœºå™¨äºº

è®¿é—®ï¼š`http://localhost:3000/config-center` â†’ **ç¾¤æœºå™¨äººé…ç½®**

```sql
-- ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ›´æ–°é…ç½®
UPDATE channel_configs
SET config_data = '{
    "bots": [
        {
            "bot_id": "bot_001",
            "bot_name": "å”®åæœåŠ¡ç¾¤",
            "group_id": "wrXXXXXXXXXXXX",
            "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx"
        }
    ]
}'::jsonb,
is_enabled = TRUE
WHERE channel_type = 'GROUP_BOT';
```

#### 2.2 é…ç½®ä¼ä¸šå¾®ä¿¡

```sql
UPDATE channel_configs
SET config_data = '{
    "corp_id": "wwXXXXXXXXXXXX",
    "contact_secret": "your_secret"
}'::jsonb,
is_enabled = TRUE
WHERE channel_type = 'WORK_WECHAT';
```

#### 2.3 é…ç½®@æ™ºèƒ½åŠ©æ‰‹

```sql
UPDATE channel_configs
SET config_data = '{
    "corp_id": "wwXXXXXXXXXXXX",
    "agent_id": "1000002",
    "agent_secret": "your_agent_secret",
    "token": "your_token",
    "encoding_aes_key": "your_aes_key",
    "target_groups": ["wrXXXXXXXXXXXX"]
}'::jsonb,
is_enabled = TRUE
WHERE channel_type = 'AI';
```

---

### æ­¥éª¤3ï¼šåˆ›å»ºæµ‹è¯•æ¨¡æ¿

```sql
INSERT INTO message_templates (
    name,
    module_type,
    category,
    content,
    content_type,
    push_mode,
    schedule_time,
    repeat_type,
    target_config,
    is_enabled,
    created_at,
    updated_at
) VALUES (
    'æ¯æ—¥å·¥ä½œæé†’',
    'GROUP_BOT',
    'ç³»ç»Ÿé€šçŸ¥',
    'ğŸ“… ä»Šæ—¥å·¥ä½œæé†’ï¼ˆ{current_date}ï¼‰

å¾…å¤„ç†å·¥å•ï¼š{pending_count} â†‘
è¿›è¡Œä¸­å·¥å•ï¼š{processing_count} â†‘
å·²å®Œæˆå·¥å•ï¼š{completed_count} â†‘

è¯·å„ä½åŒäº‹åŠæ—¶è·Ÿè¿›ï¼Œä¿è¯æœåŠ¡è´¨é‡ï¼',
    'markdown',
    'scheduled',
    '09:00',
    'daily',
    '{"bot_id": "bot_001"}'::jsonb,
    TRUE,
    NOW(),
    NOW()
);
```

---

### æ­¥éª¤4ï¼šå¯åŠ¨åç«¯æœåŠ¡

```python
# åœ¨ main.py æˆ– app.py ä¸­æ·»åŠ 
from app.services.message_scheduler import get_scheduler
from app.api.template_management import router as template_router

# æ³¨å†Œè·¯ç”±
app.include_router(template_router)

# å¯åŠ¨æ—¶åˆå§‹åŒ–è°ƒåº¦å™¨
@app.on_event("startup")
async def startup_event():
    scheduler = await get_scheduler(db_pool)
    scheduler.start()
    logger.info("âœ… æ¶ˆæ¯è°ƒåº¦å™¨å·²å¯åŠ¨")

@app.on_event("shutdown")
async def shutdown_event():
    scheduler = await get_scheduler(db_pool)
    scheduler.shutdown()
    logger.info("â¹ï¸ æ¶ˆæ¯è°ƒåº¦å™¨å·²å…³é—­")
```

---

### æ­¥éª¤5ï¼šæµ‹è¯•å‘é€

#### 5.1 ä½¿ç”¨APIæµ‹è¯•

```bash
# æµ‹è¯•å‘é€æ¨¡æ¿
curl -X POST "http://localhost:8000/api/template/test-send" \
-H "Content-Type: application/json" \
-d '{
    "template_id": 1,
    "variables": {
        "current_date": "2024-02-03",
        "pending_count": 5,
        "processing_count": 12,
        "completed_count": 38
    },
    "test_recipients": ["wrXXXXXXXXXXXX"]
}'
```

#### 5.2 ä½¿ç”¨å‰ç«¯æµ‹è¯•

è®¿é—®ï¼š`http://localhost:3000/config-center` â†’ **æ¨¡æ¿ç®¡ç†** â†’ é€‰æ‹©æ¨¡æ¿ â†’ **æµ‹è¯•å‘é€**

---

## ğŸ“Š æ–‡ä»¶æ¸…å•

```
backend/
â”œâ”€â”€ message_system_migration.py          # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ template_management.py      # æ¨¡æ¿ç®¡ç†API
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ unified_message_sender.py   # ç»Ÿä¸€æ¶ˆæ¯å‘é€æœåŠ¡
â”‚       â”œâ”€â”€ message_scheduler.py        # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â”‚       â””â”€â”€ senders/
â”‚           â”œâ”€â”€ group_bot_sender.py     # ç¾¤æœºå™¨äººå‘é€å™¨
â”‚           â”œâ”€â”€ ai_bot_sender.py        # @æ™ºèƒ½åŠ©æ‰‹å‘é€å™¨
â”‚           â”œâ”€â”€ work_wechat_sender.py   # ä¼ä¸šå¾®ä¿¡å‘é€å™¨
â”‚           â”œâ”€â”€ wechat_sender.py        # å¾®ä¿¡å…¬ä¼—å·å‘é€å™¨
â”‚           â”œâ”€â”€ sms_sender.py           # çŸ­ä¿¡å‘é€å™¨
â”‚           â””â”€â”€ email_sender.py         # é‚®ä»¶å‘é€å™¨

customer-system/
â”œâ”€â”€ æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è®¾è®¡.md
â”œâ”€â”€ æ¶ˆæ¯æ¨¡æ¿é…ç½®-å¯è§†åŒ–é¢„è§ˆæŒ‡å—.md
â””â”€â”€ æ¶ˆæ¯ç³»ç»Ÿå®Œæ•´å®æ–½-å¿«é€Ÿå¯åŠ¨æŒ‡å—.md
```

---

## ğŸ”§ APIä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºæ¨¡æ¿

```bash
curl -X POST "http://localhost:8000/api/template/create" \
-H "Content-Type: application/json" \
-d '{
    "name": "é¡¹ç›®è¿›åº¦é€šçŸ¥",
    "module_type": "WORK_WECHAT",
    "category": "æœåŠ¡é€šçŸ¥",
    "content": "å°Šæ•¬çš„{customer_name}ï¼Œæ‚¨çš„é¡¹ç›®ã€{project_name}ã€‘å½“å‰è¿›åº¦ï¼š{progress}%",
    "push_mode": "realtime",
    "keywords": ["è¿›åº¦", "æŸ¥è¯¢"],
    "target_config": {"target_type": "external_contact"}
}'
```

### æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨

```bash
curl "http://localhost:8000/api/template/list?module_type=GROUP_BOT&page=1&page_size=20"
```

### é¢„è§ˆæ¨¡æ¿

```bash
curl "http://localhost:8000/api/template/preview/1"
```

### æµ‹è¯•å‘é€

```bash
curl -X POST "http://localhost:8000/api/template/test-send" \
-H "Content-Type: application/json" \
-d '{
    "template_id": 1,
    "variables": {"customer_name": "å¼ ä¸‰", "project_name": "XXé¡¹ç›®", "progress": "80"},
    "test_recipients": ["wmXXXXXXXXXXXX"]
}'
```

---

## âš¡ å®šæ—¶ä»»åŠ¡ç¤ºä¾‹

### æ¯æ—¥9ç‚¹å‘é€å·¥ä½œæé†’

```sql
INSERT INTO message_templates (...) VALUES (
    'æ¯æ—¥å·¥ä½œæé†’',
    'GROUP_BOT',
    'ç³»ç»Ÿé€šçŸ¥',
    'ğŸ“… ä»Šæ—¥å·¥ä½œæé†’...',
    'markdown',
    'scheduled',      -- å®šæ—¶æ¨é€
    '09:00',          -- æ¯å¤©9ç‚¹
    'daily',          -- æ¯æ—¥é‡å¤
    '{"bot_id": "bot_001"}'::jsonb,
    TRUE
);
```

### æ¯å‘¨ä¸€9ç‚¹å‘é€å‘¨æŠ¥

```sql
-- repeat_type = 'weekly'
```

### æ¯æœˆ1å·å‘é€æœˆæŠ¥

```sql
-- repeat_type = 'monthly'
```

---

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹è°ƒåº¦ä»»åŠ¡

```python
from app.services.message_scheduler import get_scheduler

scheduler = await get_scheduler(db_pool)
jobs = scheduler.get_jobs()
print(jobs)
```

### æŸ¥çœ‹å‘é€è®°å½•

```sql
-- æŸ¥çœ‹ä»Šæ—¥å‘é€è®°å½•
SELECT * FROM messages
WHERE DATE(created_at) = CURRENT_DATE
ORDER BY created_at DESC;

-- æŸ¥çœ‹å¤±è´¥è®°å½•
SELECT * FROM messages
WHERE status = 'failed'
ORDER BY created_at DESC
LIMIT 50;

-- ç»Ÿè®¡å‘é€æƒ…å†µ
SELECT 
    channel_type,
    status,
    COUNT(*) as count
FROM messages
WHERE DATE(created_at) = CURRENT_DATE
GROUP BY channel_type, status;
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¿…éœ€å®Œæˆï¼ˆå®é™…ä½¿ç”¨å‰ï¼‰
1. **å®Œå–„å…¶ä»–æ¸ é“å‘é€å™¨**ï¼šå®ç° AIBotSenderã€WorkWechatSenderã€WechatSenderã€SMSSenderã€EmailSender
2. **å‰ç«¯é›†æˆ**ï¼šåœ¨é…ç½®ä¸­å¿ƒæ·»åŠ æ¸ é“é…ç½®é¡µé¢
3. **æƒé™æ§åˆ¶**ï¼šæ·»åŠ æ¨¡æ¿ç®¡ç†çš„æƒé™éªŒè¯

### å¯é€‰å¢å¼º
1. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šé›†æˆRabbitMQæˆ–Redis Streamå¤„ç†å¤§æ‰¹é‡å‘é€
2. **å‘é€é™æµ**ï¼šé˜²æ­¢çŸ­æ—¶é—´å†…å‘é€è¿‡å¤šæ¶ˆæ¯
3. **æ¶ˆæ¯ç»Ÿè®¡**ï¼šæ·»åŠ å‘é€æˆåŠŸç‡ã€å¤±è´¥ç‡ç­‰ç»Ÿè®¡
4. **WebHookå›è°ƒ**ï¼šæ”¯æŒæ¶ˆæ¯å‘é€çŠ¶æ€å›è°ƒ

---

## âœ… éªŒè¯æ¸…å•

```
[ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
[ ] 6ä¸ªæ¸ é“é…ç½®å·²æ’å…¥
[ ] messagesè¡¨ç°æœ‰æ•°æ®å®Œæ•´
[ ] message_templatesè¡¨ç°æœ‰æ•°æ®å®Œæ•´
[ ] åˆ›å»ºæµ‹è¯•æ¨¡æ¿æˆåŠŸ
[ ] æµ‹è¯•å‘é€æˆåŠŸ
[ ] å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
[ ] APIæ¥å£æ­£å¸¸å“åº”
[ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸
[ ] å¤±è´¥é‡è¯•æœºåˆ¶æ­£å¸¸
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥
**A:** æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®ï¼Œç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ

### Q2: å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ
**A:** æ£€æŸ¥æ¨¡æ¿çš„ `is_enabled` æ˜¯å¦ä¸º `TRUE`ï¼Œ`schedule_time` æ˜¯å¦å·²è®¾ç½®

### Q3: ç¾¤æœºå™¨äººå‘é€å¤±è´¥
**A:** æ£€æŸ¥ `webhook_url` æ˜¯å¦æ­£ç¡®ï¼Œç¾¤æœºå™¨äººæ˜¯å¦è¢«ç¦ç”¨

### Q4: æ¶ˆæ¯å‘é€åçŠ¶æ€ä¸€ç›´æ˜¯pending
**A:** æ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼ŒæŸ¥çœ‹é”™è¯¯æ—¥å¿—

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹ï¼š
- [æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è®¾è®¡.md](æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è®¾è®¡.md)
- [æ¶ˆæ¯æ¨¡æ¿é…ç½®-å¯è§†åŒ–é¢„è§ˆæŒ‡å—.md](æ¶ˆæ¯æ¨¡æ¿é…ç½®-å¯è§†åŒ–é¢„è§ˆæŒ‡å—.md)
- åç«¯æ—¥å¿—ï¼š`backend/logs/`

---

**ğŸ‰ æ­å–œï¼æ¶ˆæ¯ç³»ç»Ÿå·²å®Œæ•´å®æ–½ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼**
