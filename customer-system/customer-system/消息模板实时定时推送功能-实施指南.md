# 📢 消息模板「实时/定时推送」功能 - 完整实施指南

## 🎯 一、核心设计原则

### 场景必要性原则
```
✅ 有场景才添加功能
❌ 避免功能冗余
🎯 围绕实际使用设计
```

### 分模块配置策略

| 模块 | 实时推送 | 定时推送 | 原因 |
|------|---------|---------|------|
| 📢 群机器人 | ✅ | ✅ | 核心模块，双模式都需要 |
| 🤖 AI回复模板 | ✅ | ✅ | 支持实时响应和定期推送 |
| 🏢 企业微信 | ✅ | ✅ | 测试阶段需要双模式 |
| 💬 微信公众号 | ✅ | ✅ | 测试阶段需要双模式 |
| 📱 短信模板 | ❌ | ❌ | 触发即发送，无需此功能 |
| 📧 邮件模板 | ❌ | ❌ | 触发即发送，无需此功能 |

---

## 📋 二、功能详细说明

### 1️⃣ 群机器人模块（核心模块）

#### 使用场景
- **实时推送**：关键词触发自动回复（如客服问答）
- **定时推送**：定期通知、日报、活动提醒

#### 核心字段配置

```javascript
{
  // 基础信息
  name: '每日工作通知',           // 模板名称
  category: '客户通知',            // 分类
  type: 'text',                    // 模板类型：text/markdown/html
  
  // 推送配置
  push_mode: 'scheduled',          // 推送模式：realtime/scheduled
  keywords: '价格,报价,咨询',      // 触发关键词（实时推送必填）
  targets: ['internal_work'],      // 目标群聊（多选）
  
  // 定时配置
  schedule_time: '2026-02-04 09:00:00',  // 发送时间
  repeat_type: 'daily',            // 重复周期：once/daily/weekly/monthly
  repeat_days: ['1','2','3'],      // 重复日期（每周时）
  
  // AI配置
  ai_model: 'wework-official',     // AI模型代码
  
  // 内容
  content: '早上好，今日工作提醒...',
  status: true                      // 启用状态
}
```

#### 界面规则

**推送类型切换**
```
┌─────────────────────────────────┐
│ 推送模式: ⚪ 实时推送 ⚫ 定时推送 │
└─────────────────────────────────┘
```

**实时推送时显示**
```
┌─────────────────────────────────┐
│ 触发关键词: [价格,报价,咨询____] │
│ 💡 多个关键词用逗号分隔          │
└─────────────────────────────────┘
```

**定时推送时显示**
```
┌─────────────────────────────────┐
│ 发送时间: [2026-02-04 09:00]     │
│ 重复周期: [每天 ▼]              │
│ 💡 选择重复周期后将定期发送      │
└─────────────────────────────────┘
```

#### 校验规则

- ✅ 实时推送：触发关键词必填
- ✅ 定时推送：发送时间必填且必须大于当前时间
- ✅ 目标群聊：至少选择一个
- ✅ 模板内容：必填

---

### 2️⃣ AI回复模板

#### 使用场景
- **实时推送**：客户咨询自动回复
- **定时推送**：定期FAQ推送、知识库更新

#### 特殊说明

```
与群机器人配置相同，但更注重实时响应
推送类型默认选中「实时推送」
```

#### 关键词匹配逻辑

```javascript
// 示例：触发关键词 "价格,报价,咨询"
客户消息: "请问这个产品的价格是多少？"
         ↓
包含关键词: "价格" ✅
         ↓
触发自动回复: "您好，关于产品价格..."
```

---

### 3️⃣ 企业微信模块

#### 使用场景
- **实时推送**：测试环境实时通知
- **定时推送**：批量定时给成员/客户/标签发通知

#### 发送对象配置

```javascript
targets: [
  'all_members',      // 全体成员
  'dept_sales',       // 销售部门
  'dept_tech',        // 技术部门
  'dept_service',     // 客服部门
  'customer_tags'     // 客户标签
]
```

#### 界面特点

```
┌─────────────────────────────────┐
│ 发送对象: [☑ 全体成员]          │
│           [☑ 销售部门]          │
│           [☐ 技术部门]          │
│ 💡 支持按部门、标签筛选成员      │
└─────────────────────────────────┘
```

---

### 4️⃣ 微信公众号模块

#### 使用场景
- **实时推送**：测试环境实时推文
- **定时推送**：定时群发推文、活动提醒

#### 特殊限制

⚠️ **公众号群发限制**
- 每天限制群发1次
- 定时时间不得超过7天
- 粉丝数量有上限要求

#### 发送对象配置

```javascript
targets: [
  'all_fans',         // 全部粉丝
  'purchased',        // 已购买客户
  'vip',              // VIP会员
  'active'            // 活跃粉丝
]
```

#### 模板类型扩展

```
普通模板:
- text (纯文本)
- markdown
- html

公众号特有:
- article (图文消息)
  需要上传: 封面图、摘要、正文
```

---

### 5️⃣ 短信/邮件模板（无需配置）

#### 为什么不需要？

```
短信/邮件 = 触发即发送

❌ 不需要「实时推送」
   → 业务逻辑已实现触发发送

❌ 不需要「定时推送」
   → 使用业务层的定时任务管理

✅ 保留现有功能
   → 立即发送按钮
   → 发送记录查询
```

---

## 🎨 三、界面设计规范

### 1. 组件复用

**公共组件清单**
```
📦 components/
  ├── PushModeSwitch.vue      # 推送模式开关
  ├── ScheduleTimePicker.vue  # 定时时间选择器
  ├── RepeatCycleSelect.vue   # 重复周期选择
  └── VariableInserter.vue    # 变量快速插入
```

### 2. 状态联动规则

```javascript
// 选择实时推送
push_mode = 'realtime'
  ↓
显示: 触发关键词输入框
隐藏: 定时配置区域

// 选择定时推送
push_mode = 'scheduled'
  ↓
显示: 发送时间、重复周期
隐藏: 触发关键词输入框
```

### 3. 视觉一致性

**颜色规范**
```css
实时推送: #67C23A (绿色) + ⚡ emoji
定时推送: #E6A23C (橙色) + ⏰ emoji
```

**标签展示**
```html
<el-tag type="success">⚡ 实时</el-tag>
<el-tag type="warning">⏰ 定时</el-tag>
```

---

## 🔧 四、技术实现要点

### 1. 表单验证逻辑

```javascript
// 动态校验规则
const templateRules = {
  keywords: [
    { 
      validator: (rule, value, callback) => {
        // 实时推送且需要推送模式时，关键词必填
        if (templateForm.value.push_mode === 'realtime' 
            && needsPushMode.value 
            && !value) {
          callback(new Error('实时推送必须填写触发关键词'))
        } else {
          callback()
        }
      }, 
      trigger: 'blur' 
    }
  ],
  
  schedule_time: [
    { 
      validator: (rule, value, callback) => {
        // 定时推送时，时间必填且必须大于当前时间
        if (templateForm.value.push_mode === 'scheduled' && !value) {
          callback(new Error('定时推送必须选择发送时间'))
        } else if (value && new Date(value) <= new Date()) {
          callback(new Error('发送时间必须大于当前时间'))
        } else {
          callback()
        }
      }, 
      trigger: 'change' 
    }
  ]
}
```

### 2. 计算属性优化

```javascript
// 是否需要推送模式选择
const needsPushMode = computed(() => {
  return ['GROUP_BOT', 'AI', 'WORK_WECHAT', 'WECHAT'].includes(activeTab.value)
})

// 是否支持实时推送
const supportsRealtime = computed(() => {
  return ['GROUP_BOT', 'AI', 'WORK_WECHAT', 'WECHAT'].includes(activeTab.value)
})

// 是否支持定时推送
const supportsScheduled = computed(() => {
  return ['GROUP_BOT', 'AI', 'WORK_WECHAT', 'WECHAT'].includes(activeTab.value)
})

// 是否需要目标选择
const needsTargetSelection = computed(() => {
  return ['GROUP_BOT', 'WORK_WECHAT', 'WECHAT'].includes(activeTab.value)
})
```

### 3. 日期时间限制

```javascript
// 禁用过去的日期
const disabledDate = (time) => {
  return time.getTime() < Date.now() - 8.64e7
}

// 微信公众号7天限制
const disabledDateForWechat = (time) => {
  const maxDate = new Date()
  maxDate.setDate(maxDate.getDate() + 7)
  return time.getTime() < Date.now() - 8.64e7 
      || time.getTime() > maxDate.getTime()
}
```

---

## ✨ 五、用户体验优化

### 1. 变量快速插入

**常用变量列表**
```javascript
const commonVariables = [
  { code: '{customer_name}', label: '客户姓名' },
  { code: '{phone}', label: '联系电话' },
  { code: '{order_no}', label: '订单号' },
  { code: '{product}', label: '产品名称' },
  { code: '{date}', label: '日期' },
  { code: '{time}', label: '时间' },
  { code: '{amount}', label: '金额' },
  { code: '{company}', label: '公司名称' }
]
```

**使用方式**
```html
<div style="display: flex; gap: 8px;">
  <el-tag 
    v-for="variable in commonVariables" 
    :key="variable.code"
    @click="insertVariable(variable.code)"
    style="cursor: pointer;"
  >
    {{ variable.label }}
  </el-tag>
</div>
```

### 2. 智能提示

**不同场景的提示文本**
```javascript
const getTargetTip = () => {
  if (activeTab.value === 'GROUP_BOT') {
    return '💡 可选择多个群聊同时发送'
  } else if (activeTab.value === 'WORK_WECHAT') {
    return '💡 支持按部门、标签筛选成员'
  } else if (activeTab.value === 'WECHAT') {
    return '⚠️ 公众号群发每天限制1次'
  }
  return ''
}

const getScheduleTimeTip = () => {
  if (activeTab.value === 'WECHAT') {
    return '⚠️ 微信公众号定时时间不得超过7天'
  }
  return '💡 发送时间必须大于当前时间'
}
```

### 3. 测试发送功能

```javascript
// 测试发送对话框
const testSend = (row) => {
  testForm.value.templateName = row.name
  testForm.value.testTarget = ''
  testForm.value.testPhone = ''
  testDialogVisible.value = true
}

// 确认测试发送
const confirmTestSend = async () => {
  // 校验
  if (activeTab.value === 'GROUP_BOT' && !testForm.value.testTarget) {
    ElMessage.warning('请选择测试群聊')
    return
  }
  
  testSending.value = true
  try {
    // 调用测试发送API
    await axios.post('/api/template/test-send', {
      template_id: testForm.value.templateId,
      target: testForm.value.testTarget || testForm.value.testPhone
    })
    ElMessage.success('✅ 测试消息已发送成功')
    testDialogVisible.value = false
  } catch (error) {
    ElMessage.error('❌ 测试发送失败')
  } finally {
    testSending.value = false
  }
}
```

### 4. 操作反馈

**统一的反馈消息**
```javascript
// 成功提示
ElMessage.success('✅ 模板配置已保存')
ElMessage.success('✅ 测试消息已发送')
ElMessage.success('✅ 已插入变量 {customer_name}')

// 错误提示
ElMessage.error('❌ 保存失败，请重试')
ElMessage.error('❌ API密钥错误')

// 警告提示
ElMessage.warning('⚠️ 请填写所有必填项')
ElMessage.warning('⚠️ 发送时间必须大于当前时间')
```

---

## 🚀 六、实施优先级

### 第一阶段：核心功能（1-2天）
```
✅ 群机器人双模式（实时+定时）
✅ 基础表单验证
✅ 推送模式切换逻辑
```

### 第二阶段：扩展功能（2-3天）
```
✅ AI回复模板双模式
✅ 企业微信双模式
✅ 微信公众号双模式
✅ 变量快速插入
```

### 第三阶段：优化功能（1-2天）
```
✅ 测试发送功能
✅ 智能提示优化
✅ 界面美化
✅ 操作反馈完善
```

### 第四阶段：后端集成（3-5天）
```
✅ 定时任务调度
✅ 消息发送队列
✅ 发送记录管理
✅ 失败重试机制
```

---

## 📝 七、后端API设计

### 1. 模板管理API

**创建/更新模板**
```http
POST /api/template/save
Content-Type: application/json

{
  "name": "每日工作通知",
  "category": "客户通知",
  "type": "text",
  "push_mode": "scheduled",
  "schedule_time": "2026-02-04 09:00:00",
  "repeat_type": "daily",
  "targets": ["internal_work"],
  "content": "早上好，今日工作提醒...",
  "status": true
}
```

**响应**
```json
{
  "code": 200,
  "message": "模板保存成功",
  "data": {
    "id": 123,
    "name": "每日工作通知",
    "next_send_time": "2026-02-04 09:00:00"
  }
}
```

### 2. 测试发送API

```http
POST /api/template/test-send
Content-Type: application/json

{
  "template_id": 123,
  "target": "internal_work",
  "test_data": {
    "customer_name": "张三",
    "order_no": "2024020400001"
  }
}
```

### 3. 定时任务查询

```http
GET /api/template/scheduled-tasks?status=pending

响应:
{
  "code": 200,
  "data": [
    {
      "task_id": "T20260204001",
      "template_name": "每日工作通知",
      "next_run_time": "2026-02-04 09:00:00",
      "status": "pending"
    }
  ]
}
```

---

## ✅ 八、验收标准

### 功能验收

- [ ] 群机器人支持实时/定时双模式
- [ ] AI回复模板支持实时/定时双模式
- [ ] 企业微信支持实时/定时双模式
- [ ] 微信公众号支持实时/定时双模式
- [ ] 短信/邮件保持现有逻辑不变
- [ ] 实时推送关键词必填校验
- [ ] 定时推送时间必填且大于当前时间
- [ ] 目标选择至少选一个
- [ ] 变量快速插入功能正常
- [ ] 测试发送功能正常
- [ ] 定时任务调度正常执行
- [ ] 重复周期配置生效

### 界面验收

- [ ] 推送模式切换流畅无卡顿
- [ ] 相关表单项显示/隐藏逻辑正确
- [ ] 日期时间选择器禁用规则正确
- [ ] 提示文本准确清晰
- [ ] 错误提示友好明确
- [ ] 成功反馈及时准确

### 性能验收

- [ ] 表单保存响应时间 < 500ms
- [ ] 测试发送响应时间 < 2s
- [ ] 页面切换无明显延迟
- [ ] 大量数据加载流畅

---

## 🎓 九、使用示例

### 示例1：群机器人实时回复

**场景**：客户在群里问价格，自动回复

**配置**：
```
模板名称: 价格咨询自动回复
推送模式: ⚡ 实时推送
触发关键词: 价格,报价,多少钱
目标群聊: 客户服务群
模板内容: 您好！关于产品价格咨询，我们会尽快为您报价。
         请联系销售顾问：13800138000
```

**效果**：
```
客户: "请问这个产品多少钱？"
机器人: "您好！关于产品价格咨询，我们会尽快为您报价。
        请联系销售顾问：13800138000"
```

---

### 示例2：群机器人定时通知

**场景**：每天早上9点推送工作日报

**配置**：
```
模板名称: 每日工作通知
推送模式: ⏰ 定时推送
发送时间: 09:00
重复周期: 每天
目标群聊: 内部工作群
模板内容: 早上好！今日工作提醒：
         1. 跟进昨日未完成工单
         2. 回复客户咨询消息
         3. 更新项目进度
```

**效果**：
```
每天 09:00 自动发送到「内部工作群」
```

---

### 示例3：企业微信定时推送

**场景**：每周一给销售部门发周报提醒

**配置**：
```
模板名称: 周报提醒
推送模式: ⏰ 定时推送
发送时间: 每周一 10:00
重复周期: 每周
选择星期: 周一
发送对象: 销售部门
模板内容: 各位销售同事，请在今天下班前提交上周销售周报。
```

---

## 📞 十、常见问题

### Q1: 为什么短信/邮件不需要实时/定时推送？

**A**: 短信/邮件通常是业务触发式发送，比如：
- 订单确认 → 自动发短信
- 支付成功 → 自动发邮件

这种场景已经在业务逻辑中实现，无需在模板层添加实时/定时功能。

---

### Q2: 实时推送和定时推送可以同时配置吗？

**A**: 不可以。每个模板只能选择一种推送模式：
- ⚡ 实时推送：关键词触发
- ⏰ 定时推送：按计划发送

---

### Q3: 定时任务没有执行怎么办？

**A**: 检查以下几点：
1. 模板是否启用（status = true）
2. 发送时间是否正确
3. 后端定时任务服务是否运行
4. 查看定时任务日志

---

### Q4: 如何测试定时推送？

**A**: 使用「测试发送」功能：
1. 点击模板列表的「测试发送」按钮
2. 选择测试目标
3. 立即发送测试消息
4. 查看实际效果

---

## 🎉 总结

本方案完整实现了消息模板的「实时/定时推送」功能，核心特点：

✅ **场景驱动**：只在需要的模块添加功能
✅ **双模式支持**：实时响应 + 定时推送
✅ **智能校验**：动态表单验证，防止配置错误
✅ **用户友好**：变量插入、智能提示、测试发送
✅ **扩展性强**：组件化设计，易于维护扩展

按此方案实施后，可显著提升消息推送的灵活性和自动化程度！🚀
