# 🔄 客户关系无感转接 - 快速参考卡

## 📌 一句话概括

**客户只需添加销售一个人，系统自动在销售-工程师之间无感切换，保持客户体验流畅。**

---

## 🎯 核心价值

| 维度 | 价值 |
|------|------|
| **客户体验** | 只添加一个联系人，始终在同一聊天窗口对话 |
| **内部协同** | 销售负责关系，工程师负责技术，自动流转 |
| **企业资产** | 客户资源沉淀在平台，不因员工离职流失 |

---

## 🔄 完整流程（3步）

### 步骤1：分配工单时自动转接

```
内部群：售后员工回复"需要工程师@李工 协助"
      ↓
系统自动：调用企业微信API，客户关系：程红 → 李工
      ↓
客户视角：无感知，仍在"程红"的聊天窗口对话
```

### 步骤2：工程师解决问题

```
工程师：联系客户并解决问题（客户以为还是程红）
```

### 步骤3：解决后自动转回

```
内部群：李工回复"#123 已解决"
      ↓
系统自动：调用企业微信API，客户关系：李工 → 程红
      ↓
客户视角：无感知，又自动变回程红
```

---

## 🔧 核心API

### 1. 转接给工程师

```bash
POST /customer-transfer/to-engineer
{
    "project_id": 123,
    "engineer_userid": "ligong",
    "engineer_name": "李工"
}
```

### 2. 转回原销售

```bash
POST /customer-transfer/back-to-sales
{
    "project_id": 123
}
```

### 3. 查询当前负责人

```bash
GET /customer-transfer/current-owner/wmXXXXXXXXXX
```

### 4. 批量转接

```bash
POST /customer-transfer/batch-transfer
{
    "project_ids": [1, 2, 3],
    "engineer_userid": "ligong",
    "engineer_name": "李工"
}
```

---

## 📊 数据库字段

### Customer表（新增）

```python
sales_representative = Column(String(100))       # 销售代表UserID
sales_representative_name = Column(String(100))  # 销售代表姓名
```

### Project表（新增）

```python
original_sales_userid = Column(String(100))  # 原销售UserID（用于转回）
transfer_timestamp = Column(TIMESTAMP)       # 转接时间
transfer_reason = Column(String(500))        # 转接原因
```

---

## 🎬 使用示例

### 场景：分配工单（自动触发转接）

```python
# 内部群消息："@机器人 /分配工单 #123 @李工(ligong)"

# 系统自动执行：
1. ✅ 查询项目和客户信息
2. ✅ 记录原销售UserID（程红）
3. ✅ 调用企业微信API转接（程红 → 李工）
4. ✅ 更新工单负责人
5. ✅ 返回确认消息："✅ 客户已转接给@李工（对客户无感知）"
```

### 场景：解决工单（自动触发转回）

```python
# 内部群消息："#123 已解决"

# 系统自动执行：
1. ✅ 更新工单状态为"已解决"
2. ✅ 调用企业微信API转回（李工 → 程红）
3. ✅ 恢复原销售为负责人
4. ✅ 返回确认消息："✅ 客户已转回原销售"
```

---

## 🔒 企业微信配置

### 1. 权限要求

```
☑️ 客户联系权限
☑️ 管理客户权限
☑️ handover_userid 和 takeover_userid 都在通讯录中
```

### 2. API端点

```
https://qyapi.weixin.qq.com/cgi-bin/externalcontact/transfer_customer
```

### 3. 请求体示例

```json
{
    "handover_userid": "chenghong",
    "takeover_userid": "ligong",
    "external_userid": ["wmABCDEFGHIJKLMNOPQ"],
    "transfer_success_msg": "您好，我是负责技术支持的工程师。"
}
```

---

## ✅ 最佳实践

### 转接时机

✅ 售后工单分配时立即转接  
✅ 工单解决后立即转回  
✅ 批量分配时批量转接  

❌ 频繁来回转接（影响体验）  
❌ 不必要的转接（简单问题销售直接解决）  

### 转接消息

✅ "您好，我是负责技术支持的工程师，接下来由我为您服务。"  
✅ "问题已解决，后续我继续为您服务。"  

❌ "您已被转接给李工"（暴露转接操作）  
❌ "销售已离开"（负面体验）  

---

## 🧪 快速测试

### 1. 测试转接

```bash
curl -X POST http://localhost:8000/customer-transfer/to-engineer \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 1,
    "engineer_userid": "ligong",
    "engineer_name": "李工"
  }'
```

### 2. 测试转回

```bash
curl -X POST http://localhost:8000/customer-transfer/back-to-sales \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 1
  }'
```

### 3. 查询负责人

```bash
curl http://localhost:8000/customer-transfer/current-owner/wmXXXXXXXXXX
```

---

## 📊 系统架构

```
┌─────────────────────────────────────────────────┐
│           客户关系无感转接系统                    │
└─────────────────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌───────────────┐          ┌───────────────┐
│ 工单分配时触发  │          │ 工单解决时触发  │
│  自动转接      │          │  自动转回      │
└───────────────┘          └───────────────┘
        │                           │
        ▼                           ▼
┌───────────────────────────────────────────────┐
│     CustomerTransferService                   │
│  - transfer_customer_to_engineer()            │
│  - transfer_customer_back_to_sales()          │
│  - batch_transfer_customers()                 │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│     企业微信「分配客户」API                     │
│  /externalcontact/transfer_customer           │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│     客户关系静默切换（客户无感知）               │
│  销售 ⇄ 工程师                                │
└───────────────────────────────────────────────┘
```

---

## 🎉 核心优势

### 🌟 客户体验

- ✅ 只需添加一个联系人（销售）
- ✅ 始终在同一个聊天窗口对话
- ✅ 无感知的服务切换
- ✅ 专业的技术支持

### 🌟 企业管理

- ✅ 客户资源沉淀在平台
- ✅ 不因员工离职流失
- ✅ 权责清晰（销售-工程师）
- ✅ 全流程自动化

### 🌟 员工协同

- ✅ 各司其职，不互相干扰
- ✅ 无需频繁添加删除客户
- ✅ 系统自动转接，无需人工
- ✅ 完整的对话记录

---

## 📚 完整文档

📄 [客户关系无感转接功能-完整实现方案.md](./客户关系无感转接功能-完整实现方案.md)

---

**🔄 让客户服务流程更顺畅，让企业管理更高效！**
