# 消息模板配置指南 - 链接模块详解

## 🎯 模板配置位置

**访问地址：** `http://localhost:3000/config-center` 或通过侧边栏菜单找到 **"模板管理"** 

**文件位置：** 
- 前端：`frontend/src/views/TemplateManager.vue`
- 该模块支持6种消息类型的模板管理

---

## 📍 四种项目链接类型配置

### 1️⃣ 售前商机详情

**链接配置：**
```
类型：presale
URL：http://localhost:3000/project/{order_id}?type=presale
```

**页面内容：**
- 客户需求分析
- 预算金额
- 跟进记录
- 负责销售信息
- 预期成交日期

**使用场景：**
- 销售人员查看商机详情
- 商机状态变化通知
- 客户信息跟进

**微信APP适配：**
✅ 已优化，支持移动端访问
- 响应式设计
- 触摸友好的按钮
- 移动端信息展示

---

### 2️⃣ 售后工单详情

**链接配置：**
```
类型：aftersales
URL：http://localhost:3000/project/{order_id}?type=aftersales
```

**页面内容：**
- 故障/需求描述
- 处理进度显示
- 工程师信息
- 客户反馈表单
- 评价和补充说明
- 处理时间线

**使用场景：**
- 客户查看工单进度
- 工单状态变化通知
- 工单完成通知
- 满意度评价

**微信APP适配：**
✅ 已优化
- 工单进度清晰显示
- 工程师直联按钮
- 反馈表单易操作

---

### 3️⃣ 销售订单详情

**链接配置：**
```
类型：sales
URL：http://localhost:3000/project/{order_id}?type=sales
```

**页面内容：**
- 订单编号
- 下单时间
- 客户信息
- 订单金额和支付状态
- 收货地址
- 产品列表
- 物流跟踪

**使用场景：**
- 订单确认通知
- 支付提醒
- 发货通知
- 物流进度

**微信APP适配：**
✅ 已优化
- 支付状态清晰
- 产品列表可滚动
- 地址完整显示

---

### 4️⃣ 在线支付

**链接配置：**
```
类型：custom (付款页面选项)
URL：http://localhost:3000/pay/{order_id}
```

**页面内容：**
- 订单金额显示
- 支付方式选择（微信、支付宝、银行卡）
- 支付状态
- 订单详情
- 发票申请

**使用场景：**
- 订单待支付通知
- 支付链接分享
- 催付提醒

**微信APP适配：**
✅ 已优化
- 直接微信支付集成
- 支付结果同步
- 回调处理

---

## 🔧 配置步骤

### 第1步：访问模板管理模块

```
1. 打开浏览器访问：http://localhost:3000
2. 点击左侧菜单 → 配置中心 → 模板管理
   或直接访问：http://localhost:3000/config-center
```

### 第2步：选择消息类型

在顶部选择对应的模板类型：
- 📱 **短信模板** - 用于SMS通知
- 📧 **邮件模板** - 用于Email通知
- 💬 **微信公众号** - 用于微信公众号推送
- 🏢 **企业微信** - 用于企业微信
- 🤖 **AI回复模板** - 用于AI机器人
- 📢 **群机器人** - 用于企业微信群机器人

### 第3步：创建或编辑模板

```
1. 点击"+ 新建模板"按钮
2. 填写模板基本信息：
   - 模板名称：描述模板用途
   - 使用场景：选择场景类别
3. 选择推送方式：
   - 实时推送：立即发送
   - 定时推送：按Cron表达式定时
4. 配置链接信息：
   - 选择链接类型（presale/aftersales/sales）
   - 输入或点击快速插入URL模板
5. 编写模板内容：
   使用可用变量，如：{customer_name}, {order_id} 等
```

### 第4步：选择链接类型

```
在"跳转链接"配置中：

1. 点击下拉菜单"选择链接类型"
2. 选择对应类型：
   ✓ 自定义链接
   ✓ 售前商机详情 → presale
   ✓ 售后工单详情 → aftersales
   ✓ 销售订单详情 → sales
   ✓ 项目状态查询 → status-query
3. 会显示对应的URL模板
4. 点击提示标签快速插入
```

### 第5步：保存并启用

```
1. 点击"保存"按钮
2. 在模板列表中使用右侧的"启用/禁用"开关
3. 可进行"编辑"、"预览"、"删除"操作
```

---

## 📱 微信APP移动端适配

### 微信APP打开链接说明

当用户在微信APP中点击链接时：

```
原始URL：
http://localhost:3000/project/{order_id}?type=presale

微信APP中的行为：
1. ✅ 判断为本地开发环境
2. ❓ 需要配置公网域名或内网穿透
3. ✅ 完全响应式设计（已适配）
4. ✅ 支持微信内置浏览器
5. ✅ 支持返回按钮返回聊天
```

### 开发环境配置

**当前开发环境：** localhost:3000 无法从微信直接访问

**解决方案：**

#### 方案1：使用内网穿透（推荐开发）
```bash
# 使用ngrok进行内网穿透
ngrok http 3000

# 得到公网URL：https://xxxx-xxx-xxx.ngrok.io
# 在模板中使用该URL：
# https://xxxx-xxx-xxx.ngrok.io/project/{order_id}?type=presale
```

#### 方案2：配置公网域名（推荐生产）
```
1. 购买域名
2. 配置DNS指向服务器
3. 配置HTTPS证书
4. 在模板中使用该域名：
   https://yourdomain.com/project/{order_id}?type=presale
```

#### 方案3：企业微信通道（企业内部）
```
如果使用企业微信，可配置企业应用的可信域名
然后在企业微信中直接打开页面
```

---

## 🎨 可用变量列表

在模板内容中可以使用以下变量，系统会自动替换：

### 通用变量
```
{customer_name}        - 客户姓名
{customer_phone}       - 客户电话
{order_id}             - 订单/工单编号
{order_time}           - 订单时间
{status}               - 订单/工单状态
```

### 商机变量
```
{salesman_name}        - 销售人员名称
{expected_close_date}  - 预期成交日期
{amount}               - 预期金额
{follow_up_count}      - 跟进次数
{latest_follow_up}     - 最后跟进时间
```

### 工单变量
```
{engineer_name}        - 工程师名称
{engineer_phone}       - 工程师电话
{description}          - 故障描述
{priority}             - 优先级
{expected_complete}    - 预期完成时间
{processing_status}    - 处理进度
```

### 订单变量
```
{total_amount}         - 订单总额
{payment_status}       - 支付状态
{shipping_address}     - 收货地址
{product_count}        - 产品数量
{delivery_date}        - 预计送达日期
```

---

## 💡 模板编写示例

### 示例1：商机进展通知

```
模板名称：商机状态变化通知
类型：短信 / 微信公众号
链接类型：售前商机详情

模板内容：
尊敬的 {customer_name}，
您的商机已由销售顾问 {salesman_name} 更新。
当前状态：{status}
预期成交时间：{expected_close_date}

👉 点击查看详情：
[点击查看详情]

预期成交金额：¥{amount}
```

### 示例2：工单完成通知

```
模板名称：工单完成反馈
类型：短信 / 微信公众号
链接类型：售后工单详情

模板内容：
您好 {customer_name}，

您的工单 {order_id} 已完成！

工程师 {engineer_name} 为您解决了问题。
处理用时：请点击下方链接查看详情

👉 点击查看工单详情并反馈：
[点击查看工单]

如有任何问题，请回复本消息。
```

### 示例3：订单支付提醒

```
模板名称：订单支付提醒
类型：短信 / 微信公众号
链接类型：销售订单详情

模板内容：
尊敬的 {customer_name}，

您的订单 {order_id} 已确认，
订单金额：¥{total_amount}
当前状态：{payment_status}

⏰ 请在24小时内完成支付
👉 点击前往支付：
[立即支付]

感谢您的支持！
```

### 示例4：支付链接直达

```
模板名称：直接支付链接
类型：短信 / 微信公众号
链接类型：自定义（付款页面）

模板内容：
{customer_name}，您的订单 {order_id} 待支付

订单金额：¥{total_amount}

👉 长按复制链接或点击支付：
http://localhost:3000/pay/{order_id}

支付后订单即可发货，感谢！
```

---

## ⚙️ 推送方式配置

### 实时推送
```
说明：消息满足条件时立即发送
适用场景：
- 紧急工单通知
- 支付提醒
- 订单确认
```

### 定时推送
```
说明：按照Cron表达式在指定时间发送
配置示例：
- "0 9 * * * ?" → 每天上午9点
- "0 0 * * 0 ?" → 每周日午夜
- "0 0 1 * * ?" → 每月1日
- "0 */15 * * * ?" → 每15分钟

适用场景：
- 定时提醒
- 定期报告
- 批量通知
```

---

## 🔐 安全注意事项

1. **URL含有敏感ID**
   - ✅ 系统已集成JWT令牌验证
   - 每个链接可添加token参数：`?token=xxx`
   - 令牌有时间限制

2. **数据隐私**
   - 外链中的{order_id}是可见的
   - 建议配合令牌使用
   - 不要在URL中暴露敏感信息

3. **链接有效期**
   - 建议设置链接过期时间
   - 定期更新令牌
   - 监控异常访问

---

## 🚀 最佳实践

### 1. 链接设计
```
✅ 好的做法：
- 使用简短的URL
- 添加有意义的参数
- 包含token进行验证
- 考虑时效性

❌ 避免：
- 太长的URL
- 暴露内部信息
- 不受保护的链接
```

### 2. 模板内容
```
✅ 好的做法：
- 清晰的行动按钮
- 完整的订单信息
- 友好的文案
- 移动端友好

❌ 避免：
- 复杂的表述
- 缺少关键信息
- 过长的内容
- 只有文本链接
```

### 3. 场景选择
```
✅ 推荐搭配：
- 商机变化 → presale链接
- 工单更新 → aftersales链接
- 订单通知 → sales链接
- 支付催付 → pay链接
```

---

## 📊 现有配置状态

### 已配置的链接类型

| 类型 | URL模板 | 状态 | 微信适配 |
|------|--------|------|--------|
| presale | `/project/{order_id}?type=presale` | ✅ | ✅ |
| aftersales | `/project/{order_id}?type=aftersales` | ✅ | ✅ |
| sales | `/project/{order_id}?type=sales` | ✅ | ✅ |
| status-query | `/project/{order_id}?type=status` | ✅ | ✅ |
| custom (pay) | `/pay/{order_id}` | ✅ | ✅ |

### 消息类型支持

| 消息类型 | 支持状态 | 推荐用途 |
|---------|--------|--------|
| 短信 | ✅ | 紧急通知、支付提醒 |
| 邮件 | ✅ | 详细说明、发票、合同 |
| 微信公众号 | ✅ | 日常通知、营销 |
| 企业微信 | ✅ | 内部通知、工作协作 |
| AI回复 | ✅ | 自动回复、FAQ |
| 群机器人 | ✅ | 批量通知、广播 |

---

## 🎯 下一步配置建议

### 立即可做
1. ✅ 访问 TemplateManager 创建模板
2. ✅ 测试各种链接类型
3. ✅ 在本地验证展示效果

### 需要配置
1. 配置公网域名或内网穿透
2. 购买HTTPS证书
3. 配置微信权限域名

### 高级功能
1. 配置AI机器人自动发送
2. 设置定时推送任务
3. 集成CRM自动触发
4. 配置数据分析追踪

---

## 📞 常见问题

**Q: 本地开发如何在微信APP中打开链接？**
A: 使用ngrok进行内网穿透，得到公网URL后在模板中使用。

**Q: 可以自定义链接格式吗？**
A: 可以，在"自定义链接"选项中输入任意URL。

**Q: 如何验证模板是否正确？**
A: 点击"预览"按钮查看渲染效果。

**Q: 是否支持变量嵌套？**
A: 当前支持单层变量替换，复杂场景可在发送时处理。

**Q: 如何保证链接安全？**
A: 系统支持JWT令牌，可在URL中添加token参数进行验证。

---

## 📚 相关文件

- **TemplateManager.vue** - 模板管理前端
- **project_sync_router.py** - 项目详情API
- **ProjectDetail.vue** - 四种项目详情页面
- **PaymentPage.vue** - 支付页面（如果有）

---

**配置指南完成** ✅

现在你可以直接访问模板管理模块进行配置！
