# 网页配置管理后台 - 使用指南

## 🎯 系统特点

### 零代码配置
- ✅ 所有配置通过网页表单完成
- ✅ 配置后立即生效，无需重启服务
- ✅ 预制业务流程模板，一键激活
- ✅ 权限分级管理，精确控制访问

## 📋 快速开始

### 1. 数据库初始化

首先运行配置管理扩展的数据库迁移脚本：

```bash
# 连接到PostgreSQL数据库
psql -U postgres -d customer_system -f backend/config_management_extension.sql
```

这将创建以下表：
- `roles` - 角色表
- `admin_users` - 管理员用户表
- `permissions` - 权限表
- `config_groups` - 配置分组表
- `enhanced_system_config` - 增强系统配置表
- `workflow_templates` - 业务流程模板表
- `robot_webhooks` - 群机器人配置表
- `operation_logs` - 操作日志表

### 2. 默认账号

系统会自动创建一个超级管理员账号：
- **用户名**: `admin`
- **密码**: `admin123`

⚠️ **重要**: 首次登录后请立即修改密码！

### 3. 访问配置中心

启动系统后，访问以下地址：

```
http://localhost:5173/config
```

## 🎨 界面功能说明

### 配置概览

极简配置界面，所有配置在一个页面完成：

#### 第一步：企业微信基础配置
```
企业微信CorpID: [填写企业ID]
企业微信应用Secret: [填写应用密钥]
应用AgentId: [填写AgentId]
```

#### 第二步：消息接收配置
```
接收消息服务器URL: [自动生成，直接复制使用]
Token: [填写验证Token]
EncodingAESKey: [填写加密密钥]
☑️ 启用消息接收
```

系统会自动生成回调URL，点击复制按钮即可复制到企业微信管理后台。

#### 第三步：群机器人配置

在"群机器人"页面，可以添加多个Webhook：

1. 点击"添加Webhook"按钮
2. 填写以下信息：
   - Webhook名称（例如：新客户通知群）
   - Webhook类型（新客户通知/销售日报/技术支援等）
   - Webhook URL（从企业微信群机器人获取）
   - 描述（可选）
   - 是否启用
3. 点击"保存"

**支持的Webhook类型：**
- 📞 新客户通知群
- 📊 销售日报群
- 🔧 技术支援群
- 🛠️ 售后服务群
- 📝 其他自定义

#### 第四步：业务流程选择

系统提供三种预制流程模板：

**1. 标准售前流程（推荐）**
```
客户咨询 → 记录意向 → 自动分配销售 → 销售联系 → 报价 → 成交/丢单
```
- ✅ 自动识别售前意图
- ✅ 自动创建商机
- ✅ 自动分配销售（轮询策略）
- ✅ 群内通知新客户
- ✅ 成交/丢单自动记录

**2. 标准售后流程**
```
客户报修 → 验证手机号 → 创建工单 → 分配技术 → 处理中 → 完成 → 客户评价
```
- ✅ 自动验证客户身份
- ✅ 创建售后工单
- ✅ 智能分配工程师（技能匹配）
- ✅ 进度通知
- ✅ 客户评价收集

**3. 混合流程（售前+售后）**
```
智能识别 → 售前分支/售后分支 → 对应流程处理
```
- ✅ AI自动分类（售前/售后）
- ✅ 动态路由到对应流程
- ✅ 统一管理界面

**选择方式：** 在"业务流程"页面，点击对应的流程卡片即可激活。

### 权限管理

#### 预制角色

系统预制了6个角色，满足不同场景需求：

| 角色 | 权限范围 | 适用人员 |
|------|----------|---------|
| 超级管理员 | 所有权限 | 系统管理员 |
| 管理员 | 配置、用户、工作流、业务数据查看 | 部门主管 |
| 销售人员 | 客户、商机、订单管理 | 销售团队 |
| 客服人员 | 客户、项目、服务请求 | 客服团队 |
| 工程师 | 项目、设备、配件管理 | 技术团队 |
| 只读用户 | 所有数据只读 | 观察者 |

#### 权限模块

系统按功能模块划分权限：

1. **系统配置** - `config:read`, `config:write`
2. **用户管理** - `user:read`, `user:write`
3. **角色管理** - `role:read`, `role:write`
4. **工作流管理** - `workflow:read`, `workflow:write`
5. **客户管理** - `customer:read`, `customer:write`
6. **商机管理** - `opportunity:read`, `opportunity:write`
7. **订单管理** - `order:read`, `order:write`
8. **项目管理** - `project:read`, `project:write`
9. **设备管理** - `equipment:read`, `equipment:write`
10. **服务请求** - `service_request:read`, `service_request:write`
11. **配件管理** - `parts:read`, `parts:write`
12. **数据报表** - `report:view`
13. **系统日志** - `log:view`

### 用户管理

#### 添加用户

1. 进入"用户管理"页面
2. 点击"添加用户"按钮
3. 填写用户信息：
   - 用户名（登录用）
   - 密码
   - 真实姓名
   - 邮箱
   - 手机号
   - 角色（选择一个角色）
   - 状态（激活/禁用）
4. 点击"保存"

#### 编辑用户

- 点击用户列表中的"编辑"按钮
- 修改信息
- 如不修改密码，留空即可

#### 禁用用户

- 编辑用户，将"状态"切换为禁用
- 禁用的用户无法登录系统

### 操作日志

系统自动记录所有关键操作：

- ✅ 配置修改
- ✅ 用户创建/编辑/删除
- ✅ 角色权限变更
- ✅ 业务流程切换
- ✅ Webhook配置变更

日志内容包括：
- 操作用户
- 操作类型
- 操作模块
- 操作描述
- 请求路径
- IP地址
- 操作时间

## 🔧 API自动生成

系统根据配置自动生成智能路由接口，无需手动编写代码。

### 智能消息路由

```python
@app.post("/api/ai/router")
async def handle_message(user_msg: str, source: str):
    # 根据当前激活的业务流程模板自动处理
    # 自动识别：售前 → 记录意向 → 分配销售
    # 自动识别：售后 → 验证身份 → 创建工单
    # 自动识别：查询 → 验证权限 → 返回进度
    return {"reply": "智能回复", "next_step": "等待用户输入"}
```

### 自动化群消息推送

```python
async def auto_send_group_notify(notify_type, data):
    # 从配置中获取对应的Webhook
    webhook = get_webhook_by_type(notify_type)
    if webhook and webhook.is_active:
        send_robot_message(webhook.webhook_url, format_message(data))
```

## 📊 与现有系统对比

### 本项目特色功能

相比GitHub上的开源项目，本系统额外实现了：

#### 1. 多联系人权限管理
- ✅ 一个项目可以有多个联系人
- ✅ 每个联系人权限独立配置
- ✅ 主联系人、协作人、观察者三种角色

#### 2. 客户身份动态管理
- ✅ 商机→正式客户→取消客户 自动流转
- ✅ 基于订单状态自动判断
- ✅ 支持客户身份恢复

#### 3. 客户关系无感转接
- ✅ 销售离职时平滑转接客户
- ✅ 保留原始关系链，支持转回
- ✅ 自动通知相关人员

#### 4. 智能工单交互
- ✅ AI智能理解客户意图
- ✅ 自动填充工单字段
- ✅ 上下文对话追问

#### 5. 安全链接与缓存
- ✅ 项目详情安全访问链接
- ✅ Redis缓存提升性能
- ✅ 链接过期自动管理

#### 6. 完整的售后自动化
- ✅ 维修提醒自动推送
- ✅ 配件库存自动扣减
- ✅ 服务评价自动收集

#### 7. 零代码配置中心
- ✅ 本项目独有的网页配置界面
- ✅ 权限分级管理
- ✅ 操作日志审计
- ✅ 预制业务流程模板

## 🎯 技术架构

### 后端技术选型

根据第一张图片的技术选型说明：

| 技术 | 用途 | 优势 |
|------|------|------|
| **动态可控链路池** | 处理多通道消息发送任务 | 提高消息发送任务的并发量和处理速度 |
| **Nacos** | 微服务配置管理 | 动态管理链路池参数，提升系统灵活性 |
| **Redis** | 消息追踪 | 对消息的每个阶段进行实时监控，日志记录和发送记录，掌控消息生命周期 |
| **Xxl-job** | 定时任务 | 实现消息的定时发送功能 |
| **RabbitMQ** | 消息中间件 | 将变时消息发送任务或定时消息任务交给RabbitMQ监听消费，实现消息发送的异步解耦，降低系统耦合度 |
| **Docker** | 容器化部署 | 统一部署各组件，简化系统的部署难度 |
| **RabbitMQ延迟队列** | 延迟消息 | 处理延时消息任务，提高消息的可靠性 |
| **PGSQL** | 数据存储 | 存储消息发送模板信息和第三方账号配置信息的数据库 |
| **ECharts可视化** | 数据展示 | 对消息模板下发用户数、今日消息发送量、每天各时间段发送情况以及消息模板用户数据进行可视化展示 |
| **Sentinel限流** | 流量控制 | 对消息发送接口进行限流，保障系统的稳定性 |
| **Redisson分布式锁** | 并发控制 | 对消息确认机引入分布式锁小锁粒度，提高并发量 |

### 前端技术栈

- **Vue 3** - 现代化前端框架
- **Element Plus** - 企业级UI组件库
- **Vue Router** - 单页应用路由
- **Axios** - HTTP客户端

### 数据库设计

- **PostgreSQL** - 主数据库
- **Redis** - 缓存和会话管理
- **SQLAlchemy** - ORM框架
- **Asyncpg** - 异步数据库驱动

## 🔐 安全建议

1. **修改默认密码**
   - 首次登录后立即修改admin账号密码
   - 定期更新密码

2. **权限最小化原则**
   - 只给用户必要的权限
   - 定期审查用户权限

3. **敏感信息保护**
   - Secret、AESKey等敏感配置自动加密显示
   - 操作日志完整记录

4. **定期备份**
   - 定期备份数据库
   - 导出重要配置

## 📞 支持

如遇问题，请查看：
- 操作日志（查看错误信息）
- 系统API文档：`http://localhost:8000/docs`
- 数据库连接状态：`http://localhost:8000/health`

## 📝 更新日志

### v1.0.0 (2026-02-02)

✨ 新功能
- 完整的网页配置中心
- 权限分级管理系统
- 预制业务流程模板
- 群机器人管理
- 用户管理
- 操作日志审计

🔧 技术改进
- 异步数据库操作
- 密码加密存储
- 配置即时生效
- 响应式界面设计

---

**祝您使用愉快！** 🎉
