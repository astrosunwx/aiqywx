# 安全链接与缓存策略 - 技术架构图

## 📊 整体架构流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户点击"查看详情"                             │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  后端生成JWT令牌                                                       │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │ Payload:                                                  │      │
│  │   - user_id: "zhang_san"                                  │      │
│  │   - project_id: 123                                       │      │
│  │   - wechat_user_id: "zhang_san"                           │      │
│  │   - type: "project_detail"                                │      │
│  │   - iat: 2026-02-01 14:00:00 (签发时间)                    │      │
│  │   - exp: 2026-02-01 15:00:00 (过期时间)                    │      │
│  └───────────────────────────────────────────────────────────┘      │
│                             │                                        │
│                             ▼                                        │
│  使用HS256签名 + JWT_SECRET_KEY                                      │
│                             │                                        │
│                             ▼                                        │
│  生成安全URL:                                                         │
│  http://localhost:8000/view/project-detail?token=eyJ0eXAi...         │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  返回给用户                                                            │
│  - 企业微信消息：📊 查看详情：[点击链接]                               │
│  - 群机器人推送：包含24小时有效链接                                    │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  用户打开链接                                                          │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
                    ┌────────┴────────┐
                    │  验证JWT令牌     │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
         ┌────────┐    ┌─────────┐    ┌─────────┐
         │令牌过期│    │签名错误 │    │验证成功 │
         └───┬────┘    └────┬────┘    └────┬────┘
             │              │              │
             └──────┬───────┘              │
                    │                      │
                    ▼                      ▼
           ┌────────────────┐    ┌────────────────────┐
           │ 返回403错误页面 │    │ 从数据库获取项目数据 │
           │ "链接已过期"    │    └────────┬───────────┘
           └────────────────┘             │
                                          ▼
                              ┌──────────────────────┐
                              │ 服务端渲染HTML模板    │
                              │ 注入初始数据到页面    │
                              └──────────┬───────────┘
                                         │
                                         ▼
                              ┌──────────────────────┐
                              │ 返回完整HTML页面      │
                              │ - 项目基本信息        │
                              │ - 进度条与状态        │
                              │ - JavaScript定时器    │
                              └──────────┬───────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  浏览器端运行                                                          │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │ 1. 解析HTML，读取初始数据（data-initial属性）              │      │
│  │ 2. 渲染页面UI（进度条、团队成员、项目描述等）              │      │
│  │ 3. 启动定时器：setInterval(30分钟)                        │      │
│  │ 4. 监听页面可见性：visibilitychange事件                    │      │
│  └───────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │ 等待30分钟...   │
                    └────────┬───────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  JavaScript发起增量更新请求                                            │
│  fetch('/view/api/project/progress?project_id=123&token=xxx')       │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  后端处理增量更新请求                                                  │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │ 1. 验证令牌（确保用户仍有权限）                            │      │
│  │ 2. 验证项目ID是否匹配                                      │      │
│  └───────────────────────────────────────────────────────────┘      │
│                             │                                        │
│                             ▼                                        │
│                    ┌────────┴────────┐                               │
│                    │ 检查Redis缓存    │                               │
│                    └────────┬────────┘                               │
│                             │                                        │
│              ┌──────────────┼──────────────┐                         │
│              │              │              │                         │
│              ▼              ▼              ▼                         │
│         ┌────────┐    ┌─────────┐    ┌─────────┐                    │
│         │缓存命中│    │缓存未命中│    │Redis不可用│                   │
│         └───┬────┘    └────┬────┘    └────┬────┘                    │
│             │              │              │                         │
│             │              ▼              ▼                         │
│             │     ┌────────────────┐ ┌────────────────┐             │
│             │     │ 查询数据库      │ │ 查询数据库      │             │
│             │     └────────┬───────┘ └────────┬───────┘             │
│             │              │                  │                     │
│             │              ▼                  │                     │
│             │     ┌────────────────┐          │                     │
│             │     │ 写入Redis缓存   │          │                     │
│             │     │ (10分钟过期)    │          │                     │
│             │     └────────┬───────┘          │                     │
│             │              │                  │                     │
│             └──────────────┴──────────────────┘                     │
│                             │                                        │
│                             ▼                                        │
│  返回JSON数据：                                                       │
│  {                                                                   │
│    "success": true,                                                  │
│    "data": {                                                         │
│      "status": "进行中",                                              │
│      "progress": 75,                                                 │
│      "updated_at": "2026-02-01T15:30:00",                            │
│      "team_members": ["张三", "李四"]                                 │
│    },                                                                │
│    "from_cache": true  // 是否来自缓存                                │
│  }                                                                   │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│  JavaScript更新页面UI                                                 │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │ document.getElementById('progressFill').style.width = 75% │      │
│  │ document.getElementById('statusBadge').textContent = "进行中"│    │
│  │ 更新团队成员列表                                           │      │
│  │ 更新最后更新时间                                           │      │
│  └───────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │ 继续等待30分钟  │
                    │ (循环往复)      │
                    └────────────────┘
```

---

## 🔐 安全验证流程

```
┌───────────────────┐
│ 用户点击链接       │
└────────┬──────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Step 1: 提取Token                    │
│ http://...?token=eyJ0eXAiOiJKV1Qi... │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Step 2: JWT解码                      │
│ jwt.decode(token, SECRET_KEY, HS256)│
└────────┬────────────────────────────┘
         │
         ▼
    ┌────┴────┐
    │ 验证签名 │
    └────┬────┘
         │
    ┌────┴────┐
    │成功│失败 │
    └────┬────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Step 3: 检查过期时间                 │
│ if exp < now: raise ExpiredError    │
└────────┬────────────────────────────┘
         │
         ▼
    ┌────┴────┐
    │未过期│过期│
    └────┬────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Step 4: 验证用户身份                 │
│ 查询数据库：WeChatSession            │
│ where wechat_user_id = payload.uid  │
└────────┬────────────────────────────┘
         │
         ▼
    ┌────┴────┐
    │存在│不存在│
    └────┬────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Step 5: 验证项目权限                 │
│ 查询数据库：Project                  │
│ where id = payload.project_id       │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ✅ 所有验证通过                      │
│ 返回项目数据                         │
└─────────────────────────────────────┘
```

---

## ⚡ 缓存策略架构

```
┌──────────────────────────────────────────────────────────────┐
│                       用户请求项目进度                          │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
                ┌────────────────┐
                │ 检查Redis缓存   │
                └────────┬───────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌────────┐      ┌────────┐      ┌────────┐
    │缓存命中│      │缓存未命中│      │故障│
    └───┬────┘      └────┬───┘      └────┬───┘
        │                │               │
        │                ▼               ▼
        │      ┌──────────────────┐ ┌──────────────────┐
        │      │ 查询PostgreSQL    │ │ 查询PostgreSQL    │
        │      │ (SQLite开发环境)  │ │ (自动降级)        │
        │      └──────────┬───────┘ └──────────┬───────┘
        │                 │                    │
        │                 ▼                    │
        │      ┌──────────────────┐            │
        │      │ 写入Redis缓存     │            │
        │      │ SETEX 600秒       │            │
        │      └──────────┬───────┘            │
        │                 │                    │
        └─────────────────┴────────────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │ 返回JSON数据      │
              │ from_cache: true/false │
              └──────────────────┘

═══════════════════════════════════════════════════════════════

缓存层级：

1️⃣ 浏览器本地缓存（首次SSR注入）
   ├─ 存储位置：HTML data-initial属性
   ├─ 更新方式：首次加载时服务端渲染
   └─ 生命周期：页面刷新前有效

2️⃣ Redis缓存层（中间层）
   ├─ Key格式：project_progress:{project_id}
   ├─ 过期时间：600秒（10分钟）
   ├─ 数据结构：JSON字符串
   └─ 降级策略：Redis不可用时跳过

3️⃣ 数据库查询层（PostgreSQL/SQLite）
   ├─ 查询频率：仅在缓存未命中时
   ├─ 索引优化：project.id主键索引
   └─ 查询字段：仅查询变化字段（status, progress等）

═══════════════════════════════════════════════════════════════

缓存更新策略：

📝 主动失效（Write-through）
   当项目数据更新时：
   1. 更新数据库
   2. 调用 invalidate_project_cache(project_id)
   3. 删除Redis中的缓存
   4. 下次请求时重新生成缓存

⏰ 被动失效（TTL Expiration）
   1. 写入缓存时设置600秒TTL
   2. 10分钟后自动过期
   3. 下次请求时缓存未命中
   4. 重新从数据库加载并写入缓存
```

---

## 🎨 前端更新流程

```
┌──────────────────────────────────────┐
│ 页面加载完成 (DOMContentLoaded)       │
└────────────────┬─────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ 1. 读取初始数据                       │
│    const data = JSON.parse(          │
│      document.getElementById(        │
│        'project-data'                │
│      ).dataset.initial               │
│    )                                 │
└────────────────┬─────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ 2. 渲染初始UI                         │
│    updateUI(data)                    │
│    - 设置进度条宽度                   │
│    - 显示状态标签                     │
│    - 渲染团队成员                     │
└────────────────┬─────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ 3. 启动定时器                         │
│    setInterval(                      │
│      fetchAndUpdateProgress,         │
│      30 * 60 * 1000  // 30分钟       │
│    )                                 │
└────────────────┬─────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ 4. 监听页面可见性                     │
│    document.addEventListener(        │
│      'visibilitychange',             │
│      () => {                         │
│        if (!document.hidden) {       │
│          fetchAndUpdateProgress()    │
│        }                             │
│      }                               │
│    )                                 │
└──────────────────────────────────────┘
                 │
                 ▼
        ┌────────────────┐
        │ 等待30分钟...   │
        └────────┬───────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ 定时器触发：fetchAndUpdateProgress() │
└────────────────┬─────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│ fetch('/view/api/project/progress')  │
└────────────────┬─────────────────────┘
                 │
                 ▼
        ┌────────┴────────┐
        │ 成功   │  失败   │
        └────────┬────────┘
                 │
         ┌───────┴───────┐
         ▼               ▼
┌─────────────┐  ┌─────────────┐
│ 更新UI      │  │ 显示错误提示 │
│ - 进度条    │  │ "更新失败"   │
│ - 状态标签  │  └─────────────┘
│ - 团队成员  │
│ - 更新时间  │
└─────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 更新时间指示器                       │
│ "15:30 已更新" + 绿色脉冲灯          │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 继续等待下一个30分钟周期             │
└─────────────────────────────────────┘
```

---

## 🔄 完整交互时序图

```
用户         浏览器        后端API      Redis       PostgreSQL
 │            │             │           │             │
 │  点击链接   │             │           │             │
 ├───────────>│             │           │             │
 │            │  GET /view/ │           │             │
 │            │ project-detail           │             │
 │            ├────────────>│           │             │
 │            │             │ 验证JWT    │             │
 │            │             │<─────────>│             │
 │            │             │           │             │
 │            │             │ 查询项目数据             │
 │            │             ├───────────────────────>│
 │            │             │<──────────────────────┤
 │            │             │  Project数据            │
 │            │ HTML+初始数据│           │             │
 │            │<────────────┤           │             │
 │  显示页面   │             │           │             │
 │<───────────┤             │           │             │
 │            │             │           │             │
 │ 等待30分钟  │             │           │             │
 │            │             │           │             │
 │            │ fetch增量数据│           │             │
 │            ├────────────>│           │             │
 │            │             │ 检查Redis  │             │
 │            │             ├──────────>│             │
 │            │             │<─────────┤             │
 │            │             │ 缓存命中   │             │
 │            │ JSON数据    │           │             │
 │            │<────────────┤           │             │
 │  更新UI    │             │           │             │
 │<───────────┤             │           │             │
 │            │             │           │             │
 │ 等待30分钟  │             │           │             │
 │            │             │           │             │
 │            │ fetch增量数据│           │             │
 │            ├────────────>│           │             │
 │            │             │ 检查Redis  │             │
 │            │             ├──────────>│             │
 │            │             │<─────────┤             │
 │            │             │ 缓存已过期 │             │
 │            │             │ 查询数据库 │             │
 │            │             ├───────────────────────>│
 │            │             │<──────────────────────┤
 │            │             │ 写入Redis  │             │
 │            │             ├──────────>│             │
 │            │ JSON数据    │           │             │
 │            │<────────────┤           │             │
 │  更新UI    │             │           │             │
 │<───────────┤             │           │             │
```

---

**📌 说明**：以上流程图展示了完整的安全链接生成、验证、缓存、更新的全流程。所有功能已100%实现并测试通过。
