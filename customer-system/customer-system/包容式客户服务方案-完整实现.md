# åŒ…å®¹å¼å®¢æˆ·æœåŠ¡æ–¹æ¡ˆ - å®Œæ•´å®ç°

## ğŸ“‹ æ ¸å¿ƒç†å¿µ

**ä¸æ‹’ç»ä»»ä½•å®¢æˆ·çš„æœåŠ¡è¯·æ±‚**

ä¼ ç»Ÿæ–¹æ¡ˆï¼šâŒ æƒé™æ£€æŸ¥å¤±è´¥ â†’ ç›´æ¥æ‹’ç»  
åŒ…å®¹æ–¹æ¡ˆï¼šâœ… è®°å½•æ‰€æœ‰è¯·æ±‚ â†’ é€šçŸ¥é”€å”®é¡¾é—®å¤„ç†

---

## ğŸ¯ ä¸šåŠ¡åœºæ™¯

### å®¢æˆ·å‘èµ·æœåŠ¡è¯·æ±‚

```
å®¢æˆ·ï¼šæˆ‘è¦æŸ¥è¯¢è®¢å•
å®¢æˆ·ï¼šæˆ‘è¦æ›´æ”¹è®¢å•
å®¢æˆ·ï¼šæˆ‘è¦å–æ¶ˆè®¢å•
å®¢æˆ·ï¼šæˆ‘éœ€è¦å”®å
```

### ç³»ç»Ÿå“åº”æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ è¯·é—®æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ                â”‚
â”‚  ğŸ‘¤ è¾“å…¥ï¼šå¼ ä¸‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2ï¸âƒ£ æ‚¨çš„ç”µè¯æ˜¯å¤šå°‘ï¼Ÿ                â”‚
â”‚  ğŸ“± è¾“å…¥ï¼š13800138000                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3ï¸âƒ£ æ‚¨è¦ï¼š                          â”‚
â”‚     â€¢ æŸ¥è¯¢è®¢å•ï¼Ÿ                     â”‚
â”‚     â€¢ æ›´æ”¹è®¢å•ï¼Ÿ                     â”‚
â”‚     â€¢ å–æ¶ˆè®¢å•ï¼Ÿ                     â”‚
â”‚     â€¢ å”®åæœåŠ¡ï¼Ÿ                     â”‚
â”‚  ğŸ¯ è¾“å…¥ï¼šæŸ¥è¯¢è®¢å•                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4ï¸âƒ£ è¯·ç®€å•æè¿°æ‚¨çš„éœ€æ±‚              â”‚
â”‚  ğŸ“ è¾“å…¥ï¼šæƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… å·²è®°å½•æ‚¨çš„æŸ¥è¯¢è®¢å•è¯·æ±‚           â”‚
â”‚     æˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†       â”‚
â”‚     è¯·ä¿æŒç”µè¯ç•…é€š                   â”‚
â”‚                                      â”‚
â”‚  ğŸ“‹ è¯·æ±‚å•å·ï¼šREQ20240202123456ABC   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®¢æˆ·èº«ä»½åˆ†ç±»å¤„ç†

### 1ï¸âƒ£ å•†æœºç”¨æˆ·ï¼ˆprospectï¼‰

```
æ£€æµ‹ç»“æœï¼š
- customer_type = 'prospect'
- has_active_order = false

å¤„ç†æ–¹å¼ï¼š
âœ… è®°å½•è¯·æ±‚
âœ… æ¨é€é€šçŸ¥ç»™é”€å”®é¡¾é—®
ğŸ“± æç¤ºï¼š"å•†æœºç”¨æˆ·ï¼Œè¿˜æœªä¸‹å•ï¼Œè¯·å…ˆæœç´¢æ‰‹æœºå·æ·»åŠ å®¢æˆ·"
```

### 2ï¸âƒ£ å–æ¶ˆå®¢æˆ·ï¼ˆcancelledï¼‰

```
æ£€æµ‹ç»“æœï¼š
- customer_type = 'cancelled'
- has_active_order = false
- æ‰€æœ‰è®¢å•å·²å–æ¶ˆ

å¤„ç†æ–¹å¼ï¼š
âœ… è®°å½•è¯·æ±‚
âœ… æ¨é€é€šçŸ¥ç»™é”€å”®é¡¾é—®
ğŸ“± æç¤ºï¼š"å–æ¶ˆå®¢æˆ·ï¼Œè®¢å•å·²å…¨éƒ¨å–æ¶ˆï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡äº†è§£æƒ…å†µ"
```

### 3ï¸âƒ£ ä¸å­˜åœ¨çš„å®¢æˆ·ï¼ˆunknownï¼‰

```
æ£€æµ‹ç»“æœï¼š
- customersè¡¨ä¸­æ‰¾ä¸åˆ°è¯¥æ‰‹æœºå·

å¯èƒ½åŸå› ï¼š
â€¢ é¦–æ¬¡è”ç³»æœ¬å…¬å¸
â€¢ è´­ä¹°äº†æœ¬å…¬å¸äº§å“ï¼Œä½†é¡¹ç›®åº“æš‚æ—¶æ²¡æœ‰ä¿¡æ¯
â€¢ é¡¹ç›®æ›´æ¢äº†è”ç³»äºº
â€¢ è”ç³»æ–¹å¼å˜æ›´äº†

å¤„ç†æ–¹å¼ï¼š
âœ… è®°å½•è¯·æ±‚
âœ… æ¨é€é€šçŸ¥ç»™é”€å”®é¡¾é—®
ğŸ“± æç¤ºï¼š"å®¢æˆ·ä¸å­˜åœ¨äºç³»ç»Ÿï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è”ç³»æˆ–é¡¹ç›®è”ç³»äººå˜æ›´"
```

### 4ï¸âƒ£ æ­£å¼å®¢æˆ·ä½†æ— è®¢å•ï¼ˆcustomer without orderï¼‰

```
æ£€æµ‹ç»“æœï¼š
- customer_type = 'customer'
- has_active_order = false

å¤„ç†æ–¹å¼ï¼š
âœ… è®°å½•è¯·æ±‚
âœ… æ¨é€é€šçŸ¥ç»™é”€å”®é¡¾é—®
ğŸ“± æç¤ºï¼š"æ­£å¼å®¢æˆ·ä½†æš‚æ— æœ‰æ•ˆè®¢å•ï¼Œå¯èƒ½è®¢å•å·²å®Œæˆæˆ–å–æ¶ˆ"
```

### 5ï¸âƒ£ æœªéªŒè¯çš„æ­£å¼å®¢æˆ·ï¼ˆcustomer not verifiedï¼‰

```
æ£€æµ‹ç»“æœï¼š
- customer_type = 'customer'
- has_active_order = true
- is_verified = false
- è¯·æ±‚ç±»å‹ = modify_order/cancel_order/aftersales

å¤„ç†æ–¹å¼ï¼š
âœ… è®°å½•è¯·æ±‚
âœ… æ¨é€é€šçŸ¥ç»™é”€å”®é¡¾é—®
ğŸ“± æç¤ºï¼š"å®¢æˆ·æœªé€šè¿‡ä¼ä¸šå¾®ä¿¡éªŒè¯ï¼Œè¯·å…ˆæ·»åŠ å®¢æˆ·"
```

---

## ğŸš¨ è¯·æ±‚ç´§æ€¥ç¨‹åº¦åˆ†çº§

### ä½ï¼ˆlowï¼‰ğŸ“‹

```
è¯·æ±‚ç±»å‹ï¼šinquiryï¼ˆå’¨è¯¢ï¼‰
åœºæ™¯ï¼šäº†è§£äº§å“ã€è¯¢ä»·
å“åº”æ—¶é—´ï¼š24å°æ—¶å†…
```

### æ™®é€šï¼ˆnormalï¼‰ğŸ“

```
è¯·æ±‚ç±»å‹ï¼šquery_orderï¼ˆæŸ¥è¯¢è®¢å•ï¼‰
åœºæ™¯ï¼šæŸ¥çœ‹é¡¹ç›®è¿›åº¦ã€è®¢å•çŠ¶æ€
å“åº”æ—¶é—´ï¼š12å°æ—¶å†…
```

### é«˜ï¼ˆhighï¼‰âš ï¸

```
è¯·æ±‚ç±»å‹ï¼š
- modify_orderï¼ˆæ›´æ”¹è®¢å•ï¼‰
- aftersalesï¼ˆå”®åæœåŠ¡ï¼‰

åœºæ™¯ï¼šå˜æ›´éœ€æ±‚ã€è®¾å¤‡æ•…éšœ
å“åº”æ—¶é—´ï¼š4å°æ—¶å†…
```

### ç´§æ€¥ï¼ˆurgentï¼‰ğŸš¨

```
è¯·æ±‚ç±»å‹ï¼šcancel_orderï¼ˆå–æ¶ˆè®¢å•ï¼‰
åœºæ™¯ï¼šå®¢æˆ·è¦å–æ¶ˆè®¢å•
å“åº”æ—¶é—´ï¼š1å°æ—¶å†…
```

---

## ğŸ“¬ ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ ¼å¼

### éœ€è¦æ·»åŠ å®¢æˆ·çš„é€šçŸ¥

```
ğŸš¨ ã€å®¢æˆ·æœåŠ¡è¯·æ±‚ - éœ€è¦æ·»åŠ å®¢æˆ·ã€‘
è¯·æ±‚å•å·ï¼šREQ20240202123456ABC
è¯·æ±‚ç±»å‹ï¼šæŸ¥è¯¢è®¢å•ï¼ˆNORMALï¼‰
å®¢æˆ·å§“åï¼šå¼ ä¸‰
å®¢æˆ·ç”µè¯ï¼š13800138000
å®¢æˆ·èº«ä»½ï¼šprospect

âš ï¸ æ¸©é¦¨æç¤ºï¼š
å•†æœºç”¨æˆ·ï¼Œè¿˜æœªä¸‹å•ï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡è”ç³»

ğŸ“± è¯·å…ˆ"æœç´¢æ‰‹æœºå·"æ·»åŠ è¯¥å®¢æˆ·
ç„¶åå¤„ç†å®¢æˆ·çš„æŸ¥è¯¢è®¢å•è¯·æ±‚

å¯èƒ½åŸå› ï¼š
â€¢ å•†æœºå®¢æˆ·ï¼ˆè¿˜æœªä¸‹å•ï¼‰
â€¢ è´­ä¹°äº†æœ¬å…¬å¸äº§å“ä½†é¡¹ç›®åº“æš‚æ—¶æ²¡æœ‰ä¿¡æ¯
â€¢ é¡¹ç›®æ›´æ¢äº†è”ç³»äººæˆ–è”ç³»æ–¹å¼å˜æ›´

è¯·æ±‚å†…å®¹ï¼š
æƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦

è¯·ä¿æŒç”µè¯ç•…é€šï¼ŒåŠæ—¶è”ç³»å®¢æˆ·ï¼
```

### æ­£å¸¸å®¢æˆ·çš„é€šçŸ¥

```
ğŸ“ ã€å®¢æˆ·æœåŠ¡è¯·æ±‚ã€‘
è¯·æ±‚å•å·ï¼šREQ20240202123456ABC
è¯·æ±‚ç±»å‹ï¼šæŸ¥è¯¢è®¢å•ï¼ˆNORMALï¼‰
å®¢æˆ·å§“åï¼šæå››
å®¢æˆ·ç”µè¯ï¼š13900139000
å®¢æˆ·èº«ä»½ï¼šæ­£å¼å®¢æˆ· âœ…

è¯·æ±‚å†…å®¹ï¼š
æƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦

è¯·åŠæ—¶å¤„ç†å®¢æˆ·è¯·æ±‚ï¼
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### customer_service_requests è¡¨

```sql
CREATE TABLE customer_service_requests (
    id SERIAL PRIMARY KEY,
    request_no VARCHAR(50) UNIQUE NOT NULL,  -- REQ20240202123456ABC
    
    -- å®¢æˆ·ä¿¡æ¯ï¼ˆå¯èƒ½è¿˜ä¸æ˜¯æ­£å¼å®¢æˆ·ï¼‰
    customer_phone VARCHAR(20) NOT NULL,
    customer_name VARCHAR(100),
    customer_id INTEGER REFERENCES customers(id),
    customer_type VARCHAR(20),  -- prospect/customer/cancelled/unknown
    
    -- è¯·æ±‚ç±»å‹
    request_type VARCHAR(50) NOT NULL,  -- query_order, modify_order, cancel_order, aftersales, inquiry
    request_content TEXT,
    urgency VARCHAR(20) DEFAULT 'normal',  -- low, normal, high, urgent
    
    -- æ¥æºæ¸ é“
    source VARCHAR(20) DEFAULT 'wechat',
    source_openid VARCHAR(100),
    
    -- å¤„ç†çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending',  -- pending, assigned, processing, resolved, closed
    assigned_to VARCHAR(100),  -- é”€å”®é¡¾é—®UserID
    assigned_to_name VARCHAR(100),
    assigned_at TIMESTAMP,
    
    -- ç‰¹æ®Šæ ‡è®°
    needs_verification BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦éœ€è¦é”€å”®å…ˆæ·»åŠ å®¢æˆ·
    verification_note TEXT,  -- éªŒè¯æç¤ºï¼šå•†æœºç”¨æˆ·/å–æ¶ˆå®¢æˆ·/æœªæ‰¾åˆ°
    
    -- å¤„ç†è®°å½•
    response_content TEXT,
    resolved_at TIMESTAMP,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- æ¶ˆæ¯æ¨é€
    notification_sent BOOLEAN DEFAULT FALSE,
    notification_sent_at TIMESTAMP
);
```

### ç´¢å¼•è®¾è®¡

```sql
CREATE INDEX idx_service_requests_no ON customer_service_requests(request_no);
CREATE INDEX idx_service_requests_phone ON customer_service_requests(customer_phone);
CREATE INDEX idx_service_requests_type ON customer_service_requests(request_type);
CREATE INDEX idx_service_requests_status ON customer_service_requests(status);
CREATE INDEX idx_service_requests_urgency ON customer_service_requests(urgency);
CREATE INDEX idx_service_requests_needs_verification ON customer_service_requests(needs_verification);
CREATE INDEX idx_service_requests_created_at ON customer_service_requests(created_at);
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### 1. åˆ›å»ºæœåŠ¡è¯·æ±‚

**POST** `/api/service/request/create`

è¯·æ±‚ä½“ï¼š
```json
{
  "customer_phone": "13800138000",
  "customer_name": "å¼ ä¸‰",
  "request_type": "query_order",
  "request_content": "æƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦",
  "source": "wechat",
  "source_openid": "oXXXX"
}
```

å“åº”ï¼š
```json
{
  "success": true,
  "message": "å·²è®°å½•æ‚¨çš„æŸ¥è¯¢è®¢å•è¯·æ±‚ï¼Œæˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†ï¼Œè¯·ä¿æŒç”µè¯ç•…é€šã€‚",
  "request_no": "REQ20240202123456ABC",
  "urgency": "normal",
  "needs_verification": true
}
```

### 2. å¾®ä¿¡åˆ†æ­¥æ”¶é›†

**POST** `/api/wechat/message/service`

è¯·æ±‚ä½“ï¼š
```json
{
  "message": "æƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦",
  "openid": "oXXXX",
  "phone": "13800138000",  // å¯é€‰ï¼Œé€æ­¥æ”¶é›†
  "name": "å¼ ä¸‰",  // å¯é€‰ï¼Œé€æ­¥æ”¶é›†
  "request_type": "query_order"  // å¯é€‰ï¼Œè‡ªåŠ¨è¯†åˆ«
}
```

å“åº”ï¼ˆç¬¬1æ­¥ - æ”¶é›†å§“åï¼‰ï¼š
```json
{
  "success": false,
  "need_input": true,
  "prompt": "è¯·é—®æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ",
  "next_step": "collect_name"
}
```

å“åº”ï¼ˆç¬¬2æ­¥ - æ”¶é›†ç”µè¯ï¼‰ï¼š
```json
{
  "success": false,
  "need_input": true,
  "prompt": "è¯·é—®æ‚¨çš„ç”µè¯æ˜¯å¤šå°‘ï¼Ÿ",
  "next_step": "collect_phone"
}
```

å“åº”ï¼ˆç¬¬3æ­¥ - ç¡®è®¤è¯·æ±‚ç±»å‹ï¼‰ï¼š
```json
{
  "success": false,
  "need_input": true,
  "prompt": "è¯·é—®æ‚¨è¦ï¼š\n1ï¸âƒ£ æŸ¥è¯¢è®¢å•\n2ï¸âƒ£ æ›´æ”¹è®¢å•\n3ï¸âƒ£ å–æ¶ˆè®¢å•\n4ï¸âƒ£ å”®åæœåŠ¡\n\nè¯·å›å¤æ•°å­—æˆ–å…³é”®è¯",
  "next_step": "collect_request_type"
}
```

å“åº”ï¼ˆç¬¬4æ­¥ - å®Œæˆï¼‰ï¼š
```json
{
  "success": true,
  "message": "å·²è®°å½•æ‚¨çš„æŸ¥è¯¢è®¢å•è¯·æ±‚ï¼Œæˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†ï¼Œè¯·ä¿æŒç”µè¯ç•…é€šã€‚",
  "request_no": "REQ20240202123456ABC",
  "urgency": "normal",
  "needs_verification": true
}
```

### 3. æŸ¥è¯¢è¯·æ±‚è¯¦æƒ…

**GET** `/api/service/request/{request_no}`

å“åº”ï¼š
```json
{
  "request_no": "REQ20240202123456ABC",
  "customer_phone": "13800138000",
  "customer_name": "å¼ ä¸‰",
  "customer_type": "prospect",
  "request_type": "query_order",
  "request_content": "æƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦",
  "urgency": "normal",
  "status": "assigned",
  "needs_verification": true,
  "verification_note": "å•†æœºç”¨æˆ·ï¼Œè¿˜æœªä¸‹å•ï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡è”ç³»",
  "assigned_to_name": "ç¨‹çº¢",
  "created_at": "2024-02-02T12:34:56"
}
```

### 4. æŸ¥è¯¢å®¢æˆ·æ‰€æœ‰è¯·æ±‚

**GET** `/api/service/request/phone/{phone}`

å“åº”ï¼š
```json
{
  "phone": "13800138000",
  "total": 3,
  "requests": [
    {
      "request_no": "REQ20240202123456ABC",
      "request_type": "query_order",
      "urgency": "normal",
      "status": "assigned",
      "needs_verification": true,
      "created_at": "2024-02-02T12:34:56"
    }
  ]
}
```

---

## ğŸ­ å¯¹è¯æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šå•†æœºç”¨æˆ·æŸ¥è¯¢è®¢å•

```
ğŸ‘¤ å®¢æˆ·ï¼šæˆ‘è¦æŸ¥è¯¢è®¢å•

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼šå¼ ä¸‰

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ‚¨çš„ç”µè¯æ˜¯å¤šå°‘ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼š13800138000

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ‚¨è¦ï¼š
       1ï¸âƒ£ æŸ¥è¯¢è®¢å•
       2ï¸âƒ£ æ›´æ”¹è®¢å•
       3ï¸âƒ£ å–æ¶ˆè®¢å•
       4ï¸âƒ£ å”®åæœåŠ¡
       è¯·å›å¤æ•°å­—æˆ–å…³é”®è¯

ğŸ‘¤ å®¢æˆ·ï¼š1

ğŸ¤– ç³»ç»Ÿï¼šè¯·ç®€å•æè¿°æ‚¨çš„éœ€æ±‚

ğŸ‘¤ å®¢æˆ·ï¼šæƒ³çœ‹çœ‹æˆ‘çš„é¡¹ç›®è¿›åº¦

ğŸ¤– ç³»ç»Ÿï¼šâœ… å·²è®°å½•æ‚¨çš„æŸ¥è¯¢è®¢å•è¯·æ±‚
       æˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†
       è¯·ä¿æŒç”µè¯ç•…é€š
       
       ğŸ“‹ è¯·æ±‚å•å·ï¼šREQ20240202123456ABC

[åå°è‡ªåŠ¨å¤„ç†]
âœ… æ£€æµ‹åˆ°å®¢æˆ·èº«ä»½ï¼šprospectï¼ˆå•†æœºç”¨æˆ·ï¼‰
âœ… è®¾ç½® needs_verification = true
âœ… ç”Ÿæˆè¯·æ±‚å•å·ï¼šREQ20240202123456ABC
âœ… åˆ†é…ç»™é”€å”®é¡¾é—®ï¼šç¨‹çº¢
âœ… æ¨é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆå¸¦"è¯·å…ˆæœç´¢æ‰‹æœºå·æ·»åŠ å®¢æˆ·"æç¤ºï¼‰
```

### åœºæ™¯2ï¼šå–æ¶ˆå®¢æˆ·è¦å”®å

```
ğŸ‘¤ å®¢æˆ·ï¼šæˆ‘çš„è®¾å¤‡åäº†

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼šæå››

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ‚¨çš„ç”µè¯æ˜¯å¤šå°‘ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼š13900139000

ğŸ¤– ç³»ç»Ÿï¼šå·²è‡ªåŠ¨è¯†åˆ«æ‚¨çš„éœ€æ±‚ä¸º"å”®åæœåŠ¡"
       è¯·ç®€å•æè¿°å…·ä½“é—®é¢˜

ğŸ‘¤ å®¢æˆ·ï¼šç©ºè°ƒä¸åˆ¶å†·äº†

ğŸ¤– ç³»ç»Ÿï¼šâœ… å·²è®°å½•æ‚¨çš„å”®åæœåŠ¡è¯·æ±‚
       æˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†
       è¯·ä¿æŒç”µè¯ç•…é€š
       
       ğŸ“‹ è¯·æ±‚å•å·ï¼šREQ20240202234567DEF

[åå°è‡ªåŠ¨å¤„ç†]
âœ… æ£€æµ‹åˆ°å®¢æˆ·èº«ä»½ï¼šcancelledï¼ˆå–æ¶ˆå®¢æˆ·ï¼‰
âœ… è®¾ç½® needs_verification = true
âœ… ç´§æ€¥ç¨‹åº¦ï¼šhighï¼ˆå”®åï¼‰
âœ… æ¨é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆâš ï¸ é«˜ä¼˜å…ˆçº§ï¼Œå¸¦"è¯·å…ˆæ·»åŠ å¾®ä¿¡äº†è§£æƒ…å†µ"æç¤ºï¼‰
```

### åœºæ™¯3ï¼šä¸å­˜åœ¨çš„å®¢æˆ·è¦å–æ¶ˆè®¢å•

```
ğŸ‘¤ å®¢æˆ·ï¼šæˆ‘è¦å–æ¶ˆè®¢å•

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼šç‹äº”

ğŸ¤– ç³»ç»Ÿï¼šè¯·é—®æ‚¨çš„ç”µè¯æ˜¯å¤šå°‘ï¼Ÿ

ğŸ‘¤ å®¢æˆ·ï¼š13700137000

ğŸ¤– ç³»ç»Ÿï¼šâœ… å·²è®°å½•æ‚¨çš„å–æ¶ˆè®¢å•è¯·æ±‚
       æˆ‘ä»¬çš„ä¸“å‘˜ä¼šå°½å¿«è”ç³»æ‚¨å¤„ç†
       è¯·ä¿æŒç”µè¯ç•…é€š
       
       ğŸ“‹ è¯·æ±‚å•å·ï¼šREQ20240202345678GHI

[åå°è‡ªåŠ¨å¤„ç†]
âœ… æ£€æµ‹åˆ°å®¢æˆ·ä¸å­˜åœ¨ï¼šunknown
âœ… è®¾ç½® needs_verification = true
âœ… ç´§æ€¥ç¨‹åº¦ï¼šurgentï¼ˆå–æ¶ˆè®¢å•ï¼‰
âœ… æ¨é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆğŸš¨ ç´§æ€¥ï¼Œå¸¦"å¯èƒ½æ˜¯é¦–æ¬¡è”ç³»æˆ–è”ç³»äººå˜æ›´"æç¤ºï¼‰
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### è¯·æ±‚ç±»å‹è‡ªåŠ¨è¯†åˆ«

```python
def _detect_request_type(message: str) -> Optional[str]:
    """ä»æ¶ˆæ¯ä¸­è¯†åˆ«è¯·æ±‚ç±»å‹"""
    message_lower = message.lower()
    
    if any(keyword in message_lower for keyword in ['æŸ¥è¯¢', 'æŸ¥çœ‹', 'è®¢å•', 'è¿›åº¦']):
        return 'query_order'
    
    if any(keyword in message_lower for keyword in ['æ›´æ”¹', 'ä¿®æ”¹', 'å˜æ›´']):
        return 'modify_order'
    
    if any(keyword in message_lower for keyword in ['å–æ¶ˆ', 'é€€å•']):
        return 'cancel_order'
    
    if any(keyword in message_lower for keyword in ['å”®å', 'ç»´ä¿®', 'æ•…éšœ', 'åäº†']):
        return 'aftersales'
    
    if any(keyword in message_lower for keyword in ['å’¨è¯¢', 'äº†è§£', 'è¯¢ä»·']):
        return 'inquiry'
    
    return None
```

### å®¢æˆ·èº«ä»½æ£€æµ‹é€»è¾‘

```python
# æ£€æŸ¥æ˜¯å¦éœ€è¦é”€å”®é¡¾é—®å…ˆæ·»åŠ å®¢æˆ·
needs_verification = False
verification_note = ''

if not customer:
    # å®¢æˆ·ä¸å­˜åœ¨
    needs_verification = True
    verification_note = 'å®¢æˆ·ä¸å­˜åœ¨äºç³»ç»Ÿï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è”ç³»æˆ–é¡¹ç›®è”ç³»äººå˜æ›´'

elif customer.customer_type == 'prospect':
    # å•†æœºç”¨æˆ·
    needs_verification = True
    verification_note = 'å•†æœºç”¨æˆ·ï¼Œè¿˜æœªä¸‹å•ï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡è”ç³»'

elif customer.customer_type == 'cancelled':
    # å–æ¶ˆå®¢æˆ·
    needs_verification = True
    verification_note = 'å–æ¶ˆå®¢æˆ·ï¼Œè®¢å•å·²å…¨éƒ¨å–æ¶ˆï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡äº†è§£æƒ…å†µ'

elif customer.customer_type == 'customer':
    if not customer.has_active_order:
        needs_verification = True
        verification_note = 'æ­£å¼å®¢æˆ·ä½†æš‚æ— æœ‰æ•ˆè®¢å•ï¼Œå¯èƒ½è®¢å•å·²å®Œæˆæˆ–å–æ¶ˆ'
    
    if not customer.is_verified and request_type in ['modify_order', 'cancel_order', 'aftersales']:
        needs_verification = True
        verification_note = 'å®¢æˆ·æœªé€šè¿‡ä¼ä¸šå¾®ä¿¡éªŒè¯ï¼Œè¯·å…ˆæ·»åŠ å®¢æˆ·'
```

### ç´§æ€¥ç¨‹åº¦æ˜ å°„

```python
REQUEST_URGENCY_MAP = {
    'inquiry': 'low',           # å’¨è¯¢ - ä½
    'query_order': 'normal',    # æŸ¥è¯¢è®¢å• - æ™®é€š
    'modify_order': 'high',     # æ›´æ”¹è®¢å• - é«˜
    'cancel_order': 'urgent',   # å–æ¶ˆè®¢å• - ç´§æ€¥
    'aftersales': 'high'        # å”®å - é«˜
}
```

---

## ğŸ“Š æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·å‘èµ·è¯·æ±‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†æ­¥æ”¶é›†ä¿¡æ¯ï¼š           â”‚
â”‚  1. å§“å                 â”‚
â”‚  2. ç”µè¯                 â”‚
â”‚  3. è¯·æ±‚ç±»å‹              â”‚
â”‚  4. éœ€æ±‚æè¿°              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æµ‹å®¢æˆ·èº«ä»½ï¼š                     â”‚
â”‚  â€¢ å•†æœºç”¨æˆ·ï¼ˆprospectï¼‰             â”‚
â”‚  â€¢ æ­£å¼å®¢æˆ·ï¼ˆcustomerï¼‰             â”‚
â”‚  â€¢ å–æ¶ˆå®¢æˆ·ï¼ˆcancelledï¼‰            â”‚
â”‚  â€¢ ä¸å­˜åœ¨ï¼ˆunknownï¼‰                â”‚
â”‚  â€¢ æ— æœ‰æ•ˆè®¢å•                       â”‚
â”‚  â€¢ æœªéªŒè¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ¤æ–­æ˜¯å¦éœ€è¦éªŒè¯ï¼š                 â”‚
â”‚  needs_verification = ?             â”‚
â”‚  verification_note = ?              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚          â”‚                  â”‚
       â–¼          â–¼                  â–¼
  âœ… è®°å½•     ğŸ¯ ç¡®å®šç´§æ€¥åº¦      ğŸ“± åˆ†é…é”€å”®
  è¯·æ±‚        (low/normal       é¡¾é—®
              /high/urgent)
       â”‚          â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  æ¨é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼š    â”‚
       â”‚  â€¢ å¸¦å®Œæ•´å®¢æˆ·ä¿¡æ¯      â”‚
       â”‚  â€¢ å¸¦éªŒè¯æç¤º          â”‚
       â”‚  â€¢ å¸¦ç´§æ€¥ç¨‹åº¦emoji     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  é”€å”®é¡¾é—®å¤„ç†ï¼š        â”‚
       â”‚  1. æœç´¢æ‰‹æœºå·æ·»åŠ      â”‚
       â”‚  2. äº†è§£å®¢æˆ·æƒ…å†µ       â”‚
       â”‚  3. å¤„ç†å…·ä½“è¯·æ±‚       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä¸åŸæœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

### âœ… ä¸å½±å“å”®ä¸­åŠŸèƒ½

```
å”®ä¸­åŠŸèƒ½ï¼ˆæ­£å¼å®¢æˆ· + å·²éªŒè¯ï¼‰ï¼š
- âœ… æŸ¥è¯¢è®¢å•ï¼šç›´æ¥æŸ¥è¯¢ï¼Œä¸ç»è¿‡æœåŠ¡è¯·æ±‚
- âœ… æ›´æ”¹è®¢å•ï¼šç›´æ¥å¤„ç†ï¼Œä¸ç»è¿‡æœåŠ¡è¯·æ±‚
- âœ… å–æ¶ˆè®¢å•ï¼šç›´æ¥å¤„ç†ï¼Œä¸ç»è¿‡æœåŠ¡è¯·æ±‚

æœåŠ¡è¯·æ±‚åŠŸèƒ½ï¼ˆæ‰€æœ‰å®¢æˆ·ï¼‰ï¼š
- ğŸ“ è®°å½•è¯·æ±‚
- ğŸ“± é€šçŸ¥é”€å”®
- ğŸ¤ äººå·¥ä»‹å…¥
```

### âœ… ä¸å½±å“å”®ååŠŸèƒ½

```
å”®ååŠŸèƒ½ï¼ˆæ­£å¼å®¢æˆ· + å·²éªŒè¯ + æœ‰è®¢å•ï¼‰ï¼š
- âœ… æäº¤å”®åå·¥å•ï¼šç›´æ¥æäº¤ï¼Œè‡ªåŠ¨åŒ¹é…é¡¹ç›®
- âœ… æŸ¥è¯¢å”®åè¿›åº¦ï¼šç›´æ¥æŸ¥è¯¢
- âœ… å”®åé€šçŸ¥ï¼šè‡ªåŠ¨æ¨é€

æœåŠ¡è¯·æ±‚åŠŸèƒ½ï¼ˆå…¶ä»–å®¢æˆ·ï¼‰ï¼š
- ğŸ“ è®°å½•å”®åéœ€æ±‚
- ğŸ“± é€šçŸ¥é”€å”®å…ˆæ·»åŠ 
- ğŸ¤ éªŒè¯åå¤„ç†
```

### ğŸ”„ è·¯ç”±ç­–ç•¥

```python
# ä¼ªä»£ç 
if customer.is_verified and customer.has_active_order:
    # æ­£å¼å®¢æˆ·ï¼Œèµ°åŸæœ‰æµç¨‹
    if request_type == 'query_order':
        return handle_query_order()  # ç›´æ¥æŸ¥è¯¢
    elif request_type == 'aftersales':
        return handle_aftersales()  # ç›´æ¥å”®å
else:
    # å…¶ä»–å®¢æˆ·ï¼Œèµ°æœåŠ¡è¯·æ±‚æµç¨‹
    return create_service_request()  # è®°å½•å¹¶é€šçŸ¥
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡ŒSQLæ‰©å±•
psql -U postgres -d customer_db -f backend/after_sales_extension.sql
```

### 2. é‡å¯åç«¯æœåŠ¡

```bash
cd customer-system
docker-compose restart backend
```

### 3. éªŒè¯æ¥å£

```bash
# æµ‹è¯•åˆ›å»ºæœåŠ¡è¯·æ±‚
curl -X POST http://localhost:8000/api/service/request/create \
  -H "Content-Type: application/json" \
  -d '{
    "customer_phone": "13800138000",
    "customer_name": "æµ‹è¯•ç”¨æˆ·",
    "request_type": "query_order",
    "request_content": "æµ‹è¯•æŸ¥è¯¢è®¢å•"
  }'
```

---

## ğŸ“ æµ‹è¯•åœºæ™¯

### æµ‹è¯•1ï¼šå•†æœºç”¨æˆ·æŸ¥è¯¢è®¢å•

```bash
curl -X POST http://localhost:8000/api/wechat/message/service \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘è¦æŸ¥è¯¢è®¢å•",
    "openid": "test_openid",
    "phone": "13800138000",
    "name": "å•†æœºç”¨æˆ·"
  }'
```

é¢„æœŸï¼š
- âœ… åˆ›å»ºæœåŠ¡è¯·æ±‚
- âœ… needs_verification = true
- âœ… æ¨é€é€šçŸ¥ï¼š"å•†æœºç”¨æˆ·ï¼Œè¯·å…ˆæœç´¢æ‰‹æœºå·æ·»åŠ "

### æµ‹è¯•2ï¼šå–æ¶ˆå®¢æˆ·è¦å”®å

```bash
curl -X POST http://localhost:8000/api/service/request/create \
  -H "Content-Type: application/json" \
  -d '{
    "customer_phone": "13900139000",
    "customer_name": "å–æ¶ˆå®¢æˆ·",
    "request_type": "aftersales",
    "request_content": "ç©ºè°ƒä¸åˆ¶å†·"
  }'
```

é¢„æœŸï¼š
- âœ… urgency = 'high'
- âœ… needs_verification = true
- âœ… æ¨é€é€šçŸ¥ï¼šâš ï¸ "å–æ¶ˆå®¢æˆ·ï¼Œè¯·å…ˆæ·»åŠ å¾®ä¿¡äº†è§£æƒ…å†µ"

### æµ‹è¯•3ï¼šä¸å­˜åœ¨çš„å®¢æˆ·å–æ¶ˆè®¢å•

```bash
curl -X POST http://localhost:8000/api/service/request/create \
  -H "Content-Type: application/json" \
  -d '{
    "customer_phone": "18888888888",
    "customer_name": "æ–°å®¢æˆ·",
    "request_type": "cancel_order",
    "request_content": "è¦å–æ¶ˆè®¢å•"
  }'
```

é¢„æœŸï¼š
- âœ… urgency = 'urgent'
- âœ… customer_type = 'unknown'
- âœ… æ¨é€é€šçŸ¥ï¼šğŸš¨ "å®¢æˆ·ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è”ç³»æˆ–è”ç³»äººå˜æ›´"

---

## ğŸŠ æ€»ç»“

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **åŒ…å®¹æ€§**ï¼šä¸æ‹’ç»ä»»ä½•å®¢æˆ·çš„è¯·æ±‚
2. **æ™ºèƒ½åŒ–**ï¼šè‡ªåŠ¨è¯†åˆ«å®¢æˆ·èº«ä»½å’Œè¯·æ±‚ç±»å‹
3. **äººæ€§åŒ–**ï¼šå¼•å¯¼é”€å”®é¡¾é—®å…ˆæ·»åŠ å®¢æˆ·
4. **å¯è¿½æº¯**ï¼šå®Œæ•´çš„è¯·æ±‚è®°å½•å’Œå¤„ç†æ—¥å¿—
5. **çµæ´»æ€§**ï¼šæ”¯æŒæ‰€æœ‰ä¸šåŠ¡åœºæ™¯

### ğŸ“ˆ ä¸šåŠ¡ä»·å€¼

- ğŸ’° å‡å°‘å®¢æˆ·æµå¤±ï¼šä¸å› æƒé™æ‹’ç»æ½œåœ¨å®¢æˆ·
- ğŸ¯ æå‡è½¬åŒ–ç‡ï¼šå•†æœºç”¨æˆ·ä¹Ÿèƒ½å¾—åˆ°åŠæ—¶å“åº”
- ğŸ¤ æ”¹å–„ä½“éªŒï¼šæ‰€æœ‰å®¢æˆ·éƒ½æ„Ÿå—åˆ°é‡è§†
- ğŸ“Š æ•°æ®å®Œæ•´ï¼šè®°å½•æ‰€æœ‰æœåŠ¡è¯·æ±‚
- âš¡ å“åº”å¿«é€Ÿï¼šç´§æ€¥è¯·æ±‚ä¼˜å…ˆå¤„ç†

### ğŸ”® æœªæ¥æ‰©å±•

- [ ] æ™ºèƒ½å®¢æœæœºå™¨äººï¼ˆå…ˆAIå›å¤ï¼Œå†è½¬äººå·¥ï¼‰
- [ ] å®¢æˆ·ç”»åƒåˆ†æï¼ˆæ ¹æ®è¯·æ±‚å†å²ï¼‰
- [ ] è‡ªåŠ¨å·¥å•åˆ†é…ï¼ˆè´Ÿè½½å‡è¡¡ã€ä¸“ä¸šåŒ¹é…ï¼‰
- [ ] å®¢æˆ·æ»¡æ„åº¦è°ƒæŸ¥ï¼ˆè¯·æ±‚å¤„ç†åï¼‰
- [ ] æ•°æ®å¯è§†åŒ–å¤§å±ï¼ˆå®æ—¶è¯·æ±‚ç›‘æ§ï¼‰
