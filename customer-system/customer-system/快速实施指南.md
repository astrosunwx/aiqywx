# ç”µå™¨è®¾å¤‡è¡Œä¸šåŒè½¨å¹¶è¡Œç³»ç»Ÿ - å¿«é€Ÿå®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [æ•°æ®åº“å‡çº§](#æ•°æ®åº“å‡çº§)
3. [ä»£ç éƒ¨ç½²](#ä»£ç éƒ¨ç½²)
4. [åŠŸèƒ½æµ‹è¯•](#åŠŸèƒ½æµ‹è¯•)
5. [ä¸Šçº¿æ£€æŸ¥](#ä¸Šçº¿æ£€æŸ¥)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ›  ç¯å¢ƒå‡†å¤‡

### 1. æ£€æŸ¥ç°æœ‰ç¯å¢ƒ

```bash
# æ£€æŸ¥PostgreSQLç‰ˆæœ¬ï¼ˆéœ€è¦ >= 12.0ï¼‰
psql --version

# æ£€æŸ¥Pythonç‰ˆæœ¬ï¼ˆéœ€è¦ >= 3.9ï¼‰
python --version

# æ£€æŸ¥å·²å®‰è£…çš„PythonåŒ…
pip list
```

### 2. å®‰è£…æ–°ä¾èµ–

```bash
cd backend
pip install -r requirements.txt
```

å¦‚æœ`requirements.txt`æ²¡æœ‰åŒ…å«ä»¥ä¸‹ä¾èµ–ï¼Œæ‰‹åŠ¨å®‰è£…ï¼š

```bash
pip install sqlalchemy[asyncio] asyncpg
```

---

## ğŸ—„ æ•°æ®åº“å‡çº§

### æ­¥éª¤1ï¼šå¤‡ä»½ç°æœ‰æ•°æ®åº“

```bash
# åˆ›å»ºå¤‡ä»½
pg_dump -U your_username -d customer_system > backup_$(date +%Y%m%d_%H%M%S).sql
```

### æ­¥éª¤2ï¼šæ‰§è¡Œæ‰©å±•è„šæœ¬

```bash
# è¿æ¥åˆ°æ•°æ®åº“
psql -U your_username -d customer_system

# æ‰§è¡Œæ‰©å±•è„šæœ¬
\i backend/equipment_extension.sql
```

### æ­¥éª¤3ï¼šéªŒè¯è¡¨ç»“æ„

```sql
-- æ£€æŸ¥æ–°è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
\dt

-- åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–°è¡¨ï¼š
-- opportunities (å•†æœºè¡¨)
-- orders (è®¢å•è¡¨)
-- equipment (è®¾å¤‡æ¡£æ¡ˆè¡¨)
-- maintenance_records (ç»´æŠ¤è®°å½•è¡¨)
-- parts_inventory (é…ä»¶åº“å­˜è¡¨)
-- parts_usage (é…ä»¶é¢†ç”¨è®°å½•è¡¨)
-- operation_logs (æ“ä½œæ—¥å¿—è¡¨)
-- data_dictionary (æ•°æ®å­—å…¸è¡¨)

-- æ£€æŸ¥projectsè¡¨æ˜¯å¦æ·»åŠ äº†æ–°å­—æ®µ
\d projects

-- åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–°å­—æ®µï¼š
-- opportunity_id
-- order_id
-- equipment_id
-- root_cause
-- solution
-- parts_used
-- service_duration_hours
-- customer_rating
-- customer_feedback
```

### æ­¥éª¤4ï¼šæ’å…¥æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰

```sql
-- æ’å…¥æµ‹è¯•å•†æœº
INSERT INTO opportunities (customer_phone, customer_name, product_name, quantity, estimated_amount, status, sales_userid, sales_name, source, requirements)
VALUES ('13800138000', 'æµ‹è¯•å…¬å¸', 'å•†ç”¨ä¸­å¤®ç©ºè°ƒ', 10, 185000.00, 'new', 'test_sales', 'æµ‹è¯•é”€å”®', 'å…¬ä¼—å·', '300å¹³ç±³åŠå…¬å®¤éœ€è¦ä¸­å¤®ç©ºè°ƒ');

-- æ’å…¥æµ‹è¯•é…ä»¶
INSERT INTO parts_inventory (part_code, part_name, category, specification, applicable_models, stock_quantity, unit_price, supplier, min_stock_alert)
VALUES 
('TEST-COMP-001', 'æµ‹è¯•å‹ç¼©æœº', 'compressor', 'æµ‹è¯•è§„æ ¼', 'é€šç”¨', 10, 500.00, 'æµ‹è¯•ä¾›åº”å•†', 3),
('TEST-FILTER-001', 'æµ‹è¯•æ»¤ç½‘', 'filter', 'é€šç”¨å‹', 'æ‰€æœ‰ç©ºè°ƒ', 50, 20.00, 'æµ‹è¯•ä¾›åº”å•†', 10);
```

---

## ğŸš€ ä»£ç éƒ¨ç½²

### æ­¥éª¤1ï¼šæ›´æ–°åç«¯ä»£ç 

```bash
cd backend

# ç¡®è®¤æ–°æ–‡ä»¶å·²æ·»åŠ 
ls -la app/services/

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–°æ–‡ä»¶ï¼š
# - opportunity_service.py (å•†æœºç®¡ç†)
# - order_service.py (è®¢å•ç®¡ç†)
# - equipment_service.py (è®¾å¤‡ç®¡ç†)
# - parts_service.py (é…ä»¶ç®¡ç†)
# - maintenance_reminder_service.py (ç»´æŠ¤æé†’)
# - group_bot_command_service.py (ç¾¤æœºå™¨äººå‘½ä»¤)
```

### æ­¥éª¤2ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨Docker
docker-compose restart backend

# å¦‚æœç›´æ¥è¿è¡Œ
# å…ˆåœæ­¢ç°æœ‰è¿›ç¨‹ï¼Œç„¶å
python app/main.py

# æˆ–ä½¿ç”¨uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥APIæ˜¯å¦æ­£å¸¸
curl http://localhost:8000/health

# åº”è¯¥è¿”å›:
# {"status":"healthy"}

# æ£€æŸ¥APIæ–‡æ¡£
# æµè§ˆå™¨è®¿é—®: http://localhost:8000/docs
```

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•1ï¼šå•†æœºç®¡ç†API

```bash
# åˆ›å»ºå•†æœº
curl -X POST http://localhost:8000/api/opportunities \
  -H "Content-Type: application/json" \
  -d '{
    "customer_phone": "13900139000",
    "product_name": "ä¸­å¤®ç©ºè°ƒ",
    "requirements": "åŠå…¬å®¤éœ€è¦10å°ä¸­å¤®ç©ºè°ƒ",
    "sales_userid": "test_sales",
    "sales_name": "æµ‹è¯•é”€å”®",
    "quantity": 10,
    "estimated_amount": 200000
  }'

# è®¤é¢†å•†æœºï¼ˆå‡è®¾å•†æœºIDä¸º1ï¼‰
curl -X POST http://localhost:8000/api/opportunities/1/claim \
  -H "Content-Type: application/json" \
  -d '{
    "sales_userid": "test_sales",
    "sales_name": "æµ‹è¯•é”€å”®"
  }'
```

### æµ‹è¯•2ï¼šé…ä»¶æŸ¥è¯¢API

```bash
# æŸ¥è¯¢é…ä»¶
curl http://localhost:8000/api/parts/TEST-COMP-001

# ç”³è¯·é…ä»¶ï¼ˆå‡è®¾å·¥å•IDä¸º1ï¼‰
curl -X POST http://localhost:8000/api/parts/request \
  -H "Content-Type: application/json" \
  -d '{
    "ticket_id": 1,
    "part_code": "TEST-COMP-001",
    "quantity": 1,
    "engineer_userid": "test_engineer",
    "engineer_name": "æµ‹è¯•å·¥ç¨‹å¸ˆ"
  }'
```

### æµ‹è¯•3ï¼šç¾¤æœºå™¨äººå‘½ä»¤

```bash
# æµ‹è¯•ç¾¤å‘½ä»¤å¤„ç†
curl -X POST http://localhost:8000/api/group/command \
  -H "Content-Type: application/json" \
  -d '{
    "command": "#æŸ¥è¯¢é…ä»¶ TEST-COMP-001",
    "operator_userid": "test_user",
    "operator_name": "æµ‹è¯•ç”¨æˆ·"
  }'
```

---

## âœ… ä¸Šçº¿æ£€æŸ¥æ¸…å•

### æ•°æ®åº“æ£€æŸ¥

- [ ] æ•°æ®åº“å¤‡ä»½å·²åˆ›å»º
- [ ] æ‰€æœ‰æ–°è¡¨å·²åˆ›å»ºæˆåŠŸ
- [ ] Projectsè¡¨å­—æ®µå·²æ‰©å±•
- [ ] æ•°æ®å­—å…¸å·²åˆå§‹åŒ–
- [ ] æµ‹è¯•æ•°æ®å·²æ’å…¥å¹¶éªŒè¯

### ä»£ç æ£€æŸ¥

- [ ] æ‰€æœ‰æ–°æœåŠ¡æ–‡ä»¶å·²éƒ¨ç½²
- [ ] Models.pyå·²æ›´æ–°
- [ ] åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] APIæ–‡æ¡£å¯è®¿é—®
- [ ] Healthæ£€æŸ¥æ¥å£æ­£å¸¸

### åŠŸèƒ½æ£€æŸ¥

- [ ] å•†æœºåˆ›å»º/è®¤é¢†åŠŸèƒ½æ­£å¸¸
- [ ] è®¢å•ç”ŸæˆåŠŸèƒ½æ­£å¸¸
- [ ] é…ä»¶æŸ¥è¯¢/ç”³è¯·åŠŸèƒ½æ­£å¸¸
- [ ] ç¾¤å‘½ä»¤å¤„ç†åŠŸèƒ½æ­£å¸¸
- [ ] æ“ä½œæ—¥å¿—è®°å½•æ­£å¸¸

### ä¼ä¸šå¾®ä¿¡é…ç½®

- [ ] ç¾¤æœºå™¨äººWebhookå·²é…ç½®
- [ ] æ¶ˆæ¯å¡ç‰‡æ¨¡æ¿å·²è°ƒè¯•
- [ ] å‘½ä»¤å“åº”é€Ÿåº¦æ­£å¸¸
- [ ] é€šçŸ¥æ¨é€åŠŸèƒ½æ­£å¸¸

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š** å¯åŠ¨æ—¶æŠ¥é”™ `could not connect to database`

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œ
docker-compose ps

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat backend/.env | grep DATABASE

# ç¡®ä¿DATABASE_URLæ ¼å¼æ­£ç¡®
# postgresql://user:password@host:port/database
```

### Q2: å¯¼å…¥æ¨¡å—å¤±è´¥

**ç—‡çŠ¶ï¼š** `ImportError: cannot import name 'Opportunity' from 'app.models'`

**è§£å†³ï¼š**
```bash
# é‡æ–°å®‰è£…ä¾èµ–
pip install -r backend/requirements.txt

# é‡å¯Pythonè¿›ç¨‹
# æ¸…é™¤__pycache__
find . -type d -name "__pycache__" -exec rm -rf {} +
```

### Q3: ç¾¤å‘½ä»¤æ— å“åº”

**ç—‡çŠ¶ï¼š** åœ¨ç¾¤é‡Œå‘é€å‘½ä»¤æ²¡æœ‰ä»»ä½•ååº”

**è§£å†³ï¼š**
1. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡APIé…ç½®æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥Webhook URLæ˜¯å¦æœ‰æ•ˆ
3. æŸ¥çœ‹åç«¯æ—¥å¿—æ’æŸ¥é”™è¯¯
4. ç¡®è®¤å‘½ä»¤æ ¼å¼æ˜¯å¦æ­£ç¡®

### Q4: é…ä»¶åº“å­˜æ‰£å‡å¤±è´¥

**ç—‡çŠ¶ï¼š** ç”³è¯·é…ä»¶æ—¶æç¤ºåº“å­˜ä¸è¶³ï¼Œä½†å®é™…æœ‰åº“å­˜

**è§£å†³ï¼š**
```sql
-- æ£€æŸ¥é…ä»¶åº“å­˜
SELECT part_code, part_name, stock_quantity FROM parts_inventory WHERE part_code = 'XXX';

-- æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„äº‹åŠ¡é”å®šäº†è®°å½•
SELECT * FROM pg_locks WHERE relation = 'parts_inventory'::regclass;

-- æ‰‹åŠ¨æ›´æ–°åº“å­˜ï¼ˆè°¨æ…æ“ä½œï¼‰
UPDATE parts_inventory SET stock_quantity = 10 WHERE part_code = 'XXX';
```

### Q5: ç»´æŠ¤æé†’æœªè§¦å‘

**ç—‡çŠ¶ï¼š** è®¾å¤‡ç»´æŠ¤æ—¥æœŸå·²åˆ°ï¼Œä½†æœªæ”¶åˆ°æé†’

**è§£å†³ï¼š**
1. æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ˜¯å¦é…ç½®
2. æ‰‹åŠ¨æµ‹è¯•æé†’æœåŠ¡ï¼š

```python
from app.services.maintenance_reminder_service import MaintenanceReminderService
from app.database import get_db

async def test_reminder():
    async for db in get_db():
        reminders = await MaintenanceReminderService.check_and_send_maintenance_reminders(db, days_ahead=30)
        print(f"å‘é€äº† {len(reminders)} æ¡æé†’")
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **é”™è¯¯æ—¥å¿—ï¼š** å®Œæ•´çš„é”™è¯¯å †æ ˆä¿¡æ¯
2. **ç¯å¢ƒä¿¡æ¯ï¼š** Pythonç‰ˆæœ¬ã€PostgreSQLç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿ
3. **å¤ç°æ­¥éª¤ï¼š** è¯¦ç»†æè¿°å¦‚ä½•è§¦å‘é—®é¢˜
4. **ç›¸å…³æ•°æ®ï¼š** é—®é¢˜ç›¸å…³çš„æ•°æ®åº“è®°å½•ï¼ˆè„±æ•åï¼‰

---

## ğŸ“š ä¸‹ä¸€æ­¥

ç³»ç»ŸæˆåŠŸä¸Šçº¿åï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹å·¥ä½œï¼š

1. **ç”¨æˆ·åŸ¹è®­ï¼š** åŸ¹è®­é”€å”®å’Œå·¥ç¨‹å¸ˆä½¿ç”¨ç¾¤å‘½ä»¤
2. **æ•°æ®è¿ç§»ï¼š** å°†å†å²å®¢æˆ·æ•°æ®å¯¼å…¥æ–°ç³»ç»Ÿ
3. **æ€§èƒ½ç›‘æ§ï¼š** è®¾ç½®APIå“åº”æ—¶é—´ç›‘æ§
4. **å®šæœŸå¤‡ä»½ï¼š** é…ç½®è‡ªåŠ¨æ•°æ®åº“å¤‡ä»½è®¡åˆ’
5. **åŠŸèƒ½ä¼˜åŒ–ï¼š** æ ¹æ®ç”¨æˆ·åé¦ˆæŒç»­æ”¹è¿›

---

**ç‰ˆæœ¬ï¼š** v1.0  
**æ›´æ–°æ—¶é—´ï¼š** 2026å¹´2æœˆ2æ—¥  
**ç»´æŠ¤äººå‘˜ï¼š** ç³»ç»Ÿç®¡ç†å‘˜
