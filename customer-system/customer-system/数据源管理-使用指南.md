# 多数据源管理功能 - 使用指南

## 📌 功能说明

为了解决多个项目库的同步需求,我们新增了**数据源管理**功能,支持配置多个远程数据库连接。

### ✨ 主要特性

- ✅ 支持添加、编辑、删除多个数据源
- ✅ 支持MySQL、PostgreSQL数据库(SQL Server即将支持)
- ✅ 一键测试数据库连接
- ✅ 设置默认数据源用于自动同步
- ✅ 密码加密存储,安全可靠
- ✅ 支持SSL加密连接

## 🚀 访问入口

### 方式一:通过项目同步配置页面
1. 打开配置中心: http://localhost:3000/config
2. 点击左侧菜单 "项目同步"
3. 页面顶部会显示 "数据源管理" 卡片
4. 点击 "管理数据源 →" 按钮

### 方式二:直接访问
- 直接访问: http://localhost:3000/datasource

## 📋 使用步骤

### 1. 添加数据源

点击右上角 "添加数据源" 按钮,填写以下信息:

| 字段 | 说明 | 示例 |
|------|------|------|
| 数据源名称 | 唯一标识,建议使用有意义的名称 | 客户A项目库、测试环境DB |
| 描述 | 可选,描述用途 | 用于同步客户A的售后项目数据 |
| 数据库类型 | MySQL / PostgreSQL | MySQL |
| 主机地址 | IP或域名 | 192.168.1.100 或 db.example.com |
| 端口号 | 数据库端口 | MySQL:3306, PostgreSQL:5432 |
| 数据库名 | 要连接的数据库 | customer_projects |
| 用户名 | 数据库登录用户 | dbuser |
| 密码 | 数据库密码 | ******(加密存储) |
| 字符集 | 可选,默认utf8mb4 | utf8mb4 |
| 启用SSL | 是否使用SSL连接 | 根据实际情况选择 |
| 启用状态 | 是否启用此数据源 | 开启 |
| 设为默认 | 作为默认数据源 | 第一个建议设为默认 |

### 2. 测试连接

添加数据源后,点击 "测试连接" 按钮,确保配置正确:
- ✅ 成功:显示 "连接 xxx 成功!"
- ❌ 失败:显示具体错误信息,请检查配置

### 3. 设置默认数据源

如果有多个数据源,可以点击 "设为默认" 按钮,将某个数据源设为默认:
- 默认数据源会在项目自动同步时使用
- 同一时间只能有一个默认数据源
- 默认数据源会显示绿色 "默认" 标签

### 4. 编辑和删除

- **编辑**: 点击 "编辑" 按钮修改数据源配置
- **删除**: 点击 "删除" 按钮移除数据源(需确认)

## 🎯 典型使用场景

### 场景1:单一客户项目库
```
数据源名称: 主项目库
数据库类型: MySQL
主机: localhost
端口: 3306
数据库: customer_projects
设为默认: 是
```

### 场景2:多个客户独立库
```
数据源1:
  名称: 客户A-生产库
  主机: 192.168.1.100
  数据库: client_a_projects
  设为默认: 是

数据源2:
  名称: 客户B-生产库
  主机: 192.168.1.101
  数据库: client_b_projects
  设为默认: 否
  
数据源3:
  名称: 测试环境
  主机: 192.168.1.200
  数据库: test_projects
  启用状态: 否 (暂时不用)
```

### 场景3:开发/测试/生产环境
```
开发环境:
  名称: DEV-项目库
  主机: localhost
  启用: 是
  
测试环境:
  名称: TEST-项目库
  主机: test.example.com
  启用: 否
  
生产环境:
  名称: PROD-项目库
  主机: prod.example.com
  设为默认: 是
```

## 🔒 安全建议

1. **密码安全**
   - 系统使用Base64编码存储密码(建议后续升级为AES加密)
   - 建议使用只读权限账号进行同步
   - 定期更换数据库密码

2. **网络安全**
   - 生产环境建议启用SSL连接
   - 限制数据库访问IP白名单
   - 使用VPN或专网连接远程数据库

3. **权限控制**
   - 数据库用户只授予必要的SELECT权限
   - 不要使用root或admin账号
   - 为不同数据源创建独立的数据库用户

## 📊 数据表结构

系统会在SQLite中创建 `data_sources` 表:

```sql
CREATE TABLE data_sources (
    id INTEGER PRIMARY KEY,
    source_name TEXT UNIQUE,      -- 数据源名称
    source_desc TEXT,             -- 描述
    db_type TEXT,                 -- 数据库类型
    db_host TEXT,                 -- 主机
    db_port INTEGER,              -- 端口
    db_name TEXT,                 -- 数据库名
    db_username TEXT,             -- 用户名
    db_password TEXT,             -- 密码(加密)
    db_charset TEXT,              -- 字符集
    use_ssl BOOLEAN,              -- SSL
    is_active BOOLEAN,            -- 是否启用
    is_default BOOLEAN,           -- 是否默认
    created_at TIMESTAMP,         -- 创建时间
    updated_at TIMESTAMP          -- 更新时间
);
```

## 🔧 API接口

后端提供以下API接口:

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/datasources/` | GET | 获取所有数据源 |
| `/api/datasources/` | POST | 创建新数据源 |
| `/api/datasources/{id}` | GET | 获取单个数据源 |
| `/api/datasources/{id}` | PUT | 更新数据源 |
| `/api/datasources/{id}` | DELETE | 删除数据源 |
| `/api/datasources/{id}/test` | POST | 测试连接 |
| `/api/datasources/{id}/set-default` | POST | 设为默认 |

## ❓ 常见问题

### Q1: 为什么从配置中心移除了远程数据库配置?
A: 原来的配置中心采用静态配置项设计,每个字段只能配置一个值,无法支持多个数据库连接。新的数据源管理采用动态列表设计,可以无限添加多个数据源。

### Q2: 已经在配置中心填写的远程数据库信息怎么办?
A: 如果之前填写过远程数据库配置,请手动添加到数据源管理中。配置中心的远程数据库配置已移除。

### Q3: 测试连接失败怎么办?
A: 请检查:
   1. 数据库服务是否启动
   2. 主机地址和端口是否正确
   3. 用户名密码是否正确
   4. 网络连接是否正常
   5. 防火墙是否放行端口
   6. 数据库是否允许远程连接

### Q4: SQL Server支持什么时候推出?
A: SQL Server连接需要安装 `aioodbc` 或 `pyodbc` 库,预计近期支持。

### Q5: 如何在项目同步中使用指定数据源?
A: 当前版本默认使用标记为"默认"的数据源。未来版本将支持手动选择数据源进行同步。

## 📞 技术支持

如有问题,请查看:
- API文档: http://localhost:8001/docs
- 后端日志: `backend/logs/`
- 前端控制台(F12)

---

**版本**: v1.0.0  
**更新时间**: 2026-02-03  
**文档作者**: AI助手
