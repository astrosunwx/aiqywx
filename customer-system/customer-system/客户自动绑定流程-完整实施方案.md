# å®¢æˆ·è‡ªåŠ¨ç»‘å®šæµç¨‹ - å®Œæ•´å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [æœåŠ¡å®ç°](#æœåŠ¡å®ç°)
- [APIæ¥å£](#apiæ¥å£)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)

---

## åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒéœ€æ±‚
è§£å†³å®¢æˆ·åœ¨å…¬ä¼—å·æŸ¥è¯¢é¡¹ç›®è¿›åº¦æ—¶çš„èº«ä»½éªŒè¯é—®é¢˜ï¼Œ**é¿å…ä½¿ç”¨çŸ­ä¿¡éªŒè¯ç **ï¼Œè€Œæ˜¯é€šè¿‡ä¼ä¸šå¾®ä¿¡çš„"æœç´¢æ‰‹æœºå·æ·»åŠ "åŠŸèƒ½è¿›è¡Œèº«ä»½æ ¸éªŒã€‚

### è®¾è®¡ç†å¿µ
- **æ— æ„Ÿç»‘å®š**ï¼šå®¢æˆ·åªéœ€åœ¨å…¬ä¼—å·å‘é€æ‰‹æœºå·ï¼Œæ— éœ€é¢å¤–æ“ä½œ
- **åŒå‘å…³è”**ï¼šå…¬ä¼—å·OpenID + ä¼ä¸šå¾®ä¿¡ExternalUserID åŒæ—¶ç»‘å®š
- **å®‰å…¨éªŒè¯**ï¼šåªæœ‰é€šè¿‡ä¼ä¸šå¾®ä¿¡æœç´¢æ‰‹æœºå·æ·»åŠ çš„å®¢æˆ·æ‰èƒ½æŸ¥è¯¢é¡¹ç›®
- **è‡ªåŠ¨åŒ–**ï¼šå…¨æµç¨‹è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

---

## ä¸šåŠ¡æµç¨‹

### æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·è‡ªåŠ¨ç»‘å®šå®Œæ•´æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸€é˜¶æ®µï¼šå®¢æˆ·æäº¤æ‰‹æœºå·ï¼ˆå…¬ä¼—å·ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·å…³æ³¨å…¬ä¼—å· â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·å‘é€æ‰‹æœºå·     â”‚â”€â”€â”€â”€â”€â–¶â”‚ ç³»ç»ŸéªŒè¯æ ¼å¼           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ åˆ›å»ºä¸´æ—¶ç»‘å®šè®°å½•         â”‚
                         â”‚ - wechat_openid         â”‚
                         â”‚ - phone_number          â”‚
                         â”‚ - status: waiting       â”‚
                         â”‚ - expires_at: +48å°æ—¶   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ å›å¤å®¢æˆ·                â”‚
                         â”‚ "å·²æ”¶åˆ°ï¼Œè¯·è”ç³»é”€å”®äººå‘˜" â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒé˜¶æ®µï¼šä¼ä¸šå¾®ä¿¡å‘˜å·¥æ·»åŠ å®¢æˆ·
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”€å”®äººå‘˜åœ¨ä¼ä¸šå¾®ä¿¡ â”‚
â”‚ æœç´¢å®¢æˆ·æ‰‹æœºå·     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‚¹å‡»"æ·»åŠ å®¢æˆ·"     â”‚â”€â”€â”€â”€â”€â–¶â”‚ ä¼ä¸šå¾®ä¿¡æ¨é€å›è°ƒäº‹ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ Event: add_external_   â”‚
                          â”‚        contact         â”‚
                          â”‚ add_way: 2 (æœç´¢æ‰‹æœºå·) â”‚
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ å›è°ƒæ•°æ®                â”‚
                         â”‚ - ExternalUserID        â”‚
                         â”‚ - UserID (å‘˜å·¥)         â”‚
                         â”‚ - add_way: 2            â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ è°ƒç”¨ä¼ä¸šå¾®ä¿¡API          â”‚
                         â”‚ get_external_contact()  â”‚
                         â”‚ è·å–å®¢æˆ·è¯¦ç»†ä¿¡æ¯         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ ä»APIå“åº”æå–æ‰‹æœºå·      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªåŠ¨ç»‘å®š
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ æŸ¥æ‰¾ä¸´æ—¶ç»‘å®šè®°å½•         â”‚
                         â”‚ WHERE phone = ?         â”‚
                         â”‚   AND status = waiting  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                         â”‚ æ‰¾åˆ°ï¼Ÿ      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           Yes  â”‚   No
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                         â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ è‡ªåŠ¨ç»‘å®š         â”‚      â”‚ ä»…åˆ›å»ºä¼ä¸šå¾®ä¿¡   â”‚
          â”‚ - åˆ›å»º/æ›´æ–°Customerâ”‚     â”‚ å®¢æˆ·è®°å½•         â”‚
          â”‚ - wework_userid  â”‚      â”‚ binding_status:  â”‚
          â”‚ - wechat_openid  â”‚      â”‚ unbound         â”‚
          â”‚ - binding_status â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚   = 'bound'      â”‚
          â”‚ - bound_at = NOW â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ è®°å½•äº‹ä»¶åˆ°       â”‚
          â”‚ wework_customer_ â”‚
          â”‚ eventsè¡¨         â”‚
          â”‚ (add_way=2)     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æ›´æ–°ä¸´æ—¶ç»‘å®šçŠ¶æ€ â”‚
          â”‚ status = bound  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ å‘é€æ¬¢è¿æ¶ˆæ¯     â”‚
          â”‚ åˆ°ä¼ä¸šå¾®ä¿¡       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å››é˜¶æ®µï¼šå®¢æˆ·æŸ¥è¯¢é¡¹ç›®ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·åœ¨å…¬ä¼—å·å‘é€   â”‚
â”‚ "æŸ¥è¯¢é¡¹ç›®è¿›åº¦"     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿæ£€æŸ¥æƒé™       â”‚â”€â”€â”€â”€â”€â–¶â”‚ check_customer_can_    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ query(phone)           â”‚
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                         â”‚ éªŒè¯æ¡ä»¶ï¼š   â”‚
                         â”‚ 1. Customer â”‚
                         â”‚    å­˜åœ¨      â”‚
                         â”‚ 2. binding_ â”‚
                         â”‚    status =  â”‚
                         â”‚    'bound'   â”‚
                         â”‚ 3. å­˜åœ¨Event â”‚
                         â”‚    add_way=2â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                         â”‚ é€šè¿‡ï¼Ÿ      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           Yes  â”‚   No
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                         â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ è¿”å›é¡¹ç›®æ•°æ®     â”‚      â”‚ è¿”å›é”™è¯¯æç¤º     â”‚
          â”‚ - è®¢å•ä¿¡æ¯       â”‚      â”‚ "è¯·å…ˆè”ç³»é”€å”®    â”‚
          â”‚ - è¿›åº¦çŠ¶æ€       â”‚      â”‚  äººå‘˜æ·»åŠ æ‚¨"     â”‚
          â”‚ - è®¾å¤‡æ¡£æ¡ˆ       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç»„ä»¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¾®ä¿¡å…¬ä¼—å·         â”‚  ä¼ä¸šå¾®ä¿¡                         â”‚
â”‚  - å‘é€æ‰‹æœºå·       â”‚  - æœç´¢æ‰‹æœºå·æ·»åŠ å®¢æˆ·              â”‚
â”‚  - æŸ¥è¯¢é¡¹ç›®         â”‚  - æ¨é€å›è°ƒäº‹ä»¶                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIç½‘å…³å±‚ (FastAPI)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/binding/temp           - åˆ›å»ºä¸´æ—¶ç»‘å®š             â”‚
â”‚  /api/wework/callback        - æ¥æ”¶ä¼ä¸šå¾®ä¿¡å›è°ƒ          â”‚
â”‚  /api/customer/binding-status - æŸ¥è¯¢ç»‘å®šçŠ¶æ€            â”‚
â”‚  /api/customer/can-query     - æ£€æŸ¥æŸ¥è¯¢æƒé™             â”‚
â”‚  /api/wework/manual-bind     - æ‰‹åŠ¨ç»‘å®šï¼ˆè¡¥æ•‘ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡æœåŠ¡å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AutoBindingService                                     â”‚
â”‚  â”œâ”€ create_temp_binding()                               â”‚
â”‚  â”œâ”€ handle_wework_add_customer_event()                  â”‚
â”‚  â”œâ”€ auto_bind_customer()                                â”‚
â”‚  â”œâ”€ check_customer_can_query()                          â”‚
â”‚  â”œâ”€ check_binding_status()                              â”‚
â”‚  â””â”€ clean_expired_temp_bindings()                       â”‚
â”‚                                                         â”‚
â”‚  WeChatService                                          â”‚
â”‚  â”œâ”€ get_external_contact_info()                         â”‚
â”‚  â””â”€ send_welcome_message()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®æŒä¹…å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL Database                                    â”‚
â”‚  â”œâ”€ customers (å®¢æˆ·ä¸»è¡¨)                                â”‚
â”‚  â”œâ”€ temp_bindings (ä¸´æ—¶ç»‘å®š)                            â”‚
â”‚  â””â”€ wework_customer_events (ä¼ä¸šå¾®ä¿¡äº‹ä»¶)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®åº“è®¾è®¡

### 1. customers è¡¨ï¼ˆå®¢æˆ·ä¸»è¡¨ï¼‰
**æ–°å¢å­—æ®µ**ï¼š
```sql
ALTER TABLE customers ADD COLUMN wework_userid VARCHAR(100);
ALTER TABLE customers ADD COLUMN wechat_openid VARCHAR(100);
ALTER TABLE customers ADD COLUMN company VARCHAR(200);
ALTER TABLE customers ADD COLUMN binding_status VARCHAR(20) DEFAULT 'unbound';
ALTER TABLE customers ADD COLUMN bound_at TIMESTAMP;
ALTER TABLE customers ADD COLUMN bound_by VARCHAR(100);

-- çº¦æŸ
ALTER TABLE customers ADD CONSTRAINT chk_binding_status 
    CHECK (binding_status IN ('unbound', 'partial', 'bound'));

-- ç´¢å¼•
CREATE INDEX idx_customers_wework_userid ON customers(wework_userid);
CREATE INDEX idx_customers_wechat_openid ON customers(wechat_openid);
CREATE INDEX idx_customers_binding_status ON customers(binding_status);
```

**å­—æ®µè¯´æ˜**ï¼š
- `wework_userid`: ä¼ä¸šå¾®ä¿¡å¤–éƒ¨è”ç³»äººID
- `wechat_openid`: å…¬ä¼—å·OpenID
- `company`: å®¢æˆ·å…¬å¸åç§°ï¼ˆä»ä¼ä¸šå¾®ä¿¡è·å–ï¼‰
- `binding_status`: ç»‘å®šçŠ¶æ€
  - `unbound`: æœªç»‘å®š
  - `partial`: éƒ¨åˆ†ç»‘å®šï¼ˆåªæœ‰å…¬ä¼—å·æˆ–åªæœ‰ä¼ä¸šå¾®ä¿¡ï¼‰
  - `bound`: å®Œå…¨ç»‘å®šï¼ˆä¸¤è€…éƒ½æœ‰ï¼‰
- `bound_at`: ç»‘å®šå®Œæˆæ—¶é—´
- `bound_by`: ç»‘å®šæ“ä½œäººï¼ˆé€šå¸¸æ˜¯æ·»åŠ å®¢æˆ·çš„é”€å”®äººå‘˜UserIDï¼‰

### 2. temp_bindings è¡¨ï¼ˆä¸´æ—¶ç»‘å®šï¼‰
```sql
CREATE TABLE temp_bindings (
    id SERIAL PRIMARY KEY,
    wechat_openid VARCHAR(100) NOT NULL,
    phone_number VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'waiting',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    bound_at TIMESTAMP,
    CONSTRAINT chk_temp_binding_status 
        CHECK (status IN ('waiting', 'bound', 'expired'))
);

CREATE INDEX idx_temp_bindings_phone ON temp_bindings(phone_number);
CREATE INDEX idx_temp_bindings_status ON temp_bindings(status);
CREATE INDEX idx_temp_bindings_expires_at ON temp_bindings(expires_at);

COMMENT ON TABLE temp_bindings IS 'å…¬ä¼—å·ä¸´æ—¶ç»‘å®šè®°å½•ï¼Œç­‰å¾…ä¼ä¸šå¾®ä¿¡å‘˜å·¥æ·»åŠ ';
COMMENT ON COLUMN temp_bindings.status IS 'waiting:ç­‰å¾…, bound:å·²ç»‘å®š, expired:å·²è¿‡æœŸ';
COMMENT ON COLUMN temp_bindings.expires_at IS 'è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºå48å°æ—¶ï¼‰';
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š
1. å®¢æˆ·åœ¨å…¬ä¼—å·å‘é€æ‰‹æœºå· â†’ åˆ›å»ºè®°å½•ï¼ˆstatus=waitingï¼‰
2. ä¼ä¸šå¾®ä¿¡å‘˜å·¥æ·»åŠ  â†’ è‡ªåŠ¨ç»‘å®šï¼ˆstatus=boundï¼‰
3. 48å°æ—¶æœªæ·»åŠ  â†’ è¿‡æœŸï¼ˆstatus=expiredï¼‰
4. å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸè®°å½•

### 3. wework_customer_events è¡¨ï¼ˆä¼ä¸šå¾®ä¿¡äº‹ä»¶ï¼‰
```sql
CREATE TABLE wework_customer_events (
    id SERIAL PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    external_userid VARCHAR(100) NOT NULL,
    employee_userid VARCHAR(100) NOT NULL,
    customer_phone VARCHAR(20),
    add_way INTEGER,
    state VARCHAR(100),
    raw_event_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_add_way 
        CHECK (add_way IS NULL OR add_way IN (1,2,3,4,5,6,7,8,9,10,201,202))
);

CREATE INDEX idx_wework_events_external_userid ON wework_customer_events(external_userid);
CREATE INDEX idx_wework_events_phone ON wework_customer_events(customer_phone);
CREATE INDEX idx_wework_events_add_way ON wework_customer_events(add_way);

COMMENT ON TABLE wework_customer_events IS 'ä¼ä¸šå¾®ä¿¡å®¢æˆ·äº‹ä»¶è®°å½•';
COMMENT ON COLUMN wework_customer_events.add_way IS 'æ·»åŠ æ–¹å¼ï¼š2=æœç´¢æ‰‹æœºå·ï¼ˆå®‰å…¨ï¼‰';
```

**add_way å€¼è¯´æ˜**ï¼ˆæ¥è‡ªä¼ä¸šå¾®ä¿¡æ–‡æ¡£ï¼‰ï¼š
- `1`: æ‰«æäºŒç»´ç 
- `2`: **æœç´¢æ‰‹æœºå·**ï¼ˆæœ€å®‰å…¨ï¼Œç”¨äºèº«ä»½éªŒè¯ï¼‰
- `3`: åç‰‡åˆ†äº«
- `4`: ç¾¤èŠ
- `5`: æ‰‹æœºé€šè®¯å½•
- `6`: å¾®ä¿¡è”ç³»äºº
- `7`: æ¥è‡ªå¾®ä¿¡çš„æ·»åŠ å¥½å‹ç”³è¯·
- `8`: å®‰è£…ç¬¬ä¸‰æ–¹åº”ç”¨æ—¶è‡ªåŠ¨æ·»åŠ çš„å®¢æœäººå‘˜
- `9`: æœç´¢é‚®ç®±
- `10`: è§†é¢‘å·ä¸»é¡µæ·»åŠ 
- `201`: å†…éƒ¨æˆå‘˜å…±äº«
- `202`: ç®¡ç†å‘˜/è´Ÿè´£äººåˆ†é…

---

## æœåŠ¡å®ç°

### AutoBindingService æ ¸å¿ƒæ–¹æ³•

#### 1. åˆ›å»ºä¸´æ—¶ç»‘å®š
```python
async def create_temp_binding(
    db: AsyncSession,
    wechat_openid: str,
    phone_number: str
) -> Dict:
    """
    å®¢æˆ·åœ¨å…¬ä¼—å·å‘é€æ‰‹æœºå·ï¼Œåˆ›å»ºä¸´æ—¶ç»‘å®šè®°å½•
    
    ä¸šåŠ¡é€»è¾‘ï¼š
    1. éªŒè¯æ‰‹æœºå·æ ¼å¼
    2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æœªè¿‡æœŸçš„è®°å½•
    3. åˆ›å»ºæ–°è®°å½•ï¼Œ48å°æ—¶åè¿‡æœŸ
    4. è¿”å›æç¤ºä¿¡æ¯
    """
```

#### 2. å¤„ç†ä¼ä¸šå¾®ä¿¡æ·»åŠ äº‹ä»¶
```python
async def handle_wework_add_customer_event(
    db: AsyncSession,
    event_data: Dict
) -> Dict:
    """
    ä¼ä¸šå¾®ä¿¡æ¨é€"æ·»åŠ å®¢æˆ·"å›è°ƒæ—¶è°ƒç”¨
    
    ä¸šåŠ¡é€»è¾‘ï¼š
    1. è§£æå›è°ƒæ•°æ®ï¼ˆExternalUserID, UserID, add_wayï¼‰
    2. è°ƒç”¨ä¼ä¸šå¾®ä¿¡APIè·å–å®¢æˆ·è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ‰‹æœºå·ï¼‰
    3. è°ƒç”¨ auto_bind_customer() å®Œæˆç»‘å®š
    4. è®°å½•äº‹ä»¶åˆ° wework_customer_events è¡¨
    5. å‘é€æ¬¢è¿æ¶ˆæ¯
    """
```

#### 3. è‡ªåŠ¨ç»‘å®šå®¢æˆ·
```python
async def auto_bind_customer(
    db: AsyncSession,
    customer_phone: str,
    external_userid: str,
    employee_userid: str
) -> Dict:
    """
    æ ¸å¿ƒç»‘å®šé€»è¾‘
    
    ä¸šåŠ¡é€»è¾‘ï¼š
    1. æŸ¥æ‰¾ä¸´æ—¶ç»‘å®šè®°å½•ï¼ˆphone_number + status=waitingï¼‰
    2. æŸ¥æ‰¾æˆ–åˆ›å»ºå®¢æˆ·è®°å½•
    3. æ›´æ–°å®¢æˆ·ä¿¡æ¯ï¼š
       - wework_userid = external_userid
       - wechat_openid = temp_binding.wechat_openid
       - binding_status = 'bound'
       - bound_at = NOW
       - bound_by = employee_userid
    4. æ›´æ–°ä¸´æ—¶ç»‘å®šçŠ¶æ€ = 'bound'
    5. è®°å½•æ“ä½œæ—¥å¿—
    """
```

#### 4. æ£€æŸ¥æŸ¥è¯¢æƒé™
```python
async def check_customer_can_query(
    db: AsyncSession,
    customer_phone: str
) -> bool:
    """
    å®‰å…¨æ£€æŸ¥ï¼šå®¢æˆ·æ˜¯å¦æœ‰æƒé™æŸ¥è¯¢é¡¹ç›®
    
    éªŒè¯æ¡ä»¶ï¼š
    1. customers è¡¨ä¸­å­˜åœ¨è¯¥å®¢æˆ·
    2. binding_status = 'bound'
    3. wework_customer_events è¡¨ä¸­å­˜åœ¨è®°å½•
       - customer_phone = ?
       - add_way = 2ï¼ˆæœç´¢æ‰‹æœºå·ï¼‰
       - event_type = 'add_external_contact'
    
    åªæœ‰æ»¡è¶³ä»¥ä¸Šæ‰€æœ‰æ¡ä»¶æ‰è¿”å› True
    """
```

#### 5. æŸ¥è¯¢ç»‘å®šçŠ¶æ€
```python
async def check_binding_status(
    db: AsyncSession,
    phone: str
) -> Dict:
    """
    å®¢æˆ·æŸ¥è¯¢ç»‘å®šè¿›åº¦
    
    è¿”å›ä¿¡æ¯ï¼š
    - status: bound/pending/expired/not_found
    - message: æè¿°æ€§æç¤º
    - bound_at: ç»‘å®šå®Œæˆæ—¶é—´
    - expires_at: ä¸´æ—¶ç»‘å®šè¿‡æœŸæ—¶é—´
    """
```

#### 6. æ¸…ç†è¿‡æœŸè®°å½•
```python
async def clean_expired_temp_bindings(
    db: AsyncSession
) -> int:
    """
    å®šæ—¶ä»»åŠ¡ï¼šæ¸…ç†è¿‡æœŸçš„ä¸´æ—¶ç»‘å®šè®°å½•
    
    æ‰§è¡Œé¢‘ç‡ï¼šæ¯æ—¥ 00:00 æ‰§è¡Œ
    æ¸…ç†é€»è¾‘ï¼š
    - status = 'waiting'
    - expires_at <= NOW
    â†’ æ›´æ–°ä¸º status = 'expired'
    """
```

---

## APIæ¥å£

### 1. POST /api/binding/temp
åˆ›å»ºä¸´æ—¶ç»‘å®šè®°å½•ï¼ˆå…¬ä¼—å·è°ƒç”¨ï¼‰

**è¯·æ±‚ä½“**ï¼š
```json
{
  "wechat_openid": "oABC123...",
  "phone_number": "13800138000"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "å·²æ”¶åˆ°æ‚¨çš„ä¿¡æ¯ï¼Œè¯·è”ç³»æˆ‘ä»¬çš„é”€å”®äººå‘˜",
  "temp_binding_id": 123,
  "expires_at": "2024-01-15T10:30:00"
}
```

### 2. POST /api/wework/callback
æ¥æ”¶ä¼ä¸šå¾®ä¿¡å›è°ƒï¼ˆä¼ä¸šå¾®ä¿¡æ¨é€ï¼‰

**URLéªŒè¯ï¼ˆGETï¼‰**ï¼š
```
GET /api/wework/callback?msg_signature=xxx&timestamp=xxx&nonce=xxx&echostr=xxx
```

**äº‹ä»¶å›è°ƒï¼ˆPOSTï¼‰**ï¼š
```xml
<xml>
  <ToUserName><![CDATA[ww123456]]></ToUserName>
  <FromUserName><![CDATA[wmXXX...]]></FromUserName>
  <CreateTime>1234567890</CreateTime>
  <MsgType><![CDATA[event]]></MsgType>
  <Event><![CDATA[change_external_contact]]></Event>
  <ChangeType><![CDATA[add_external_contact]]></ChangeType>
  <UserID><![CDATA[zhangsan]]></UserID>
  <ExternalUserID><![CDATA[wmXXX...]]></ExternalUserID>
  <State><![CDATA[]]></State>
  <WelcomeCode><![CDATA[CALLBACK_CODE]]></WelcomeCode>
</xml>
```

### 3. GET /api/customer/binding-status/{phone}
æŸ¥è¯¢ç»‘å®šçŠ¶æ€

**å“åº”**ï¼š
```json
{
  "status": "pending",
  "created_at": "2024-01-13T10:30:00",
  "expires_at": "2024-01-15T10:30:00",
  "message": "ç­‰å¾…ä¼ä¸šå¾®ä¿¡å‘˜å·¥æ·»åŠ "
}
```

### 4. GET /api/customer/can-query/{phone}
æ£€æŸ¥æŸ¥è¯¢æƒé™

**å“åº”**ï¼š
```json
{
  "can_query": true,
  "message": "æœ‰æŸ¥è¯¢æƒé™"
}
```

### 5. POST /api/wework/manual-bind
æ‰‹åŠ¨ç»‘å®šï¼ˆè¡¥æ•‘åœºæ™¯ï¼‰

**è¯·æ±‚ä½“**ï¼š
```json
{
  "customer_phone": "13800138000",
  "wechat_openid": "oABC123...",
  "wework_userid": "wmXXX...",
  "operator_userid": "admin"
}
```

---

## å®‰å…¨æœºåˆ¶

### 1. èº«ä»½éªŒè¯
- **é¿å…çŸ­ä¿¡éªŒè¯ç **ï¼šä¸ä¾èµ–ç¬¬ä¸‰æ–¹çŸ­ä¿¡æœåŠ¡ï¼Œé™ä½æˆæœ¬å’Œå¤æ‚åº¦
- **ä¼ä¸šå¾®ä¿¡éªŒè¯**ï¼šåˆ©ç”¨ä¼ä¸šå¾®ä¿¡"æœç´¢æ‰‹æœºå·æ·»åŠ "åŠŸèƒ½
  - å‘˜å·¥å¿…é¡»åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æœç´¢å®¢æˆ·æ‰‹æœºå·
  - å®¢æˆ·æ”¶åˆ°æ·»åŠ è¯·æ±‚å¹¶åŒæ„
  - ç³»ç»Ÿæ”¶åˆ° add_way=2 çš„å›è°ƒäº‹ä»¶

### 2. æƒé™æ§åˆ¶
```python
# é¡¹ç›®æŸ¥è¯¢æ¥å£ç¤ºä¾‹
@router.get("/api/projects/my")
async def get_my_projects(
    phone: str,
    db: AsyncSession = Depends(get_db)
):
    # å…ˆæ£€æŸ¥æƒé™
    can_query = await AutoBindingService.check_customer_can_query(db, phone)
    
    if not can_query:
        raise HTTPException(
            status_code=403,
            detail="æ‚¨è¿˜æ²¡æœ‰æŸ¥è¯¢æƒé™ï¼Œè¯·è”ç³»é”€å”®äººå‘˜é€šè¿‡æ‰‹æœºå·æœç´¢æ·»åŠ æ‚¨"
        )
    
    # æŸ¥è¯¢é¡¹ç›®æ•°æ®
    customer = await get_customer_by_phone(db, phone)
    projects = await get_customer_projects(db, customer.id)
    
    return projects
```

### 3. æ•°æ®å®‰å…¨
- **ä¸´æ—¶æ•°æ®è¿‡æœŸ**ï¼š48å°æ—¶åè‡ªåŠ¨è¿‡æœŸï¼Œé¿å…é•¿æœŸå­˜å‚¨æ•æ„Ÿä¿¡æ¯
- **äº‹ä»¶å®¡è®¡**ï¼šæ‰€æœ‰ç»‘å®šæ“ä½œè®°å½•åˆ° wework_customer_events
- **æ“ä½œæ—¥å¿—**ï¼šè®°å½• operator_userid å’Œ operation_detail

### 4. é˜²åˆ·æœºåˆ¶
- åŒä¸€æ‰‹æœºå·åœ¨48å°æ—¶å†…åªèƒ½åˆ›å»ºä¸€æ¬¡ä¸´æ—¶ç»‘å®š
- ä½¿ç”¨ UNIQUE çº¦æŸé˜²æ­¢é‡å¤è®°å½•
- å®šæ—¶æ¸…ç†è¿‡æœŸè®°å½•ï¼Œé‡Šæ”¾æ•°æ®åº“ç©ºé—´

---

## å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¿ç§»
```bash
# æ‰§è¡ŒSQLè„šæœ¬
psql -U postgres -d customer_db -f backend/equipment_extension.sql
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… customers è¡¨æ–°å¢6ä¸ªå­—æ®µ
- âœ… temp_bindings è¡¨åˆ›å»ºæˆåŠŸ
- âœ… wework_customer_events è¡¨åˆ›å»ºæˆåŠŸ
- âœ… æ‰€æœ‰ç´¢å¼•åˆ›å»ºæˆåŠŸ

### ç¬¬äºŒæ­¥ï¼šé…ç½®ä¼ä¸šå¾®ä¿¡å›è°ƒ
1. ç™»å½•ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°
2. è¿›å…¥"å®¢æˆ·è”ç³»" â†’ "API" â†’ "è®¾ç½®æ¥æ”¶äº‹ä»¶æœåŠ¡å™¨"
3. å¡«å†™å›è°ƒURLï¼š`https://yourdomain.com/api/wework/callback`
4. å¡«å†™Tokenå’ŒEncodingAESKey
5. ç‚¹å‡»ä¿å­˜å¹¶éªŒè¯

**å›è°ƒäº‹ä»¶è®¢é˜…**ï¼š
- âœ… æ·»åŠ å®¢æˆ·äº‹ä»¶ï¼ˆadd_external_contactï¼‰
- âœ… åˆ é™¤å®¢æˆ·äº‹ä»¶ï¼ˆdel_external_contactï¼‰
- âœ… ç¼–è¾‘å®¢æˆ·äº‹ä»¶ï¼ˆedit_external_contactï¼‰

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡
```env
# ä¼ä¸šå¾®ä¿¡é…ç½®
WEWORK_CORP_ID=ww123456
WEWORK_CONTACT_SECRET=xxx
WEWORK_CALLBACK_TOKEN=yyy
WEWORK_CALLBACK_AES_KEY=zzz

# å…¬ä¼—å·é…ç½®
WECHAT_APPID=wx123456
WECHAT_SECRET=xxx
```

### ç¬¬å››æ­¥ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡
```python
# ä½¿ç”¨ APScheduler
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from app.services.auto_binding_service import AutoBindingService

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', hour=0, minute=0)
async def clean_expired_bindings():
    async with get_db() as db:
        count = await AutoBindingService.clean_expired_temp_bindings(db)
        logger.info(f"å®šæ—¶æ¸…ç†è¿‡æœŸä¸´æ—¶ç»‘å®š: {count}æ¡")

scheduler.start()
```

### ç¬¬äº”æ­¥ï¼šå…¬ä¼—å·æ¶ˆæ¯å¤„ç†
```python
# åœ¨å…¬ä¼—å·æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­æ·»åŠ 
@router.post("/api/wechat/message")
async def handle_wechat_message(request: Request, db: AsyncSession = Depends(get_db)):
    # ... è§£æå…¬ä¼—å·æ¶ˆæ¯ ...
    
    if msg_type == 'text':
        content = message['Content']
        openid = message['FromUserName']
        
        # æ£€æµ‹æ‰‹æœºå·
        phone_pattern = r'^1[3-9]\d{9}$'
        if re.match(phone_pattern, content):
            # åˆ›å»ºä¸´æ—¶ç»‘å®š
            result = await AutoBindingService.create_temp_binding(
                db, openid, content
            )
            
            return reply_text(
                openid,
                "å·²æ”¶åˆ°æ‚¨çš„è”ç³»æ–¹å¼ï¼\n"
                "è¯·è”ç³»æˆ‘ä»¬çš„é”€å”®äººå‘˜ï¼Œä»–ä»¬ä¼šé€šè¿‡ä¼ä¸šå¾®ä¿¡æ·»åŠ æ‚¨ã€‚\n"
                "æ·»åŠ æˆåŠŸåï¼Œæ‚¨å³å¯æŸ¥è¯¢é¡¹ç›®è¿›åº¦ã€‚"
            )
```

### ç¬¬å…­æ­¥ï¼šé¡¹ç›®æŸ¥è¯¢æ¥å£ä¿æŠ¤
```python
# æ‰€æœ‰éœ€è¦å®¢æˆ·èº«ä»½çš„æ¥å£éƒ½æ·»åŠ æƒé™æ£€æŸ¥
@router.get("/api/projects")
async def get_projects(phone: str, db: AsyncSession = Depends(get_db)):
    # å®‰å…¨æ£€æŸ¥
    can_query = await AutoBindingService.check_customer_can_query(db, phone)
    if not can_query:
        raise HTTPException(403, "æ— æŸ¥è¯¢æƒé™")
    
    # ä¸šåŠ¡é€»è¾‘...
```

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•éªŒè¯

**åŠŸèƒ½æµ‹è¯•æ¸…å•**ï¼š
- [ ] å®¢æˆ·åœ¨å…¬ä¼—å·å‘é€æ‰‹æœºå· â†’ åˆ›å»ºä¸´æ—¶ç»‘å®š
- [ ] ä¸´æ—¶ç»‘å®šè®°å½•æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- [ ] é”€å”®äººå‘˜åœ¨ä¼ä¸šå¾®ä¿¡æœç´¢æ‰‹æœºå·æ·»åŠ å®¢æˆ·
- [ ] ç³»ç»Ÿæ”¶åˆ°ä¼ä¸šå¾®ä¿¡å›è°ƒäº‹ä»¶
- [ ] è‡ªåŠ¨å®Œæˆç»‘å®šï¼ˆcustomers è¡¨æ›´æ–°ï¼‰
- [ ] ä¸´æ—¶ç»‘å®šçŠ¶æ€æ›´æ–°ä¸º bound
- [ ] å®¢æˆ·æŸ¥è¯¢é¡¹ç›®æ—¶æƒé™æ£€æŸ¥é€šè¿‡
- [ ] éæœç´¢æ‰‹æœºå·æ·»åŠ çš„å®¢æˆ·æƒé™æ£€æŸ¥å¤±è´¥
- [ ] 48å°æ—¶åä¸´æ—¶ç»‘å®šè‡ªåŠ¨è¿‡æœŸ

**æµ‹è¯•è„šæœ¬**ï¼š
```python
# test_auto_binding.py
import asyncio
from app.database import get_db
from app.services.auto_binding_service import AutoBindingService

async def test_flow():
    async with get_db() as db:
        # 1. åˆ›å»ºä¸´æ—¶ç»‘å®š
        result = await AutoBindingService.create_temp_binding(
            db,
            wechat_openid="oTest123",
            phone_number="13800138000"
        )
        print("ä¸´æ—¶ç»‘å®šåˆ›å»º:", result)
        
        # 2. æ¨¡æ‹Ÿä¼ä¸šå¾®ä¿¡å›è°ƒ
        event_data = {
            'Event': 'change_external_contact',
            'ChangeType': 'add_external_contact',
            'UserID': 'zhangsan',
            'ExternalUserID': 'wmTest456'
        }
        result = await AutoBindingService.handle_wework_add_customer_event(
            db, event_data
        )
        print("äº‹ä»¶å¤„ç†:", result)
        
        # 3. æ£€æŸ¥æƒé™
        can_query = await AutoBindingService.check_customer_can_query(
            db, "13800138000"
        )
        print("æŸ¥è¯¢æƒé™:", can_query)

asyncio.run(test_flow())
```

---

## é™„å½•ï¼šå¸¸è§é—®é¢˜

### Q1: ä¸´æ—¶ç»‘å®šä¸ºä»€ä¹ˆè®¾ç½®48å°æ—¶è¿‡æœŸï¼Ÿ
**A**: è€ƒè™‘åˆ°å®¢æˆ·å¯èƒ½ä¸æ˜¯ç«‹å³è”ç³»é”€å”®äººå‘˜ï¼Œç»™äºˆ2å¤©ç¼“å†²æ—¶é—´ã€‚è¿‡æœŸåå®¢æˆ·å¯ä»¥é‡æ–°å‘é€æ‰‹æœºå·ã€‚

### Q2: å¦‚æœä¼ä¸šå¾®ä¿¡å›è°ƒå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
**A**: æä¾›æ‰‹åŠ¨ç»‘å®šæ¥å£ `/api/wework/manual-bind`ï¼Œç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨å…³è”å®¢æˆ·ä¿¡æ¯ã€‚

### Q3: ä¸ºä»€ä¹ˆåªå…è®¸ add_way=2 çš„å®¢æˆ·æŸ¥è¯¢ï¼Ÿ
**A**: add_way=2 è¡¨ç¤ºé€šè¿‡æœç´¢æ‰‹æœºå·æ·»åŠ ï¼Œæ˜¯æœ€å¯é çš„èº«ä»½éªŒè¯æ–¹å¼ã€‚å…¶ä»–æ–¹å¼ï¼ˆæ‰«ç ã€åç‰‡åˆ†äº«ï¼‰å¯èƒ½å­˜åœ¨å†’å……é£é™©ã€‚

### Q4: å¦‚æœå®¢æˆ·æ›´æ¢æ‰‹æœºå·æ€ä¹ˆåŠï¼Ÿ
**A**: éœ€è¦ç®¡ç†å‘˜åœ¨åå°æ›´æ–°å®¢æˆ·æ‰‹æœºå·ï¼Œå¹¶é‡æ–°èµ°ä¸€éç»‘å®šæµç¨‹ã€‚

### Q5: ä¼ä¸šå¾®ä¿¡APIè·å–ä¸åˆ°æ‰‹æœºå·æ€ä¹ˆåŠï¼Ÿ
**A**: ç¡®ä¿ï¼š
1. å‘˜å·¥æœ‰"å®¢æˆ·è”ç³»"åº”ç”¨æƒé™
2. åº”ç”¨é…ç½®äº†"æ‰‹æœºå·"å­—æ®µæƒé™
3. è°ƒç”¨ API æ—¶ä½¿ç”¨æ­£ç¡®çš„ access_token

---

## æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†**æ— çŸ­ä¿¡éªŒè¯ç çš„å®‰å…¨å®¢æˆ·ç»‘å®š**ï¼š

1. **åŒå‘ç»‘å®š**ï¼šå…¬ä¼—å·OpenID + ä¼ä¸šå¾®ä¿¡ExternalUserID
2. **å®‰å…¨éªŒè¯**ï¼šåˆ©ç”¨ä¼ä¸šå¾®ä¿¡æœç´¢æ‰‹æœºå·åŠŸèƒ½ï¼ˆadd_way=2ï¼‰
3. **è‡ªåŠ¨åŒ–**ï¼šå…¨æµç¨‹è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€äººå·¥å¹²é¢„
4. **å¯è¿½æº¯**ï¼šæ‰€æœ‰æ“ä½œè®°å½•åˆ°æ•°æ®åº“ï¼Œæ”¯æŒå®¡è®¡
5. **å®¹é”™æœºåˆ¶**ï¼šä¸´æ—¶ç»‘å®šè¿‡æœŸã€æ‰‹åŠ¨ç»‘å®šè¡¥æ•‘

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âŒ ä¸éœ€è¦çŸ­ä¿¡éªŒè¯ç ï¼ˆçœé’±ï¼‰
- âŒ ä¸éœ€è¦å®¢æˆ·é¢å¤–æ“ä½œï¼ˆçœåŠ›ï¼‰
- âœ… åˆ©ç”¨ä¼ä¸šå¾®ä¿¡ç°æœ‰åŠŸèƒ½ï¼ˆçœäº‹ï¼‰
- âœ… å®‰å…¨å¯é ï¼ˆadd_way=2 éªŒè¯ï¼‰
- âœ… å…¨ç¨‹è‡ªåŠ¨åŒ–ï¼ˆçœå¿ƒï¼‰
