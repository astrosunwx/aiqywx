# 电器设备行业双轨并行系统 - 完整实施方案

## 一、系统架构总览

### 1.1 核心设计理念

本系统采用"**双轨并行、数据统一**"的架构设计，实现线上线下无缝融合：

- **渠道一（企业内部群）**：移动优先、快速响应、零学习成本
- **渠道二（网页管理系统）**：深度管理、数据分析、复杂操作
- **统一数据中枢**：无论哪个渠道操作，数据实时同步

### 1.2 数据流与界面关系

```
flowchart TD
    A[客户] --> B[企业微信API]

    subgraph C [智能售后中枢]
        B --> C1[统一API接口层]
        C1 --> C2[(统一数据库)]
    end

    subgraph D [员工操作端：双轨并行]
        C2 --> E[操作渠道一<br>企业内部群<br>（API对话）]
        C2 --> F[操作渠道二<br>网页管理系统<br>（深度操作）]
    end

    E --> G[适用场景<br>移动办公/快速响应]
    F --> H[适用场景<br>复杂处理/数据分析]
```

---

## 二、电器设备行业特色功能

### 2.1 设备全生命周期管理

从采购到报废的完整追踪：

| 阶段 | 操作 | 数据记录 |
|------|------|----------|
| 售前咨询 | 创建商机记录 | 客户需求、设备型号、报价方案 |
| 订单确认 | 生成订单 | 订单金额、配送计划、安装计划 |
| 设备安装 | 创建设备档案 | 安装日期、设备序列号、保修期 |
| 定期维护 | 自动提醒 | 维护周期、维护记录、配件更换 |
| 故障维修 | 创建售后工单 | 故障描述、处理过程、配件使用 |
| 设备报废 | 更新设备状态 | 报废原因、报废日期 |

### 2.2 四大核心业务场景

#### 场景1：售前商机管理
```
客户咨询 → 创建商机 → 销售跟进 → 方案报价 → 订单确认
```

#### 场景2：设备交付安装
```
订单确认 → 配送安排 → 现场安装 → 设备档案入库 → 交付确认
```

#### 场景3：售后故障维修
```
故障报修 → 创建工单 → 故障诊断 → 配件申领 → 现场维修 → 服务完成
```

#### 场景4：预防性维护
```
自动检测保养周期 → 生成维护提醒 → 计划性保养 → 更新维护记录
```

---

## 三、数据库设计方案

### 3.1 核心数据表

#### 商机表 (opportunities)
```sql
CREATE TABLE opportunities (
    id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(id),
    customer_phone VARCHAR(20),
    customer_name VARCHAR(100),
    product_name VARCHAR(200) COMMENT '产品名称',
    quantity INTEGER COMMENT '数量',
    estimated_amount DECIMAL(10,2) COMMENT '预计金额',
    status VARCHAR(20) CHECK (status IN ('new', 'contacted', 'quoted', 'negotiating', 'won', 'lost')) DEFAULT 'new',
    sales_userid VARCHAR(100) COMMENT '销售UserID',
    sales_name VARCHAR(100) COMMENT '销售姓名',
    source VARCHAR(50) COMMENT '来源渠道：公众号、电话、转介绍',
    requirements TEXT COMMENT '客户需求描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    followed_up_at TIMESTAMP COMMENT '最后跟进时间'
);
```

#### 订单表 (orders)
```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单编号',
    opportunity_id INTEGER REFERENCES opportunities(id),
    customer_id INTEGER REFERENCES customers(id),
    customer_phone VARCHAR(20),
    product_name VARCHAR(200),
    quantity INTEGER,
    unit_price DECIMAL(10,2),
    total_amount DECIMAL(10,2),
    status VARCHAR(20) CHECK (status IN ('pending', 'confirmed', 'paid', 'delivered', 'installed', 'completed', 'cancelled')) DEFAULT 'pending',
    sales_userid VARCHAR(100),
    sales_name VARCHAR(100),
    delivery_address TEXT COMMENT '配送地址',
    delivery_date DATE COMMENT '计划配送日期',
    install_date DATE COMMENT '计划安装日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 设备档案表 (equipment)
```sql
CREATE TABLE equipment (
    id SERIAL PRIMARY KEY,
    equipment_no VARCHAR(50) UNIQUE NOT NULL COMMENT '设备编号',
    order_id INTEGER REFERENCES orders(id),
    customer_id INTEGER REFERENCES customers(id),
    customer_phone VARCHAR(20),
    equipment_type VARCHAR(50) COMMENT '设备类型：中央空调、冰箱、洗衣机等',
    brand VARCHAR(50) COMMENT '品牌',
    model VARCHAR(100) COMMENT '型号',
    serial_number VARCHAR(100) COMMENT '序列号',
    install_date DATE COMMENT '安装日期',
    install_location VARCHAR(200) COMMENT '安装位置',
    warranty_months INTEGER DEFAULT 36 COMMENT '保修月数',
    warranty_end_date DATE COMMENT '保修截止日期',
    status VARCHAR(20) CHECK (status IN ('in_use', 'under_repair', 'retired')) DEFAULT 'in_use',
    maintenance_cycle_days INTEGER DEFAULT 90 COMMENT '维护周期（天）',
    last_maintenance_date DATE COMMENT '上次维护日期',
    next_maintenance_date DATE COMMENT '下次维护日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 维护记录表 (maintenance_records)
```sql
CREATE TABLE maintenance_records (
    id SERIAL PRIMARY KEY,
    equipment_id INTEGER REFERENCES equipment(id),
    maintenance_type VARCHAR(20) CHECK (maintenance_type IN ('routine', 'repair', 'upgrade')) COMMENT '维护类型',
    maintenance_date DATE,
    engineer_userid VARCHAR(100),
    engineer_name VARCHAR(100),
    work_description TEXT COMMENT '工作内容',
    parts_replaced TEXT COMMENT '更换配件',
    cost DECIMAL(10,2) COMMENT '费用',
    next_maintenance_date DATE COMMENT '建议下次维护日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 配件库存表 (parts_inventory)
```sql
CREATE TABLE parts_inventory (
    id SERIAL PRIMARY KEY,
    part_code VARCHAR(50) UNIQUE NOT NULL COMMENT '配件编码',
    part_name VARCHAR(200) COMMENT '配件名称',
    category VARCHAR(50) COMMENT '配件类别',
    specification VARCHAR(200) COMMENT '规格型号',
    applicable_models TEXT COMMENT '适用设备型号',
    stock_quantity INTEGER DEFAULT 0 COMMENT '库存数量',
    unit_price DECIMAL(10,2) COMMENT '单价',
    supplier VARCHAR(100) COMMENT '供应商',
    min_stock_alert INTEGER COMMENT '最低库存预警',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 配件领用记录表 (parts_usage)
```sql
CREATE TABLE parts_usage (
    id SERIAL PRIMARY KEY,
    ticket_id INTEGER REFERENCES projects(id) COMMENT '关联工单ID',
    equipment_id INTEGER REFERENCES equipment(id),
    part_code VARCHAR(50) REFERENCES parts_inventory(part_code),
    quantity INTEGER COMMENT '领用数量',
    engineer_userid VARCHAR(100),
    engineer_name VARCHAR(100),
    usage_date DATE,
    purpose VARCHAR(20) CHECK (purpose IN ('repair', 'maintenance', 'replacement')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 升级现有Projects表

```sql
-- 为现有projects表添加电器设备行业字段
ALTER TABLE projects 
    ADD COLUMN opportunity_id INTEGER REFERENCES opportunities(id),
    ADD COLUMN order_id INTEGER REFERENCES orders(id),
    ADD COLUMN equipment_id INTEGER REFERENCES equipment(id),
    ADD COLUMN root_cause TEXT COMMENT '故障根本原因',
    ADD COLUMN solution TEXT COMMENT '解决方案',
    ADD COLUMN parts_used TEXT COMMENT '使用的配件（JSON格式）',
    ADD COLUMN service_duration_hours DECIMAL(5,2) COMMENT '服务时长（小时）';
```

---

## 四、群机器人命令系统

### 4.1 售前阶段命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `#认领` | 认领商机 | 直接回复消息 |
| `#跟进 [内容]` | 记录跟进内容 | `#跟进 已发送方案，客户考虑中` |
| `#报价 [金额]` | 提交报价 | `#报价 185000` |
| `#成交` | 标记商机成交，生成订单 | `#成交` |
| `#丢单 [原因]` | 标记商机丢失 | `#丢单 价格原因` |

### 4.2 售后阶段命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `#认领` | 认领工单 | 直接回复消息 |
| `#转派 @某人` | 转派给其他工程师 | `#转派 @李工` |
| `#协作 @某人` | 添加协作人员 | `#协作 @张工` |
| `#申请配件 [编码] [数量]` | 申请配件 | `#申请配件 AC-COMP-2023 1` |
| `#进度 [百分比]` | 更新处理进度 | `#进度 50%` |
| `#已解决` | 标记工单已解决 | `#已解决` |
| `#需要回访` | 标记需要客户回访 | `#需要回访` |

### 4.3 查询命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `#我的工单` | 查询自己负责的工单 | `#我的工单` |
| `#查询设备 [客户名称]` | 查询客户设备信息 | `#查询设备 ABC公司` |
| `#查询配件 [编码]` | 查询配件库存 | `#查询配件 AC-COMP-2023` |
| `#客户历史 [手机号]` | 查询客户历史记录 | `#客户历史 13800138000` |

---

## 五、网页管理系统功能模块

### 5.1 商机管理模块

**功能清单：**
- ✅ 商机列表（支持筛选：状态、销售、日期范围）
- ✅ 商机详情（客户信息、需求描述、跟进记录）
- ✅ 商机看板（新增、跟进中、已报价、成交、丢单）
- ✅ 转化漏斗分析
- ✅ 销售业绩统计

### 5.2 订单管理模块

**功能清单：**
- ✅ 订单列表（支持搜索订单号、客户）
- ✅ 订单详情（订单信息、配送跟踪、安装进度）
- ✅ 订单状态流转（待确认→已支付→已配送→已安装→已完成）
- ✅ 配送计划管理
- ✅ 订单统计报表

### 5.3 设备档案模块

**功能清单：**
- ✅ 设备列表（支持按客户、设备类型、保修状态筛选）
- ✅ 设备详情（基本信息、维护历史、关联工单）
- ✅ 设备360视图（完整生命周期）
- ✅ 保修到期预警
- ✅ 维护周期提醒

### 5.4 售后工单模块

**功能清单：**
- ✅ 工单列表（支持多维度筛选）
- ✅ 工单详情（问题描述、处理过程、使用配件、服务时长）
- ✅ 工单看板（待处理、处理中、已解决、已关闭）
- ✅ 工单催办功能
- ✅ 客户满意度调查

### 5.5 配件库存模块

**功能清单：**
- ✅ 配件库存列表
- ✅ 库存预警（低于最低库存提醒）
- ✅ 配件领用记录
- ✅ 配件使用统计
- ✅ 采购申请管理

### 5.6 数据分析模块

**功能清单：**
- ✅ 业务概览仪表板
- ✅ 销售业绩分析
- ✅ 售后服务分析（响应时间、解决时长、满意度）
- ✅ 设备故障分析（故障类型、高频问题）
- ✅ 工程师绩效分析

---

## 六、技术实现要点

### 6.1 统一API设计原则

```python
# 所有操作都通过统一的RESTful API
# 群机器人和网页前端调用相同的接口

# 示例：认领工单
POST /api/tickets/{ticket_id}/claim
{
    "operator_userid": "zhangsan",
    "operator_name": "张三",
    "source": "group_bot" | "web_ui"  # 标识操作来源
}

# 响应：
{
    "success": true,
    "ticket": {
        "id": 123,
        "status": "processing",
        "assigned_to": "zhangsan",
        "assigned_to_name": "张三"
    },
    "message": "工单已认领"
}
```

### 6.2 数据同步机制

```python
# 使用PostgreSQL的LISTEN/NOTIFY实现实时推送
# 或使用WebSocket推送数据变更

# 当群机器人更新工单时：
# 1. 更新数据库
# 2. 触发数据变更事件
# 3. 通知所有在线的网页客户端刷新数据

# 当网页前端更新工单时：
# 1. 更新数据库
# 2. 触发数据变更事件
# 3. 群机器人同步通知群成员
```

### 6.3 群消息富文本卡片设计

```json
{
    "msgtype": "template_card",
    "template_card": {
        "card_type": "text_notice",
        "source": {
            "icon_url": "https://...",
            "desc": "新售后工单"
        },
        "main_title": {
            "title": "中央空调制冷不佳"
        },
        "emphasis_content": {
            "title": "优先级",
            "desc": "高"
        },
        "sub_title_text": "客户：ABC公司 | 设备：3楼中央空调",
        "horizontal_content_list": [
            {"keyname": "订单号", "value": "OR20241108001"},
            {"keyname": "设备型号", "value": "格力GMV-H120"}
        ],
        "card_action": {
            "type": 1,
            "url": "https://yourweb.com/ticket/123"
        },
        "button_list": [
            {"text": "认领", "key": "claim"},
            {"text": "查看详情", "key": "view"}
        ]
    }
}
```

---

## 七、典型业务场景实现

### 场景1：客户咨询→商机→订单→设备档案（全流程）

```
1. 客户在公众号咨询："需要10台中央空调"
   ↓ 系统自动创建商机
   
2. 销售群收到通知：【新商机】客户：张经理...
   ↓ 销售回复：#认领
   
3. 销售在网页系统填写详细需求和报价方案
   ↓ 客户确认订单
   
4. 销售回复：#成交
   ↓ 系统自动生成订单
   
5. 配送、安装完成后，自动创建设备档案
   ↓ 设备进入全生命周期管理
```

### 场景2：设备故障→工单→配件→维修→闭环

```
1. 客户报修："3楼空调制冷不好"
   ↓ 系统创建售后工单
   
2. 售后群收到通知
   ↓ 工程师回复：#认领
   
3. 工程师现场诊断后，在群里：#申请配件 AC-FILTER-001 1
   ↓ 系统检查库存，自动扣减
   
4. 更换配件后，工程师在网页系统填写详细维修记录
   ↓ 包括故障原因、解决方案、配件使用
   
5. 工程师在群里：#已解决
   ↓ 系统自动发送满意度调查给客户
   
6. 系统更新设备维护记录和下次维护时间
```

### 场景3：预防性维护提醒

```
1. 系统每日检测设备维护周期
   ↓ 发现ABC公司3楼空调距上次维护已满90天
   
2. 售后群自动推送：
   【维护提醒】ABC公司-3楼中央空调 建议安排保养
   ↓ 工程师回复：#生成维护工单
   
3. 系统创建维护工单并分配给工程师
   ↓ 工程师完成维护后更新记录
   
4. 系统计算下次维护时间（90天后）
```

---

## 八、实施路线图

### 第一阶段：核心数据模型（1周）
- ✅ 创建商机、订单、设备、配件等数据表
- ✅ 升级现有Projects表
- ✅ 编写数据迁移脚本

### 第二阶段：后端API开发（2周）
- ✅ 商机管理API
- ✅ 订单管理API
- ✅ 设备档案API
- ✅ 配件库存API
- ✅ 维护提醒API

### 第三阶段：群机器人命令增强（1周）
- ✅ 实现售前命令（#认领、#跟进、#成交等）
- ✅ 实现售后命令（#申请配件、#进度等）
- ✅ 实现查询命令（#查询设备、#查询配件等）

### 第四阶段：网页前端开发（3周）
- ✅ 商机管理页面
- ✅ 订单管理页面
- ✅ 设备档案页面
- ✅ 配件库存页面
- ✅ 数据分析页面

### 第五阶段：测试与优化（1周）
- ✅ 功能测试
- ✅ 双轨同步测试
- ✅ 性能优化
- ✅ 用户培训

---

## 九、成功关键要素

### 9.1 数据一致性
- 所有操作必须通过统一API，严禁直接修改数据库
- 使用数据库事务保证原子性
- 关键操作添加操作日志

### 9.2 用户体验
- 群命令设计简洁、符合直觉
- 网页界面信息层次清晰
- 响应速度快（API响应 < 500ms）

### 9.3 权限管理
- 销售只能查看/操作自己的商机
- 工程师只能查看/操作分配给自己的工单
- 管理员可查看所有数据和报表

### 9.4 监控与告警
- 关键业务指标监控（响应时间、工单积压）
- 系统异常告警（API错误、数据库连接）
- 业务异常告警（工单超期、库存不足）

---

## 十、附录：命令速查表

### 售前命令
```
#认领              认领商机
#跟进 [内容]       记录跟进
#报价 [金额]       提交报价
#成交              生成订单
#丢单 [原因]       标记丢失
```

### 售后命令
```
#认领              认领工单
#转派 @某人        转派工单
#协作 @某人        添加协作
#申请配件 [编码] [数量]  申请配件
#进度 [百分比]     更新进度
#已解决            完成工单
#需要回访          标记回访
```

### 查询命令
```
#我的工单          我的工单列表
#查询设备 [客户]   设备信息
#查询配件 [编码]   配件库存
#客户历史 [手机]   客户记录
```

---

**文档版本：** v1.0  
**最后更新：** 2026年2月2日  
**适用行业：** 电器设备销售与售后服务
