# 🎯 智能工单交互系统 - 完整实现方案

## 📌 对标分析：腾讯客服 vs 企业微信智能售后助手

| 腾讯客服功能 | 企业微信实现方案 | 实现状态 |
|------------|----------------|---------|
| 用户反馈问题 | 客户通过员工/网站提交工单 | ✅ 已实现 |
| 客服告知状态"已升级" | 内部群自动推送富文本卡片："客户XX的问题已升级处理" | ✅ 已实现 |
| 用户追问"24小时过去了" | 自动检测超时工单，推送催促提醒到内部群 | ✅ 已实现 |
| 客服询问具体产品名称 | 系统自动关联：根据客户ID带出产品和历史工单 | ✅ 已实现 |
| 消息回复更新状态 | 员工在群里回复"#123 已解决"自动更新工单状态 | ✅ 已实现 |
| @机器人创建工单 | 员工在内部群@智能助手：/创建工单 @客户张三 问题:XXX | ✅ 已实现 |

---

## 🏗️ 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────┐
│                   智能售后助手系统                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────┐        ┌──────────────────┐     │
│  │ 工单交互服务      │        │ 工单提醒服务      │     │
│  │ TicketInteraction│        │ TicketReminder   │     │
│  │ Service          │        │ Service          │     │
│  │                  │        │                  │     │
│  │ • @机器人创建工单 │        │ • 24小时超时检测  │     │
│  │ • 命令解析与执行  │        │ • 自动催促提醒    │     │
│  │ • 工单分配       │        │ • 多次催促升级    │     │
│  │ • 回复监听       │        │ • 群消息推送      │     │
│  │ • 状态自动更新   │        │                  │     │
│  └──────────────────┘        └──────────────────┘     │
│           │                           │                │
│           └───────────┬───────────────┘                │
│                       │                                │
│         ┌─────────────┴──────────────┐                 │
│         │  客户历史查询服务             │                 │
│         │  CustomerHistoryService     │                 │
│         │                            │                 │
│         │  • 工单汇总统计              │                 │
│         │  • 历史问题查询              │                 │
│         │  • 相似问题匹配              │                 │
│         │  • 客户服务报告              │                 │
│         └─────────────┬──────────────┘                 │
│                       │                                │
│         ┌─────────────┴──────────────┐                 │
│         │  企业微信API集成             │                 │
│         │  WeChatWorkAPI             │                 │
│         │                            │                 │
│         │  • 消息接收（webhook）       │                 │
│         │  • 消息发送（文本/卡片）     │                 │
│         │  • 群消息推送                │                 │
│         │  • @提醒功能                │                 │
│         └────────────────────────────┘                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 🎬 使用场景演示

### 场景1：员工在内部群@机器人创建工单

**操作步骤**：

1. **员工在内部群发送命令**：
   ```
   /创建工单 @客户张三 手机:13800138000 问题:服务器无法连接
   ```

2. **系统自动处理**：
   - ✅ 解析命令参数（客户名、手机号、问题描述）
   - ✅ 查询或创建客户记录
   - ✅ 创建工单（24小时期限）
   - ✅ 推送富文本卡片到群

3. **群内展示效果**：
   ```markdown
   🟡 【新工单提醒】#ID123
   
   **客户信息**
   > 客户：张三
   > 公司：XX科技有限公司
   > 联系：13800138000
   
   **工单详情**
   > 产品/项目：售后工单 - 服务器无法连接
   > 问题描述：服务器无法连接
   > 优先级：➡️ NORMAL
   > 提交时间：2026-02-01 15:30
   
   **处理状态**
   > 当前状态：待分配
   > 负责人：待分配
   > 处理进度：0%
   > 处理期限：⏰ 2026-02-02 15:30
   
   ---
   💬 请负责人在本消息下回复处理进度
   ✅ 回复"已解决"可自动关闭工单
   📋 回复"分配给@某人"可转交工单
   📊 查看详情：[安全链接]
   
   🆘 请在02月02日 15:30前处理
   ```

---

### 场景2：分配工单给负责人

**操作步骤**：

```
/分配工单 #123 @李四
```

**系统响应**：
```
✅ 工单 #123 已分配给 @李四
```

**工单状态更新**：
- 状态：pending → assigned
- 负责人：李四
- 群内卡片自动刷新

---

### 场景3：负责人回复工单

**李四在群里回复**：
```
#123 已解决，问题是网络配置错误，已修复
```

**系统自动处理**：
- ✅ 识别工单号 #123
- ✅ 识别关键词"已解决"
- ✅ 更新工单状态：assigned → resolved
- ✅ 更新进度：0% → 100%
- ✅ 记录处理时间

**系统响应**：
```
✅ 工单 #123 状态已更新为：已解决
```

---

### 场景4：24小时超时自动提醒

**定时任务检测**：
- 每小时检查一次超时工单
- 发现工单 #123 超时12小时

**自动推送提醒**：
```
🚨 【工单超时提醒】

工单编号：#123
客户：张三 (13800138000)
问题：服务器无法连接...

当前状态：processing
负责人：李四
处理进度：50%

⏰ 处理期限：2026-02-02 15:30
⏱️  已超时：12 小时
🔔 催促次数：第 1 次

@李四 请尽快处理！

---
💡 回复 "#123 已解决" 可关闭工单
💡 回复 "#123 升级处理" 可升级工单
```

---

### 场景5：查询客户历史工单

**操作步骤**：

```
/查询工单 客户张三
```

**系统响应**：
```markdown
📋 查询到 3 个工单：

**工单 #123**
状态：已解决 | 进度：100%
问题：服务器无法连接...
负责人：李四
创建时间：2026-02-01 15:30

**工单 #118**
状态：处理中 | 进度：75%
问题：登录失败报错500...
负责人：王五
创建时间：2026-01-28 10:20

**工单 #105**
状态：已关闭 | 进度：100%
问题：无法导出数据...
负责人：李四
创建时间：2026-01-20 14:00
```

---

## 📊 支持的命令列表

### 工单管理命令

| 命令 | 格式 | 示例 | 功能 |
|------|------|------|------|
| `/创建工单` | `/创建工单 @客户XXX 手机:13800138000 问题:XXX` | `/创建工单 @客户张三 手机:13800138000 问题:服务器无法连接` | 创建新工单 |
| `/查询工单` | `/查询工单 客户XXX` <br> `/查询工单 手机13800138000` <br> `/查询工单 #123` | `/查询工单 客户张三` | 查询客户的所有工单 |
| `/分配工单` | `/分配工单 #工单ID @负责人` | `/分配工单 #123 @李四` | 分配工单给指定人员 |

### 工单回复（状态更新）

| 回复内容 | 效果 |
|---------|------|
| `#123 已解决` | 工单状态 → resolved，进度 → 100% |
| `#123 已处理` | 工单状态 → processing，进度 → 80% |
| `#123 升级处理` | 工单状态 → escalated |

### 优先级关键词

在创建工单时，可以添加以下关键词自动设置优先级：

| 关键词 | 优先级 |
|--------|--------|
| 紧急、严重 | urgent (🚨) |
| 高优先级 | high (⬆️) |
| 无关键词 | normal (➡️) |

---

## 🔧 API端点

### 1. 接收企业微信消息

**端点**：`POST /api/wechat/work-message`

**功能**：
- 接收企业微信推送的消息事件
- 自动识别命令类型（/创建工单、/查询工单等）
- 处理工单回复（#123 已解决）
- 执行多轮对话（自动工单生成）

**请求示例**：
```json
{
  "ToUserName": "企业ID",
  "FromUserName": "员工UserID",
  "MsgType": "text",
  "Content": "/创建工单 @客户张三 手机:13800138000 问题:服务器无法连接"
}
```

**响应示例**：
```json
{
  "type": "command_response",
  "response": "✅ 工单 #123 创建成功！已推送到群聊。",
  "data": {
    "handled": true,
    "ticket_id": 123
  }
}
```

---

### 2. 查询客户历史工单汇总

**端点**：`GET /api/customers/{customer_id}/tickets/summary`

**功能**：
- 获取客户的工单统计数据
- 列出最近5个工单
- 展示涉及的产品列表

**响应示例**：
```json
{
  "customer": {
    "id": 1,
    "name": "张三",
    "phone": "13800138000",
    "company": "XX科技"
  },
  "total_tickets": 15,
  "pending_tickets": 2,
  "resolved_tickets": 13,
  "recent_tickets": [
    {
      "id": 123,
      "title": "服务器无法连接",
      "status": "resolved",
      "progress": 100,
      "created_at": "2026-02-01T15:30:00",
      "assigned_to": "李四"
    }
  ],
  "products": ["斗战神V2.0", "云服务器管理系统"],
  "customer_since": "2025-01-15T10:00:00"
}
```

---

### 3. 手动触发超时提醒

**端点**：`POST /api/admin/reminders/run`

**功能**：
- 手动执行一次超时检查
- 向所有超时工单发送提醒

**响应示例**：
```json
{
  "success": true,
  "overdue_count": 3,
  "reminders_sent": 3
}
```

---

## 🗂️ 数据库模型扩展

### Project（工单）表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `customer_id` | Integer | 关联客户ID |
| `assigned_to` | String(100) | 负责人（企业微信UserID） |
| `assigned_to_name` | String(100) | 负责人姓名 |
| `progress` | Integer | 处理进度（0-100） |
| `priority` | String(20) | 优先级：low, normal, high, urgent |
| `deadline` | TIMESTAMP | 处理期限 |
| `reminder_count` | Integer | 催促次数 |
| `last_reminder_at` | TIMESTAMP | 最后催促时间 |
| `group_message_id` | String(200) | 内部群消息ID（用于回复监听） |

### 工单状态流转

```
pending（待分配）
  ↓
assigned（已分配）
  ↓
processing（处理中）
  ↓
resolved（已解决）
  ↓
closed（已关闭）

特殊状态：
escalated（已升级） → 需要更高级别处理
cancelled（已取消） → 客户取消或无效工单
```

---

## ⏰ 定时任务配置

### 使用APScheduler

```python
from app.services.ticket_reminder_service import ReminderScheduler
from app.database import SessionLocal

# 启动定时任务
scheduler = ReminderScheduler(db_session_factory=SessionLocal)
scheduler.start()

# 每小时的0分执行超时检查
# 例如：01:00, 02:00, 03:00...
```

### 使用系统Cron

```bash
# 每小时检查一次
0 */1 * * * cd /path/to/backend && python -m app.scripts.check_overdue_tickets
```

### 手动触发

```bash
# 开发测试时可手动触发
curl -X POST http://localhost:8000/api/admin/reminders/run
```

---

## 📦 新增文件清单

| 文件路径 | 行数 | 功能描述 |
|---------|------|---------|
| `app/services/ticket_interaction_service.py` | 520 | 工单交互服务（命令解析、状态更新） |
| `app/services/ticket_reminder_service.py` | 175 | 超时提醒服务（24小时检测、自动催促） |
| `app/services/customer_history_service.py` | 230 | 客户历史查询服务（工单汇总、统计报告） |
| `app/models.py` | 已修改 | 扩展Project模型（新增9个字段） |
| `app/routers/wechat.py` | 已修改 | 集成智能工单交互到消息路由 |

---

## 🎯 核心优势

### 1️⃣ 自动化程度高

- ✅ @机器人自动创建工单（无需打开网页）
- ✅ 回复消息自动更新状态（无需手动标记）
- ✅ 超时自动提醒（不会遗漏工单）
- ✅ 客户历史自动关联（快速了解背景）

### 2️⃣ 状态透明可追溯

- ✅ 所有状态变更记录在数据库
- ✅ 群消息实时展示工单状态
- ✅ 催促次数自动累计
- ✅ 处理时间自动统计

### 3️⃣ 责任到人不遗漏

- ✅ 每个工单必须指定负责人
- ✅ 超时自动@负责人提醒
- ✅ 未分配工单@all提醒
- ✅ 紧急工单@all强制关注

### 4️⃣ 用户体验友好

- ✅ 命令格式简单易记
- ✅ 富文本卡片美观清晰
- ✅ 支持在群里直接回复操作
- ✅ 一键查看详情（安全链接）

---

## 🚀 快速开始

### 1. 启动后端服务

```bash
cd backend
.\venv\Scripts\Activate.ps1
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 配置环境变量

在 `.env` 文件中添加：

```bash
# 企业微信配置
CORP_ID=your_corp_id
CORP_SECRET=your_corp_secret
AGENT_ID=1000002
GROUP_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

# JWT密钥
JWT_SECRET_KEY=your-secret-key-12345678

# 应用域名
APP_DOMAIN=http://localhost:8000
```

### 3. 在内部群测试

发送测试命令：

```
/创建工单 @客户测试 手机:13800138000 问题:测试工单系统
```

观察群内是否收到工单卡片消息。

### 4. 启动定时提醒（可选）

```python
# 在main.py中添加
from app.services.ticket_reminder_service import ReminderScheduler
from app.database import SessionLocal

scheduler = ReminderScheduler(SessionLocal)
scheduler.start()
```

---

## 📚 相关文档

- **企业微信对接指南**：[企业微信对接指南.md](./企业微信对接指南.md)
- **安全链接使用指南**：[安全链接与缓存策略-使用指南.md](./安全链接与缓存策略-使用指南.md)
- **智能助手实现方案**：[智能助手实现方案.md](./智能助手实现方案.md)

---

## 🎉 总结

通过企业微信API，我们成功实现了一个**类似腾讯客服**的智能工单系统：

✅ **状态透明**：像腾讯客服一样，所有人看到问题状态（待分配→处理中→已解决）  
✅ **责任到人**：每个工单都有明确负责人，超时自动提醒  
✅ **永不遗漏**：定时检查机制确保问题不被遗忘  
✅ **记录可查**：所有沟通记录自动留存，便于追溯  
✅ **高度自动化**：@机器人创建、回复更新、超时提醒全自动  

**这正是内部售后跟进系统的理想方案！** 🚀
