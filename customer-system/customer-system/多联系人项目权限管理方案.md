# 多联系人项目权限管理方案

## 🎯 业务场景

### 典型场景
企业项目往往有多个对接人：
- **主客户**：下单人/公司负责人（张三，13800138000）
- **技术负责人**：负责技术对接（李四，13900139000）
- **采购负责人**：负责采购跟进（王五，13700137000）

**问题**：李四想查询项目进度或提交售后，但他不是主客户！

---

## 💡 解决方案：多联系人权限体系

### 核心设计

```
项目 (Project)
├── customer_id: 123（主客户张三）
└── additional_contacts: [
      {"phone": "13900139000", "name": "李四", "role": "技术负责人"},
      {"phone": "13700137000", "name": "王五", "role": "采购负责人"}
    ]
```

### 权限规则

| 角色 | 手机号 | 查询项目 | 提交售后 | 更改订单 |
|------|--------|---------|---------|---------|
| **主客户**（张三） | 13800138000 | ✅ 所有自己的项目 | ✅ 允许 | ✅ 允许 |
| **技术负责人**（李四） | 13900139000 | ✅ 在联系人列表的项目 | ✅ 允许 | ❌ 需提交服务请求 |
| **其他客户**（赵六） | 13600136000 | ❌ 无权限 | ❌ 无权限 | ❌ 无权限 |

---

## 🔍 权限检查流程

### 场景1：A查询A的项目（主客户）

```
客户：查询我的项目 13800138000

🤖系统检查：
✅ customer_id = 123（匹配）
✅ 有权限，返回所有项目

返回：
- 项目1：中央空调安装（主客户）
- 项目2：售后维修（主客户）
```

### 场景2：B查询A的项目（不在联系人列表）

```
客户：查询项目123，我的手机是 13600136000

🤖系统检查：
❌ customer_id != 该客户ID
❌ additional_contacts 中没有 13600136000
❌ 无权限

🤖不直接拒绝，而是：
📝 记录服务请求（CustomerServiceRequest）
📱 推送企业微信内部群：
    "客户赵六（13600136000）尝试查询项目123
     但不是项目联系人
     请销售顾问核实处理"
👥 人工介入处理
```

### 场景3：B查询A的项目（在联系人列表中）

```
客户：查询项目123，我的手机是 13900139000

🤖系统检查：
❌ customer_id != 该客户ID
✅ additional_contacts 中有 13900139000（技术负责人）
✅ 有权限

返回：
- 项目123：中央空调安装
  access_type: additional_contact
  role: 技术负责人
```

---

## 🗄️ 数据库设计

### 扩展 projects 表

```sql
-- 添加多联系人字段
ALTER TABLE projects 
ADD COLUMN additional_contacts JSONB DEFAULT '[]'::jsonb 
COMMENT '项目额外联系人列表';

-- 创建GIN索引（高效查询JSONB）
CREATE INDEX idx_projects_additional_contacts 
ON projects USING gin(additional_contacts);
```

### 数据格式

```json
{
  "id": 123,
  "customer_id": 456,
  "customer_phone": "13800138000",
  "title": "中央空调安装项目",
  "additional_contacts": [
    {
      "phone": "13900139000",
      "name": "李四",
      "role": "技术负责人"
    },
    {
      "phone": "13700137000",
      "name": "王五",
      "role": "采购负责人"
    }
  ]
}
```

---

## 📡 API接口设计

### 1. 查询可访问的项目（支持多联系人）

**GET** `/api/customer/{phone}/projects`

**请求**：
```
GET /api/customer/13900139000/projects
```

**响应**：
```json
{
  "success": true,
  "customer_type": "customer",
  "total_projects": 2,
  "projects": [
    {
      "id": 123,
      "title": "中央空调安装项目",
      "status": "processing",
      "access_type": "additional_contact",
      "my_role": "技术负责人"
    },
    {
      "id": 456,
      "title": "我的项目",
      "status": "completed",
      "access_type": "primary_customer"
    }
  ]
}
```

### 2. 添加项目联系人

**POST** `/api/project/contact/add`

**请求**：
```json
{
  "project_id": 123,
  "phone": "13900139000",
  "name": "李四",
  "role": "技术负责人"
}
```

**响应**：
```json
{
  "success": true,
  "message": "已添加联系人 李四",
  "contact": {
    "phone": "13900139000",
    "name": "李四",
    "role": "技术负责人"
  }
}
```

### 3. 移除项目联系人

**POST** `/api/project/contact/remove`

**请求**：
```json
{
  "project_id": 123,
  "phone": "13900139000"
}
```

**响应**：
```json
{
  "success": true,
  "message": "已移除联系人 13900139000"
}
```

### 4. 检查项目访问权限

**POST** `/api/project/access/check`

**请求**：
```json
{
  "customer_phone": "13900139000",
  "project_id": 123
}
```

**响应（有权限）**：
```json
{
  "has_access": true,
  "access_type": "additional_contact",
  "contact_role": "技术负责人",
  "message": "项目联系人（技术负责人），拥有查询权限"
}
```

**响应（无权限）**：
```json
{
  "has_access": false,
  "reason": "not_project_contact",
  "message": "您不是该项目的联系人，无法查询",
  "suggestion": "您可以提交服务请求，我们的销售顾问会帮您处理",
  "action": "create_service_request"
}
```

### 5. 获取项目所有联系人

**GET** `/api/project/{project_id}/contacts`

**响应**：
```json
{
  "project_id": 123,
  "project_title": "中央空调安装项目",
  "primary_customer": {
    "phone": "13800138000",
    "name": "张三",
    "role": "主客户",
    "type": "primary"
  },
  "additional_contacts": [
    {
      "phone": "13900139000",
      "name": "李四",
      "role": "技术负责人",
      "type": "additional"
    },
    {
      "phone": "13700137000",
      "name": "王五",
      "role": "采购负责人",
      "type": "additional"
    }
  ],
  "total_contacts": 3
}
```

---

## 🤖 AI对话处理（微信公众号/企业微信）

### 情况1：额外联系人查询项目（有权限）

```
李四（技术负责人）：我想查询项目进度

🤖：请问您的手机号是多少？

李四：13900139000

🤖：正在查询...

[后台检查]
✅ 客户存在，customer_type='customer'
✅ 查询 additional_contacts 包含 13900139000
✅ 有权限

🤖：您的项目进度：
    • 中央空调安装项目: 处理中（您的角色：技术负责人）
      预计完成时间：2024-02-05
```

### 情况2：非联系人查询项目（无权限，包容处理）

```
赵六（非联系人）：我想查询项目123

🤖：请问您的手机号是多少？

赵六：13600136000

🤖：请问怎么称呼您？

赵六：赵六

🤖：✅ 已记录您的查询项目请求
    我们的专员会尽快联系您处理
    请保持电话畅通
    📋 请求单号：REQ20240202123456ABC

[后台自动处理]
✅ 创建 CustomerServiceRequest
✅ request_type = 'query_order'
✅ needs_verification = true
✅ 推送企业微信内部群：

【客户服务请求 - 需要验证】📝
请求单号：REQ20240202123456ABC
请求类型：查询订单（NORMAL）
客户姓名：赵六
客户电话：13600136000
请求内容：查询项目123

⚠️ 温馨提示：
该客户不是项目123的联系人

可能原因：
• 项目联系人变更了
• 客户记错了项目编号
• 需要添加为额外联系人

📱 请销售顾问先联系客户核实情况
   如确认需要，可添加为项目联系人
```

### 情况3：额外联系人提交售后（有权限）

```
李四（技术负责人）：空调不制冷了

🤖：好的，正在为您创建售后工单。请问具体是什么问题？

李四：制冷效果不好

🤖：收到。请提供一下您的手机号

李四：13900139000

🤖：正在匹配您的项目...

[后台检查]
✅ 查询所有包含 13900139000 的项目
✅ 找到项目123（中央空调安装）
✅ additional_contacts 中有该手机号
✅ 有售后权限

🤖：信息已记录！
    工单号：SV20240202001
    项目：中央空调安装项目
    您的角色：技术负责人
    
    技术支持将在30分钟内联系您
    📊 查看详情：https://xxx/secure/project/abc123
```

---

## 🔧 技术实现

### MultiContactPermissionService 核心方法

#### 1. check_project_access()
```python
权限检查逻辑：
1. 主客户检查：project.customer_id == customer.id
2. 额外联系人检查：customer_phone in additional_contacts
3. 返回详细权限信息（has_access, access_type, role）
```

#### 2. get_accessible_projects()
```python
SQL查询（PostgreSQL JSONB）：
SELECT * FROM projects 
WHERE customer_id = :customer_id  -- 主客户项目
   OR additional_contacts @> '[{"phone":"13900139000"}]'  -- 额外联系人项目
ORDER BY created_at DESC
```

#### 3. add_project_contact()
```python
添加联系人：
1. 查询项目
2. 获取 additional_contacts 数组
3. 检查是否已存在
4. 添加新联系人
5. 更新 JSONB 字段
```

#### 4. remove_project_contact()
```python
移除联系人：
1. 查询项目
2. 过滤掉指定phone
3. 更新 additional_contacts
```

---

## 📊 权限矩阵总览

| 操作 | 主客户 | 额外联系人 | 商机用户 | 取消客户 | 非联系人 |
|------|--------|-----------|---------|---------|---------|
| **查询自己的项目** | ✅ | ✅ | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 |
| **查询其他项目** | ❌ 服务请求 | ✅（如在联系人列表） | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 |
| **提交售后工单** | ✅ | ✅ | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 |
| **更改订单** | ✅ | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 |
| **取消订单** | ✅ | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 | ❌ 服务请求 |

**核心理念**：
- ✅ 直接允许：主客户、额外联系人的查询/售后
- ❌ 不直接拒绝：走**服务请求流程**，人工处理

---

## 🚀 部署步骤

### 1. 执行数据库迁移

```bash
psql -U postgres -d customer_db -f backend/after_sales_extension.sql
```

### 2. 重启后端服务

```bash
docker-compose restart backend
```

### 3. 测试接口

#### 测试1：添加项目联系人
```bash
curl -X POST http://localhost:8000/api/project/contact/add \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 123,
    "phone": "13900139000",
    "name": "李四",
    "role": "技术负责人"
  }'
```

#### 测试2：检查访问权限
```bash
curl -X POST http://localhost:8000/api/project/access/check \
  -H "Content-Type: application/json" \
  -d '{
    "customer_phone": "13900139000",
    "project_id": 123
  }'
```

#### 测试3：查询可访问项目
```bash
curl http://localhost:8000/api/customer/13900139000/projects
```

---

## 🎊 总结

### ✨ 核心优势

1. **灵活的权限管理**
   - 支持一个项目多个联系人
   - 不同角色不同权限
   - 动态添加/移除联系人

2. **包容式处理**
   - 无权限不直接拒绝
   - 自动创建服务请求
   - 推送通知给销售处理

3. **高效的查询**
   - PostgreSQL JSONB原生支持
   - GIN索引加速查询
   - 一条SQL查询所有可访问项目

4. **完整的审计**
   - 记录所有服务请求
   - 明确权限检查结果
   - 可追溯每次访问

### 📈 业务价值

- 🏢 **适配企业场景**：一个项目多个对接人
- 🔒 **安全可控**：严格权限检查，防止越权
- 🤝 **用户友好**：无权限也能得到帮助
- 📊 **数据完整**：所有请求都有记录

### 🔮 扩展方向

- [ ] 联系人角色权限细分（只读/可提交售后/可更改）
- [ ] 联系人有效期管理（临时授权）
- [ ] 批量导入项目联系人
- [ ] 联系人变更通知（企业微信推送）
- [ ] 可视化联系人管理界面

**让每个项目对接人都能高效协作，让每个客户请求都得到响应！** 🚀
