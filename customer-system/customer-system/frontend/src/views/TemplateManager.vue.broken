<template>
  <div class="template-manager">
    <el-card>
      <template #header>
        <div class="header-actions">
          <h2>📝 消息模板管理</h2>
          <el-button type="primary" @click="showCreateDialog">+ 新建模板</el-button>
        </div>
      </template>

      <!-- 🔧 域名配置面板 -->
      <el-collapse>
        <el-collapse-item title="⚙️ 域名配置 & 快速模板" name="1">
          <el-row :gutter="20" style="margin-bottom: 20px;">
            <el-col :span="8">
              <div>
                <label><strong>📍 基础域名配置</strong></label>
                <p style="color: #666; font-size: 12px; margin: 10px 0;">
                  配置ngrok或自定义域名，模板链接会自动使用该域名
                </p>
                <el-input 
                  v-model="baseUrl"
                  placeholder="如：https://xxxx.ngrok.io 或 http://localhost:3000"
                  style="margin-bottom: 10px;"
                >
                  <template #prepend>域名</template>
                </el-input>
                <el-button @click="saveBaseUrl" type="success" style="width: 100%;">
                  💾 保存域名配置
                </el-button>
              </div>
            </el-col>

            <el-col :span="16">
              <div>
                <label><strong>📝 快速预设模�?/strong></label>
                <p style="color: #666; font-size: 12px; margin: 10px 0;">
                  快速插入预设模板内容，点击按钮自动填充到编辑框
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <el-button @click="insertPresetTemplate('presale')" type="info" size="small">
                    🎯 商机通知模板
                  </el-button>
                  <el-button @click="insertPresetTemplate('aftersales')" type="warning" size="small">
                    🔧 工单进度模板
                  </el-button>
                  <el-button @click="insertPresetTemplate('sales')" type="success" size="small">
                    📦 订单确认模板
                  </el-button>
                  <el-button @click="insertPresetTemplate('payment')" type="danger" size="small">
                    💳 支付催付模板
                  </el-button>
                </div>
              </div>
            </el-col>
          </el-row>

          <!-- 现有URL配置速览 -->
          <el-alert
            title="💡 当前URL配置"
            type="info"
            :closable="false"
            style="margin-top: 15px;"
          >
            <div style="font-family: monospace; font-size: 12px; line-height: 1.8;">
              <div>基础域名strong>{{ baseUrl || 'http://localhost:3000' }}</strong></div>
              <div style="margin-top: 10px; color: #606266;">
                <div>售前商机：{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=presale</div>
                <div>售后工单：{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=aftersales</div>
                <div>销售订单：{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=sales</div>
                <div>在线支付：{{ baseUrl || 'http://localhost:3000' }}/pay/{order_id}</div>
              </div>
            </div>
          </el-alert>
        </el-collapse-item>
      </el-collapse>

      <!-- 模板分类标签 -->
      <el-tabs v-model="activeTab" @tab-change="loadTemplates" style="margin-top: 20px;">
        <el-tab-pane label="📱 短信模板" name="SMS"></el-tab-pane>
        <el-tab-pane label="📧 邮件模板" name="EMAIL"></el-tab-pane>
        <el-tab-pane label="💬 微信公众号" name="WECHAT"></el-tab-pane>
        <el-tab-pane label="🏢 企业微信" name="WORK_WECHAT"></el-tab-pane>
        <el-tab-pane label="🤖 AI回复模板" name="AI"></el-tab-pane>
        <el-tab-pane label="📢 群机器人" name="GROUP_BOT"></el-tab-pane>
      </el-tabs>

      <!-- 模板列表 -->
      <el-table :data="templates" border style="margin-top: 20px;">
        <el-table-column prop="id" label="模板ID" width="80"></el-table-column>
        <el-table-column prop="name" label="模板名称" width="200"></el-table-column>
        <el-table-column prop="category" label="使用场景" width="120">
          <template #default="scope">
            <el-tag :type="getCategoryType(scope.row.category)">
              {{ scope.row.category }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="content" label="模板内容" show-overflow-tooltip></el-table-column>
        <el-table-column prop="variables" label="可用变量" width="180">
          <template #default="scope">
            <el-tag 
              v-for="variable in scope.row.variables" 
              :key="variable" 
              size="small"
              style="margin: 2px;"
            >
              {{ variable }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态 width="100">
          <template #default="scope">
            <el-switch
              v-model="scope.row.status"
              active-text="启用"
              inactive-text="禁用"
              @change="toggleStatus(scope.row)"
            ></el-switch>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="220" fixed="right">
          <template #default="scope">
            <el-button size="small" @click="editTemplate(scope.row)">编辑</el-button>
            <el-button size="small" type="info" @click="previewTemplate(scope.row)">预览</el-button>
            <el-button 
              size="small" 
              :type="scope.row.is_system ? 'warning' : 'danger'"
              @click="deleteTemplate(scope.row)"
            >
              {{ scope.row.is_system ? '🔒 禁用' : '删除' }}
            </el-button>
            <el-tag v-if="scope.row.is_system" type="success" size="small" style="margin-left: 5px;">
              系统预留
            </el-tag>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 创建/编辑模板对话框-->
    <el-dialog 
      v-model="dialogVisible" 
      :title="dialogTitle"
      width="800px"
    >
      <el-form :model="templateForm" label-width="120px">
        <el-form-item label="模板名称">
          <el-input v-model="templateForm.name" placeholder="请输入模板名称></el-input>
        </el-form-item>

        <el-form-item label="使用场景">
          <el-select v-model="templateForm.category" placeholder="请选择使用场景">
            <el-option label="售前咨询" value="售前咨询"></el-option>
            <el-option label="订单通知" value="订单通知"></el-option>
            <el-option label="发货通知" value="发货通知"></el-option>
            <el-option label="售后服务" value="售后服务"></el-option>
            <el-option label="预约提醒" value="预约提醒"></el-option>
            <el-option label="维修进度" value="维修进度"></el-option>
            <el-option label="系统通知" value="系统通知"></el-option>
          </el-select>
        </el-form-item>

        <el-form-item label="推送类型>
          <el-radio-group v-model="templateForm.push_type">
            <el-radio label="realtime">实时推送/el-radio>
            <el-radio label="scheduled">定时推送/el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="发送时间 v-if="templateForm.push_type === 'scheduled'">
          <el-input 
            v-model="templateForm.cron_expression" 
            placeholder="输入Cron表达式，如：0 0 9 * * ? 表示每天9点
          >
            <template #append>
              <el-button @click="openCronGenerator">Cron生成器/el-button>
            </template>
          </el-input>
          <span class="form-tip">
            生成器 <a href="http://cron.ciding.cc/" target="_blank">http://cron.ciding.cc/</a>
          </span>
        </el-form-item>

        <el-form-item label="消息类型">
          <el-radio-group v-model="templateForm.message_type">
            <el-radio label="notification">通知类消息/el-radio>
            <el-radio label="marketing">营销类消息/el-radio>
            <el-radio label="verification">验证码类消息</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="模板类型">
          <el-radio-group v-model="templateForm.type">
            <el-radio label="text">纯文本/el-radio>
            <el-radio label="card">卡片消息</el-radio>
            <el-radio label="markdown">Markdown</el-radio>
            <el-radio label="template">微信模板消息</el-radio>
          </el-radio-group>
        </el-form-item>

        <!-- 微信模板消息专用字段 -->
        <el-form-item label="模板ID" v-if="activeTab === 'WECHAT' && templateForm.type === 'template'">
          <el-input v-model="templateForm.template_id" placeholder="微信公众号模板ID"></el-input>
          <span class="form-tip">从微信公众平台获取模板ID</span>
        </el-form-item>

        <el-form-item label="跳转链接" v-if="templateForm.type === 'template' || templateForm.type === 'card'">
          <el-select v-model="templateForm.link_type" placeholder="选择链接类型" style="width: 200px; margin-bottom: 10px;">
            <el-option label="自定义链接 value="custom"></el-option>
            <el-option label="售前商机详情" value="presale"></el-option>
            <el-option label="售后工单详情" value="aftersales"></el-option>
            <el-option label="销售订单详情 value="sales"></el-option>
            <el-option label="项目状态查询 value="status-query"></el-option>
          </el-select>

          <el-input 
            v-model="templateForm.url" 
            placeholder="点击后跳转的URL"
            style="margin-top: 10px;"
          ></el-input>

          <div style="margin-top: 10px;">
            <el-tag 
              v-if="templateForm.link_type === 'presale'"
              size="small" 
              @click="insertUrl('presale')" 
              style="margin: 2px; cursor: pointer;"
            >
              售前商机: http://localhost:3000/project/{order_id}?type=presale
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'status-query'"
              size="small" 
              @click="insertUrl('status-query')" 
              style="margin: 2px; cursor: pointer;"
            >
              项目状态 http://localhost:3000/project/{order_id}?type=status
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'aftersales'"
              size="small" 
              @click="insertUrl('aftersales')" 
              style="margin: 2px; cursor: pointer;"
            >
              售后工单: http://localhost:3000/project/{order_id}?type=aftersales
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'sales'"
              size="small" 
              @click="insertUrl('sales')" 
              style="margin: 2px; cursor: pointer;"
            >
              销售订单 http://localhost:3000/project/{order_id}?type=sales
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'custom'"
              size="small" 
              @click="insertUrl('payment')" 
              style="margin: 2px; cursor: pointer;"
            >
              付款页面: http://localhost:3000/pay/{order_id}
            </el-tag>
          </div>

          <el-alert 
            style="margin-top: 10px;" 
            type="info" 
            :closable="false"
          >
            <template v-if="templateForm.link_type === 'presale'">
              <strong>售前商机页面</strong>包含：客户需求、预算金额、跟进记录、负责销售等信息
            </template>
            <template v-else-if="templateForm.link_type === 'aftersales'">
              <strong>售后工单页面</strong>包含：故障描述、处理进度、工程师信息、客户反馈（已解�?未解决转工程师）
            </template>
            <template v-else-if="templateForm.link_type === 'sales'">
              <strong>销售订单页�?/strong>包含：订单详情、商品列表、物流信息、在线支�?
            </template>
            <template v-else>
              点击标签插入常用链接模板
            </template>
          </el-alert>
        </el-form-item>

        <!-- AI模板专用字段 -->
        <el-form-item label="触发关键�? v-if="activeTab === 'AI'">
          <el-input 
            v-model="templateForm.keywords" 
            placeholder="用逗号分隔多个关键词，如：价格,报价,多少�?
          ></el-input>
        </el-form-item>

        <el-form-item label="AI模型" v-if="activeTab === 'AI'">
          <el-select v-model="templateForm.ai_model" placeholder="选择AI模型">
            <el-option 
              v-for="model in aiModels" 
              :key="model.value"
              :label="model.label"
              :value="model.value"
            >
              <span>{{ model.label }}</span>
              <el-tag 
                v-if="model.is_official" 
                type="success" 
                size="small" 
                style="margin-left: 10px;"
              >
                �?官方API
              </el-tag>
              <el-tag 
                v-if="model.is_default" 
                type="primary" 
                size="small" 
                style="margin-left: 5px;"
              >
                默认
              </el-tag>
            </el-option>
          </el-select>
          <div style="color: #909399; font-size: 12px; margin-top: 8px;">
            💡 推荐使用<strong style="color: #67C23A;">企业微信官方API</strong>，安全稳定无风险
          </div>
        </el-form-item>

        <el-form-item label="模板内容">
          <el-input 
            v-model="templateForm.content" 
            type="textarea" 
            :rows="8"
            placeholder="支持变量：{customer_name} {phone} {product} {order_id} {date} {time} {amount} {status}"
          ></el-input>
          <div class="variable-help">
            <el-tag 
              v-for="v in availableVariables" 
              :key="v.key"
              size="small"
              @click="insertVariable(v.key)"
              style="margin: 5px; cursor: pointer;"
            >
              {{ v.key }} - {{ v.desc }}
            </el-tag>
          </div>
        </el-form-item>

        <el-form-item label="示例数据">
          <el-button size="small" @click="fillSampleData">填充示例</el-button>
          <el-button size="small" type="success" @click="testTemplate">测试发�?/el-button>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="saveTemplate">保存模板</el-button>
      </template>
    </el-dialog>

    <!-- 预览对话框-->
    <el-dialog v-model="previewVisible" title="模板预览" width="800px">
      <div class="preview-container" v-if="currentTemplate">
        <el-row :gutter="20">
          <!-- 左侧：模板信�?-->
          <el-col :span="12">
            <h3>{{ currentTemplate.name }}</h3>
            <el-descriptions :column="1" size="small" border style="margin-top: 10px;">
              <el-descriptions-item label="使用场景">
                <el-tag>{{ currentTemplate.category }}</el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="推送类型>
                <el-tag :type="currentTemplate.push_type === 'realtime' ? 'success' : 'warning'">
                  {{ currentTemplate.push_type === 'realtime' ? '实时推送 : '定时推送 }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="消息类型">
                <el-tag :type="getMessageTypeColor(currentTemplate.message_type)">
                  {{ getMessageTypeText(currentTemplate.message_type) }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="Cron表达�? v-if="currentTemplate.cron_expression">
                <code>{{ currentTemplate.cron_expression }}</code>
              </el-descriptions-item>
              <el-descriptions-item label="跳转链接" v-if="currentTemplate.url">
                <el-link :href="currentTemplate.url" target="_blank" type="primary">
                  {{ currentTemplate.url }}
                </el-link>
              </el-descriptions-item>
            </el-descriptions>
          </el-col>

          <!-- 右侧：模拟手机预�?-->
          <el-col :span="12">
            <div class="phone-preview">
              <div class="phone-header">
                <span v-if="activeTab === 'WECHAT'">💬 微信公众号/span>
                <span v-else-if="activeTab === 'WORK_WECHAT'">🏢 企业微信</span>
                <span v-else-if="activeTab === 'SMS'">📱 短信</span>
                <span v-else>{{ activeTab }}</span>
              </div>
              <div class="phone-body">
                <!-- 微信公众号样�?-->
                <div v-if="activeTab === 'WECHAT'" class="wechat-message">
                  <div class="wechat-card">
                    <div class="wechat-title">{{ currentTemplate.name }}</div>
                    <div class="wechat-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="wechat-footer" v-if="currentTemplate.url">
                      <el-icon><Link /></el-icon>
                      <span>点击查看详情</span>
                    </div>
                  </div>
                </div>

                <!-- 企业微信样式 -->
                <div v-else-if="activeTab === 'WORK_WECHAT'" class="work-wechat-message">
                  <div class="work-wechat-card">
                    <div class="work-wechat-header">
                      <span class="app-name">售前售后系统</span>
                      <span class="send-time">刚刚</span>
                    </div>
                    <div class="work-wechat-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="work-wechat-actions" v-if="currentTemplate.url">
                      <el-button size="small" type="primary">查看详情</el-button>
                    </div>
                  </div>
                </div>

                <!-- 短信样式 -->
                <div v-else-if="activeTab === 'SMS'" class="sms-message">
                  <div class="sms-bubble">
                    <div class="sms-sender">【售前售后系统�?/div>
                    <div class="sms-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="sms-time">{{ new Date().toLocaleTimeString() }}</div>
                  </div>
                </div>

                <!-- 其他类型 -->
                <div v-else class="default-message">
                  <div class="preview-content" v-html="renderTemplate(currentTemplate)"></div>
                </div>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import axios from 'axios'

const activeTab = ref('SMS')
const dialogVisible = ref(false)
const previewVisible = ref(false)
const templates = ref([])
const currentTemplate = ref(null)
const isEditing = ref(false)
const baseUrl = ref(localStorage.getItem('baseUrl') || 'http://localhost:3000')

const dialogTitle = computed(() => isEditing.value ? '编辑模板' : '新建模板')

// 模板表单
// AI模型列表（从后端加载�?
const aiModels = ref([])
const defaultAIModel = ref('wework-official')

const templateForm = ref({
  name: '',
  category: '',
  push_type: 'realtime',
  message_type: 'notification',
  cron_expression: '',
  type: 'text',
  content: '',
  template_id: '',
  url: '',
  link_type: 'custom',
  keywords: '',
  ai_model: 'wework-official',
  status: true,
  variables: []
})

// 可用变量
const availableVariables = [
  { key: '{customer_name}', desc: '客户姓名' },
  { key: '{phone}', desc: '手机�? },
  { key: '{product}', desc: '产品名称' },
  { key: '{order_id}', desc: '订单�? },
  { key: '{date}', desc: '日期' },
  { key: '{time}', desc: '时间' },
  { key: '{amount}', desc: '金额' },
  { key: '{status}', desc: '状态 },
  { key: '{address}', desc: '地址' },
  { key: '{technician}', desc: '技术员' },
  { key: '{appointment_time}', desc: '预约时间' }
]

// 加载AI模型列表
const loadAIModels = async () => {
  try {
    const response = await axios.get('http://localhost:8000/api/admin/ai-models/active')
    aiModels.value = response.data || []
    
    // 查找默认模型
    const defaultModel = aiModels.value.find(m => m.is_default)
    if (defaultModel) {
      defaultAIModel.value = defaultModel.value
      templateForm.value.ai_model = defaultModel.value
    }
    
    console.log('�?已加载AI模型列表:', aiModels.value.length, '个模�?)
  } catch (error) {
    console.error('�?加载AI模型列表失败:', error)
    // 使用默认配置
    aiModels.value = [
      { value: 'wework-official', label: '企业微信官方API', is_official: true, is_default: true }
    ]
  }
}

// 加载模板
const loadTemplates = async () => {
  try {
    const response = await axios.get('http://localhost:8000/api/templates', {
      params: { type: activeTab.value }
    })
    templates.value = response.data.templates || getPresetTemplates()
  } catch (error) {
    console.error('加载模板失败:', error)
    templates.value = getPresetTemplates()
  }
}

// 获取预制模板
const getPresetTemplates = () => {
  const presets = {
    'SMS': [
      {
        id: 1,
        name: '订单确认短信',
        category: '订单通知',
        type: 'text',
        content: '尊敬的{customer_name}，您的订单{order_id}已确认，预计{date}送达。如有疑问请致电客服�?,
        variables: ['{customer_name}', '{order_id}', '{date}'],
        status: true
      },
      {
        id: 2,
        name: '发货通知短信',
        category: '发货通知',
        type: 'text',
        content: '您好{customer_name}，您的订单{order_id}已发货，物流单号{tracking_number}，请注意查收�?,
        variables: ['{customer_name}', '{order_id}', '{tracking_number}'],
        status: true
      }
    ],
    'WECHAT': [
      {
        id: 3,
        name: '售后预约提醒',
        category: '预约提醒',
        type: 'template',
        template_id: 'YOUR_TEMPLATE_ID',
        content: '预约时间：{appointment_time}\n服务地址：{address}\n联系电话：{phone}\n技术员：{technician}',
        url: 'https://your-domain.com/appointment/{order_id}',
        variables: ['{appointment_time}', '{address}', '{phone}', '{technician}'],
        status: true
      }
    ],
    'WORK_WECHAT': [
      {
        id: 4,
        name: '紧急工单通知',
        category: '系统通知',
        type: 'card',
        content: '🚨 紧急工单提醒\n\n工单编号：{order_id}\n客户：{customer_name}\n问题：{product} 故障\n地址：{address}\n\n请及时处理！',
        variables: ['{order_id}', '{customer_name}', '{product}', '{address}'],
        status: true
      }
    ],
    'AI': [
      {
        id: 5,
        name: '💰 价格咨询AI回复',
        category: '售前咨询',
        type: 'text',
        keywords: '价格,报价,多少�?费用,成本',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于回复客户的价格咨询问�?,
        content: `您好！关于{product}的价格，我们提供以下方案�?

📊 **价格体系**
�?基础版：{price_basic}�?
�?标准版：{price_standard}�? 
�?旗舰版：{price_premium}�?

💡 **如何选择�?*
- 小规模使�?�?基础�?
- 中等规模 �?标准版（性价比最佳）
- 大规模企�?�?旗舰版（功能全面�?

具体价格会根据您的需求有所调整。我是{sales_representative_name}，很高兴为您服务�?

📞 需要详细咨询？点击链接了解更多�?
{baseUrl}/project/{order_id}?type=presale

请问您更倾向于哪个版本呢？`,
        variables: ['{product}', '{price_basic}', '{price_standard}', '{price_premium}', '{sales_representative_name}', '{baseUrl}', '{order_id}'],
        status: true
      },
      {
        id: 6,
        name: '🔧 售后维修AI回复',
        category: '售后服务',
        type: 'text',
        keywords: '维修,报修,坏了,不能�?故障,坏掉,修理',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于回复售后维修相关问题',
        content: `非常抱歉给您带来不便！�?

我已为您记录报修信息�?

🛠�?**维修工单**
�?产品：{product}
�?问题：{issue}
�?预约时间：{appointment_time}
�?工单号：{ticket_id}

�?**我们承诺**
我们的技术员{technician}（电话：{technician_phone}）将准时上门服务，预计{expected_visit_date} {expected_visit_time}到达�?

请保持电话畅通，以便我们及时联系您�?

📋 查看维修详情和进度：
{baseUrl}/project/{ticket_id}?type=aftersales

感谢您的耐心等待！`,
        variables: ['{product}', '{issue}', '{appointment_time}', '{ticket_id}', '{technician}', '{technician_phone}', '{expected_visit_date}', '{expected_visit_time}', '{baseUrl}'],
        status: true
      },
      {
        id: 7,
        name: '📦 订单确认AI回复',
        category: '订单通知',
        type: 'text',
        keywords: '订单,确认,已下�?收到订单,订单�?,
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于订单确认通知',
        content: `订单确认成功！�?

感谢{customer_name}的订单，我们已收到您的购买申请�?

📋 **订单信息**
�?订单号：{order_id}
�?产品：{product}
�?金额：{amount}�?
�?订单时间：{order_date}
�?预期交付：{expected_delivery_date}

💰 **支付方式**
点击链接完成支付�?
{baseUrl}/pay/{order_id}

需要发票吗？我们的客服会为您开具正式发票�?

📞 后续流程
1. 💳 完成支付
2. 📦 我们为您准备商品
3. 🚚 发货并推送物流信�? 
4. �?确认收货

有任何问题，请随时联系我。祝您购物愉快！`,
        variables: ['{customer_name}', '{order_id}', '{product}', '{amount}', '{order_date}', '{expected_delivery_date}', '{baseUrl}'],
        status: true
      },
      {
        id: 8,
        name: '�?常见问题AI回复',
        category: '售前咨询',
        type: 'text',
        keywords: '怎么�?如何,怎么,什�?哪个,如何使用,使用方法',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于回答常见问题',
        content: `很高兴您对我们的产品感兴趣！😊

关于您提出的问题，以下是常见解答�?

�?**常见问题**

**Q1：产品使用难度高吗？**
A：非常简单！我们的产品设计遵�?傻瓜式操�?原则，即使是新手也能5分钟上手�?

**Q2：有售后保障吗？**
A：当然有！我们提供：
  �?1年免费保�?
  �?7×24小时技术支�?
  �?30天无理由退换货

**Q3：能定制化吗�?*
A：可以的！我们支持：
  �?功能定制
  �?界面定制  
  �?集成定制

**Q4：购买后如何得到技术支持？**
A：多种方式任选：
  📞 电话：{sales_representative_phone}
  💬 微信：搜�?{sales_representative_name}"
  📧 邮件：support@company.com
  💻 在线：{baseUrl}/support

如果您的问题不在以上列表，请告诉我具体是什么，我会为您详细解答�?

点击了解更多：{baseUrl}/product/{product}`,
        variables: ['{product}', '{sales_representative_name}', '{sales_representative_phone}', '{baseUrl}'],
        status: true
      },
      {
        id: 9,
        name: '📊 数据统计AI回复',
        category: '查询统计',
        type: 'text',
        keywords: '统计,数据,报表,分析,有多�?总共,一�?,
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于提供数据统计信息',
        content: `您好！以下是最新的数据统计�?

📈 **业绩统计**（{query_date}�?

**销售数�?*
�?今日订单：{today_orders}�?
�?本月订单：{month_orders}�?
�?本月金额：{month_amount}�?
�?同比增长：{growth_rate}%

**服务数据**
�?待处理工单：{pending_tickets}�?
�?平均处理时间：{avg_processing_time}小时
�?客户满意度：{satisfaction_rate}%

**库存数据**
�?库存总数：{total_inventory}�?
�?本周进货：{weekly_restock}�?
�?预警商品：{low_stock_items}�?

📊 详细报表�?
{baseUrl}/analytics/{customer_id}?date={query_date}

💡 **建议**
根据数据分析，{suggestion_text}�?

需要更详细的数据吗？我为您准备了完整的Excel报表，请告诉我您的邮箱！`,
        variables: ['{query_date}', '{today_orders}', '{month_orders}', '{month_amount}', '{growth_rate}', '{pending_tickets}', '{avg_processing_time}', '{satisfaction_rate}', '{total_inventory}', '{weekly_restock}', '{low_stock_items}', '{baseUrl}', '{customer_id}', '{suggestion_text}'],
        status: true
      },
      {
        id: 10,
        name: '�?预约提醒AI回复',
        category: '预约提醒',
        type: 'text',
        keywords: '预约,时间,什么时�?什么时�?排期',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于服务预约提醒',
        content: `预约成功！我们已为您安排上门服务。✨

📅 **服务预约信息**
�?预约日期：{appointment_date}
�?预约时间：{appointment_time}（请提前10分钟在家等候）
�?服务类型：{service_type}
�?技术员：{technician}
�?联系电话：{technician_phone}

📍 **服务地址**
{appointment_address}

⚠️ **温馨提示**
1. 请保持电话畅�?
2. 家里要有人接待（需要原业主或授权人在场�?
3. 如需更改时间，请提前24小时通知
4. 我们会在出发�?0分钟短信通知�?

🚫 **临时取消**
如必须取消或延期，请点击�?
{baseUrl}/appointment/{appointment_id}/cancel

感谢您的配合！如有问题可随时致电{technician_phone}。`,
        variables: ['{appointment_date}', '{appointment_time}', '{service_type}', '{technician}', '{technician_phone}', '{appointment_address}', '{appointment_id}', '{baseUrl}'],
        status: true
      },
      {
        id: 11,
        name: '💬 咨询转接AI回复',
        category: '转接处理',
        type: 'text',
        keywords: '转接,人工,客服,销售代�?我要',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于转接到人工客�?,
        content: `感谢您的耐心！我已为您转接到专业团队。�?

👤 **负责人信�?*
�?姓名：{assigned_person_name}
�?职位：{assigned_person_title}
�?电话：{assigned_person_phone}  
�?微信：{assigned_person_wechat}
�?邮箱：{assigned_person_email}

⏱️ **预期响应时间**
�?工作时间�?:00-18:00）：5分钟内回�?
�?非工作时间：下个工作�?9:00回复

📝 **您的咨询信息**
我已记录了您的咨询需求，{assigned_person_name}会立即为您处理�?

💡 **更快获得帮助**
如果想加速处理，可以�?
1. 直接拨打电话：{assigned_person_phone}
2. 添加微信快速沟通：{assigned_person_wechat}
3. 发邮件详细说明：{assigned_person_email}

查看转接详情：{baseUrl}/ticket/{transfer_id}

感谢您选择我们的服务！`,
        variables: ['{assigned_person_name}', '{assigned_person_title}', '{assigned_person_phone}', '{assigned_person_wechat}', '{assigned_person_email}', '{transfer_id}', '{baseUrl}'],
        status: true
      },
      {
        id: 12,
        name: '🎁 活动推广AI回复',
        category: '营销推广',
        type: 'text',
        keywords: '活动,促销,优惠,打折,特价,限时',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: '用于活动推广和营销',
        content: `🎉 **重大活动通知** - {activity_name}

为感谢{customer_name}的持续支持，我们特别为您准备了专属优惠！

💝 **您的专属优惠**
�?优惠力度：{discount_percentage}% 折扣
�?优惠券码：{coupon_code}
�?使用条件：满{min_amount}元可�?
�?有效期：{activity_start_date} - {activity_end_date}

🎁 **活动商品**
�?{product_1}：{product_1_discount}
�?{product_2}：{product_2_discount}  
�?{product_3}：{product_3_discount}

�?**倒计�?*
优惠仅剩：{remaining_days}�?
赶快下单吧，错过就没有了�?

🛒 **快速购买链�?*
{baseUrl}/activity/{activity_id}?coupon={coupon_code}

📱 **分享赚现�?*
将此活动分享给朋友，每成功转介绍1人，您就能获得{referral_bonus}元奖励！
分享链接：{baseUrl}/referral/{referral_code}

还有问题？我随时为您解答！`,
        variables: ['{activity_name}', '{customer_name}', '{discount_percentage}', '{coupon_code}', '{min_amount}', '{activity_start_date}', '{activity_end_date}', '{product_1}', '{product_1_discount}', '{product_2}', '{product_2_discount}', '{product_3}', '{product_3_discount}', '{remaining_days}', '{activity_id}', '{referral_bonus}', '{referral_code}', '{baseUrl}'],
        status: true
      }
    ],
    'GROUP_BOT': [
      {
        id: 7,
        name: '每日工作提醒',
        category: '系统通知',
        type: 'markdown',
        content: '📅 **今日工作提醒** ({date})\n\n待处理工单：{pending_count} 个\n进行中工单：{processing_count} 个\n已完成工单：{completed_count} 个\n\n请各位同事及时跟进，保证服务质量�?,
        variables: ['{date}', '{pending_count}', '{processing_count}', '{completed_count}'],
        status: true
      }
    ]
  }
  return presets[activeTab.value] || []
}

// 显示创建对话框
const showCreateDialog = () => {
  isEditing.value = false
  templateForm.value = {
    name: '',
    category: '',
    push_type: 'realtime',
    message_type: 'notification',
    cron_expression: '',
    type: 'text',
    content: '',
    template_id: '',
    url: '',
    link_type: 'custom',
    keywords: '',
    ai_model: 'wework-official',
    status: true,
    variables: []
  }
  dialogVisible.value = true
}

// 打开Cron表达式生成器
const openCronGenerator = () => {
  window.open('http://cron.ciding.cc/', '_blank')
}

// 插入URL模板
const insertUrl = (type) => {
  const urls = {
    'presale': 'http://localhost:3000/project/{order_id}?type=presale',
    'aftersales': 'http://localhost:3000/project/{order_id}?type=aftersales',
    'sales': 'http://localhost:3000/project/{order_id}?type=sales',
    'status-query': 'http://localhost:3000/project/{order_id}?type=status',
    'payment': 'http://localhost:3000/pay/{order_id}'
  }
  templateForm.value.url = urls[type] || ''
}

// 获取消息类型颜色
const getMessageTypeColor = (type) => {
  const colors = {
    'notification': 'info',
    'marketing': 'warning',
    'verification': 'success'
  }
  return colors[type] || 'info'
}

// 获取消息类型文本
const getMessageTypeText = (type) => {
  const texts = {
    'notification': '通知类消息,
    'marketing': '营销类消息,
    'verification': '验证码类消息'
  }
  return texts[type] || type
}

// 编辑模板
const editTemplate = (template) => {
  isEditing.value = true
  templateForm.value = { ...template }
  dialogVisible.value = true
}

// 保存模板
const saveTemplate = async () => {
  if (!templateForm.value.name || !templateForm.value.content) {
    ElMessage.warning('请填写模板名称和内容')
    return
  }

  // 提取模板中的变量
  const variableRegex = /\{([^}]+)\}/g
  const matches = templateForm.value.content.matchAll(variableRegex)
  templateForm.value.variables = [...new Set([...matches].map(m => `{${m[1]}}`))]

  try {
    const url = isEditing.value 
      ? `http://localhost:8000/api/templates/${templateForm.value.id}`
      : 'http://localhost:8000/api/templates'
    
    await axios.post(url, {
      ...templateForm.value,
      channel: activeTab.value
    })

    ElMessage.success('模板保存成功')
    dialogVisible.value = false
    loadTemplates()
  } catch (error) {
    ElMessage.error('保存失败: ' + (error.response?.data?.detail || error.message))
  }
}

// 删除/关闭模板
const deleteTemplate = async (template) => {
  // 检查是否为系统预留模块
  if (template.is_system) {
    ElMessageBox.confirm(
      `此模块为系统预留模块，不可删除！\n\n💡 您可以通过"启用/禁用"开关来关闭此模块，而不会丢失数据。\n\n模块名称�?{template.name}`,
      '系统预留模块保护',
      {
        type: 'warning',
        confirmButtonText: '我明白了',
        cancelButtonText: '取消',
        cancelButtonClass: 'is-disabled'
      }
    ).catch(() => {
      // 用户点击取消或关�?
    })
    return
  }

  // 对于非系统模块，可以删除
  try {
    await ElMessageBox.confirm('确定要删除这个模板吗？删除后无法恢复�?, '确认删除', {
      type: 'warning',
      confirmButtonText: '确定删除',
      cancelButtonText: '取消'
    })
    
    await axios.delete(`http://localhost:8000/api/templates/${template.id}`)
    ElMessage.success('删除成功')
    loadTemplates()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('删除失败')
    }
  }
}

// 预览模板
const previewTemplate = (template) => {
  currentTemplate.value = template
  previewVisible.value = true
}

// 渲染模板
const renderTemplate = (template) => {
  let content = template.content
  
  // 替换变量为示例数�?
  const sampleData = {
    '{customer_name}': '张三',
    '{phone}': '13800138000',
    '{product}': '空调',
    '{order_id}': 'ORD20240202001',
    '{date}': '2024-02-02',
    '{time}': '14:30',
    '{amount}': '3999',
    '{status}': '已确�?,
    '{address}': '北京市朝阳区xxx路xxx�?,
    '{technician}': '李师�?,
    '{appointment_time}': '2024-02-03 09:00',
    '{tracking_number}': 'SF1234567890'
  }

  Object.entries(sampleData).forEach(([key, value]) => {
    content = content.replaceAll(key, `<span class="variable-value">${value}</span>`)
  })

  // Markdown渲染
  if (template.type === 'markdown') {
    content = content
      .replaceAll('\n', '<br>')
      .replaceAll('**', '<strong>')
      .replaceAll('**', '</strong>')
  }

  return content
}

// 插入变量
const insertVariable = (variable) => {
  const textarea = document.querySelector('textarea')
  if (textarea) {
    const start = textarea.selectionStart
    const end = textarea.selectionEnd
    const text = templateForm.value.content
    templateForm.value.content = text.substring(0, start) + variable + text.substring(end)
  }
}

// 填充示例数据
const fillSampleData = () => {
  if (activeTab.value === 'SMS') {
    templateForm.value.content = '尊敬的{customer_name}，您的订单{order_id}已确认，预计{date}送达�?
  } else if (activeTab.value === 'AI') {
    templateForm.value.content = '您好！关于{product}的咨询，我来为您解答...'
  }
}

// 测试发�?
const testTemplate = () => {
  ElMessage.info('测试发送功能开发中...')
}

// 切换状态
const toggleStatus = async (template) => {
  try {
    await axios.patch(`http://localhost:8000/api/templates/${template.id}/status`, {
      status: template.status
    })
    ElMessage.success(template.status ? '模板已启�? : '模板已禁�?)
  } catch (error) {
    ElMessage.error('状态更新失�?)
    template.status = !template.status
  }
}

// 获取分类类型
const getCategoryType = (category) => {
  const types = {
    '售前咨询': 'primary',
    '订单通知': 'success',
    '发货通知': 'info',
    '售后服务': 'warning',
    '预约提醒': 'danger',
    '维修进度': 'warning',
    '系统通知': 'info'
  }
  return types[category] || 'info'
}

// 保存基础URL配置
const saveBaseUrl = () => {
  localStorage.setItem('baseUrl', baseUrl.value)
  ElMessage.success('�?域名配置已保存！')
}

// 预设模板�?
const getPresetTemplate = (type) => {
  const templates = {
    presale: {
      name: '商机进展通知',
      category: '售前咨询',
      content: `尊敬�?{customer_name}�?

您的商机已更新！

📊 商机信息�?
�?预期成交额：¥{amount}
�?预期成交时间：{date}
�?当前阶段：{status}
�?负责销售：{technician}

👉 点击查看详情�?
${baseUrl.value}/project/{order_id}?type=presale

感谢您的信任！`
    },
    aftersales: {
      name: '工单进度更新',
      category: '售后服务',
      content: `尊敬�?{customer_name}�?

您的工单 {order_id} 有新的进展！

🔧 工单详情�?
�?故障描述：{product}
�?当前状态：{status}
�?处理进度：已处理
�?负责工程师：{technician}

👉 点击查看详情并反馈：
${baseUrl.value}/project/{order_id}?type=aftersales

如有问题，请随时联系我们。`
    },
    sales: {
      name: '订单确认通知',
      category: '订单通知',
      content: `亲爱�?{customer_name}�?

感谢您的购买！订单已确认�?

📦 订单信息�?
�?订单号：{order_id}
�?订单金额：¥{amount}
�?收货地址：{address}
�?预计送达：{date}

👉 点击查看订单详情�?
${baseUrl.value}/project/{order_id}?type=sales

感谢您的支持！`
    },
    payment: {
      name: '支付催付提醒',
      category: '订单通知',
      content: `尊敬�?{customer_name}�?

您的订单 {order_id} 需要完成支付�?

💰 支付信息�?
�?订单金额：¥{amount}
�?订单状态：待支�?
�?有效期：24小时�?

�?请尽快完成支付！

👉 点击前往支付�?
${baseUrl.value}/pay/{order_id}

支付完成后，我们将立即为您发货。`
    }
  }
  return templates[type] || templates['presale']
}

// 插入预设模板
const insertPresetTemplate = (type) => {
  if (!isEditing.value && !dialogVisible.value) {
    // 如果没有打开编辑对话框，自动打开
    templateForm.value = {
      name: '',
      category: '',
      push_type: 'realtime',
      message_type: 'notification',
      cron_expression: '',
      type: 'text',
      content: '',
      template_id: '',
      url: '',
      link_type: 'custom',
      keywords: '',
      ai_model: 'wework-official',
      status: true,
      variables: []
    }
    dialogVisible.value = true
  }
  
  // 获取预设模板
  const preset = getPresetTemplate(type)
  templateForm.value.name = preset.name
  templateForm.value.category = preset.category
  templateForm.value.content = preset.content
  templateForm.value.link_type = type
  
  // 自动关闭collapse，聚焦编辑框
  setTimeout(() => {
    const contentInput = document.querySelector('textarea[placeholder*="模板内容"]')
    if (contentInput) {
      contentInput.focus()
    }
  }, 100)
  
  ElMessage.success(`�?已加�?${preset.name}"模板`)
}

onMounted(() => {
  loadTemplates()
  loadAIModels()  // 加载AI模型列表
})
</script>

<style scoped>
.template-manager {
  padding: 20px;
}

.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-actions h2 {
  margin: 0;
}

.variable-help {
  margin-top: 10px;
  padding: 10px;
  background: #f5f7fa;
  border-radius: 4px;
}

.form-tip {
  font-size: 12px;
  color: #909399;
  margin-left: 10px;
}

.preview-container {
  padding: 20px;
}

.phone-preview {
  border: 3px solid #333;
  border-radius: 30px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.phone-header {
  background: #f7f7f7;
  padding: 15px;
  text-align: center;
  font-size: 14px;
  font-weight: bold;
  border-bottom: 1px solid #e0e0e0;
}

.phone-body {
  padding: 20px;
  background: #f5f5f5;
  min-height: 400px;
}

/* 微信公众号样�?*/
.wechat-message {
  background: #fff;
}

.wechat-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.wechat-title {
  padding: 15px;
  font-size: 16px;
  font-weight: bold;
  color: #333;
  background: linear-gradient(135deg, #07c160 0%, #1aad19 100%);
  color: white;
}

.wechat-content {
  padding: 15px;
  line-height: 1.8;
  color: #666;
}

.wechat-footer {
  padding: 12px 15px;
  background: #f7f7f7;
  border-top: 1px solid #e0e0e0;
  display: flex;
  align-items: center;
  gap: 5px;
  color: #576b95;
  font-size: 14px;
}

/* 企业微信样式 */
.work-wechat-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.work-wechat-header {
  padding: 12px 15px;
  background: #f7f7f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e0e0e0;
}

.app-name {
  font-weight: bold;
  color: #333;
}

.send-time {
  font-size: 12px;
  color: #999;
}

.work-wechat-content {
  padding: 15px;
  line-height: 1.8;
  color: #666;
  white-space: pre-wrap;
}

.work-wechat-actions {
  padding: 12px 15px;
  border-top: 1px solid #e0e0e0;
  text-align: right;
}

/* 短信样式 */
.sms-message {
  display: flex;
  justify-content: flex-start;
}

.sms-bubble {
  max-width: 80%;
  background: #95ec69;
  border-radius: 8px;
  padding: 12px;
  position: relative;
}

.sms-bubble::before {
  content: '';
  position: absolute;
  left: -8px;
  top: 10px;
  width: 0;
  height: 0;
  border-style: solid;
  border-width: 8px 8px 8px 0;
  border-color: transparent #95ec69 transparent transparent;
}

.sms-sender {
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
  font-size: 12px;
}

.sms-content {
  color: #333;
  line-height: 1.6;
  font-size: 14px;
}

.sms-time {
  font-size: 11px;
  color: #666;
  margin-top: 5px;
  text-align: right;
}

.preview-content {
  padding: 15px;
  background: #f5f7fa;
  border-radius: 4px;
  line-height: 1.8;
  white-space: pre-wrap;
}

:deep(.variable-value) {
  color: #409EFF;
  font-weight: bold;
  background: #ecf5ff;
  padding: 2px 6px;
  border-radius: 3px;
}
</style>

