<template>
  <div class="template-manager">
    <el-card>
      <template #header>
        <div class="header-actions">
          <h2>ğŸ“ æ¶ˆæ¯æ¨¡æ¿ç®¡ç†</h2>
          <el-button type="primary" @click="showCreateDialog">+ æ–°å»ºæ¨¡æ¿</el-button>
        </div>
      </template>

      <!-- ğŸ”§ åŸŸåé…ç½®é¢æ¿ -->
      <el-collapse>
        <el-collapse-item title="âš™ï¸ åŸŸåé…ç½® & å¿«é€Ÿæ¨¡æ? name="1">
          <el-row :gutter="20" style="margin-bottom: 20px;">
            <el-col :span="8">
              <div>
                <label><strong>ğŸ“ åŸºç¡€åŸŸåé…ç½®</strong></label>
                <p style="color: #666; font-size: 12px; margin: 10px 0;">
                  é…ç½®ngrokæˆ–è‡ªå®šä¹‰åŸŸåï¼Œæ¨¡æ¿é“¾æ¥ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥åŸŸå?
                </p>
                <el-input 
                  v-model="baseUrl"
                  placeholder="å¦‚ï¼šhttps://xxxx.ngrok.io æˆ?http://localhost:3000"
                  style="margin-bottom: 10px;"
                >
                  <template #prepend>åŸŸå</template>
                </el-input>
                <el-button @click="saveBaseUrl" type="success" style="width: 100%;">
                  ğŸ’¾ ä¿å­˜åŸŸåé…ç½®
                </el-button>
              </div>
            </el-col>

            <el-col :span="16">
              <div>
                <label><strong>ğŸ“ å¿«é€Ÿé¢„è®¾æ¨¡æ?/strong></label>
                <p style="color: #666; font-size: 12px; margin: 10px 0;">
                  å¿«é€Ÿæ’å…¥é¢„è®¾æ¨¡æ¿å†…å®¹ï¼Œç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¡«å……åˆ°ç¼–è¾‘æ¡†
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                  <el-button @click="insertPresetTemplate('presale')" type="info" size="small">
                    ğŸ¯ å•†æœºé€šçŸ¥æ¨¡æ¿
                  </el-button>
                  <el-button @click="insertPresetTemplate('aftersales')" type="warning" size="small">
                    ğŸ”§ å·¥å•è¿›åº¦æ¨¡æ¿
                  </el-button>
                  <el-button @click="insertPresetTemplate('sales')" type="success" size="small">
                    ğŸ“¦ è®¢å•ç¡®è®¤æ¨¡æ¿
                  </el-button>
                  <el-button @click="insertPresetTemplate('payment')" type="danger" size="small">
                    ğŸ’³ æ”¯ä»˜å‚¬ä»˜æ¨¡æ¿
                  </el-button>
                </div>
              </div>
            </el-col>
          </el-row>

          <!-- ç°æœ‰URLé…ç½®é€Ÿè§ˆ -->
          <el-alert
            title="ğŸ’¡ å½“å‰URLé…ç½®"
            type="info"
            :closable="false"
            style="margin-top: 15px;"
          >
            <div style="font-family: monospace; font-size: 12px; line-height: 1.8;">
              <div>åŸºç¡€åŸŸåï¼?strong>{{ baseUrl || 'http://localhost:3000' }}</strong></div>
              <div style="margin-top: 10px; color: #606266;">
                <div>å”®å‰å•†æœºï¼š{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=presale</div>
                <div>å”®åå·¥å•ï¼š{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=aftersales</div>
                <div>é”€å”®è®¢å•ï¼š{{ baseUrl || 'http://localhost:3000' }}/project/{order_id}?type=sales</div>
                <div>åœ¨çº¿æ”¯ä»˜ï¼š{{ baseUrl || 'http://localhost:3000' }}/pay/{order_id}</div>
              </div>
            </div>
          </el-alert>
        </el-collapse-item>
      </el-collapse>

      <!-- æ¨¡æ¿åˆ†ç±»æ ‡ç­¾ -->
      <el-tabs v-model="activeTab" @tab-change="loadTemplates" style="margin-top: 20px;">
        <el-tab-pane label="ğŸ“± çŸ­ä¿¡æ¨¡æ¿" name="SMS"></el-tab-pane>
        <el-tab-pane label="ğŸ“§ é‚®ä»¶æ¨¡æ¿" name="EMAIL"></el-tab-pane>
        <el-tab-pane label="ğŸ’¬ å¾®ä¿¡å…¬ä¼—å? name="WECHAT"></el-tab-pane>
        <el-tab-pane label="ğŸ¢ ä¼ä¸šå¾®ä¿¡" name="WORK_WECHAT"></el-tab-pane>
        <el-tab-pane label="ğŸ¤– AIå›å¤æ¨¡æ¿" name="AI"></el-tab-pane>
        <el-tab-pane label="ğŸ“¢ ç¾¤æœºå™¨äºº" name="GROUP_BOT"></el-tab-pane>
      </el-tabs>

      <!-- æ¨¡æ¿åˆ—è¡¨ -->
      <el-table :data="templates" border style="margin-top: 20px;">
        <el-table-column prop="id" label="æ¨¡æ¿ID" width="80"></el-table-column>
        <el-table-column prop="name" label="æ¨¡æ¿åç§°" width="200"></el-table-column>
        <el-table-column prop="category" label="ä½¿ç”¨åœºæ™¯" width="120">
          <template #default="scope">
            <el-tag :type="getCategoryType(scope.row.category)">
              {{ scope.row.category }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="content" label="æ¨¡æ¿å†…å®¹" show-overflow-tooltip></el-table-column>
        <el-table-column prop="variables" label="å¯ç”¨å˜é‡" width="180">
          <template #default="scope">
            <el-tag 
              v-for="variable in scope.row.variables" 
              :key="variable" 
              size="small"
              style="margin: 2px;"
            >
              {{ variable }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="çŠ¶æ€? width="100">
          <template #default="scope">
            <el-switch
              v-model="scope.row.status"
              active-text="å¯ç”¨"
              inactive-text="ç¦ç”¨"
              @change="toggleStatus(scope.row)"
            ></el-switch>
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="220" fixed="right">
          <template #default="scope">
            <el-button size="small" @click="editTemplate(scope.row)">ç¼–è¾‘</el-button>
            <el-button size="small" type="info" @click="previewTemplate(scope.row)">é¢„è§ˆ</el-button>
            <el-button 
              size="small" 
              :type="scope.row.is_system ? 'warning' : 'danger'"
              @click="deleteTemplate(scope.row)"
            >
              {{ scope.row.is_system ? 'ğŸ”’ ç¦ç”¨' : 'åˆ é™¤' }}
            </el-button>
            <el-tag v-if="scope.row.is_system" type="success" size="small" style="margin-left: 5px;">
              ç³»ç»Ÿé¢„ç•™
            </el-tag>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ¿å¯¹è¯æ¡?-->
    <el-dialog 
      v-model="dialogVisible" 
      :title="dialogTitle"
      width="800px"
    >
      <el-form :model="templateForm" label-width="120px">
        <el-form-item label="æ¨¡æ¿åç§°">
          <el-input v-model="templateForm.name" placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§?></el-input>
        </el-form-item>

        <el-form-item label="ä½¿ç”¨åœºæ™¯">
          <el-select v-model="templateForm.category" placeholder="è¯·é€‰æ‹©ä½¿ç”¨åœºæ™¯">
            <el-option label="å”®å‰å’¨è¯¢" value="å”®å‰å’¨è¯¢"></el-option>
            <el-option label="è®¢å•é€šçŸ¥" value="è®¢å•é€šçŸ¥"></el-option>
            <el-option label="å‘è´§é€šçŸ¥" value="å‘è´§é€šçŸ¥"></el-option>
            <el-option label="å”®åæœåŠ¡" value="å”®åæœåŠ¡"></el-option>
            <el-option label="é¢„çº¦æé†’" value="é¢„çº¦æé†’"></el-option>
            <el-option label="ç»´ä¿®è¿›åº¦" value="ç»´ä¿®è¿›åº¦"></el-option>
            <el-option label="ç³»ç»Ÿé€šçŸ¥" value="ç³»ç»Ÿé€šçŸ¥"></el-option>
          </el-select>
        </el-form-item>

        <el-form-item label="æ¨é€ç±»å?>
          <el-radio-group v-model="templateForm.push_type">
            <el-radio label="realtime">å®æ—¶æ¨é€?/el-radio>
            <el-radio label="scheduled">å®šæ—¶æ¨é€?/el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="å‘é€æ—¶é—? v-if="templateForm.push_type === 'scheduled'">
          <el-input 
            v-model="templateForm.cron_expression" 
            placeholder="è¾“å…¥Cronè¡¨è¾¾å¼ï¼Œå¦‚ï¼š0 0 9 * * ? è¡¨ç¤ºæ¯å¤©9ç‚?
          >
            <template #append>
              <el-button @click="openCronGenerator">Cronç”Ÿæˆå™?/el-button>
            </template>
          </el-input>
          <span class="form-tip">
            ç”Ÿæˆå™? <a href="http://cron.ciding.cc/" target="_blank">http://cron.ciding.cc/</a>
          </span>
        </el-form-item>

        <el-form-item label="æ¶ˆæ¯ç±»å‹">
          <el-radio-group v-model="templateForm.message_type">
            <el-radio label="notification">é€šçŸ¥ç±»æ¶ˆæ?/el-radio>
            <el-radio label="marketing">è¥é”€ç±»æ¶ˆæ?/el-radio>
            <el-radio label="verification">éªŒè¯ç ç±»æ¶ˆæ¯</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="æ¨¡æ¿ç±»å‹">
          <el-radio-group v-model="templateForm.type">
            <el-radio label="text">çº¯æ–‡æœ?/el-radio>
            <el-radio label="card">å¡ç‰‡æ¶ˆæ¯</el-radio>
            <el-radio label="markdown">Markdown</el-radio>
            <el-radio label="template">å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯</el-radio>
          </el-radio-group>
        </el-form-item>

        <!-- å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ä¸“ç”¨å­—æ®µ -->
        <el-form-item label="æ¨¡æ¿ID" v-if="activeTab === 'WECHAT' && templateForm.type === 'template'">
          <el-input v-model="templateForm.template_id" placeholder="å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿ID"></el-input>
          <span class="form-tip">ä»å¾®ä¿¡å…¬ä¼—å¹³å°è·å–æ¨¡æ¿ID</span>
        </el-form-item>

        <el-form-item label="è·³è½¬é“¾æ¥" v-if="templateForm.type === 'template' || templateForm.type === 'card'">
          <el-select v-model="templateForm.link_type" placeholder="é€‰æ‹©é“¾æ¥ç±»å‹" style="width: 200px; margin-bottom: 10px;">
            <el-option label="è‡ªå®šä¹‰é“¾æ? value="custom"></el-option>
            <el-option label="å”®å‰å•†æœºè¯¦æƒ…" value="presale"></el-option>
            <el-option label="å”®åå·¥å•è¯¦æƒ…" value="aftersales"></el-option>
            <el-option label="é”€å”®è®¢å•è¯¦æƒ? value="sales"></el-option>
            <el-option label="é¡¹ç›®çŠ¶æ€æŸ¥è¯? value="status-query"></el-option>
          </el-select>

          <el-input 
            v-model="templateForm.url" 
            placeholder="ç‚¹å‡»åè·³è½¬çš„URL"
            style="margin-top: 10px;"
          ></el-input>

          <div style="margin-top: 10px;">
            <el-tag 
              v-if="templateForm.link_type === 'presale'"
              size="small" 
              @click="insertUrl('presale')" 
              style="margin: 2px; cursor: pointer;"
            >
              å”®å‰å•†æœº: http://localhost:3000/project/{order_id}?type=presale
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'status-query'"
              size="small" 
              @click="insertUrl('status-query')" 
              style="margin: 2px; cursor: pointer;"
            >
              é¡¹ç›®çŠ¶æ€? http://localhost:3000/project/{order_id}?type=status
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'aftersales'"
              size="small" 
              @click="insertUrl('aftersales')" 
              style="margin: 2px; cursor: pointer;"
            >
              å”®åå·¥å•: http://localhost:3000/project/{order_id}?type=aftersales
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'sales'"
              size="small" 
              @click="insertUrl('sales')" 
              style="margin: 2px; cursor: pointer;"
            >
              é”€å”®è®¢å? http://localhost:3000/project/{order_id}?type=sales
            </el-tag>
            <el-tag 
              v-if="templateForm.link_type === 'custom'"
              size="small" 
              @click="insertUrl('payment')" 
              style="margin: 2px; cursor: pointer;"
            >
              ä»˜æ¬¾é¡µé¢: http://localhost:3000/pay/{order_id}
            </el-tag>
          </div>

          <el-alert 
            style="margin-top: 10px;" 
            type="info" 
            :closable="false"
          >
            <template v-if="templateForm.link_type === 'presale'">
              <strong>å”®å‰å•†æœºé¡µé¢</strong>åŒ…å«ï¼šå®¢æˆ·éœ€æ±‚ã€é¢„ç®—é‡‘é¢ã€è·Ÿè¿›è®°å½•ã€è´Ÿè´£é”€å”®ç­‰ä¿¡æ¯
            </template>
            <template v-else-if="templateForm.link_type === 'aftersales'">
              <strong>å”®åå·¥å•é¡µé¢</strong>åŒ…å«ï¼šæ•…éšœæè¿°ã€å¤„ç†è¿›åº¦ã€å·¥ç¨‹å¸ˆä¿¡æ¯ã€å®¢æˆ·åé¦ˆï¼ˆå·²è§£å†?æœªè§£å†³è½¬å·¥ç¨‹å¸ˆï¼‰
            </template>
            <template v-else-if="templateForm.link_type === 'sales'">
              <strong>é”€å”®è®¢å•é¡µé?/strong>åŒ…å«ï¼šè®¢å•è¯¦æƒ…ã€å•†å“åˆ—è¡¨ã€ç‰©æµä¿¡æ¯ã€åœ¨çº¿æ”¯ä»?
            </template>
            <template v-else>
              ç‚¹å‡»æ ‡ç­¾æ’å…¥å¸¸ç”¨é“¾æ¥æ¨¡æ¿
            </template>
          </el-alert>
        </el-form-item>

        <!-- AIæ¨¡æ¿ä¸“ç”¨å­—æ®µ -->
        <el-form-item label="è§¦å‘å…³é”®è¯? v-if="activeTab === 'AI'">
          <el-input 
            v-model="templateForm.keywords" 
            placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªå…³é”®è¯ï¼Œå¦‚ï¼šä»·æ ¼,æŠ¥ä»·,å¤šå°‘é’?
          ></el-input>
        </el-form-item>

        <el-form-item label="AIæ¨¡å‹" v-if="activeTab === 'AI'">
          <el-select v-model="templateForm.ai_model" placeholder="é€‰æ‹©AIæ¨¡å‹">
            <el-option 
              v-for="model in aiModels" 
              :key="model.value"
              :label="model.label"
              :value="model.value"
            >
              <span>{{ model.label }}</span>
              <el-tag 
                v-if="model.is_official" 
                type="success" 
                size="small" 
                style="margin-left: 10px;"
              >
                âœ?å®˜æ–¹API
              </el-tag>
              <el-tag 
                v-if="model.is_default" 
                type="primary" 
                size="small" 
                style="margin-left: 5px;"
              >
                é»˜è®¤
              </el-tag>
            </el-option>
          </el-select>
          <div style="color: #909399; font-size: 12px; margin-top: 8px;">
            ğŸ’¡ æ¨èä½¿ç”¨<strong style="color: #67C23A;">ä¼ä¸šå¾®ä¿¡å®˜æ–¹API</strong>ï¼Œå®‰å…¨ç¨³å®šæ— é£é™©
          </div>
        </el-form-item>

        <el-form-item label="æ¨¡æ¿å†…å®¹">
          <el-input 
            v-model="templateForm.content" 
            type="textarea" 
            :rows="8"
            placeholder="æ”¯æŒå˜é‡ï¼š{customer_name} {phone} {product} {order_id} {date} {time} {amount} {status}"
          ></el-input>
          <div class="variable-help">
            <el-tag 
              v-for="v in availableVariables" 
              :key="v.key"
              size="small"
              @click="insertVariable(v.key)"
              style="margin: 5px; cursor: pointer;"
            >
              {{ v.key }} - {{ v.desc }}
            </el-tag>
          </div>
        </el-form-item>

        <el-form-item label="ç¤ºä¾‹æ•°æ®">
          <el-button size="small" @click="fillSampleData">å¡«å……ç¤ºä¾‹</el-button>
          <el-button size="small" type="success" @click="testTemplate">æµ‹è¯•å‘é€?/el-button>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveTemplate">ä¿å­˜æ¨¡æ¿</el-button>
      </template>
    </el-dialog>

    <!-- é¢„è§ˆå¯¹è¯æ¡?-->
    <el-dialog v-model="previewVisible" title="æ¨¡æ¿é¢„è§ˆ" width="800px">
      <div class="preview-container" v-if="currentTemplate">
        <el-row :gutter="20">
          <!-- å·¦ä¾§ï¼šæ¨¡æ¿ä¿¡æ?-->
          <el-col :span="12">
            <h3>{{ currentTemplate.name }}</h3>
            <el-descriptions :column="1" size="small" border style="margin-top: 10px;">
              <el-descriptions-item label="ä½¿ç”¨åœºæ™¯">
                <el-tag>{{ currentTemplate.category }}</el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="æ¨é€ç±»å?>
                <el-tag :type="currentTemplate.push_type === 'realtime' ? 'success' : 'warning'">
                  {{ currentTemplate.push_type === 'realtime' ? 'å®æ—¶æ¨é€? : 'å®šæ—¶æ¨é€? }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="æ¶ˆæ¯ç±»å‹">
                <el-tag :type="getMessageTypeColor(currentTemplate.message_type)">
                  {{ getMessageTypeText(currentTemplate.message_type) }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="Cronè¡¨è¾¾å¼? v-if="currentTemplate.cron_expression">
                <code>{{ currentTemplate.cron_expression }}</code>
              </el-descriptions-item>
              <el-descriptions-item label="è·³è½¬é“¾æ¥" v-if="currentTemplate.url">
                <el-link :href="currentTemplate.url" target="_blank" type="primary">
                  {{ currentTemplate.url }}
                </el-link>
              </el-descriptions-item>
            </el-descriptions>
          </el-col>

          <!-- å³ä¾§ï¼šæ¨¡æ‹Ÿæ‰‹æœºé¢„è§?-->
          <el-col :span="12">
            <div class="phone-preview">
              <div class="phone-header">
                <span v-if="activeTab === 'WECHAT'">ğŸ’¬ å¾®ä¿¡å…¬ä¼—å?/span>
                <span v-else-if="activeTab === 'WORK_WECHAT'">ğŸ¢ ä¼ä¸šå¾®ä¿¡</span>
                <span v-else-if="activeTab === 'SMS'">ğŸ“± çŸ­ä¿¡</span>
                <span v-else>{{ activeTab }}</span>
              </div>
              <div class="phone-body">
                <!-- å¾®ä¿¡å…¬ä¼—å·æ ·å¼?-->
                <div v-if="activeTab === 'WECHAT'" class="wechat-message">
                  <div class="wechat-card">
                    <div class="wechat-title">{{ currentTemplate.name }}</div>
                    <div class="wechat-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="wechat-footer" v-if="currentTemplate.url">
                      <el-icon><Link /></el-icon>
                      <span>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</span>
                    </div>
                  </div>
                </div>

                <!-- ä¼ä¸šå¾®ä¿¡æ ·å¼ -->
                <div v-else-if="activeTab === 'WORK_WECHAT'" class="work-wechat-message">
                  <div class="work-wechat-card">
                    <div class="work-wechat-header">
                      <span class="app-name">å”®å‰å”®åç³»ç»Ÿ</span>
                      <span class="send-time">åˆšåˆš</span>
                    </div>
                    <div class="work-wechat-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="work-wechat-actions" v-if="currentTemplate.url">
                      <el-button size="small" type="primary">æŸ¥çœ‹è¯¦æƒ…</el-button>
                    </div>
                  </div>
                </div>

                <!-- çŸ­ä¿¡æ ·å¼ -->
                <div v-else-if="activeTab === 'SMS'" class="sms-message">
                  <div class="sms-bubble">
                    <div class="sms-sender">ã€å”®å‰å”®åç³»ç»Ÿã€?/div>
                    <div class="sms-content" v-html="renderTemplate(currentTemplate)"></div>
                    <div class="sms-time">{{ new Date().toLocaleTimeString() }}</div>
                  </div>
                </div>

                <!-- å…¶ä»–ç±»å‹ -->
                <div v-else class="default-message">
                  <div class="preview-content" v-html="renderTemplate(currentTemplate)"></div>
                </div>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import axios from 'axios'

const activeTab = ref('SMS')
const dialogVisible = ref(false)
const previewVisible = ref(false)
const templates = ref([])
const currentTemplate = ref(null)
const isEditing = ref(false)
const baseUrl = ref(localStorage.getItem('baseUrl') || 'http://localhost:3000')

const dialogTitle = computed(() => isEditing.value ? 'ç¼–è¾‘æ¨¡æ¿' : 'æ–°å»ºæ¨¡æ¿')

// æ¨¡æ¿è¡¨å•
// AIæ¨¡å‹åˆ—è¡¨ï¼ˆä»åç«¯åŠ è½½ï¼?
const aiModels = ref([])
const defaultAIModel = ref('wework-official')

const templateForm = ref({
  name: '',
  category: '',
  push_type: 'realtime',
  message_type: 'notification',
  cron_expression: '',
  type: 'text',
  content: '',
  template_id: '',
  url: '',
  link_type: 'custom',
  keywords: '',
  ai_model: 'wework-official',
  status: true,
  variables: []
})

// å¯ç”¨å˜é‡
const availableVariables = [
  { key: '{customer_name}', desc: 'å®¢æˆ·å§“å' },
  { key: '{phone}', desc: 'æ‰‹æœºå? },
  { key: '{product}', desc: 'äº§å“åç§°' },
  { key: '{order_id}', desc: 'è®¢å•å? },
  { key: '{date}', desc: 'æ—¥æœŸ' },
  { key: '{time}', desc: 'æ—¶é—´' },
  { key: '{amount}', desc: 'é‡‘é¢' },
  { key: '{status}', desc: 'çŠ¶æ€? },
  { key: '{address}', desc: 'åœ°å€' },
  { key: '{technician}', desc: 'æŠ€æœ¯å‘˜' },
  { key: '{appointment_time}', desc: 'é¢„çº¦æ—¶é—´' }
]

// åŠ è½½AIæ¨¡å‹åˆ—è¡¨
const loadAIModels = async () => {
  try {
    const response = await axios.get('http://localhost:8000/api/admin/ai-models/active')
    aiModels.value = response.data || []
    
    // æŸ¥æ‰¾é»˜è®¤æ¨¡å‹
    const defaultModel = aiModels.value.find(m => m.is_default)
    if (defaultModel) {
      defaultAIModel.value = defaultModel.value
      templateForm.value.ai_model = defaultModel.value
    }
    
    console.log('âœ?å·²åŠ è½½AIæ¨¡å‹åˆ—è¡¨:', aiModels.value.length, 'ä¸ªæ¨¡å?)
  } catch (error) {
    console.error('â?åŠ è½½AIæ¨¡å‹åˆ—è¡¨å¤±è´¥:', error)
    // ä½¿ç”¨é»˜è®¤é…ç½®
    aiModels.value = [
      { value: 'wework-official', label: 'ä¼ä¸šå¾®ä¿¡å®˜æ–¹API', is_official: true, is_default: true }
    ]
  }
}

// åŠ è½½æ¨¡æ¿
const loadTemplates = async () => {
  try {
    const response = await axios.get('http://localhost:8000/api/templates', {
      params: { type: activeTab.value }
    })
    templates.value = response.data.templates || getPresetTemplates()
  } catch (error) {
    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error)
    templates.value = getPresetTemplates()
  }
}

// è·å–é¢„åˆ¶æ¨¡æ¿
const getPresetTemplates = () => {
  const presets = {
    'SMS': [
      {
        id: 1,
        name: 'è®¢å•ç¡®è®¤çŸ­ä¿¡',
        category: 'è®¢å•é€šçŸ¥',
        type: 'text',
        content: 'å°Šæ•¬çš„{customer_name}ï¼Œæ‚¨çš„è®¢å•{order_id}å·²ç¡®è®¤ï¼Œé¢„è®¡{date}é€è¾¾ã€‚å¦‚æœ‰ç–‘é—®è¯·è‡´ç”µå®¢æœã€?,
        variables: ['{customer_name}', '{order_id}', '{date}'],
        status: true
      },
      {
        id: 2,
        name: 'å‘è´§é€šçŸ¥çŸ­ä¿¡',
        category: 'å‘è´§é€šçŸ¥',
        type: 'text',
        content: 'æ‚¨å¥½{customer_name}ï¼Œæ‚¨çš„è®¢å•{order_id}å·²å‘è´§ï¼Œç‰©æµå•å·{tracking_number}ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ã€?,
        variables: ['{customer_name}', '{order_id}', '{tracking_number}'],
        status: true
      }
    ],
    'WECHAT': [
      {
        id: 3,
        name: 'å”®åé¢„çº¦æé†’',
        category: 'é¢„çº¦æé†’',
        type: 'template',
        template_id: 'YOUR_TEMPLATE_ID',
        content: 'é¢„çº¦æ—¶é—´ï¼š{appointment_time}\næœåŠ¡åœ°å€ï¼š{address}\nè”ç³»ç”µè¯ï¼š{phone}\næŠ€æœ¯å‘˜ï¼š{technician}',
        url: 'https://your-domain.com/appointment/{order_id}',
        variables: ['{appointment_time}', '{address}', '{phone}', '{technician}'],
        status: true
      }
    ],
    'WORK_WECHAT': [
      {
        id: 4,
        name: 'ç´§æ€¥å·¥å•é€šçŸ¥',
        category: 'ç³»ç»Ÿé€šçŸ¥',
        type: 'card',
        content: 'ğŸš¨ ç´§æ€¥å·¥å•æé†’\n\nå·¥å•ç¼–å·ï¼š{order_id}\nå®¢æˆ·ï¼š{customer_name}\né—®é¢˜ï¼š{product} æ•…éšœ\nåœ°å€ï¼š{address}\n\nè¯·åŠæ—¶å¤„ç†ï¼',
        variables: ['{order_id}', '{customer_name}', '{product}', '{address}'],
        status: true
      }
    ],
    'AI': [
      {
        id: 5,
        name: 'ğŸ’° ä»·æ ¼å’¨è¯¢AIå›å¤',
        category: 'å”®å‰å’¨è¯¢',
        type: 'text',
        keywords: 'ä»·æ ¼,æŠ¥ä»·,å¤šå°‘é’?è´¹ç”¨,æˆæœ¬',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºå›å¤å®¢æˆ·çš„ä»·æ ¼å’¨è¯¢é—®é¢?,
        content: `æ‚¨å¥½ï¼å…³äº{product}çš„ä»·æ ¼ï¼Œæˆ‘ä»¬æä¾›ä»¥ä¸‹æ–¹æ¡ˆï¼?

ğŸ“Š **ä»·æ ¼ä½“ç³»**
â€?åŸºç¡€ç‰ˆï¼š{price_basic}å…?
â€?æ ‡å‡†ç‰ˆï¼š{price_standard}å…? 
â€?æ——èˆ°ç‰ˆï¼š{price_premium}å…?

ğŸ’¡ **å¦‚ä½•é€‰æ‹©ï¼?*
- å°è§„æ¨¡ä½¿ç”?â†?åŸºç¡€ç‰?
- ä¸­ç­‰è§„æ¨¡ â†?æ ‡å‡†ç‰ˆï¼ˆæ€§ä»·æ¯”æœ€ä½³ï¼‰
- å¤§è§„æ¨¡ä¼ä¸?â†?æ——èˆ°ç‰ˆï¼ˆåŠŸèƒ½å…¨é¢ï¼?

å…·ä½“ä»·æ ¼ä¼šæ ¹æ®æ‚¨çš„éœ€æ±‚æœ‰æ‰€è°ƒæ•´ã€‚æˆ‘æ˜¯{sales_representative_name}ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼?

ğŸ“ éœ€è¦è¯¦ç»†å’¨è¯¢ï¼Ÿç‚¹å‡»é“¾æ¥äº†è§£æ›´å¤šï¼?
{baseUrl}/project/{order_id}?type=presale

è¯·é—®æ‚¨æ›´å€¾å‘äºå“ªä¸ªç‰ˆæœ¬å‘¢ï¼Ÿ`,
        variables: ['{product}', '{price_basic}', '{price_standard}', '{price_premium}', '{sales_representative_name}', '{baseUrl}', '{order_id}'],
        status: true
      },
      {
        id: 6,
        name: 'ğŸ”§ å”®åç»´ä¿®AIå›å¤',
        category: 'å”®åæœåŠ¡',
        type: 'text',
        keywords: 'ç»´ä¿®,æŠ¥ä¿®,åäº†,ä¸èƒ½ç”?æ•…éšœ,åæ‰,ä¿®ç†',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºå›å¤å”®åç»´ä¿®ç›¸å…³é—®é¢˜',
        content: `éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿ï¼ğŸ˜?

æˆ‘å·²ä¸ºæ‚¨è®°å½•æŠ¥ä¿®ä¿¡æ¯ï¼?

ğŸ› ï¸?**ç»´ä¿®å·¥å•**
â€?äº§å“ï¼š{product}
â€?é—®é¢˜ï¼š{issue}
â€?é¢„çº¦æ—¶é—´ï¼š{appointment_time}
â€?å·¥å•å·ï¼š{ticket_id}

âœ?**æˆ‘ä»¬æ‰¿è¯º**
æˆ‘ä»¬çš„æŠ€æœ¯å‘˜{technician}ï¼ˆç”µè¯ï¼š{technician_phone}ï¼‰å°†å‡†æ—¶ä¸Šé—¨æœåŠ¡ï¼Œé¢„è®¡{expected_visit_date} {expected_visit_time}åˆ°è¾¾ã€?

è¯·ä¿æŒç”µè¯ç•…é€šï¼Œä»¥ä¾¿æˆ‘ä»¬åŠæ—¶è”ç³»æ‚¨ã€?

ğŸ“‹ æŸ¥çœ‹ç»´ä¿®è¯¦æƒ…å’Œè¿›åº¦ï¼š
{baseUrl}/project/{ticket_id}?type=aftersales

æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ï¼`,
        variables: ['{product}', '{issue}', '{appointment_time}', '{ticket_id}', '{technician}', '{technician_phone}', '{expected_visit_date}', '{expected_visit_time}', '{baseUrl}'],
        status: true
      },
      {
        id: 7,
        name: 'ğŸ“¦ è®¢å•ç¡®è®¤AIå›å¤',
        category: 'è®¢å•é€šçŸ¥',
        type: 'text',
        keywords: 'è®¢å•,ç¡®è®¤,å·²ä¸‹å?æ”¶åˆ°è®¢å•,è®¢å•å?,
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºè®¢å•ç¡®è®¤é€šçŸ¥',
        content: `è®¢å•ç¡®è®¤æˆåŠŸï¼ğŸ?

æ„Ÿè°¢{customer_name}çš„è®¢å•ï¼Œæˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„è´­ä¹°ç”³è¯·ã€?

ğŸ“‹ **è®¢å•ä¿¡æ¯**
â€?è®¢å•å·ï¼š{order_id}
â€?äº§å“ï¼š{product}
â€?é‡‘é¢ï¼š{amount}å…?
â€?è®¢å•æ—¶é—´ï¼š{order_date}
â€?é¢„æœŸäº¤ä»˜ï¼š{expected_delivery_date}

ğŸ’° **æ”¯ä»˜æ–¹å¼**
ç‚¹å‡»é“¾æ¥å®Œæˆæ”¯ä»˜ï¼?
{baseUrl}/pay/{order_id}

éœ€è¦å‘ç¥¨å—ï¼Ÿæˆ‘ä»¬çš„å®¢æœä¼šä¸ºæ‚¨å¼€å…·æ­£å¼å‘ç¥¨ã€?

ğŸ“ åç»­æµç¨‹
1. ğŸ’³ å®Œæˆæ”¯ä»˜
2. ğŸ“¦ æˆ‘ä»¬ä¸ºæ‚¨å‡†å¤‡å•†å“
3. ğŸšš å‘è´§å¹¶æ¨é€ç‰©æµä¿¡æ? 
4. âœ?ç¡®è®¤æ”¶è´§

æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ã€‚ç¥æ‚¨è´­ç‰©æ„‰å¿«ï¼`,
        variables: ['{customer_name}', '{order_id}', '{product}', '{amount}', '{order_date}', '{expected_delivery_date}', '{baseUrl}'],
        status: true
      },
      {
        id: 8,
        name: 'â?å¸¸è§é—®é¢˜AIå›å¤',
        category: 'å”®å‰å’¨è¯¢',
        type: 'text',
        keywords: 'æ€ä¹ˆæ ?å¦‚ä½•,æ€ä¹ˆ,ä»€ä¹?å“ªä¸ª,å¦‚ä½•ä½¿ç”¨,ä½¿ç”¨æ–¹æ³•',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºå›ç­”å¸¸è§é—®é¢˜',
        content: `å¾ˆé«˜å…´æ‚¨å¯¹æˆ‘ä»¬çš„äº§å“æ„Ÿå…´è¶£ï¼ğŸ˜Š

å…³äºæ‚¨æå‡ºçš„é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯å¸¸è§è§£ç­”ï¼?

â?**å¸¸è§é—®é¢˜**

**Q1ï¼šäº§å“ä½¿ç”¨éš¾åº¦é«˜å—ï¼Ÿ**
Aï¼šéå¸¸ç®€å•ï¼æˆ‘ä»¬çš„äº§å“è®¾è®¡éµå¾?å‚»ç“œå¼æ“ä½?åŸåˆ™ï¼Œå³ä½¿æ˜¯æ–°æ‰‹ä¹Ÿèƒ½5åˆ†é’Ÿä¸Šæ‰‹ã€?

**Q2ï¼šæœ‰å”®åä¿éšœå—ï¼Ÿ**
Aï¼šå½“ç„¶æœ‰ï¼æˆ‘ä»¬æä¾›ï¼š
  âœ?1å¹´å…è´¹ä¿ä¿?
  âœ?7Ã—24å°æ—¶æŠ€æœ¯æ”¯æŒ?
  âœ?30å¤©æ— ç†ç”±é€€æ¢è´§

**Q3ï¼šèƒ½å®šåˆ¶åŒ–å—ï¼?*
Aï¼šå¯ä»¥çš„ï¼æˆ‘ä»¬æ”¯æŒï¼š
  â€?åŠŸèƒ½å®šåˆ¶
  â€?ç•Œé¢å®šåˆ¶  
  â€?é›†æˆå®šåˆ¶

**Q4ï¼šè´­ä¹°åå¦‚ä½•å¾—åˆ°æŠ€æœ¯æ”¯æŒï¼Ÿ**
Aï¼šå¤šç§æ–¹å¼ä»»é€‰ï¼š
  ğŸ“ ç”µè¯ï¼š{sales_representative_phone}
  ğŸ’¬ å¾®ä¿¡ï¼šæœç´?{sales_representative_name}"
  ğŸ“§ é‚®ä»¶ï¼šsupport@company.com
  ğŸ’» åœ¨çº¿ï¼š{baseUrl}/support

å¦‚æœæ‚¨çš„é—®é¢˜ä¸åœ¨ä»¥ä¸Šåˆ—è¡¨ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä¼šä¸ºæ‚¨è¯¦ç»†è§£ç­”ï¼?

ç‚¹å‡»äº†è§£æ›´å¤šï¼š{baseUrl}/product/{product}`,
        variables: ['{product}', '{sales_representative_name}', '{sales_representative_phone}', '{baseUrl}'],
        status: true
      },
      {
        id: 9,
        name: 'ğŸ“Š æ•°æ®ç»Ÿè®¡AIå›å¤',
        category: 'æŸ¥è¯¢ç»Ÿè®¡',
        type: 'text',
        keywords: 'ç»Ÿè®¡,æ•°æ®,æŠ¥è¡¨,åˆ†æ,æœ‰å¤šå°?æ€»å…±,ä¸€å…?,
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºæä¾›æ•°æ®ç»Ÿè®¡ä¿¡æ¯',
        content: `æ‚¨å¥½ï¼ä»¥ä¸‹æ˜¯æœ€æ–°çš„æ•°æ®ç»Ÿè®¡ï¼?

ğŸ“ˆ **ä¸šç»©ç»Ÿè®¡**ï¼ˆ{query_date}ï¼?

**é”€å”®æ•°æ?*
â€?ä»Šæ—¥è®¢å•ï¼š{today_orders}ä¸?
â€?æœ¬æœˆè®¢å•ï¼š{month_orders}ä¸?
â€?æœ¬æœˆé‡‘é¢ï¼š{month_amount}å…?
â€?åŒæ¯”å¢é•¿ï¼š{growth_rate}%

**æœåŠ¡æ•°æ®**
â€?å¾…å¤„ç†å·¥å•ï¼š{pending_tickets}ä¸?
â€?å¹³å‡å¤„ç†æ—¶é—´ï¼š{avg_processing_time}å°æ—¶
â€?å®¢æˆ·æ»¡æ„åº¦ï¼š{satisfaction_rate}%

**åº“å­˜æ•°æ®**
â€?åº“å­˜æ€»æ•°ï¼š{total_inventory}ä»?
â€?æœ¬å‘¨è¿›è´§ï¼š{weekly_restock}ä»?
â€?é¢„è­¦å•†å“ï¼š{low_stock_items}ä»?

ğŸ“Š è¯¦ç»†æŠ¥è¡¨ï¼?
{baseUrl}/analytics/{customer_id}?date={query_date}

ğŸ’¡ **å»ºè®®**
æ ¹æ®æ•°æ®åˆ†æï¼Œ{suggestion_text}ã€?

éœ€è¦æ›´è¯¦ç»†çš„æ•°æ®å—ï¼Ÿæˆ‘ä¸ºæ‚¨å‡†å¤‡äº†å®Œæ•´çš„ExcelæŠ¥è¡¨ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„é‚®ç®±ï¼`,
        variables: ['{query_date}', '{today_orders}', '{month_orders}', '{month_amount}', '{growth_rate}', '{pending_tickets}', '{avg_processing_time}', '{satisfaction_rate}', '{total_inventory}', '{weekly_restock}', '{low_stock_items}', '{baseUrl}', '{customer_id}', '{suggestion_text}'],
        status: true
      },
      {
        id: 10,
        name: 'â?é¢„çº¦æé†’AIå›å¤',
        category: 'é¢„çº¦æé†’',
        type: 'text',
        keywords: 'é¢„çº¦,æ—¶é—´,ä»€ä¹ˆæ—¶å€?ä»€ä¹ˆæ—¶é—?æ’æœŸ',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºæœåŠ¡é¢„çº¦æé†’',
        content: `é¢„çº¦æˆåŠŸï¼æˆ‘ä»¬å·²ä¸ºæ‚¨å®‰æ’ä¸Šé—¨æœåŠ¡ã€‚âœ¨

ğŸ“… **æœåŠ¡é¢„çº¦ä¿¡æ¯**
â€?é¢„çº¦æ—¥æœŸï¼š{appointment_date}
â€?é¢„çº¦æ—¶é—´ï¼š{appointment_time}ï¼ˆè¯·æå‰10åˆ†é’Ÿåœ¨å®¶ç­‰å€™ï¼‰
â€?æœåŠ¡ç±»å‹ï¼š{service_type}
â€?æŠ€æœ¯å‘˜ï¼š{technician}
â€?è”ç³»ç”µè¯ï¼š{technician_phone}

ğŸ“ **æœåŠ¡åœ°å€**
{appointment_address}

âš ï¸ **æ¸©é¦¨æç¤º**
1. è¯·ä¿æŒç”µè¯ç•…é€?
2. å®¶é‡Œè¦æœ‰äººæ¥å¾…ï¼ˆéœ€è¦åŸä¸šä¸»æˆ–æˆæƒäººåœ¨åœºï¼?
3. å¦‚éœ€æ›´æ”¹æ—¶é—´ï¼Œè¯·æå‰24å°æ—¶é€šçŸ¥
4. æˆ‘ä»¬ä¼šåœ¨å‡ºå‘å‰?0åˆ†é’ŸçŸ­ä¿¡é€šçŸ¥æ‚?

ğŸš« **ä¸´æ—¶å–æ¶ˆ**
å¦‚å¿…é¡»å–æ¶ˆæˆ–å»¶æœŸï¼Œè¯·ç‚¹å‡»ï¼?
{baseUrl}/appointment/{appointment_id}/cancel

æ„Ÿè°¢æ‚¨çš„é…åˆï¼å¦‚æœ‰é—®é¢˜å¯éšæ—¶è‡´ç”µ{technician_phone}ã€‚`,
        variables: ['{appointment_date}', '{appointment_time}', '{service_type}', '{technician}', '{technician_phone}', '{appointment_address}', '{appointment_id}', '{baseUrl}'],
        status: true
      },
      {
        id: 11,
        name: 'ğŸ’¬ å’¨è¯¢è½¬æ¥AIå›å¤',
        category: 'è½¬æ¥å¤„ç†',
        type: 'text',
        keywords: 'è½¬æ¥,äººå·¥,å®¢æœ,é”€å”®ä»£è¡?æˆ‘è¦',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºè½¬æ¥åˆ°äººå·¥å®¢æœ?,
        content: `æ„Ÿè°¢æ‚¨çš„è€å¿ƒï¼æˆ‘å·²ä¸ºæ‚¨è½¬æ¥åˆ°ä¸“ä¸šå›¢é˜Ÿã€‚ğŸ?

ğŸ‘¤ **è´Ÿè´£äººä¿¡æ?*
â€?å§“åï¼š{assigned_person_name}
â€?èŒä½ï¼š{assigned_person_title}
â€?ç”µè¯ï¼š{assigned_person_phone}  
â€?å¾®ä¿¡ï¼š{assigned_person_wechat}
â€?é‚®ç®±ï¼š{assigned_person_email}

â±ï¸ **é¢„æœŸå“åº”æ—¶é—´**
â€?å·¥ä½œæ—¶é—´ï¼?:00-18:00ï¼‰ï¼š5åˆ†é’Ÿå†…å›å¤?
â€?éå·¥ä½œæ—¶é—´ï¼šä¸‹ä¸ªå·¥ä½œæ—?9:00å›å¤

ğŸ“ **æ‚¨çš„å’¨è¯¢ä¿¡æ¯**
æˆ‘å·²è®°å½•äº†æ‚¨çš„å’¨è¯¢éœ€æ±‚ï¼Œ{assigned_person_name}ä¼šç«‹å³ä¸ºæ‚¨å¤„ç†ã€?

ğŸ’¡ **æ›´å¿«è·å¾—å¸®åŠ©**
å¦‚æœæƒ³åŠ é€Ÿå¤„ç†ï¼Œå¯ä»¥ï¼?
1. ç›´æ¥æ‹¨æ‰“ç”µè¯ï¼š{assigned_person_phone}
2. æ·»åŠ å¾®ä¿¡å¿«é€Ÿæ²Ÿé€šï¼š{assigned_person_wechat}
3. å‘é‚®ä»¶è¯¦ç»†è¯´æ˜ï¼š{assigned_person_email}

æŸ¥çœ‹è½¬æ¥è¯¦æƒ…ï¼š{baseUrl}/ticket/{transfer_id}

æ„Ÿè°¢æ‚¨é€‰æ‹©æˆ‘ä»¬çš„æœåŠ¡ï¼`,
        variables: ['{assigned_person_name}', '{assigned_person_title}', '{assigned_person_phone}', '{assigned_person_wechat}', '{assigned_person_email}', '{transfer_id}', '{baseUrl}'],
        status: true
      },
      {
        id: 12,
        name: 'ğŸ æ´»åŠ¨æ¨å¹¿AIå›å¤',
        category: 'è¥é”€æ¨å¹¿',
        type: 'text',
        keywords: 'æ´»åŠ¨,ä¿ƒé”€,ä¼˜æƒ ,æ‰“æŠ˜,ç‰¹ä»·,é™æ—¶',
        ai_model: 'wework-official',
        is_system: true,
        is_enabled: true,
        description: 'ç”¨äºæ´»åŠ¨æ¨å¹¿å’Œè¥é”€',
        content: `ğŸ‰ **é‡å¤§æ´»åŠ¨é€šçŸ¥** - {activity_name}

ä¸ºæ„Ÿè°¢{customer_name}çš„æŒç»­æ”¯æŒï¼Œæˆ‘ä»¬ç‰¹åˆ«ä¸ºæ‚¨å‡†å¤‡äº†ä¸“å±ä¼˜æƒ ï¼

ğŸ’ **æ‚¨çš„ä¸“å±ä¼˜æƒ **
â€?ä¼˜æƒ åŠ›åº¦ï¼š{discount_percentage}% æŠ˜æ‰£
â€?ä¼˜æƒ åˆ¸ç ï¼š{coupon_code}
â€?ä½¿ç”¨æ¡ä»¶ï¼šæ»¡{min_amount}å…ƒå¯ç”?
â€?æœ‰æ•ˆæœŸï¼š{activity_start_date} - {activity_end_date}

ğŸ **æ´»åŠ¨å•†å“**
â€?{product_1}ï¼š{product_1_discount}
â€?{product_2}ï¼š{product_2_discount}  
â€?{product_3}ï¼š{product_3_discount}

â?**å€’è®¡æ—?*
ä¼˜æƒ ä»…å‰©ï¼š{remaining_days}å¤?
èµ¶å¿«ä¸‹å•å§ï¼Œé”™è¿‡å°±æ²¡æœ‰äº†ï¼?

ğŸ›’ **å¿«é€Ÿè´­ä¹°é“¾æ?*
{baseUrl}/activity/{activity_id}?coupon={coupon_code}

ğŸ“± **åˆ†äº«èµšç°é‡?*
å°†æ­¤æ´»åŠ¨åˆ†äº«ç»™æœ‹å‹ï¼Œæ¯æˆåŠŸè½¬ä»‹ç»1äººï¼Œæ‚¨å°±èƒ½è·å¾—{referral_bonus}å…ƒå¥–åŠ±ï¼
åˆ†äº«é“¾æ¥ï¼š{baseUrl}/referral/{referral_code}

è¿˜æœ‰é—®é¢˜ï¼Ÿæˆ‘éšæ—¶ä¸ºæ‚¨è§£ç­”ï¼`,
        variables: ['{activity_name}', '{customer_name}', '{discount_percentage}', '{coupon_code}', '{min_amount}', '{activity_start_date}', '{activity_end_date}', '{product_1}', '{product_1_discount}', '{product_2}', '{product_2_discount}', '{product_3}', '{product_3_discount}', '{remaining_days}', '{activity_id}', '{referral_bonus}', '{referral_code}', '{baseUrl}'],
        status: true
      }
    ],
    'GROUP_BOT': [
      {
        id: 7,
        name: 'æ¯æ—¥å·¥ä½œæé†’',
        category: 'ç³»ç»Ÿé€šçŸ¥',
        type: 'markdown',
        content: 'ğŸ“… **ä»Šæ—¥å·¥ä½œæé†’** ({date})\n\nå¾…å¤„ç†å·¥å•ï¼š{pending_count} ä¸ª\nè¿›è¡Œä¸­å·¥å•ï¼š{processing_count} ä¸ª\nå·²å®Œæˆå·¥å•ï¼š{completed_count} ä¸ª\n\nè¯·å„ä½åŒäº‹åŠæ—¶è·Ÿè¿›ï¼Œä¿è¯æœåŠ¡è´¨é‡ï¼?,
        variables: ['{date}', '{pending_count}', '{processing_count}', '{completed_count}'],
        status: true
      }
    ]
  }
  return presets[activeTab.value] || []
}

// æ˜¾ç¤ºåˆ›å»ºå¯¹è¯æ¡?
const showCreateDialog = () => {
  isEditing.value = false
  templateForm.value = {
    name: '',
    category: '',
    push_type: 'realtime',
    message_type: 'notification',
    cron_expression: '',
    type: 'text',
    content: '',
    template_id: '',
    url: '',
    link_type: 'custom',
    keywords: '',
    ai_model: 'wework-official',
    status: true,
    variables: []
  }
  dialogVisible.value = true
}

// æ‰“å¼€Cronè¡¨è¾¾å¼ç”Ÿæˆå™¨
const openCronGenerator = () => {
  window.open('http://cron.ciding.cc/', '_blank')
}

// æ’å…¥URLæ¨¡æ¿
const insertUrl = (type) => {
  const urls = {
    'presale': 'http://localhost:3000/project/{order_id}?type=presale',
    'aftersales': 'http://localhost:3000/project/{order_id}?type=aftersales',
    'sales': 'http://localhost:3000/project/{order_id}?type=sales',
    'status-query': 'http://localhost:3000/project/{order_id}?type=status',
    'payment': 'http://localhost:3000/pay/{order_id}'
  }
  templateForm.value.url = urls[type] || ''
}

// è·å–æ¶ˆæ¯ç±»å‹é¢œè‰²
const getMessageTypeColor = (type) => {
  const colors = {
    'notification': 'info',
    'marketing': 'warning',
    'verification': 'success'
  }
  return colors[type] || 'info'
}

// è·å–æ¶ˆæ¯ç±»å‹æ–‡æœ¬
const getMessageTypeText = (type) => {
  const texts = {
    'notification': 'é€šçŸ¥ç±»æ¶ˆæ?,
    'marketing': 'è¥é”€ç±»æ¶ˆæ?,
    'verification': 'éªŒè¯ç ç±»æ¶ˆæ¯'
  }
  return texts[type] || type
}

// ç¼–è¾‘æ¨¡æ¿
const editTemplate = (template) => {
  isEditing.value = true
  templateForm.value = { ...template }
  dialogVisible.value = true
}

// ä¿å­˜æ¨¡æ¿
const saveTemplate = async () => {
  if (!templateForm.value.name || !templateForm.value.content) {
    ElMessage.warning('è¯·å¡«å†™æ¨¡æ¿åç§°å’Œå†…å®¹')
    return
  }

  // æå–æ¨¡æ¿ä¸­çš„å˜é‡
  const variableRegex = /\{([^}]+)\}/g
  const matches = templateForm.value.content.matchAll(variableRegex)
  templateForm.value.variables = [...new Set([...matches].map(m => `{${m[1]}}`))]

  try {
    const url = isEditing.value 
      ? `http://localhost:8000/api/templates/${templateForm.value.id}`
      : 'http://localhost:8000/api/templates'
    
    await axios.post(url, {
      ...templateForm.value,
      channel: activeTab.value
    })

    ElMessage.success('æ¨¡æ¿ä¿å­˜æˆåŠŸ')
    dialogVisible.value = false
    loadTemplates()
  } catch (error) {
    ElMessage.error('ä¿å­˜å¤±è´¥: ' + (error.response?.data?.detail || error.message))
  }
}

// åˆ é™¤/å…³é—­æ¨¡æ¿
const deleteTemplate = async (template) => {
  // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿé¢„ç•™æ¨¡å—
  if (template.is_system) {
    ElMessageBox.confirm(
      `æ­¤æ¨¡å—ä¸ºç³»ç»Ÿé¢„ç•™æ¨¡å—ï¼Œä¸å¯åˆ é™¤ï¼\n\nğŸ’¡ æ‚¨å¯ä»¥é€šè¿‡"å¯ç”¨/ç¦ç”¨"å¼€å…³æ¥å…³é—­æ­¤æ¨¡å—ï¼Œè€Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚\n\næ¨¡å—åç§°ï¼?{template.name}`,
      'ç³»ç»Ÿé¢„ç•™æ¨¡å—ä¿æŠ¤',
      {
        type: 'warning',
        confirmButtonText: 'æˆ‘æ˜ç™½äº†',
        cancelButtonText: 'å–æ¶ˆ',
        cancelButtonClass: 'is-disabled'
      }
    ).catch(() => {
      // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆæˆ–å…³é—?
    })
    return
  }

  // å¯¹äºéç³»ç»Ÿæ¨¡å—ï¼Œå¯ä»¥åˆ é™¤
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€?, 'ç¡®è®¤åˆ é™¤', {
      type: 'warning',
      confirmButtonText: 'ç¡®å®šåˆ é™¤',
      cancelButtonText: 'å–æ¶ˆ'
    })
    
    await axios.delete(`http://localhost:8000/api/templates/${template.id}`)
    ElMessage.success('åˆ é™¤æˆåŠŸ')
    loadTemplates()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥')
    }
  }
}

// é¢„è§ˆæ¨¡æ¿
const previewTemplate = (template) => {
  currentTemplate.value = template
  previewVisible.value = true
}

// æ¸²æŸ“æ¨¡æ¿
const renderTemplate = (template) => {
  let content = template.content
  
  // æ›¿æ¢å˜é‡ä¸ºç¤ºä¾‹æ•°æ?
  const sampleData = {
    '{customer_name}': 'å¼ ä¸‰',
    '{phone}': '13800138000',
    '{product}': 'ç©ºè°ƒ',
    '{order_id}': 'ORD20240202001',
    '{date}': '2024-02-02',
    '{time}': '14:30',
    '{amount}': '3999',
    '{status}': 'å·²ç¡®è®?,
    '{address}': 'åŒ—äº¬å¸‚æœé˜³åŒºxxxè·¯xxxå?,
    '{technician}': 'æå¸ˆå‚?,
    '{appointment_time}': '2024-02-03 09:00',
    '{tracking_number}': 'SF1234567890'
  }

  Object.entries(sampleData).forEach(([key, value]) => {
    content = content.replaceAll(key, `<span class="variable-value">${value}</span>`)
  })

  // Markdownæ¸²æŸ“
  if (template.type === 'markdown') {
    content = content
      .replaceAll('\n', '<br>')
      .replaceAll('**', '<strong>')
      .replaceAll('**', '</strong>')
  }

  return content
}

// æ’å…¥å˜é‡
const insertVariable = (variable) => {
  const textarea = document.querySelector('textarea')
  if (textarea) {
    const start = textarea.selectionStart
    const end = textarea.selectionEnd
    const text = templateForm.value.content
    templateForm.value.content = text.substring(0, start) + variable + text.substring(end)
  }
}

// å¡«å……ç¤ºä¾‹æ•°æ®
const fillSampleData = () => {
  if (activeTab.value === 'SMS') {
    templateForm.value.content = 'å°Šæ•¬çš„{customer_name}ï¼Œæ‚¨çš„è®¢å•{order_id}å·²ç¡®è®¤ï¼Œé¢„è®¡{date}é€è¾¾ã€?
  } else if (activeTab.value === 'AI') {
    templateForm.value.content = 'æ‚¨å¥½ï¼å…³äº{product}çš„å’¨è¯¢ï¼Œæˆ‘æ¥ä¸ºæ‚¨è§£ç­”...'
  }
}

// æµ‹è¯•å‘é€?
const testTemplate = () => {
  ElMessage.info('æµ‹è¯•å‘é€åŠŸèƒ½å¼€å‘ä¸­...')
}

// åˆ‡æ¢çŠ¶æ€?
const toggleStatus = async (template) => {
  try {
    await axios.patch(`http://localhost:8000/api/templates/${template.id}/status`, {
      status: template.status
    })
    ElMessage.success(template.status ? 'æ¨¡æ¿å·²å¯ç”? : 'æ¨¡æ¿å·²ç¦ç”?)
  } catch (error) {
    ElMessage.error('çŠ¶æ€æ›´æ–°å¤±è´?)
    template.status = !template.status
  }
}

// è·å–åˆ†ç±»ç±»å‹
const getCategoryType = (category) => {
  const types = {
    'å”®å‰å’¨è¯¢': 'primary',
    'è®¢å•é€šçŸ¥': 'success',
    'å‘è´§é€šçŸ¥': 'info',
    'å”®åæœåŠ¡': 'warning',
    'é¢„çº¦æé†’': 'danger',
    'ç»´ä¿®è¿›åº¦': 'warning',
    'ç³»ç»Ÿé€šçŸ¥': 'info'
  }
  return types[category] || 'info'
}

// ä¿å­˜åŸºç¡€URLé…ç½®
const saveBaseUrl = () => {
  localStorage.setItem('baseUrl', baseUrl.value)
  ElMessage.success('âœ?åŸŸåé…ç½®å·²ä¿å­˜ï¼')
}

// é¢„è®¾æ¨¡æ¿åº?
const getPresetTemplate = (type) => {
  const templates = {
    presale: {
      name: 'å•†æœºè¿›å±•é€šçŸ¥',
      category: 'å”®å‰å’¨è¯¢',
      content: `å°Šæ•¬çš?{customer_name}ï¼?

æ‚¨çš„å•†æœºå·²æ›´æ–°ï¼

ğŸ“Š å•†æœºä¿¡æ¯ï¼?
â€?é¢„æœŸæˆäº¤é¢ï¼šÂ¥{amount}
â€?é¢„æœŸæˆäº¤æ—¶é—´ï¼š{date}
â€?å½“å‰é˜¶æ®µï¼š{status}
â€?è´Ÿè´£é”€å”®ï¼š{technician}

ğŸ‘‰ ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼?
${baseUrl.value}/project/{order_id}?type=presale

æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ï¼`
    },
    aftersales: {
      name: 'å·¥å•è¿›åº¦æ›´æ–°',
      category: 'å”®åæœåŠ¡',
      content: `å°Šæ•¬çš?{customer_name}ï¼?

æ‚¨çš„å·¥å• {order_id} æœ‰æ–°çš„è¿›å±•ï¼

ğŸ”§ å·¥å•è¯¦æƒ…ï¼?
â€?æ•…éšœæè¿°ï¼š{product}
â€?å½“å‰çŠ¶æ€ï¼š{status}
â€?å¤„ç†è¿›åº¦ï¼šå·²å¤„ç†
â€?è´Ÿè´£å·¥ç¨‹å¸ˆï¼š{technician}

ğŸ‘‰ ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¹¶åé¦ˆï¼š
${baseUrl.value}/project/{order_id}?type=aftersales

å¦‚æœ‰é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚`
    },
    sales: {
      name: 'è®¢å•ç¡®è®¤é€šçŸ¥',
      category: 'è®¢å•é€šçŸ¥',
      content: `äº²çˆ±çš?{customer_name}ï¼?

æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼è®¢å•å·²ç¡®è®¤ã€?

ğŸ“¦ è®¢å•ä¿¡æ¯ï¼?
â€?è®¢å•å·ï¼š{order_id}
â€?è®¢å•é‡‘é¢ï¼šÂ¥{amount}
â€?æ”¶è´§åœ°å€ï¼š{address}
â€?é¢„è®¡é€è¾¾ï¼š{date}

ğŸ‘‰ ç‚¹å‡»æŸ¥çœ‹è®¢å•è¯¦æƒ…ï¼?
${baseUrl.value}/project/{order_id}?type=sales

æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼`
    },
    payment: {
      name: 'æ”¯ä»˜å‚¬ä»˜æé†’',
      category: 'è®¢å•é€šçŸ¥',
      content: `å°Šæ•¬çš?{customer_name}ï¼?

æ‚¨çš„è®¢å• {order_id} éœ€è¦å®Œæˆæ”¯ä»˜ã€?

ğŸ’° æ”¯ä»˜ä¿¡æ¯ï¼?
â€?è®¢å•é‡‘é¢ï¼šÂ¥{amount}
â€?è®¢å•çŠ¶æ€ï¼šå¾…æ”¯ä»?
â€?æœ‰æ•ˆæœŸï¼š24å°æ—¶å†?

â?è¯·å°½å¿«å®Œæˆæ”¯ä»˜ï¼

ğŸ‘‰ ç‚¹å‡»å‰å¾€æ”¯ä»˜ï¼?
${baseUrl.value}/pay/{order_id}

æ”¯ä»˜å®Œæˆåï¼Œæˆ‘ä»¬å°†ç«‹å³ä¸ºæ‚¨å‘è´§ã€‚`
    }
  }
  return templates[type] || templates['presale']
}

// æ’å…¥é¢„è®¾æ¨¡æ¿
const insertPresetTemplate = (type) => {
  if (!isEditing.value && !dialogVisible.value) {
    // å¦‚æœæ²¡æœ‰æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†ï¼Œè‡ªåŠ¨æ‰“å¼€
    templateForm.value = {
      name: '',
      category: '',
      push_type: 'realtime',
      message_type: 'notification',
      cron_expression: '',
      type: 'text',
      content: '',
      template_id: '',
      url: '',
      link_type: 'custom',
      keywords: '',
      ai_model: 'wework-official',
      status: true,
      variables: []
    }
    dialogVisible.value = true
  }
  
  // è·å–é¢„è®¾æ¨¡æ¿
  const preset = getPresetTemplate(type)
  templateForm.value.name = preset.name
  templateForm.value.category = preset.category
  templateForm.value.content = preset.content
  templateForm.value.link_type = type
  
  // è‡ªåŠ¨å…³é—­collapseï¼Œèšç„¦ç¼–è¾‘æ¡†
  setTimeout(() => {
    const contentInput = document.querySelector('textarea[placeholder*="æ¨¡æ¿å†…å®¹"]')
    if (contentInput) {
      contentInput.focus()
    }
  }, 100)
  
  ElMessage.success(`âœ?å·²åŠ è½?${preset.name}"æ¨¡æ¿`)
}

onMounted(() => {
  loadTemplates()
  loadAIModels()  // åŠ è½½AIæ¨¡å‹åˆ—è¡¨
})
</script>

<style scoped>
.template-manager {
  padding: 20px;
}

.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-actions h2 {
  margin: 0;
}

.variable-help {
  margin-top: 10px;
  padding: 10px;
  background: #f5f7fa;
  border-radius: 4px;
}

.form-tip {
  font-size: 12px;
  color: #909399;
  margin-left: 10px;
}

.preview-container {
  padding: 20px;
}

.phone-preview {
  border: 3px solid #333;
  border-radius: 30px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.phone-header {
  background: #f7f7f7;
  padding: 15px;
  text-align: center;
  font-size: 14px;
  font-weight: bold;
  border-bottom: 1px solid #e0e0e0;
}

.phone-body {
  padding: 20px;
  background: #f5f5f5;
  min-height: 400px;
}

/* å¾®ä¿¡å…¬ä¼—å·æ ·å¼?*/
.wechat-message {
  background: #fff;
}

.wechat-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.wechat-title {
  padding: 15px;
  font-size: 16px;
  font-weight: bold;
  color: #333;
  background: linear-gradient(135deg, #07c160 0%, #1aad19 100%);
  color: white;
}

.wechat-content {
  padding: 15px;
  line-height: 1.8;
  color: #666;
}

.wechat-footer {
  padding: 12px 15px;
  background: #f7f7f7;
  border-top: 1px solid #e0e0e0;
  display: flex;
  align-items: center;
  gap: 5px;
  color: #576b95;
  font-size: 14px;
}

/* ä¼ä¸šå¾®ä¿¡æ ·å¼ */
.work-wechat-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.work-wechat-header {
  padding: 12px 15px;
  background: #f7f7f7;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e0e0e0;
}

.app-name {
  font-weight: bold;
  color: #333;
}

.send-time {
  font-size: 12px;
  color: #999;
}

.work-wechat-content {
  padding: 15px;
  line-height: 1.8;
  color: #666;
  white-space: pre-wrap;
}

.work-wechat-actions {
  padding: 12px 15px;
  border-top: 1px solid #e0e0e0;
  text-align: right;
}

/* çŸ­ä¿¡æ ·å¼ */
.sms-message {
  display: flex;
  justify-content: flex-start;
}

.sms-bubble {
  max-width: 80%;
  background: #95ec69;
  border-radius: 8px;
  padding: 12px;
  position: relative;
}

.sms-bubble::before {
  content: '';
  position: absolute;
  left: -8px;
  top: 10px;
  width: 0;
  height: 0;
  border-style: solid;
  border-width: 8px 8px 8px 0;
  border-color: transparent #95ec69 transparent transparent;
}

.sms-sender {
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
  font-size: 12px;
}

.sms-content {
  color: #333;
  line-height: 1.6;
  font-size: 14px;
}

.sms-time {
  font-size: 11px;
  color: #666;
  margin-top: 5px;
  text-align: right;
}

.preview-content {
  padding: 15px;
  background: #f5f7fa;
  border-radius: 4px;
  line-height: 1.8;
  white-space: pre-wrap;
}

:deep(.variable-value) {
  color: #409EFF;
  font-weight: bold;
  background: #ecf5ff;
  padding: 2px 6px;
  border-radius: 3px;
}
</style>

