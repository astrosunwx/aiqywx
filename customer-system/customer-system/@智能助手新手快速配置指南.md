# @智能助手 新手快速配置指南

## 🎯 核心澄清

```
❌ 不需要做：
  • 在消息模板管理中设置 @智能助手 模块
  • 不需要编辑 backend/.env 文件
  
✅ 只需要做：
  • 在企业微信后台配置应用信息
  • 在系统 UI 中填写凭证
  • 启用自动消息处理
```

---

## 📱 两种配置方案对比

| 方案 | 难度 | 适合人群 | 配置位置 | 修改凭证 |
|------|------|---------|---------|---------|
| **方案A：系统UI配置** ⭐ 推荐 | ⭐ 简单 | 新手 | 系统管理后台 | 直接在 UI 修改，无需重启 |
| **方案B：.env 文件配置** | ⭐⭐ 中等 | 进阶/开发 | 编辑文件 | 修改后需要重启后端 |

---

## 🌟 方案A：系统 UI 配置（新手推荐）

### 第1步：企业微信后台获取凭证（一次性）

**打开企业微信管理后台**

```
https://work.weixin.qq.com/wework_admin/
```

**创建应用**

```
左侧菜单：应用与小程序 → 应用 → 创建应用

填写信息：
├─ 应用名称：智能助手
├─ 应用描述：工单管理、客户服务、消息推送
├─ 应用图标：选一个图标
├─ 可见范围：选择 "所有成员"（或指定部门）
└─ 点击"创建"
```

**获取 3 个关键凭证**

创建成功后，你会看到这个页面：

```
┌─────────────────────────────────────────┐
│ 应用管理 - 智能助手                      │
├─────────────────────────────────────────┤
│                                        │
│ 📌 应用ID（AgentID）                   │
│    1000001         ← 复制这个            │
│                                        │
│ 📌 Secret（应用密钥）                  │
│    abc123xyz456...  ← 复制这个           │
│    [显示/隐藏]                          │
│                                        │
│ 📌 企业ID（CorpID）                    │
│    ww123456789abc  ← 复制这个           │
│    [显示/隐藏]                          │
│                                        │
└─────────────────────────────────────────┘

💾 妥善保管这三个值：
  • AgentID = 1000001
  • Secret = abc123xyz456...
  • CorpID = ww123456789abc
```

**⏭️ 暂时不设置回调 URL**

```
不需要现在在企业微信后台设置"回调URL"
我们会在系统 UI 中配置，系统会自动生成回调URL
```

---

### 第2步：在系统 UI 中配置凭证

**打开系统管理后台**

```
http://localhost:3000/settings  或 http://localhost:3000/admin
（具体路由根据实际系统调整）

如果没有设置菜单，使用管理API：
http://localhost:3000/api/admin/wechat-config
```

**找到"企业微信配置"页面**

```
左侧菜单：
├─ 系统设置
│  ├─ 基础配置
│  ├─ 企业微信配置 ← 点这里！
│  ├─ 模板管理
│  └─ 数据统计
```

**填写 4 个信息**

```
┌──────────────────────────────────────────────┐
│ 企业微信配置                                  │
├──────────────────────────────────────────────┤
│                                              │
│ 1️⃣ CorpID（企业ID）                         │
│    [________________] 输入：ww123456789abc   │
│                                              │
│ 2️⃣ AgentID（应用ID）                        │
│    [________________] 输入：1000001          │
│                                              │
│ 3️⃣ Secret（应用密钥）                       │
│    [________________] 输入：abc123xyz456...  │
│                                              │
│ 4️⃣ Token（回调令牌，自动生成）               │
│    [________________] 自动：abc123xyz...    │
│                                              │
│    [测试连接] [保存配置] [重置]             │
│                                              │
│ ✅ 配置已启用                                │
│ 🔗 回调URL：                                 │
│    https://yourdomain.com/api/wechat/callback│
│    （自动生成，无需手动设置）                │
│                                              │
└──────────────────────────────────────────────┘
```

**复制凭证并粘贴**

```
来自企业微信后台的三个值：

AgentID: 1000001
  ↓ 复制
  ↓ 粘贴到系统 UI 的"应用ID"字段

Secret: abc123xyz456def789
  ↓ 复制
  ↓ 粘贴到系统 UI 的"应用密钥"字段

CorpID: ww123456789abcdef
  ↓ 复制
  ↓ 粘贴到系统 UI 的"企业ID"字段
```

**点击"测试连接"验证**

```
系统会自动：
✅ 验证 CorpID 和 Secret 是否正确
✅ 生成回调 URL
✅ 显示"连接成功"提示

如果失败，检查：
1. 复制的凭证是否正确（有无多余空格）
2. 企业微信后台应用是否已创建
3. 应用的"可见范围"是否包含你的账号
```

**点击"保存配置"**

```
系统会：
✅ 保存到数据库
✅ 立即生效（不需要重启！）
✅ 显示绿色"✅ 配置已启用"
```

---

### 第3步：在企业微信后台填写回调 URL（重要！）

**回到企业微信管理后台**

```
应用管理 → 智能助手 → 接收消息服务器设置
```

**复制系统生成的回调 URL**

回到系统 UI 的"企业微信配置"页面，你会看到：

```
🔗 回调URL：
https://yourdomain.com/api/wechat/callback
或者（本地开发）
https://abc123.ngrok.io/api/wechat/callback
```

**粘贴到企业微信**

```
企业微信后台 → 接收消息服务器设置

┌──────────────────────────────────────────┐
│ 企业微信 - 消息服务器                    │
├──────────────────────────────────────────┤
│                                          │
│ 💻 服务器地址（URL）                    │
│ [https://abc123.ngrok.io/api/wechat/callback]
│                                          │
│ 🔑 Token                                │
│ [abc123xyz456...]  (系统自动生成)        │
│                                          │
│ 🔐 EncodingAESKey                       │
│ [abc123xyz456...] (系统自动生成，可选)   │
│                                          │
│ [保存]  [测试]                          │
│                                          │
└──────────────────────────────────────────┘

💡 提示：
Token 和 EncodingAESKey 直接从系统 UI 复制
无需手动输入
```

**点击"测试"验证连接**

```
企业微信会向你的服务器发送测试请求

✅ 成功：显示"成功接收消息"
❌ 失败：检查
  1. URL 是否正确
  2. URL 是否可公网访问（如果用 ngrok）
  3. ngrok 连接是否还活着
  4. 防火墙是否放行
```

---

### 第4步：启用 @智能助手（完成！）

**在企业微信中测试**

```
1️⃣ 创建一个内部测试群
   • 群名称：测试群
   • 群成员：包含 @智能助手 应用

2️⃣ 在群中输入命令
   @智能助手 /查询工单 SV20240202001
   
3️⃣ 智能助手应该回复
   工单号：SV20240202001
   客户：...
   ...
```

**如果收不到回复，检查**

```
❌ 问题1：应用不在群里
   ✅ 解决：在群里添加应用
   
❌ 问题2：回调 URL 错误
   ✅ 解决：检查企业微信后台的"回调URL"是否正确
   
❌ 问题3：后端 API 没有启动
   ✅ 解决：确保后端在运行（python app/main.py）
   
❌ 问题4：ngrok 连接断了
   ✅ 解决：重新运行 ngrok http 8000
   ✅ 更新企业微信后台的回调 URL
```

---

## 💪 方案B：.env 文件配置（进阶，可跳过）

**如果你想完全控制配置，可以选择这个方案**

### 第1步：打开 .env 文件

```
文件位置：backend/.env

编辑工具：
• 记事本（Notepad）
• VS Code
• 任何文本编辑器
```

**打开 backend 文件夹**

```
Windows 资源管理器：
G:\aiqywx\customer-system\customer-system\backend\
          ↓
找到 .env 文件（可能是隐藏的）
          ↓
右键 → 用 VS Code 打开（或记事本）
```

### 第2步：添加企业微信配置

```
# backend/.env 文件内容

# 其他配置...
DATABASE_URL=postgresql://...

# 企业微信配置（新增）
WECHAT_WORK_CORPID=ww123456789abcdef
WECHAT_WORK_SECRET=abc123xyz456def789ghi
WECHAT_WORK_AGENTID=1000001
WECHAT_WORK_TOKEN=your_random_token_32bit
WECHAT_WORK_ENCODING_AES_KEY=your_aes_key_here

# 其他配置...
```

### 第3步：重启后端

```
按 Ctrl+C 停止当前后端进程

重新启动：
python -m uvicorn app.main:app --reload
```

---

## 🎯 推荐方案总结

### 如果你是新手 → 选方案 A ✅

```
✨ 优点：
  • UI 界面，直观易懂
  • 不需要编辑代码文件
  • 修改后立即生效
  • 可视化看到配置状态
  • 有"测试连接"验证按钮

⚠️ 缺点：
  • 需要系统中有"企业微信配置"页面
  • （如果没有，可以让开发者添加）
```

### 如果你是开发者 → 选方案 B ✅

```
✨ 优点：
  • 完全手工控制
  • 可以版本控制（git）
  • 开发和生产环境分离

⚠️ 缺点：
  • 需要编辑配置文件
  • 修改后需要重启服务
  • 容易出错（多余空格等）
```

---

## 📋 完整步骤总结（方案 A）

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1️⃣ | 企业微信后台 → 创建应用 | 获得 CorpID、AgentID、Secret |
| 2️⃣ | 系统 UI → 企业微信配置 | 粘贴三个凭证 + 点测试 |
| 3️⃣ | 企业微信后台 → 填回调 URL | 从系统 UI 复制并粘贴 |
| 4️⃣ | 企业微信后台 → 点测试 | 验证连接成功 |
| 5️⃣ | 企业微信群 → @智能助手 | 测试命令是否生效 |

完成！所有配置无需接触代码 🎉

---

## 🤔 常见问题

### Q1：找不到"企业微信配置"页面怎么办？

```
✅ 解决方案：
  选择方案 B（编辑 .env 文件）
  或
  联系开发者添加"企业微信配置"页面
  
  页面位置应该在：
  管理后台 → 系统设置 → 企业微信配置
```

### Q2：修改了凭证后，需要重启吗？

```
方案 A（UI 配置）：
  ❌ 不需要重启
  ✅ 点保存后立即生效

方案 B（.env 文件）：
  ✅ 需要重启后端
  命令：Ctrl+C 停止，然后 python -m uvicorn app.main:app --reload
```

### Q3：回调 URL 用什么？

```
本地开发（ngrok）：
https://abc123def456.ngrok.io/api/wechat/callback

云服务器（生产）：
https://yourdomain.com/api/wechat/callback

内网穿透（其他工具）：
https://your-tunnel-url/api/wechat/callback

都是自动生成的，从系统 UI 复制即可
```

### Q4：Token 是什么？需要自己填吗？

```
方案 A（UI 配置）：
  系统自动生成
  你只需要复制并粘贴到企业微信后台

方案 B（.env 文件）：
  自己生成（32位随机字符串）
  或用系统生成的值
```

### Q5：Secret 在哪里看？

```
企业微信后台 → 应用管理 → 你的应用

找到这个：
┌─────────────────────────────┐
│ Secret（应用密钥）          │
│ [点击显示]                 │
│ abc123xyz456def...         │
│ [复制]                     │
└─────────────────────────────┘
```

---

## 🚀 快速开始（新手 5 分钟上手）

```
5 分钟完成配置：

⏱️ 1分钟：企业微信后台获取凭证
  访问 https://work.weixin.qq.com/
  创建应用 → 复制 3 个值

⏱️ 1分钟：打开系统 UI 配置页面
  访问 http://localhost:3000/settings

⏱️ 1分钟：粘贴凭证 + 点保存
  CorpID → AgentID → Secret

⏱️ 1分钟：企业微信后台填回调 URL
  复制系统 UI 的 URL → 粘贴到企业微信

⏱️ 1分钟：测试
  在企业微信群里 @智能助手 /命令

完成！现在你的 @智能助手 已经可以用了 🎉
```

---

## ✅ 检查清单

配置完成前，确保：

- [ ] 已在企业微信后台创建应用
- [ ] 已获取 CorpID、AgentID、Secret
- [ ] 已在系统 UI 中填写凭证（或 .env 文件）
- [ ] 已点击"测试连接"验证
- [ ] 已在企业微信后台填写回调 URL
- [ ] 已在企业微信群中添加 @智能助手 应用
- [ ] 已在群中测试 @智能助手 命令
- [ ] 收到了自动回复

全部完成 ✅ → @智能助手 已就绪！

---

## 💬 遇到问题？

| 问题 | 检查点 |
|------|--------|
| 收不到回复 | ① 凭证是否正确 ② 回调 URL 是否正确 ③ 后端是否运行 |
| 凭证错误 | 重新复制，确保无多余空格 |
| 回调 URL 错误 | 确保能公网访问（ngrok 还活着吗？） |
| 应用不在群里 | 在群里添加应用或邀请应用加入 |

有问题看这里：[企业微信AI设置完全指南-员工和顾客区分.md](./企业微信AI设置完全指南-员工和顾客区分.md)

---

**现在去试试吧！选择方案 A，5 分钟搞定！** 🚀
