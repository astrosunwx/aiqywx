# å®¢æˆ·è”ç³»åŠŸèƒ½ - å¿«é€Ÿå¯åŠ¨æ¸…å•

## âœ… ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå˜é‡é…ç½®

å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ° `backend/.env`ï¼š

```bash
# ä¼ä¸šå¾®ä¿¡é…ç½®
CORP_ID=ww1234567890abcdef
CORP_SECRET=your_customer_contact_secret
AGENT_ID=1000002

# åº”ç”¨åŸŸåï¼ˆç”Ÿäº§ç¯å¢ƒå¿…å¡«ï¼‰
APP_DOMAIN=https://your-domain.com

# JWTå¯†é’¥ï¼ˆå®‰å…¨é“¾æ¥ï¼‰
JWT_SECRET_KEY=your-super-secret-key-change-this-in-production

# Redisï¼ˆå¯é€‰ï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# æ•°æ®åº“
DATABASE_URL=sqlite+aiosqlite:///./customer_system.db
```

---

## âœ… ç¬¬äºŒæ­¥ï¼šä¼ä¸šå¾®ä¿¡åå°é…ç½®

### 1. èŠå¤©å·¥å…·æ é…ç½®

ç™»å½•ï¼šhttps://work.weixin.qq.com/ â†’ åº”ç”¨ç®¡ç† â†’ å®¢æˆ·è”ç³»åº”ç”¨

é…ç½®é¡¹ï¼š
```
è·¯å¾„ï¼šèŠå¤©å·¥å…·æ 
åç§°ï¼šé¡¹ç›®è¿›åº¦
å›¾æ ‡ï¼šğŸ“Š
URLï¼šhttps://your-domain.com/sidebar/project-selector
```

### 2. å¼€å¯APIæƒé™

```
â˜‘ï¸ å‘é€æ¶ˆæ¯åˆ°å¤–éƒ¨è”ç³»äºº
â˜‘ï¸ è·å–å®¢æˆ·è”ç³»äººä¿¡æ¯
â˜‘ï¸ è·å–å‘˜å·¥ä¿¡æ¯
```

### 3. é…ç½®å¯ä¿¡åŸŸå

```
åº”ç”¨ç®¡ç† â†’ ç½‘é¡µæˆæƒåŠJS-SDK
æ·»åŠ ï¼šyour-domain.com
```

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨æœåŠ¡

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
.\venv\Scripts\Activate.ps1

# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

éªŒè¯ï¼šè®¿é—® http://localhost:8000/docs

---

## âœ… ç¬¬å››æ­¥ï¼šæµ‹è¯•åŠŸèƒ½

### æµ‹è¯•1ï¼šèŠå¤©å·¥å…·æ ï¼ˆæ‰‹åŠ¨ï¼‰

1. åœ¨ä¼ä¸šå¾®ä¿¡æ‰“å¼€ä¸å®¢æˆ·çš„èŠå¤©çª—å£
2. ç‚¹å‡»å³ä¾§å·¥å…·æ "é¡¹ç›®è¿›åº¦"
3. é€‰æ‹©é¡¹ç›®ï¼Œç‚¹å‡»"å‘é€"
4. éªŒè¯å®¢æˆ·æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

### æµ‹è¯•2ï¼šAPIå‘é€ï¼ˆè‡ªåŠ¨ï¼‰

```bash
# å‘é€é‡Œç¨‹ç¢‘é€šçŸ¥
curl -X POST http://localhost:8000/auto-notify/milestone \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 1,
    "milestone": "å¼€å‘å®Œæˆ",
    "customer_external_userid": "wmXXXXXXXXXXXX",
    "sender_userid": "zhangsan"
  }'
```

### æµ‹è¯•3ï¼šæ‰¹é‡å‘¨æŠ¥

```bash
# è·å–æ´»è·ƒé¡¹ç›®
curl http://localhost:8000/auto-notify/active-projects

# æ‰¹é‡å‘é€
curl -X POST http://localhost:8000/auto-notify/batch-weekly \
  -H "Content-Type: application/json" \
  -d '{
    "project_ids": [1, 2, 3],
    "sender_userid": "system"
  }'
```

---

## âœ… ç¬¬äº”æ­¥ï¼šé…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

### æ–¹å¼Aï¼šAPSchedulerï¼ˆæ¨èï¼‰

åˆ›å»º `backend/app/scheduler.py`ï¼š

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import aiohttp

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', day_of_week='fri', hour=17, minute=0)
async def send_weekly_reports():
    async with aiohttp.ClientSession() as session:
        async with session.get('http://localhost:8000/auto-notify/active-projects') as resp:
            data = await resp.json()
            project_ids = [p['project_id'] for p in data['projects']]
        
        async with session.post(
            'http://localhost:8000/auto-notify/batch-weekly',
            json={"project_ids": project_ids, "sender_userid": "system"}
        ) as resp:
            print(await resp.json())

def start_scheduler():
    scheduler.start()
```

åœ¨ `app/main.py` ä¸­å¯åŠ¨ï¼š

```python
from app.scheduler import start_scheduler

@app.on_event("startup")
async def startup_event():
    start_scheduler()
```

### æ–¹å¼Bï¼šLinux Crontab

```bash
# æ¯å‘¨äº”17:00
0 17 * * 5 curl -X POST http://localhost:8000/auto-notify/batch-weekly \
  -H "Content-Type: application/json" \
  -d '{"project_ids": [1,2,3], "sender_userid": "system"}'
```

---

## ğŸ¯ æ ¸å¿ƒAPIç«¯ç‚¹é€ŸæŸ¥

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/sidebar/project-selector` | GET | èŠå¤©å·¥å…·æ ä¾§è¾¹æ  |
| `/sidebar/send-progress` | POST | å‘é€é¡¹ç›®è¿›åº¦ |
| `/auto-notify/milestone` | POST | é‡Œç¨‹ç¢‘é€šçŸ¥ |
| `/auto-notify/batch-weekly` | POST | æ‰¹é‡å‘¨æŠ¥ |
| `/auto-notify/progress-threshold` | POST | è¿›åº¦é˜ˆå€¼é€šçŸ¥ |
| `/auto-notify/active-projects` | GET | è·å–æ´»è·ƒé¡¹ç›® |

---

## ğŸ“Š æ¶ˆæ¯ç¤ºä¾‹

å®¢æˆ·æ”¶åˆ°çš„å›¾æ–‡æ¶ˆæ¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š XXç³»ç»Ÿå¼€å‘V2.0 - é¡¹ç›®è¿›åº¦é€šçŸ¥  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº²çˆ±çš„å¼ ä¸‰ï¼Œæ‚¨å¥½ï¼               â”‚
â”‚                                â”‚
â”‚ é¡¹ç›®åç§°ï¼šXXç³»ç»Ÿå¼€å‘V2.0         â”‚
â”‚ å½“å‰è¿›åº¦ï¼šå·²å®Œæˆ 80%             â”‚
â”‚ æœ€æ–°çŠ¶æ€ï¼šè¿›è¡Œä¸­ - ç¨³æ­¥æ¨è¿›ä¸­     â”‚
â”‚ è´Ÿè´£å›¢é˜Ÿï¼šæŠ€æœ¯å›¢é˜Ÿ               â”‚
â”‚                                â”‚
â”‚ ğŸ’¡ ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¿›åº¦æŠ¥å‘Š          â”‚
â”‚ â° é¡µé¢å°†æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç‚¹å‡»åè·³è½¬åˆ°ï¼šå®‰å…¨é“¾æ¥é¡µé¢ï¼ˆ1å°æ—¶æœ‰æ•ˆï¼‰

---

## ğŸ”’ å®‰å…¨é…ç½®

1. **ç”Ÿäº§ç¯å¢ƒå¿…æ”¹**ï¼š
   - `JWT_SECRET_KEY`ï¼šæ”¹ä¸ºå¤æ‚å¯†é’¥
   - `APP_DOMAIN`ï¼šæ”¹ä¸ºæ­£å¼åŸŸå
   - CORSï¼šé™åˆ¶å…·ä½“åŸŸå

2. **ä¼ä¸šå¾®ä¿¡IPç™½åå•**ï¼š
   - æ·»åŠ æœåŠ¡å™¨IPåˆ°ä¼ä¸šå¾®ä¿¡åå°

3. **HTTPSéƒ¨ç½²**ï¼š
   - èŠå¤©å·¥å…·æ URLå¿…é¡»ä½¿ç”¨HTTPS

---

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 1. ä¿®æ”¹ç¯å¢ƒå˜é‡

```bash
APP_DOMAIN=https://production-domain.com
JWT_SECRET_KEY=super-complex-production-key-123456
REDIS_HOST=production-redis.com
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨Gunicorn + Uvicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 3. é…ç½®Nginxåå‘ä»£ç†

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šä¾§è¾¹æ æ‰“ä¸å¼€

**åŸå› **ï¼šåŸŸåæœªé…ç½®æˆ–ä¸æ˜¯HTTPS

**è§£å†³**ï¼š
1. æ£€æŸ¥ `.env` ä¸­ `APP_DOMAIN` æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿ä½¿ç”¨HTTPSï¼ˆä¼ä¸šå¾®ä¿¡è¦æ±‚ï¼‰
3. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡åå°"å¯ä¿¡åŸŸå"é…ç½®

### é—®é¢˜2ï¼šæ¶ˆæ¯å‘é€å¤±è´¥

**åŸå› **ï¼šAPIæƒé™æœªå¼€å¯æˆ–Secreté”™è¯¯

**è§£å†³**ï¼š
1. æ£€æŸ¥ä¼ä¸šå¾®ä¿¡åå°"APIæƒé™"æ˜¯å¦å¼€å¯
2. éªŒè¯ `CORP_SECRET` æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š`tail -f logs/app.log`

### é—®é¢˜3ï¼šå®¢æˆ·æ”¶ä¸åˆ°æ¶ˆæ¯

**åŸå› **ï¼šexternal_useridä¸æ­£ç¡®

**è§£å†³**ï¼š
1. ç¡®è®¤å®¢æˆ·å·²æ·»åŠ åˆ°ä¼ä¸šå¾®ä¿¡
2. æ£€æŸ¥æ•°æ®åº“ä¸­ `customer.wechat_openid` å­—æ®µ
3. è°ƒç”¨APIéªŒè¯ï¼š`/auto-notify/active-projects`

---

## âœ… å®Œæˆï¼

ç°åœ¨æ‚¨çš„ç³»ç»Ÿæ‹¥æœ‰å®Œæ•´çš„**å¯¹å¤–å®¢æˆ·æ²Ÿé€š**èƒ½åŠ›ï¼š

âœ¨ å‘˜å·¥ä¸€é”®å‘é€é¡¹ç›®è¿›åº¦  
âœ¨ ç³»ç»Ÿè‡ªåŠ¨é‡Œç¨‹ç¢‘é€šçŸ¥  
âœ¨ æ¯å‘¨æ‰¹é‡å‘¨æŠ¥æ¨é€  
âœ¨ å®‰å…¨é“¾æ¥æƒé™ä¿æŠ¤  
âœ¨ é¡µé¢è‡ªåŠ¨å¢é‡æ›´æ–°  

ğŸ‰ ä¸“ä¸šã€é«˜æ•ˆã€è‡ªåŠ¨åŒ–çš„å®¢æˆ·æ²Ÿé€šè§£å†³æ–¹æ¡ˆï¼
