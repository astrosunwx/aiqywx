# 📚 消息模板管理 - 完整升级指南

## ✨ 本次升级内容

### 1. 🎯 新增23个预留模板

| 渠道 | 数量 | 说明 |
|------|------|------|
| **AI回复模板** | 10个 | 价格、售后、项目、订单、常见问题、工单统计、预约、转接、活动、售前 |
| **企业微信** | 5个 | 工单创建、工单超时、项目进度、每日汇报、客户反馈 |
| **微信公众号** | 4个 | 订单确认、售后服务、活动推广、会员福利 |
| **群机器人** | 2个 | 工单提醒、每日数据 |
| **短信模板** | 2个 | 订单确认、物流通知（少量，因为不重要） |
| **总计** | **23个** | 覆盖所有业务场景 |

---

### 2. 🔗 新增链接变量（安全链接）

在系统变量中新增了6个链接相关变量：

| 变量代码 | 变量名称 | 示例值 | 使用场景 |
|---------|---------|--------|---------|
| `{safe_link}` | 安全链接 | https://your-domain.com/secure/abc123xyz | 通用安全链接（带token） |
| `{ticket_link}` | 工单详情链接 | https://your-domain.com/tickets/123 | 工单相关消息 |
| `{project_link}` | 项目进度链接 | https://your-domain.com/projects/PRJ001 | 项目进度查询 |
| `{detail_link}` | 详情链接 | https://your-domain.com/details/view | 通用详情页 |
| `{payment_link}` | 支付链接 | https://your-domain.com/pay/ORD20260203001 | 订单支付 |
| `{feedback_link}` | 反馈链接 | https://your-domain.com/feedback/submit | 客户反馈 |

**使用示例**：
```
查看详情：{ticket_link}
点击支付：{payment_link}
查看项目进度：{project_link}
```

---

### 3. 🔧 新增项目相关变量

| 变量代码 | 变量名称 | 示例值 |
|---------|---------|--------|
| `{project_id}` | 项目ID | PRJ001 |
| `{project_name}` | 项目名称 | 智能客服系统升级 |
| `{project_status}` | 项目状态 | 进行中 |
| `{project_progress}` | 项目进度 | 60% |
| `{milestone}` | 里程碑 | 第二阶段完成 |

---

### 4. 👥 测试发送功能增强

#### 之前：
- ❌ 只能输入手机号、微信OpenID、UserID
- ❌ 不能选择企业微信员工
- ❌ 不能选择公众号用户

#### 现在：
- ✅ 支持从企业微信通讯录选择员工
- ✅ 支持从公众号粉丝列表选择用户
- ✅ 显示员工部门、用户标签等信息

**新增测试方式**：

| 测试方式 | 适用渠道 | 说明 |
|---------|---------|------|
| 📱 手机号 | 所有渠道 | 输入手机号测试 |
| 💬 微信OpenID | 微信公众号 | 输入OpenID测试 |
| 👤 选择公众号用户 | 微信公众号 | **新增**：从粉丝列表选择 |
| 👤 员工UserID | 企业微信 | 输入UserID测试 |
| 👥 选择企业微信员工 | 企业微信 | **新增**：从通讯录选择 |
| 👥 选择客户 | AI回复 | 从客户列表选择 |
| 📢 选择群聊 | 群机器人 | 从群列表选择 |

---

### 5. 📊 系统变量完整分类

所有系统变量现在按类别组织（共37个）：

#### 客户信息（3个）
```
{customer_name} - 客户姓名
{phone} - 联系电话
{company} - 公司名称
```

#### 订单信息（2个）
```
{order_no} - 订单号
{amount} - 金额
```

#### 产品信息（1个）
```
{product} - 产品名称
```

#### 时间信息（2个）
```
{date} - 日期
{time} - 时间
```

#### 工单信息（6个）
```
{ticket_id} - 工单编号
{ticket_status} - 工单状态
{ticket_title} - 工单标题
{ticket_priority} - 工单优先级
{assigned_to} - 负责人
{deadline} - 处理期限
{progress} - 处理进度
```

#### 工单统计（3个）
```
{pending_count} - 待处理数量
{processing_count} - 进行中数量
{completed_count} - 已完成数量
```

#### 项目信息（5个）
```
{project_id} - 项目ID
{project_name} - 项目名称
{project_status} - 项目状态
{project_progress} - 项目进度
{milestone} - 里程碑
```

#### 链接变量（6个）
```
{safe_link} - 安全链接
{ticket_link} - 工单详情链接
{project_link} - 项目进度链接
{detail_link} - 详情链接
{payment_link} - 支付链接
{feedback_link} - 反馈链接
```

#### 员工信息（3个）
```
{staff_name} - 员工姓名
{staff_phone} - 员工电话
{department} - 部门名称
```

---

## 🚀 快速开始

### 第1步：导入预留模板到数据库

```bash
# 进入backend目录
cd g:\aiqywx\customer-system\customer-system\backend

# 执行SQL脚本
sqlite3 customer_system.db < init_message_templates.sql
```

**验证导入成功**：
```sql
SELECT channel, COUNT(*) as count 
FROM message_templates 
WHERE is_system = 1 
GROUP BY channel;

-- 应该看到：
-- AI回复: 10
-- WORK_WECHAT: 5
-- WECHAT: 4
-- GROUP_BOT: 2
-- SMS: 2
```

---

### 第2步：重启前端服务

```bash
# 如果前端正在运行，先停止（Ctrl+C）
# 然后重新启动
npm run dev
```

---

### 第3步：查看新增的预留模板

1. 打开浏览器访问 http://localhost:3000
2. 进入"消息模板管理"
3. 切换到"🤖 AI回复模板"标签页
4. 你会看到10个预留模板（价格咨询、售后维修、项目进度...）
5. 切换到其他标签页查看更多模板

---

### 第4步：编辑模板内容

1. 点击任意模板的"编辑"按钮
2. 修改模板内容，使用链接变量：
   ```
   查看详情：{ticket_link}
   项目进度：{project_link}
   在线支付：{payment_link}
   ```
3. 点击"👁️ 模板预览"查看效果
4. 保存模板

---

### 第5步：测试发送

#### 测试企业微信员工选择：

1. 选择一个企业微信模板（如"工单创建通知"）
2. 点击"测试发送"
3. 选择"👥 选择企业微信员工"
4. 从下拉列表选择员工（显示部门信息）
5. 填充变量值
6. 点击"确认发送"

#### 测试公众号用户选择：

1. 选择一个公众号模板（如"订单确认通知"）
2. 点击"测试发送"
3. 选择"👤 选择公众号用户"
4. 从下拉列表选择粉丝（显示标签：已关注/VIP/活跃）
5. 填充变量值
6. 点击"确认发送"

---

## 📋 预留模板详细说明

### AI回复模板（10个）

#### 1️⃣ 💰 价格咨询AI回复
- **触发关键词**：价格,报价,多少钱,费用,成本
- **使用变量**：`{customer_name}`, `{product}`, `{staff_name}`, `{staff_phone}`, `{detail_link}`
- **应用场景**：客户询问产品价格时自动回复

#### 2️⃣ 🔧 售后维修AI回复
- **触发关键词**：维修,报修,坏了,故障,修理
- **使用变量**：`{ticket_id}`, `{ticket_title}`, `{ticket_priority}`, `{assigned_to}`, `{deadline}`, `{ticket_link}`, `{staff_phone}`
- **应用场景**：客户报修时自动创建工单并回复

#### 3️⃣ 📊 项目进度查询
- **触发关键词**：项目,进度,状态,完成情况
- **使用变量**：`{project_name}`, `{project_id}`, `{project_status}`, `{project_progress}`, `{milestone}`, `{project_link}`, `{staff_name}`, `{staff_phone}`, `{feedback_link}`
- **应用场景**：客户查询项目进度

#### 4️⃣ 📦 订单确认AI回复
- **触发关键词**：订单,下单,购买,支付
- **使用变量**：`{customer_name}`, `{order_no}`, `{product}`, `{amount}`, `{date}`, `{time}`, `{payment_link}`, `{detail_link}`, `{staff_phone}`
- **应用场景**：客户下单后自动确认

#### 5️⃣ ❓ 常见问题AI回复
- **触发关键词**：怎么样,如何,使用,功能,问题
- **使用变量**：`{product}`, `{detail_link}`, `{payment_link}`, `{feedback_link}`, `{ticket_link}`, `{staff_name}`, `{staff_phone}`
- **应用场景**：回答常见问题

#### 6️⃣ 📊 工单数据统计
- **触发关键词**：统计,数据,报表,工单数量
- **使用变量**：`{date}`, `{pending_count}`, `{processing_count}`, `{completed_count}`, `{ticket_id}`, `{ticket_title}`, `{ticket_status}`, `{progress}`, `{deadline}`, `{ticket_link}`, `{staff_name}`, `{staff_phone}`
- **应用场景**：查询工单统计数据

#### 7️⃣ ⏰ 预约提醒AI回复
- **触发关键词**：预约,时间,什么时候,排期
- **使用变量**：`{customer_name}`, `{deadline}`, `{assigned_to}`, `{ticket_title}`, `{company}`, `{staff_phone}`, `{phone}`, `{ticket_link}`, `{feedback_link}`
- **应用场景**：预约服务提醒

#### 8️⃣ 💬 咨询转接AI回复
- **触发关键词**：转接,人工,客服,销售代表
- **使用变量**：`{staff_name}`, `{staff_phone}`, `{department}`, `{ticket_link}`, `{feedback_link}`, `{project_link}`
- **应用场景**：AI转人工客服

#### 9️⃣ 🎁 活动推广AI回复
- **触发关键词**：活动,促销,优惠,打折,特价
- **使用变量**：`{date}`, `{product}`, `{amount}`, `{payment_link}`, `{detail_link}`, `{feedback_link}`, `{staff_phone}`
- **应用场景**：营销活动推广

#### 🔟 📞 售前咨询AI回复
- **触发关键词**：咨询,了解,介绍,推荐
- **使用变量**：`{customer_name}`, `{product}`, `{staff_name}`, `{detail_link}`, `{staff_phone}`, `{feedback_link}`, `{payment_link}`
- **应用场景**：售前咨询服务

---

### 企业微信模板（5个）

#### 1️⃣ 🟡 工单创建通知
- **推送模式**：实时推送
- **发送对象**：全体成员
- **使用变量**：工单相关、客户信息、链接变量
- **应用场景**：新工单创建后自动推送到企业微信群

#### 2️⃣ 🚨 工单超时提醒
- **推送模式**：实时推送
- **发送对象**：全体成员
- **使用变量**：工单相关、链接变量
- **应用场景**：工单超时后自动催促负责人

#### 3️⃣ 📈 项目进度更新通知
- **推送模式**：实时推送
- **发送对象**：全体成员
- **使用变量**：项目相关、员工信息、链接变量
- **应用场景**：项目进度更新时通知团队

#### 4️⃣ 📊 每日工作数据汇报
- **推送模式**：定时推送（每天9:00）
- **重复周期**：每日
- **发送对象**：全体成员
- **使用变量**：工单统计、项目统计、链接变量
- **应用场景**：每日早晨自动推送工作数据

#### 5️⃣ 💬 客户反馈通知
- **推送模式**：实时推送
- **发送对象**：客服部门
- **使用变量**：客户信息、工单相关、链接变量
- **应用场景**：客户提交反馈后通知客服

---

### 微信公众号模板（4个）

#### 1️⃣ 📦 订单确认通知
- **推送模式**：实时推送
- **发送对象**：全部粉丝
- **使用变量**：订单信息、支付链接、详情链接
- **应用场景**：客户下单后自动确认

#### 2️⃣ 🔧 售后服务通知
- **推送模式**：实时推送
- **发送对象**：已购买客户
- **使用变量**：工单相关、员工信息、链接变量
- **应用场景**：售后服务安排通知

#### 3️⃣ 🎁 限时活动推广
- **推送模式**：定时推送（10:00）
- **发送对象**：全部粉丝、VIP会员
- **使用变量**：产品信息、支付链接、详情链接
- **应用场景**：定时推送营销活动

#### 4️⃣ ⭐ VIP会员专享福利
- **推送模式**：实时推送
- **发送对象**：VIP会员
- **使用变量**：客户信息、金额、链接变量
- **应用场景**：VIP会员福利通知

---

### 群机器人模板（2个）

#### 1️⃣ 📢 群机器人-工单提醒
- **推送模式**：实时推送
- **发送对象**：内部工作群、技术支持群
- **使用变量**：工单相关、客户信息、链接变量
- **应用场景**：工单催办提醒

#### 2️⃣ 📊 群机器人-每日数据播报
- **推送模式**：定时推送（每天18:00）
- **重复周期**：每日
- **发送对象**：内部工作群
- **使用变量**：工单统计、链接变量
- **应用场景**：每日下班前数据播报

---

## 💡 使用技巧

### 技巧1：如何在模板中使用安全链接

**问题**：用户文档中提到的"查看详情：[安全链接]"如何实现？

**答案**：使用链接变量即可！

**示例**：
```
查看详情：{ticket_link}
项目进度：{project_link}
在线支付：{payment_link}
```

**效果**：
```
查看详情：https://your-domain.com/tickets/123
项目进度：https://your-domain.com/projects/PRJ001
在线支付：https://your-domain.com/pay/ORD20260203001
```

---

### 技巧2：如何快速插入变量

1. **方法1**：点击变量标签快速插入
   - 在模板内容编辑区下方有变量列表
   - 点击任意变量标签即可插入到光标位置

2. **方法2**：手动输入
   - 直接输入 `{变量名}`
   - 例如：`{customer_name}`, `{ticket_link}`

3. **方法3**：新增自定义变量
   - 点击"➕ 新增自定义变量"按钮
   - 填写变量代码和名称
   - 保存后即可使用

---

### 技巧3：如何测试链接变量

1. 点击"测试发送"
2. 填充变量值时，链接变量输入实际URL：
   ```
   {ticket_link} → https://your-domain.com/tickets/123
   {project_link} → https://your-domain.com/projects/PRJ001
   ```
3. 发送测试消息
4. 查看消息中的链接是否正确

---

### 技巧4：如何选择企业微信员工进行测试

1. 选择企业微信模板
2. 点击"测试发送"
3. 选择"👥 选择企业微信员工"
4. 下拉列表显示员工信息（姓名 + 部门）：
   - 🧑 张三 - 技术部
   - 🧑 李四 - 销售部
   - 👩 王五 - 客服部
   - 🧑 赵六 - 管理层
5. 选择一个员工
6. 填充变量值
7. 发送测试

**说明**：这里展示的是示例数据，实际使用时会从企业微信通讯录获取真实员工列表。

---

### 技巧5：如何选择公众号用户进行测试

1. 选择微信公众号模板
2. 点击"测试发送"
3. 选择"👤 选择公众号用户"
4. 下拉列表显示粉丝信息（姓名 + 标签）：
   - 👤 张三 - 已关注
   - 👤 李四 - VIP
   - 👤 王五 - 活跃粉丝
5. 选择一个用户
6. 填充变量值
7. 发送测试

**说明**：这里展示的是示例数据，实际使用时会从微信公众号获取真实粉丝列表。

---

## ✅ 验证清单

### 数据库验证

- [ ] SQL脚本执行成功
- [ ] 数据库中有23个预留模板（`is_system=1`）
- [ ] AI回复模板10个
- [ ] 企业微信模板5个
- [ ] 微信公众号模板4个
- [ ] 群机器人模板2个
- [ ] 短信模板2个

### 前端功能验证

- [ ] 所有标签页都能看到预留模板
- [ ] 预留模板不能删除（显示"🔒 禁用"按钮）
- [ ] 可以编辑预留模板内容
- [ ] 变量列表包含链接变量（6个）
- [ ] 变量列表包含项目变量（5个）
- [ ] 测试发送支持"选择企业微信员工"
- [ ] 测试发送支持"选择公众号用户"
- [ ] 模板预览能正确显示链接变量
- [ ] 快速插入变量功能正常

### 功能测试

- [ ] 编辑任一预留模板，保存成功
- [ ] 在模板内容中使用 `{ticket_link}`，预览正常
- [ ] 在模板内容中使用 `{project_link}`，预览正常
- [ ] 测试发送选择企业微信员工，发送成功
- [ ] 测试发送选择公众号用户，发送成功
- [ ] 新增自定义变量，插入到模板，保存成功

---

## 📖 相关文档

| 文档 | 说明 |
|------|------|
| [智能工单交互系统-完整实现方案.md](./智能工单交互系统-完整实现方案.md) | 工单系统完整方案 |
| [AI回复模板-8个预留模块快速参考卡.md](./AI回复模板-8个预留模块快速参考卡.md) | AI回复模板快速参考 |
| [AI回复模板-完整功能升级指南.md](./AI回复模板-完整功能升级指南.md) | AI回复模板功能升级指南 |

---

## 🆘 常见问题

### Q1: SQL脚本导入失败怎么办？

**A**: 检查是否已存在相同名称的模板，先删除旧数据：
```sql
DELETE FROM message_templates WHERE is_system = 1;
```
然后重新执行脚本。

---

### Q2: 看不到预留模板怎么办？

**A**: 
1. 刷新浏览器（Ctrl+Shift+R 硬刷新）
2. 检查数据库是否导入成功
3. 检查后端服务是否正常运行
4. 检查前端API请求是否成功（F12查看Network）

---

### Q3: 测试发送看不到"选择企业微信员工"选项？

**A**: 确保：
1. 当前标签页是"企业微信"
2. 测试方式选择了"👥 选择企业微信员工"
3. 前端代码已更新

---

### Q4: 链接变量在预览时显示不正确？

**A**: 
1. 检查变量代码是否正确（`{ticket_link}` 而不是 `{ticketlink}`）
2. 查看 renderPreviewContent() 函数中的 sampleData 是否包含该链接变量
3. 重启前端服务

---

### Q5: 如何自定义安全链接的域名？

**A**: 在后端配置中修改 `baseUrl`：
```python
# backend/config.py
BASE_URL = "https://your-domain.com"
```

链接变量会自动使用这个域名生成完整URL。

---

## 🎉 总结

本次升级为消息模板管理系统带来了：

✅ **23个即用预留模板** - 覆盖所有业务场景  
✅ **6个链接变量** - 支持安全链接、工单链接、项目链接等  
✅ **5个项目变量** - 完整支持项目进度管理  
✅ **增强的测试发送** - 支持企业微信员工和公众号用户选择  
✅ **完善的变量系统** - 37个系统变量，支持自定义变量  
✅ **SQL初始化脚本** - 一键导入所有预留模板  

现在你可以：
- ✅ 快速使用预留模板（不需要从零编写）
- ✅ 在模板中使用安全链接（如：查看详情：{ticket_link}）
- ✅ 测试发送时选择企业微信员工
- ✅ 测试发送时选择公众号用户
- ✅ 新增自定义变量满足特殊需求

**祝使用愉快！** 🚀
