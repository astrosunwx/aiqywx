# ðŸš€ å®¢æˆ·è”ç³»åŠŸèƒ½ - å®Œæ•´é…ç½®ä¸Žä½¿ç”¨æŒ‡å—

## ðŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#æ–¹æ¡ˆæ¦‚è¿°)
2. [ä¼ä¸šå¾®ä¿¡åŽå°é…ç½®](#ä¼ä¸šå¾®ä¿¡åŽå°é…ç½®)
3. [åŠŸèƒ½å®žçŽ°è¯´æ˜Ž](#åŠŸèƒ½å®žçŽ°è¯´æ˜Ž)
4. [APIæŽ¥å£æ–‡æ¡£](#apiæŽ¥å£æ–‡æ¡£)
5. [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
6. [å®šæ—¶ä»»åŠ¡é…ç½®](#å®šæ—¶ä»»åŠ¡é…ç½®)

---

## æ–¹æ¡ˆæ¦‚è¿°

### ðŸŽ¯ æ ¸å¿ƒç›®æ ‡

å®žçŽ°**å¯¹å¤–å®¢æˆ·æ²Ÿé€š**çš„è‡ªåŠ¨åŒ–å’Œä¸“ä¸šåŒ–ï¼Œå°†é¡¹ç›®è¿›åº¦ä»¥å®‰å…¨ã€ç¾Žè§‚çš„æ–¹å¼æŽ¨é€ç»™å®¢æˆ·ã€‚

### âœ¨ ä¸¤å¤§æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šèŠå¤©å·¥å…·æ ï¼ˆæŽ¨è â­ï¼‰

**ç”¨æˆ·ä½“éªŒæœ€ä½³**ï¼Œå‘˜å·¥åœ¨ä¸Žå®¢æˆ·èŠå¤©æ—¶ï¼Œä¾§è¾¹æ ä¸€é”®å‘é€é¡¹ç›®è¿›åº¦ã€‚

```
å‘˜å·¥æ“ä½œæµç¨‹ï¼š
1. æ‰“å¼€ä¸Žå®¢æˆ·çš„èŠå¤©çª—å£
2. ç‚¹å‡»å³ä¾§å·¥å…·æ "é¡¹ç›®è¿›åº¦"æŒ‰é’®
3. é€‰æ‹©è¦å‘é€çš„é¡¹ç›®
4. ç‚¹å‡»"å‘é€è¿›åº¦"
5. å®¢æˆ·ç«‹å³æ”¶åˆ°å›¾æ–‡æ¶ˆæ¯
```

#### æ–¹æ¡ˆäºŒï¼šè‡ªåŠ¨æŽ¨é€

**ç³»ç»Ÿè‡ªåŠ¨åŒ–**ï¼Œåœ¨ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨é€šçŸ¥å®¢æˆ·ã€‚

```
è§¦å‘åœºæ™¯ï¼š
- é‡Œç¨‹ç¢‘è¾¾æˆï¼ˆéœ€æ±‚ç¡®è®¤ã€å¼€å‘å®Œæˆã€æµ‹è¯•é€šè¿‡ï¼‰
- è¿›åº¦é˜ˆå€¼ï¼ˆ50%ã€80%ã€100%ï¼‰
- å®šæ—¶å‘¨æŠ¥ï¼ˆæ¯å‘¨äº”17:00ï¼‰
```

---

## ä¼ä¸šå¾®ä¿¡åŽå°é…ç½®

### ç¬¬ä¸€æ­¥ï¼šé…ç½®åº”ç”¨ä¾§è¾¹æ 

1. **ç™»å½•ä¼ä¸šå¾®ä¿¡ç®¡ç†åŽå°**
   - è®¿é—®ï¼šhttps://work.weixin.qq.com/
   - è¿›å…¥ã€Œåº”ç”¨ç®¡ç†ã€â†’ æ‰¾åˆ°æ‚¨çš„ã€Œå®¢æˆ·è”ç³»åº”ç”¨ã€

2. **é…ç½®èŠå¤©å·¥å…·æ **
   
   è·¯å¾„ï¼š`åº”ç”¨ç®¡ç†` â†’ `å®¢æˆ·è”ç³»åº”ç”¨` â†’ `èŠå¤©å·¥å…·æ `
   
   é…ç½®é¡¹ï¼š
   ```
   åç§°ï¼šé¡¹ç›®è¿›åº¦
   å›¾æ ‡ï¼šðŸ“Šï¼ˆå¯ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡ï¼‰
   é¡µé¢URLï¼šhttps://your-domain.com/sidebar/project-selector
   ```

3. **é…ç½®å¯ä¿¡åŸŸå**
   
   è·¯å¾„ï¼š`åº”ç”¨ç®¡ç†` â†’ `å®¢æˆ·è”ç³»åº”ç”¨` â†’ `ç½‘é¡µæŽˆæƒåŠJS-SDK`
   
   æ·»åŠ åŸŸåï¼š
   ```
   your-domain.com
   ```

4. **å¼€å¯æŽ¥å£æƒé™**
   
   è·¯å¾„ï¼š`åº”ç”¨ç®¡ç†` â†’ `å®¢æˆ·è”ç³»åº”ç”¨` â†’ `APIæƒé™`
   
   éœ€è¦å¼€å¯çš„æƒé™ï¼š
   - âœ… å‘é€æ¶ˆæ¯åˆ°å¤–éƒ¨è”ç³»äºº
   - âœ… èŽ·å–å®¢æˆ·è”ç³»äººä¿¡æ¯
   - âœ… èŽ·å–å‘˜å·¥ä¿¡æ¯

### ç¬¬äºŒæ­¥ï¼šé…ç½®å®¢æˆ·è”ç³»Secret

1. **èŽ·å–Secret**
   
   è·¯å¾„ï¼š`åº”ç”¨ç®¡ç†` â†’ `å®¢æˆ·è”ç³»åº”ç”¨` â†’ `Secret`
   
   å¤åˆ¶Secretå¹¶ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡ï¼š
   ```bash
   # .env
   CORP_ID=ww1234567890abcdef
   CORP_SECRET=your_customer_contact_secret_here
   AGENT_ID=1000002
   ```

2. **é…ç½®å›žè°ƒURLï¼ˆå¯é€‰ï¼‰**
   
   å¦‚éœ€æŽ¥æ”¶å®¢æˆ·æ¶ˆæ¯ï¼Œé…ç½®ï¼š
   ```
   URL: https://your-domain.com/wechat/callback
   Token: your_callback_token
   EncodingAESKey: your_encoding_aes_key
   ```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®å¯ä¿¡IP

è·¯å¾„ï¼š`ç®¡ç†å·¥å…·` â†’ `é€šè®¯å½•åŒæ­¥` â†’ `APIæŽ¥å£`

æ·»åŠ æœåŠ¡å™¨IPï¼š
```
æœåŠ¡å™¨IPï¼š123.45.67.89
```

---

## åŠŸèƒ½å®žçŽ°è¯´æ˜Ž

### ðŸ“‚ æ–‡ä»¶ç»“æž„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ customer_contact_service.py  # å®¢æˆ·è”ç³»æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ sidebar.py                   # èŠå¤©å·¥å…·æ è·¯ç”±
â”‚   â”‚   â””â”€â”€ auto_notify.py               # è‡ªåŠ¨é€šçŸ¥è·¯ç”±
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ sidebar_project_selector.html # ä¾§è¾¹æ é¡µé¢
```

### ðŸ”§ æ ¸å¿ƒåŠŸèƒ½

#### 1. CustomerContactServiceï¼ˆå®¢æˆ·è”ç³»æœåŠ¡ï¼‰

**æ–‡ä»¶**ï¼š`app/services/customer_contact_service.py`

**æ ¸å¿ƒæ–¹æ³•**ï¼š

| æ–¹æ³• | åŠŸèƒ½ | å‚æ•° |
|------|------|------|
| `send_progress_to_customer()` | å‘é€é¡¹ç›®è¿›åº¦ç»™å®¢æˆ· | project_id, customer_external_userid, sender_userid |
| `auto_notify_on_milestone()` | é‡Œç¨‹ç¢‘é€šçŸ¥ | project_id, milestone, customer_external_userid |
| `batch_send_progress_updates()` | æ‰¹é‡å‘é€å‘¨æŠ¥ | project_ids, sender_userid |

**æ¶ˆæ¯æ ¼å¼**ï¼š

```python
{
    "type": "link",
    "link": {
        "title": "ðŸ“Š XXé¡¹ç›® - é¡¹ç›®è¿›åº¦é€šçŸ¥",
        "url": "https://your-domain.com/view/project-detail?token=xxx",
        "desc": """äº²çˆ±çš„å®¢æˆ·ï¼Œæ‚¨å¥½ï¼

é¡¹ç›®åç§°ï¼šXXç³»ç»Ÿå¼€å‘V2.0
å½“å‰è¿›åº¦ï¼šå·²å®Œæˆ 80%
æœ€æ–°çŠ¶æ€ï¼šè¿›è¡Œä¸­ - ç¨³æ­¥æŽ¨è¿›ä¸­
è´Ÿè´£å›¢é˜Ÿï¼šæŠ€æœ¯å›¢é˜Ÿ

ðŸ’¡ ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¿›åº¦æŠ¥å‘Š
â° é¡µé¢å°†æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°æœ€æ–°è¿›å±•""",
        "picurl": ""
    }
}
```

#### 2. èŠå¤©å·¥å…·æ ä¾§è¾¹æ 

**è·¯ç”±**ï¼š`/sidebar/project-selector`

**å‚æ•°**ï¼ˆä¼ä¸šå¾®ä¿¡è‡ªåŠ¨ä¼ å…¥ï¼‰ï¼š
- `userid`ï¼šå‘˜å·¥UserID
- `external_userid`ï¼šå®¢æˆ·external_userid

**é¡µé¢åŠŸèƒ½**ï¼š
1. å±•ç¤ºè¯¥å®¢æˆ·å…³è”çš„æ‰€æœ‰é¡¹ç›®
2. æ¯ä¸ªé¡¹ç›®æ˜¾ç¤ºï¼šæ ‡é¢˜ã€è¿›åº¦ã€çŠ¶æ€ã€è´Ÿè´£äºº
3. å‘˜å·¥é€‰æ‹©é¡¹ç›®åŽç‚¹å‡»"å‘é€"
4. è°ƒç”¨APIå‘é€æ¶ˆæ¯ç»™å®¢æˆ·

**ç•Œé¢é¢„è§ˆ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ“Š å‘é€é¡¹ç›®è¿›åº¦              â”‚
â”‚  é€‰æ‹©è¦å‘é€çš„é¡¹ç›®ï¼Œä¸€é”®åˆ†äº«ç»™å®¢æˆ· â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ‘¤ å¼ ä¸‰                     â”‚
â”‚  å³å°†æŽ¥æ”¶é¡¹ç›®è¿›åº¦é€šçŸ¥           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ XXç³»ç»Ÿå¼€å‘V2.0  [80%] â”€â” â”‚
â”‚  â”‚ ðŸ“‹ çŠ¶æ€: è¿›è¡Œä¸­           â”‚ â”‚
â”‚  â”‚ ðŸ‘¥ è´Ÿè´£å›¢é˜Ÿ: å¼€å‘ç»„       â”‚ â”‚
â”‚  â”‚ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€ YYå¹³å°å‡çº§   [50%] â”€â”    â”‚
â”‚  â”‚ ðŸ“‹ çŠ¶æ€: è¿›è¡Œä¸­           â”‚ â”‚
â”‚  â”‚ ðŸ‘¤ è´Ÿè´£äºº: æŽå››           â”‚ â”‚
â”‚  â”‚ â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ ðŸ“¤ å‘é€é¡¹ç›®è¿›åº¦ç»™å®¢æˆ· ]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIæŽ¥å£æ–‡æ¡£

### 1ï¸âƒ£ ä¾§è¾¹æ ï¼šå±•ç¤ºé¡¹ç›®é€‰æ‹©å™¨

**ç«¯ç‚¹**ï¼š`GET /sidebar/project-selector`

**è¯·æ±‚å‚æ•°**ï¼š
```
userid: string         # å‘˜å·¥UserIDï¼ˆä¼ä¸šå¾®ä¿¡è‡ªåŠ¨ä¼ å…¥ï¼‰
external_userid: string # å®¢æˆ·external_useridï¼ˆä¼ä¸šå¾®ä¿¡è‡ªåŠ¨ä¼ å…¥ï¼‰
```

**å“åº”**ï¼šHTMLé¡µé¢

---

### 2ï¸âƒ£ ä¾§è¾¹æ ï¼šå‘é€é¡¹ç›®è¿›åº¦

**ç«¯ç‚¹**ï¼š`POST /sidebar/send-progress`

**è¯·æ±‚ä½“**ï¼š
```json
{
    "project_id": 1,
    "userid": "zhangsan",
    "external_userid": "wmABCDEFGHIJKLMNOPQ"
}
```

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "é¡¹ç›®è¿›åº¦å·²å‘é€ç»™å®¢æˆ·",
    "secure_link": "https://your-domain.com/view/project-detail?token=eyJ0eXAi..."
}
```

---

### 3ï¸âƒ£ è‡ªåŠ¨é€šçŸ¥ï¼šé‡Œç¨‹ç¢‘é€šçŸ¥

**ç«¯ç‚¹**ï¼š`POST /auto-notify/milestone`

**è¯·æ±‚ä½“**ï¼š
```json
{
    "project_id": 1,
    "milestone": "éœ€æ±‚ç¡®è®¤",
    "customer_external_userid": "wmABCDEFGHIJKLMNOPQ",
    "sender_userid": "zhangsan"
}
```

**é‡Œç¨‹ç¢‘ç±»åž‹**ï¼š
- éœ€æ±‚ç¡®è®¤ âœ…
- è®¾è®¡å®Œæˆ ðŸŽ¨
- å¼€å‘å®Œæˆ ðŸ’»
- æµ‹è¯•é€šè¿‡ âœ”ï¸
- ä¸Šçº¿éƒ¨ç½² ðŸš€
- éªŒæ”¶é€šè¿‡ ðŸŽ‰

---

### 4ï¸âƒ£ è‡ªåŠ¨é€šçŸ¥ï¼šæ‰¹é‡å‘¨æŠ¥

**ç«¯ç‚¹**ï¼š`POST /auto-notify/batch-weekly`

**è¯·æ±‚ä½“**ï¼š
```json
{
    "project_ids": [1, 2, 3, 4, 5],
    "sender_userid": "zhangsan"
}
```

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "å·²å¼€å§‹æ‰¹é‡å‘é€é€šçŸ¥ï¼Œå…± 5 ä¸ªé¡¹ç›®",
    "project_count": 5
}
```

---

### 5ï¸âƒ£ è‡ªåŠ¨é€šçŸ¥ï¼šè¿›åº¦é˜ˆå€¼é€šçŸ¥

**ç«¯ç‚¹**ï¼š`POST /auto-notify/progress-threshold`

**è¯·æ±‚å‚æ•°**ï¼š
```
project_id: int    # é¡¹ç›®ID
threshold: int     # è¿›åº¦é˜ˆå€¼ï¼ˆ25, 50, 75, 90, 100ï¼‰
sender_userid: string
```

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "å·²é€šçŸ¥å®¢æˆ·ï¼šå¼€å‘å®Œæˆ50%",
    "threshold": 50,
    "current_progress": 52
}
```

---

### 6ï¸âƒ£ èŽ·å–æ´»è·ƒé¡¹ç›®åˆ—è¡¨

**ç«¯ç‚¹**ï¼š`GET /auto-notify/active-projects`

**å“åº”**ï¼š
```json
{
    "total_count": 3,
    "projects": [
        {
            "project_id": 1,
            "project_title": "XXç³»ç»Ÿå¼€å‘V2.0",
            "progress": 80,
            "customer_name": "å¼ ä¸‰",
            "customer_external_userid": "wmABCDEFGHIJKLMNOPQ"
        }
    ]
}
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå‘˜å·¥æ‰‹åŠ¨å‘é€è¿›åº¦

**æ­¥éª¤**ï¼š

1. å‘˜å·¥åœ¨ä¼ä¸šå¾®ä¿¡æ‰“å¼€ä¸Žå®¢æˆ·çš„èŠå¤©çª—å£
2. ç‚¹å‡»å³ä¾§å·¥å…·æ çš„"é¡¹ç›®è¿›åº¦"æŒ‰é’®
3. ä¾§è¾¹æ å±•ç¤ºè¯¥å®¢æˆ·çš„æ‰€æœ‰é¡¹ç›®
4. å‘˜å·¥é€‰æ‹©é¡¹ç›®ï¼Œç‚¹å‡»"å‘é€è¿›åº¦"
5. å®¢æˆ·ç«‹å³æ”¶åˆ°å›¾æ–‡æ¶ˆæ¯

**å®¢æˆ·æ”¶åˆ°çš„æ¶ˆæ¯**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“Š XXç³»ç»Ÿå¼€å‘V2.0 - é¡¹ç›®è¿›åº¦é€šçŸ¥       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº²çˆ±çš„å¼ ä¸‰ï¼Œæ‚¨å¥½ï¼                     â”‚
â”‚                                     â”‚
â”‚ é¡¹ç›®åç§°ï¼šXXç³»ç»Ÿå¼€å‘V2.0               â”‚
â”‚ å½“å‰è¿›åº¦ï¼šå·²å®Œæˆ 80%                   â”‚
â”‚ æœ€æ–°çŠ¶æ€ï¼šè¿›è¡Œä¸­ - ç¨³æ­¥æŽ¨è¿›ä¸­           â”‚
â”‚ è´Ÿè´£å›¢é˜Ÿï¼šæŠ€æœ¯å›¢é˜Ÿ                     â”‚
â”‚                                     â”‚
â”‚ ðŸ’¡ ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¿›åº¦æŠ¥å‘Š                â”‚
â”‚ â° é¡µé¢å°†æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°æœ€æ–°è¿›å±•       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   [ ç‚¹å‡»æŸ¥çœ‹ ]
```

---

### åœºæ™¯2ï¼šé¡¹ç›®è¾¾åˆ°é‡Œç¨‹ç¢‘è‡ªåŠ¨é€šçŸ¥

**è§¦å‘æ¡ä»¶**ï¼šé¡¹ç›®è¿›åº¦æ›´æ–°åˆ°ç‰¹å®šé˜¶æ®µ

**ä»£ç ç¤ºä¾‹**ï¼š

```python
# åœ¨é¡¹ç›®ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå½“è¿›åº¦æ›´æ–°æ—¶
async def update_project_progress(project_id: int, new_progress: int):
    # æ›´æ–°è¿›åº¦
    await update_progress_in_db(project_id, new_progress)
    
    # æ£€æµ‹æ˜¯å¦è¾¾åˆ°é‡Œç¨‹ç¢‘
    if new_progress >= 50 and old_progress < 50:
        # è§¦å‘é‡Œç¨‹ç¢‘é€šçŸ¥
        await notify_milestone(
            project_id=project_id,
            milestone="å¼€å‘å®Œæˆ50%",
            customer_external_userid=customer.wechat_openid,
            sender_userid="system"
        )
```

**APIè°ƒç”¨**ï¼š

```bash
curl -X POST http://localhost:8000/auto-notify/milestone \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": 1,
    "milestone": "å¼€å‘å®Œæˆ",
    "customer_external_userid": "wmABCDEFGHIJKLMNOPQ",
    "sender_userid": "zhangsan"
  }'
```

---

### åœºæ™¯3ï¼šæ¯å‘¨äº”æ‰¹é‡å‘é€å‘¨æŠ¥

**å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š

```python
# cron_jobs.py
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import aiohttp

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', day_of_week='fri', hour=17, minute=0)
async def weekly_report():
    """æ¯å‘¨äº”17:00å‘é€å‘¨æŠ¥"""
    
    # 1. èŽ·å–æ‰€æœ‰æ´»è·ƒé¡¹ç›®
    async with aiohttp.ClientSession() as session:
        async with session.get('http://localhost:8000/auto-notify/active-projects') as resp:
            data = await resp.json()
            project_ids = [p['project_id'] for p in data['projects']]
    
    # 2. æ‰¹é‡å‘é€
    async with aiohttp.ClientSession() as session:
        async with session.post(
            'http://localhost:8000/auto-notify/batch-weekly',
            json={
                "project_ids": project_ids,
                "sender_userid": "system_bot"
            }
        ) as resp:
            result = await resp.json()
            print(f"âœ… å‘¨æŠ¥å‘é€å®Œæˆï¼š{result['project_count']} ä¸ªé¡¹ç›®")

scheduler.start()
```

**Linux Crontabé…ç½®**ï¼š

```bash
# æ¯å‘¨äº”17:00æ‰§è¡Œ
0 17 * * 5 curl -X POST http://localhost:8000/auto-notify/batch-weekly \
  -H "Content-Type: application/json" \
  -d '{"project_ids": [1,2,3], "sender_userid": "system"}'
```

---

### åœºæ™¯4ï¼šè¿›åº¦é˜ˆå€¼è‡ªåŠ¨é€šçŸ¥

**è§¦å‘é€»è¾‘**ï¼š

```python
# åœ¨é¡¹ç›®è¿›åº¦æ›´æ–°æ—¶æ£€æµ‹
async def check_and_notify_threshold(project_id: int, old_progress: int, new_progress: int):
    thresholds = [25, 50, 75, 90, 100]
    
    for threshold in thresholds:
        if old_progress < threshold <= new_progress:
            # è¾¾åˆ°æ–°çš„é˜ˆå€¼ï¼Œå‘é€é€šçŸ¥
            await notify_progress_threshold(
                project_id=project_id,
                threshold=threshold,
                sender_userid="system"
            )
```

---

## å®šæ—¶ä»»åŠ¡é…ç½®

### æ–¹å¼ä¸€ï¼šAPSchedulerï¼ˆæŽ¨èï¼‰

**å®‰è£…ä¾èµ–**ï¼š

```bash
pip install apscheduler
```

**é…ç½®æ–‡ä»¶**ï¼š`app/scheduler.py`

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
import aiohttp

scheduler = AsyncIOScheduler()

# æ¯å‘¨äº”17:00å‘é€å‘¨æŠ¥
@scheduler.scheduled_job(CronTrigger(day_of_week='fri', hour=17, minute=0))
async def send_weekly_reports():
    async with aiohttp.ClientSession() as session:
        # èŽ·å–æ´»è·ƒé¡¹ç›®
        async with session.get('http://localhost:8000/auto-notify/active-projects') as resp:
            data = await resp.json()
            project_ids = [p['project_id'] for p in data['projects']]
        
        # æ‰¹é‡å‘é€
        async with session.post(
            'http://localhost:8000/auto-notify/batch-weekly',
            json={"project_ids": project_ids, "sender_userid": "system"}
        ) as resp:
            print(await resp.json())

# å¯åŠ¨è°ƒåº¦å™¨
def start_scheduler():
    scheduler.start()
    print("âœ… å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨")
```

**åœ¨main.pyä¸­å¯åŠ¨**ï¼š

```python
from app.scheduler import start_scheduler

@app.on_event("startup")
async def startup_event():
    start_scheduler()
```

---

### æ–¹å¼äºŒï¼šLinux Crontab

**ç¼–è¾‘crontab**ï¼š

```bash
crontab -e
```

**æ·»åŠ ä»»åŠ¡**ï¼š

```bash
# æ¯å‘¨äº”17:00å‘é€å‘¨æŠ¥
0 17 * * 5 /usr/bin/curl -X POST http://localhost:8000/auto-notify/batch-weekly \
  -H "Content-Type: application/json" \
  -d '{"project_ids": [1,2,3,4,5], "sender_userid": "system"}'

# æ¯å¤©æ£€æŸ¥è¿›åº¦é˜ˆå€¼ï¼ˆå¯é€‰ï¼‰
0 10 * * * /usr/bin/python /path/to/check_thresholds.py
```

---

### æ–¹å¼ä¸‰ï¼šWindowsä»»åŠ¡è®¡åˆ’ç¨‹åº

1. æ‰“å¼€"ä»»åŠ¡è®¡åˆ’ç¨‹åº"
2. åˆ›å»ºåŸºæœ¬ä»»åŠ¡
3. è§¦å‘å™¨ï¼šæ¯å‘¨äº” 17:00
4. æ“ä½œï¼šå¯åŠ¨ç¨‹åº
   - ç¨‹åºï¼š`C:\Windows\System32\curl.exe`
   - å‚æ•°ï¼š`-X POST http://localhost:8000/auto-notify/batch-weekly -H "Content-Type: application/json" -d "{\"project_ids\": [1,2,3], \"sender_userid\": \"system\"}"`

---

## ðŸŽ‰ å®Œæ•´å®žçŽ°æ•ˆæžœ

### å‘˜å·¥ä¾§ï¼ˆå†…éƒ¨ï¼‰

âœ… èŠå¤©å·¥å…·æ å¿«æ·å‘é€  
âœ… ä¾§è¾¹æ é¡¹ç›®é€‰æ‹©å™¨  
âœ… ä¸€é”®å‘é€è¿›åº¦ç»™å®¢æˆ·  
âœ… é¢„è§ˆæ¶ˆæ¯å†…å®¹  

### å®¢æˆ·ä¾§ï¼ˆå¤–éƒ¨ï¼‰

âœ… æ”¶åˆ°ä¸“ä¸šå›¾æ–‡æ¶ˆæ¯  
âœ… ç‚¹å‡»é“¾æŽ¥æŸ¥çœ‹è¯¦æƒ…é¡µ  
âœ… é¡µé¢è‡ªåŠ¨åˆ·æ–°ï¼ˆ30åˆ†é’Ÿï¼‰  
âœ… æƒé™ä¿æŠ¤ï¼ˆåªèƒ½æŸ¥çœ‹è‡ªå·±çš„é¡¹ç›®ï¼‰  

### ç³»ç»Ÿè‡ªåŠ¨åŒ–

âœ… é‡Œç¨‹ç¢‘è‡ªåŠ¨é€šçŸ¥  
âœ… è¿›åº¦é˜ˆå€¼é€šçŸ¥  
âœ… æ¯å‘¨æ‰¹é‡å‘¨æŠ¥  
âœ… å®šæ—¶ä»»åŠ¡è°ƒåº¦  

---

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [å®‰å…¨é“¾æŽ¥ä½¿ç”¨æŒ‡å—](./å®‰å…¨é“¾æŽ¥ä¸Žç¼“å­˜ç­–ç•¥-ä½¿ç”¨æŒ‡å—.md)
- [æ™ºèƒ½å·¥å•ç³»ç»Ÿå¿«é€Ÿå‚è€ƒå¡](./æ™ºèƒ½å·¥å•ç³»ç»Ÿ-å¿«é€Ÿå‚è€ƒå¡.md)
- FastAPIæ–‡æ¡£ï¼šhttp://localhost:8000/docs
