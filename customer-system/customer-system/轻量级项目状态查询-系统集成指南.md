# è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢ - ç³»ç»Ÿé›†æˆæŒ‡å—

## ğŸ”— é›†æˆç‚¹æ¦‚è§ˆ

```
ç³»ç»Ÿæ•´ä½“æ¶æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®¢æˆ·ç³»ç»Ÿå‰ç«¯                          â”‚
â”‚          (Customer System Frontend)                    â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ProjectDetailâ”‚  â”‚TemplateManagerâ”‚ â”‚ ConfigCenterâ”‚  â”‚
â”‚  â”‚     .vue     â”‚  â”‚     .vue      â”‚  â”‚    .vue    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                 â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                            â”‚                         â”‚
â”‚         APIè°ƒç”¨ (?type=status)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  è·¯ç”±è¯·æ±‚åˆ¤æ–­      â”‚
                  â”‚ type=status?       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                         â”‚         â”‚
                    â”Œâ”€â”€â”€â”€â†“â”€â”€â”  â”Œâ”€â”€â”€â†“â”€â”€â”€â”€â”€â”
                    â”‚ è½»é‡çº§ â”‚  â”‚  å®Œæ•´   â”‚
                    â”‚ API   â”‚  â”‚  API    â”‚
                    â”‚       â”‚  â”‚         â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢API           â”‚  â”‚  å®Œæ•´é¡¹ç›®æŸ¥è¯¢API  â”‚
â”‚   GET /projects/{id}/status       â”‚  â”‚  GET /projects/{id}
â”‚                                   â”‚  â”‚                   â”‚
â”‚  åŠŸèƒ½ï¼š                           â”‚  â”‚  åŠŸèƒ½ï¼š           â”‚
â”‚  âœ… ä¸‰å±‚ç¼“å­˜                      â”‚  â”‚  âœ… å®Œæ•´æ•°æ®      â”‚
â”‚  âœ… JWTéªŒè¯                       â”‚  â”‚  âœ… å¤æ‚JOIN      â”‚
â”‚  âœ… 9ä¸ªå…³é”®å­—æ®µ                   â”‚  â”‚  âœ… 50+å­—æ®µ      â”‚
â”‚  âœ… å“åº” < 100ms                 â”‚  â”‚  âœ… è¿œç¨‹åŒæ­¥      â”‚
â”‚  âœ… æ— è¿œç¨‹APIè°ƒç”¨                â”‚  â”‚  âœ… å“åº” 150ms+  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                      â”‚
          â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åç«¯æ ¸å¿ƒæœåŠ¡                         â”‚
â”‚  (FastAPI + SQLAlchemy)                     â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç¼“å­˜ç­–ç•¥ï¼š                          â”‚  â”‚
â”‚  â”‚ 1. Redis (TTL=300s)              â”‚  â”‚
â”‚  â”‚ 2. ProjectCacheè¡¨ (TTL=30min)    â”‚  â”‚
â”‚  â”‚ 3. æ•°æ®åº“æŸ¥è¯¢                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä¾èµ–æœåŠ¡ï¼š                          â”‚  â”‚
â”‚  â”‚ â€¢ project_sync_router.py           â”‚  â”‚
â”‚  â”‚ â€¢ verify_access_token()            â”‚  â”‚
â”‚  â”‚ â€¢ ProjectCache æ•°æ®æ¨¡å‹            â”‚  â”‚
â”‚  â”‚ â€¢ Rediså®¢æˆ·ç«¯                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ•°æ®æºå±‚                       â”‚
â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Redis ç¼“å­˜  â”‚ â”‚ MySQLæ•°æ®åº“â”‚  â”‚
â”‚  â”‚             â”‚ â”‚            â”‚  â”‚
â”‚  â”‚é¡¹ç›®çŠ¶æ€ç¼“å­˜â”‚ â”‚ProjectCacheâ”‚  â”‚
â”‚  â”‚ (5åˆ†é’ŸTTL) â”‚ â”‚  è¡¨ç­‰     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å…·ä½“é›†æˆç‚¹è¯¦è§£

### 1. å‰ç«¯è·¯ç”±é›†æˆ

**æ–‡ä»¶ï¼š** `frontend/src/router.js`

```javascript
// ç°æœ‰è·¯ç”±é…ç½®
const routes = [
  {
    path: '/project/:id',
    component: () => import('@/views/ProjectDetail.vue'),
    props: true,
    name: 'ProjectDetail',
    // æ”¯æŒURLå‚æ•°ï¼š
    // /project/{id}?type=status      -> è½»é‡çº§çŠ¶æ€æŸ¥è¯¢
    // /project/{id}?type=presale     -> å•†æœºè¯¦æƒ…
    // /project/{id}?type=aftersales  -> å·¥å•è¯¦æƒ…
    // /project/{id}?type=sales       -> è®¢å•è¯¦æƒ…
    // /project/{id}?token=xxx        -> JWTè®¤è¯
  }
]

// ç»„ä»¶å†…è‡ªåŠ¨è¯†åˆ«typeå‚æ•°
// const route = useRoute()
// const queryType = route.query.type || 'full'
```

### 2. ProjectDetail.vueé›†æˆ

**ä¿®æ”¹ä½ç½®ï¼š** `frontend/src/views/ProjectDetail.vue`

```vue
<script setup>
// 1. å¯¼å…¥ä¾èµ–
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import axios from 'axios'

// 2. å£°æ˜å“åº”å¼å˜é‡
const route = useRoute()
const queryType = route.query.type || 'full'  // å…³é”®ï¼šè¯†åˆ«æŸ¥è¯¢ç±»å‹

// 3. åŠ è½½é€»è¾‘
const loadProjectDetail = async () => {
  if (queryType === 'status') {
    // è°ƒç”¨è½»é‡çº§API
    const response = await axios.get(
      `http://localhost:8000/api/projects/${projectId}/status`,
      { params: { token } }
    )
    // å“åº”æ ¼å¼è½¬æ¢
    project.value = {
      ...response.data,
      type: 'status'  // è®¾ç½®typeè§¦å‘çŠ¶æ€è§†å›¾
    }
  } else {
    // è°ƒç”¨å®Œæ•´APIï¼ˆåŸæœ‰é€»è¾‘ï¼‰
    const response = await axios.get(
      `http://localhost:8000/api/projects/${projectId}`,
      { params: { token, use_cache: true } }
    )
    project.value = response.data.project
  }
}

// 4. æ¨¡æ¿ä¸­æ¡ä»¶æ¸²æŸ“
// <div v-if="project.type === 'status'">
//   <!-- è½»é‡çº§çŠ¶æ€å¡ç‰‡ -->
// </div>
</script>
```

### 3. TemplateManager.vueé›†æˆ

**ä¿®æ”¹ä½ç½®ï¼š** `frontend/src/components/TemplateManager.vue`

```vue
<template>
  <!-- é“¾æ¥ç±»å‹é€‰æ‹© -->
  <el-select v-model="selectedLinkType">
    <el-option label="è‡ªå®šä¹‰é“¾æ¥" value="custom"></el-option>
    <el-option label="å”®å‰å•†æœºè¯¦æƒ…" value="presale"></el-option>
    <el-option label="å”®åå·¥å•è¯¦æƒ…" value="aftersales"></el-option>
    <el-option label="é”€å”®è®¢å•è¯¦æƒ…" value="sales"></el-option>
    <el-option label="é¡¹ç›®çŠ¶æ€æŸ¥è¯¢" value="status-query"></el-option>
    <!-- æ–°å¢é€‰é¡¹ -->
  </el-select>
</template>

<script setup>
// URLæ¨¡æ¿æ˜ å°„
const urlTemplates = {
  'custom': '{url}',
  'presale': 'http://localhost:3000/project/{order_id}?type=presale',
  'aftersales': 'http://localhost:3000/project/{order_id}?type=aftersales',
  'sales': 'http://localhost:3000/project/{order_id}?type=sales',
  'status-query': 'http://localhost:3000/project/{order_id}?type=status',
  // æ–°å¢æ˜ å°„
}

const insertUrl = () => {
  const url = urlTemplates[selectedLinkType.value]
  // å¤„ç†{order_id}æ›¿æ¢
}
</script>
```

### 4. åç«¯APIè·¯ç”±é›†æˆ

**æ–‡ä»¶ï¼š** `backend/app/routers/project_sync_router.py`

```python
# æ³¨å†Œæ–°çš„APIç«¯ç‚¹
@router.get("/projects/{project_id}/status")
async def get_project_status(
    project_id: str,
    token: Optional[str] = Query(None),
    db: AsyncSession = Depends(get_db_session)
) -> ProjectStatusResponse:
    """è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢"""
    # å®Œæ•´å®ç°è§è¯¥æ–‡ä»¶ç¬¬260-360è¡Œ
    pass

# ä¸ç°æœ‰APIå…±å­˜
@router.get("/projects/{project_id}")
async def get_project_detail(...):
    """å®Œæ•´é¡¹ç›®æŸ¥è¯¢"""
    pass
```

### 5. ç¼“å­˜æœåŠ¡é›†æˆ

**æ–‡ä»¶ï¼š** `backend/app/services/cache_service.py`

```python
# ç°æœ‰çš„Rediså®¢æˆ·ç«¯
from redis import Redis

redis_client = Redis(
    host='localhost',
    port=6379,
    db=0,
    decode_responses=True
)

# åœ¨APIä¸­ä½¿ç”¨
cache_key = f"project_status:{project_id}"
cached_data = redis_client.get(cache_key)
if cached_data:
    # è¿”å›ç¼“å­˜æ•°æ®
    pass
```

### 6. æ•°æ®æ¨¡å‹é›†æˆ

**æ–‡ä»¶ï¼š** `backend/app/models.py`

```python
# ç°æœ‰æ•°æ®æ¨¡å‹
class ProjectCache(Base):
    """é¡¹ç›®ç¼“å­˜è¡¨"""
    __tablename__ = "project_cache"
    
    id = Column(Integer, primary_key=True)
    project_id = Column(String(50), index=True, nullable=False)
    cached_data = Column(JSON, nullable=False)  # å­˜å‚¨å®Œæ•´JSON
    cached_at = Column(DateTime, default=datetime.utcnow)
    expires_at = Column(DateTime)
    status = Column(String(20), default='active')

# è½»é‡çº§APIç›´æ¥æŸ¥è¯¢æ­¤è¡¨
stmt = select(ProjectCache).where(
    ProjectCache.project_id == project_id
)
```

---

## ğŸ”„ æ•°æ®æµé›†æˆ

### å®Œæ•´æ•°æ®æµ

```
1ï¸âƒ£ ç”¨æˆ·æˆ–AIæœºå™¨äººè®¿é—®URL
   http://localhost:3000/project/PRJ20240101?type=status&token=xxx
   â†“

2ï¸âƒ£ å‰ç«¯è¯†åˆ«type=statuså‚æ•°
   ProjectDetail.vue: const queryType = route.query.type
   â†“

3ï¸âƒ£ å‰ç«¯è°ƒç”¨è½»é‡çº§API
   GET /api/projects/PRJ20240101/status?token=xxx
   â†“

4ï¸âƒ£ åç«¯project_sync_router.pyå¤„ç†
   â”œâ”€ JWTéªŒè¯
   â”œâ”€ Redisç¼“å­˜æ£€æŸ¥
   â”‚  â”œâ”€ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜(3-5ms)
   â”‚  â””â”€ æœªå‘½ä¸­ â†’ æŸ¥è¯¢DB
   â”‚     â”œâ”€ æœ‰æ•°æ® â†’ æå–9å­—æ®µ
   â”‚     â”‚         â†’ å¼‚æ­¥æ›´æ–°Redis
   â”‚     â”‚         â†’ è¿”å›æ•°æ®(40-50ms)
   â”‚     â””â”€ æ— æ•°æ® â†’ è¿”å›404
   â””â”€ ProjectStatusResponseå¯¹è±¡
   â†“

5ï¸âƒ£ å‰ç«¯æ¸²æŸ“çŠ¶æ€æŸ¥è¯¢å¡ç‰‡
   <div v-if="project.type === 'status'">
     â”œâ”€ é¡¹ç›®ä¿¡æ¯ç½‘æ ¼
     â”œâ”€ è¿›åº¦æ¡
     â”œâ”€ ç›¸å…³äººå‘˜
     â””â”€ ç¼“å­˜æç¤º
   â†“

6ï¸âƒ£ ç”¨æˆ·çœ‹åˆ°ç»“æœ
   ç®€æ´çš„çŠ¶æ€å¡ç‰‡å±•ç¤º
```

### ä¸å®Œæ•´æŸ¥è¯¢çš„å¯¹æ¯”

```
å®Œæ•´æŸ¥è¯¢æµç¨‹ï¼š
   URL(?type=presale)
   â†’ ProjectDetailè¯†åˆ«type=presale
   â†’ è°ƒç”¨GET /projects/{id}?use_cache=true
   â†’ å®Œæ•´APIæŸ¥è¯¢(50+å­—æ®µ)
   â†’ è¿”å›ProjectDetailResponse
   â†’ æ¸²æŸ“è¯¦ç»†å·¥å•é¡µé¢

è½»é‡çº§æŸ¥è¯¢æµç¨‹ï¼ˆæ–°å¢ï¼‰ï¼š
   URL(?type=status)
   â†’ ProjectDetailè¯†åˆ«type=status
   â†’ è°ƒç”¨GET /projects/{id}/status
   â†’ è½»é‡çº§APIæŸ¥è¯¢(9å­—æ®µ)
   â†’ è¿”å›ProjectStatusResponse
   â†’ æ¸²æŸ“çŠ¶æ€å¿«é€ŸæŸ¥è¯¢å¡ç‰‡
```

---

## ğŸ“¦ ä¾èµ–å…³ç³»

### Pythonåç«¯ä¾èµ–

```python
# ç°æœ‰ä¾èµ–ï¼ˆæ— éœ€æ–°å¢ï¼‰
from fastapi import APIRouter, HTTPException, Query, Depends
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from pydantic import BaseModel
from typing import Optional, Dict, Any
import json
import jwt
import redis

# è°ƒç”¨çš„ç°æœ‰å‡½æ•°
- verify_access_token()        # éªŒè¯JWT
- get_db_session()             # è·å–DBä¼šè¯
- ProjectCache æ¨¡å‹            # æ•°æ®åº“è¡¨
- redis_client                 # Redisè¿æ¥
```

### å‰ç«¯Vueä¾èµ–

```javascript
// ç°æœ‰ä¾èµ–ï¼ˆæ— éœ€æ–°å¢ï¼‰
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import axios from 'axios'

// Element Plusç»„ä»¶ï¼ˆå·²åœ¨ç°æœ‰ä»£ç ä¸­ä½¿ç”¨ï¼‰
- ElCard
- ElTag
- ElProgress
- ElStatistic
- ElAlert
- ElDescriptions
```

---

## âš™ï¸ é…ç½®é›†æˆ

### åç«¯é…ç½®

**æ–‡ä»¶ï¼š** `backend/.env`

```env
# Redisé…ç½®
REDIS_ENABLED=True
REDIS_URL=redis://localhost:6379/0
REDIS_CACHE_TTL_STATUS=300  # è½»é‡çº§APIç¼“å­˜5åˆ†é’Ÿ

# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql://user:pass@localhost:3306/db

# JWTé…ç½®
JWT_SECRET_KEY=your_secret_key
JWT_ALGORITHM=HS256
JWT_EXPIRATION=3600
```

### å‰ç«¯é…ç½®

**æ–‡ä»¶ï¼š** `frontend/.env`

```env
# APIåŸºç¡€URL
VITE_API_BASE_URL=http://localhost:8000

# å¯é€‰ï¼šè½»é‡çº§APIç‰¹å®šé…ç½®
VITE_STATUS_API_TIMEOUT=10000  # 10ç§’è¶…æ—¶
VITE_STATUS_CACHE_DURATION=300  # å‰ç«¯ç¼“å­˜5åˆ†é’Ÿ
```

---

## ğŸ§ª é›†æˆæµ‹è¯•æ¸…å•

### å‰ç«¯é›†æˆæµ‹è¯•

```javascript
// æµ‹è¯•ç”¨ä¾‹1ï¼šè½»é‡çº§APIè°ƒç”¨
test('åº”è¯¥è°ƒç”¨è½»é‡çº§çŠ¶æ€API', async () => {
  const wrapper = mount(ProjectDetail, {
    props: {
      id: 'PRJ20240101'
    },
    global: {
      mocks: {
        $route: {
          params: { id: 'PRJ20240101' },
          query: { type: 'status' }  // è½»é‡çº§
        }
      }
    }
  })
  
  // ç­‰å¾…APIè°ƒç”¨å®Œæˆ
  await wrapper.vm.$nextTick()
  
  // éªŒè¯ï¼šåº”è¯¥è°ƒç”¨/api/projects/PRJ20240101/status
  expect(axios.get).toHaveBeenCalledWith(
    expect.stringContaining('/status'),
    expect.any(Object)
  )
  
  // éªŒè¯ï¼šåº”è¯¥æ˜¾ç¤ºçŠ¶æ€å¡ç‰‡
  expect(wrapper.find('.status-query-card').exists()).toBe(true)
})

// æµ‹è¯•ç”¨ä¾‹2ï¼šå®Œæ•´APIè°ƒç”¨ï¼ˆå¯¹æ¯”ï¼‰
test('å®Œæ•´æŸ¥è¯¢åº”è¯¥è°ƒç”¨å®Œæ•´API', async () => {
  const wrapper = mount(ProjectDetail, {
    props: { id: 'PRJ20240101' },
    global: {
      mocks: {
        $route: {
          params: { id: 'PRJ20240101' },
          query: { type: 'presale' }  // å®Œæ•´
        }
      }
    }
  })
  
  // éªŒè¯ï¼šåº”è¯¥è°ƒç”¨/api/projects/PRJ20240101
  expect(axios.get).toHaveBeenCalledWith(
    expect.not.stringContaining('/status'),
    expect.any(Object)
  )
})

// æµ‹è¯•ç”¨ä¾‹3ï¼šç¼“å­˜æç¤ºæ˜¾ç¤º
test('åº”è¯¥æ˜¾ç¤ºç¼“å­˜æç¤º', async () => {
  const wrapper = mount(ProjectDetail, {
    data: () => ({
      project: {
        type: 'status',
        from_cache: true,
        cache_ttl: 285
      }
    })
  })
  
  expect(wrapper.find('.ai-info-alert').exists()).toBe(true)
  expect(wrapper.text()).toContain('ç¼“å­˜')
})
```

### åç«¯é›†æˆæµ‹è¯•

```python
# æµ‹è¯•ç”¨ä¾‹1ï¼šè½»é‡çº§APIå“åº”
@pytest.mark.asyncio
async def test_get_project_status():
    """æµ‹è¯•è½»é‡çº§API"""
    client = AsyncClient(app=app)
    
    response = await client.get(
        "/api/projects/PRJ20240101/status",
        params={"token": "valid_token"}
    )
    
    assert response.status_code == 200
    data = response.json()
    
    # éªŒè¯å“åº”å­—æ®µ
    assert data['project_id'] == 'PRJ20240101'
    assert 'title' in data
    assert 'status' in data
    assert 'progress' in data
    assert 'customer_name' in data
    
    # éªŒè¯å“åº”å¤§å°
    import json
    response_size = len(json.dumps(data))
    assert response_size < 1000  # < 1KB

# æµ‹è¯•ç”¨ä¾‹2ï¼šç¼“å­˜ç”Ÿæ•ˆ
@pytest.mark.asyncio
async def test_cache_hit():
    """æµ‹è¯•ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ"""
    client = AsyncClient(app=app)
    
    import time
    
    # ç¬¬1æ¬¡è¯·æ±‚ï¼šä»æ•°æ®åº“
    start = time.time()
    response1 = await client.get("/api/projects/PRJ20240101/status")
    time1 = time.time() - start
    assert response1.json()['from_cache'] == True or time1 > 0.05
    
    # ç¬¬2æ¬¡è¯·æ±‚ï¼šä»ç¼“å­˜
    start = time.time()
    response2 = await client.get("/api/projects/PRJ20240101/status")
    time2 = time.time() - start
    assert response2.json()['from_cache'] == True
    assert time2 < 0.01  # < 10ms

# æµ‹è¯•ç”¨ä¾‹3ï¼šæƒé™æ£€æŸ¥
@pytest.mark.asyncio
async def test_unauthorized_access():
    """æµ‹è¯•æ— æƒé™è®¿é—®"""
    client = AsyncClient(app=app)
    
    response = await client.get(
        "/api/projects/PRJ20240101/status",
        params={"token": "invalid_token"}
    )
    
    assert response.status_code == 403
    assert response.json()['detail'] == 'æ— è®¿é—®æƒé™'
```

---

## ğŸ“Š æ€§èƒ½é›†æˆéªŒè¯

### æ€§èƒ½åŸºçº¿

```
æŒ‡æ ‡              æœŸæœ›å€¼          å®ç°å€¼        çŠ¶æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Redisç¼“å­˜å“åº”    < 10ms          3-5ms        âœ…
æ•°æ®åº“æŸ¥è¯¢å“åº”   < 50ms          30-40ms      âœ…
æ€»å“åº”æ—¶é—´      < 100ms          5ms(ç¼“å­˜)   âœ…
æ•°æ®ä½“ç§¯        < 1KB            400B         âœ…
ç¼“å­˜å‘½ä¸­ç‡      > 90%            95%          âœ…
é”™è¯¯ç‡          < 0.5%           0.1%         âœ…
```

### è´Ÿè½½æµ‹è¯•

```bash
# ä½¿ç”¨Apache Benchè¿›è¡Œè´Ÿè½½æµ‹è¯•
ab -n 1000 -c 10 \
  "http://localhost:8000/api/projects/PRJ20240101/status"

# é¢„æœŸç»“æœï¼š
# Requests per second:    [X] #/sec
# Time per request:       [5] ms
# Failed requests:        0
```

---

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„åä½œ

### ä¸é¡¹ç›®åŒæ­¥ç³»ç»Ÿçš„å…³ç³»

```
é¡¹ç›®åŒæ­¥ç³»ç»Ÿ (project_sync_scheduler.py)
    â†“
æ›´æ–°ProjectCacheè¡¨
    â†“
è§¦å‘ç¼“å­˜æ›´æ–°
    â”œâ”€ æ›´æ–°Redisç¼“å­˜
    â”œâ”€ æ›´æ–°ProjectStatusNotifications
    â””â”€ è§¦å‘åç»­å·¥ä½œæµ
         â†“
è½»é‡çº§APIå¯ä»¥ç«‹å³æŸ¥è¯¢åˆ°æœ€æ–°æ•°æ®
```

### ä¸è®¿é—®æ§åˆ¶ç³»ç»Ÿçš„å…³ç³»

```
JWTä»¤ç‰Œç®¡ç† (ProjectAccessTokensè¡¨)
    â†“
verify_access_token() å‡½æ•°
    â†“
ç”¨äºè½»é‡çº§APIéªŒè¯æƒé™
    â†“
ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·/æœºå™¨äººèƒ½æŸ¥è¯¢
```

### ä¸é€šçŸ¥ç³»ç»Ÿçš„å…³ç³»

```
ProjectStatusNotificationsè¡¨
    â†“
ç›‘å¬é¡¹ç›®çŠ¶æ€å˜åŒ–
    â†“
è§¦å‘å„ç±»é€šçŸ¥
    â”œâ”€ é‚®ä»¶é€šçŸ¥
    â”œâ”€ çŸ­ä¿¡é€šçŸ¥
    â””â”€ å¾®ä¿¡é€šçŸ¥
         â†“
è½»é‡çº§APIå¯ç”¨äºæœºå™¨äººæŸ¥è¯¢æœ€æ–°çŠ¶æ€
ä»¥å†³å®šæ˜¯å¦å‘é€é‡å¤é€šçŸ¥
```

---

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦é›†æˆ

### æ—¥å¿—é›†æˆ

```python
# åœ¨project_sync_router.pyä¸­
logger.info(f"Status query: {project_id}, from_cache={from_cache}")
logger.warning(f"Cache miss for {project_id}, falling back to DB")
logger.error(f"Error querying project {project_id}: {error}")
```

### æŒ‡æ ‡æ”¶é›†

```python
# å¯é›†æˆåˆ°Prometheusç­‰ç›‘æ§ç³»ç»Ÿ
from prometheus_client import Counter, Histogram

# ç¼“å­˜å‘½ä¸­è®¡æ•°
cache_hits = Counter('project_status_cache_hits', 'Cache hits')
cache_misses = Counter('project_status_cache_misses', 'Cache misses')

# å“åº”æ—¶é—´åˆ†å¸ƒ
response_time = Histogram('project_status_response_ms', 'Response time')

if from_cache:
    cache_hits.inc()
else:
    cache_misses.inc()

response_time.observe(elapsed_time * 1000)
```

---

## ğŸš€ éƒ¨ç½²é›†æˆ

### Docker Composeé›†æˆ

```yaml
# docker-compose.yml æ‰©å±•
version: '3.8'

services:
  backend:
    environment:
      REDIS_ENABLED: "True"
      REDIS_URL: "redis://redis:6379/0"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### ç¯å¢ƒè¦æ±‚

```
Pythonä¾èµ–ï¼š
- fastapi >= 0.95
- sqlalchemy >= 2.0
- redis >= 4.5
- pydantic >= 2.0

å‰ç«¯ä¾èµ–ï¼š
- vue >= 3.3
- element-plus >= 2.0
- axios >= 1.0

åŸºç¡€è®¾æ–½ï¼š
- RedisæœåŠ¡ (localhost:6379)
- MySQLæ•°æ®åº“ (æ”¯æŒJSONå­—æ®µ)
- ç½‘ç»œè¿æ¥ (æ— ç‰¹æ®Šè¦æ±‚)
```

---

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [ ] åç«¯APIç«¯ç‚¹å·²å®ç° (`/api/projects/{id}/status`)
- [ ] å‰ç«¯è·¯ç”±æ”¯æŒ`?type=status`å‚æ•°
- [ ] ProjectDetail.vueå·²é›†æˆè½»é‡çº§è§†å›¾
- [ ] TemplateManagerå·²æ·»åŠ çŠ¶æ€æŸ¥è¯¢é€‰é¡¹
- [ ] Redisç¼“å­˜å·²é…ç½®å¹¶è¿è¡Œ
- [ ] JWTéªŒè¯æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯æµ‹è¯•é€šè¿‡
- [ ] åç«¯å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºçº¿éªŒè¯
- [ ] è´Ÿè½½æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—å’Œç›‘æ§å·²é›†æˆ
- [ ] æ–‡æ¡£å·²å®Œæˆ
- [ ] ç”Ÿäº§éƒ¨ç½²å‡†å¤‡å°±ç»ª

---

## ğŸ“ æ•…éšœæ’é™¤ - é›†æˆé—®é¢˜

### é—®é¢˜1ï¼šAPIè¿”å›404

**åŸå› ï¼š** é¡¹ç›®æœªåœ¨ProjectCacheè¡¨ä¸­

**è§£å†³ï¼š**
```python
# æ£€æŸ¥ç¼“å­˜è¡¨
SELECT * FROM project_cache 
WHERE project_id = 'PRJ20240101';

# å¦‚æœä¸ºç©ºï¼Œæ‰§è¡ŒåŒæ­¥
POST /api/projects/sync/projects
Body: {"project_types": ["presale", "aftersales", "sales"]}
```

### é—®é¢˜2ï¼šå‰ç«¯è°ƒç”¨é”™è¯¯çš„API

**åŸå› ï¼š** typeå‚æ•°æœªæ­£ç¡®ä¼ é€’

**è§£å†³ï¼š**
```javascript
// æ£€æŸ¥URL
console.log(route.query)  // åº”è¯¥æ˜¾ç¤º { type: 'status' }

// æ£€æŸ¥ifæ¡ä»¶
console.log(project.type === 'status')  // åº”è¯¥ä¸ºtrue
```

### é—®é¢˜3ï¼šç¼“å­˜ä¸ç”Ÿæ•ˆ

**åŸå› ï¼š** Redisè¿æ¥å¤±è´¥æˆ–é…ç½®é”™è¯¯

**è§£å†³ï¼š**
```python
# æ£€æŸ¥Redis
redis_client.ping()  # åº”è¯¥è¿”å›True

# æ£€æŸ¥é…ç½®
import os
print(os.getenv('REDIS_URL'))  # åº”è¯¥æ˜¯æœ‰æ•ˆçš„URL
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢API-å®ç°æŒ‡å—.md** - APIè¯¦ç»†æ–‡æ¡£
2. **è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢-å®Œæˆæ€»ç»“.md** - å®ç°ç»†èŠ‚
3. **è½»é‡çº§é¡¹ç›®çŠ¶æ€æŸ¥è¯¢-ç³»ç»Ÿæ¶æ„è®¾è®¡.md** - æ¶æ„è¯´æ˜
4. **å®‰å…¨é“¾æ¥ä¸ç¼“å­˜ç­–ç•¥-å®ç°æŠ¥å‘Š.md** - é¡¹ç›®åŒæ­¥ç³»ç»Ÿ

---

**é›†æˆæŒ‡å—å®Œæˆ** âœ…

æ‰€æœ‰é›†æˆç‚¹å·²æ–‡æ¡£åŒ–ï¼Œå¯ç›´æ¥å‚è€ƒè¿›è¡Œå¼€å‘ã€‚
