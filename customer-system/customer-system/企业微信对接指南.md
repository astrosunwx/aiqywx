# ä¼ä¸šå¾®ä¿¡APIå¯¹æ¥å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®](#1-ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®)
2. [è·å–ä¼ä¸šå¾®ä¿¡å‡­è¯](#2-è·å–ä¼ä¸šå¾®ä¿¡å‡­è¯)
3. [é…ç½®æ¶ˆæ¯æ¥æ”¶](#3-é…ç½®æ¶ˆæ¯æ¥æ”¶)
4. [ä»£ç é›†æˆ](#4-ä»£ç é›†æˆ)
5. [æµ‹è¯•éªŒè¯](#5-æµ‹è¯•éªŒè¯)

---

## 1. ä¼ä¸šå¾®ä¿¡åº”ç”¨é…ç½®

### æ­¥éª¤1ï¼šç™»å½•ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°
è®¿é—®ï¼šhttps://work.weixin.qq.com/

### æ­¥éª¤2ï¼šåˆ›å»ºè‡ªå»ºåº”ç”¨
1. è¿›å…¥ã€Œåº”ç”¨ç®¡ç†ã€â†’ã€Œè‡ªå»ºã€
2. ç‚¹å‡»ã€Œåˆ›å»ºåº”ç”¨ã€
3. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - **åº”ç”¨åç§°**ï¼šæ™ºèƒ½å”®å‰å”®åç³»ç»Ÿ
   - **åº”ç”¨Logo**ï¼šä¸Šä¼ åº”ç”¨å›¾æ ‡
   - **å¯è§èŒƒå›´**ï¼šé€‰æ‹©éœ€è¦ä½¿ç”¨çš„éƒ¨é—¨/æˆå‘˜

### æ­¥éª¤3ï¼šè®°å½•åº”ç”¨å‡­è¯
åˆ›å»ºå®Œæˆåï¼Œåœ¨åº”ç”¨è¯¦æƒ…é¡µæ‰¾åˆ°ï¼š
- **AgentId**ï¼ˆåº”ç”¨IDï¼‰
- **Secret**ï¼ˆåº”ç”¨å¯†é’¥ï¼‰

åŒæ—¶è®°å½•ä¼ä¸šä¿¡æ¯ï¼š
- **CorpId**ï¼ˆä¼ä¸šIDï¼‰ï¼šåœ¨ã€Œæˆ‘çš„ä¼ä¸šã€â†’ã€Œä¼ä¸šä¿¡æ¯ã€ä¸­æŸ¥çœ‹

---

## 2. è·å–ä¼ä¸šå¾®ä¿¡å‡­è¯

### å¿…éœ€çš„é…ç½®ä¿¡æ¯
```env
# ä¼ä¸šå¾®ä¿¡é…ç½®
WECHAT_WORK_CORP_ID=ww1234567890abcdef      # ä¼ä¸šID
WECHAT_WORK_AGENT_ID=1000001                # åº”ç”¨AgentId
WECHAT_WORK_SECRET=abc123xyz456            # åº”ç”¨Secret
WECHAT_WORK_TOKEN=MyToken123               # è‡ªå®šä¹‰Tokenï¼ˆç”¨äºæ¶ˆæ¯åŠ è§£å¯†ï¼‰
WECHAT_WORK_AES_KEY=abcdefghijklmnopqrstuvwxyz1234567890ABC  # è‡ªå®šä¹‰AESå¯†é’¥
```

---

## 3. é…ç½®æ¶ˆæ¯æ¥æ”¶

### æ­¥éª¤1ï¼šé…ç½®æ¥æ”¶æ¶ˆæ¯æœåŠ¡å™¨
åœ¨åº”ç”¨è¯¦æƒ…é¡µ â†’ ã€Œæ¥æ”¶æ¶ˆæ¯ã€â†’ã€Œè®¾ç½®APIæ¥æ”¶ã€

å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
- **URL**ï¼š`https://your-domain.com/api/wechat/work-message`
  - æœ¬åœ°å¼€å‘å¯ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼ˆå¦‚ngrokï¼‰
- **Token**ï¼šè‡ªå®šä¹‰å­—ç¬¦ä¸²ï¼ˆä¸ç¯å¢ƒå˜é‡ä¸­çš„TOKENä¸€è‡´ï¼‰
- **EncodingAESKey**ï¼šç‚¹å‡»ã€Œéšæœºç”Ÿæˆã€æˆ–è‡ªå®šä¹‰

### æ­¥éª¤2ï¼šæœ¬åœ°å¼€å‘ä½¿ç”¨å†…ç½‘ç©¿é€

#### ä½¿ç”¨ ngrok
```bash
# å®‰è£… ngrok
# ä¸‹è½½ï¼šhttps://ngrok.com/download

# å¯åŠ¨å†…ç½‘ç©¿é€
ngrok http 8000

# ä¼šå¾—åˆ°ä¸€ä¸ªå…¬ç½‘åœ°å€ï¼Œå¦‚ï¼š
# https://abc123.ngrok.io
```

ç„¶ååœ¨ä¼ä¸šå¾®ä¿¡åå°é…ç½®URLä¸ºï¼š
```
https://abc123.ngrok.io/api/wechat/work-message
```

---

## 4. ä»£ç é›†æˆ

### ç¯å¢ƒå˜é‡é…ç½®
ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```env
# ä¼ä¸šå¾®ä¿¡é…ç½®
WECHAT_WORK_CORP_ID=ww1234567890abcdef
WECHAT_WORK_AGENT_ID=1000001
WECHAT_WORK_SECRET=your_secret_here
WECHAT_WORK_TOKEN=MyToken123
WECHAT_WORK_AES_KEY=your_aes_key_here
```

### ä¼ä¸šå¾®ä¿¡æœåŠ¡å¢å¼º
æˆ‘ä»¬çš„ç³»ç»Ÿå·²ç»å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

#### 1. æ¥æ”¶ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯
- ç«¯ç‚¹ï¼š`POST /api/wechat/work-message`
- åŠŸèƒ½ï¼šæ¥æ”¶å‘˜å·¥å‘é€çš„æ¶ˆæ¯å’Œå‘½ä»¤

#### 2. å¿«æ·å‘½ä»¤å¤„ç†
- ç«¯ç‚¹ï¼š`POST /api/wechat/work/command`
- æ”¯æŒçš„å‘½ä»¤ï¼š
  - `#è®°å½•å®¢æˆ· æ‰‹æœºå·138xxxx æ„å‘äº§å“ç©ºè°ƒ`
  - `#æŸ¥è¯¢è¿›åº¦ æ‰‹æœºå·138xxxx`
  - `#è½¬æ¥å·¥ç¨‹å¸ˆ é¡¹ç›®ID123 é—®é¢˜æè¿°XXX`
  - `#é—®é¢˜å·²è§£å†³`

#### 3. ä¾§è¾¹æ åº”ç”¨
- ç«¯ç‚¹ï¼š`GET /api/wechat/sidebar-data`
- åŠŸèƒ½ï¼šæ˜¾ç¤ºå®¢æˆ·é¡¹ç›®ä¿¡æ¯å’Œå¿«æ·æ“ä½œ

#### 4. ç¾¤æœºå™¨äººé€šçŸ¥
- ç«¯ç‚¹ï¼š`POST /api/wechat/group-bot-notify`
- åŠŸèƒ½ï¼šå‘å†…éƒ¨ç¾¤æ¨é€æ¶ˆæ¯

---

## 5. æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šéªŒè¯URLé…ç½®
ä¼ä¸šå¾®ä¿¡ä¼šå‘é€GETè¯·æ±‚éªŒè¯URLï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å“åº”ã€‚

### æµ‹è¯•2ï¼šå‘é€æµ‹è¯•æ¶ˆæ¯
1. åœ¨ä¼ä¸šå¾®ä¿¡ä¸­å‘åº”ç”¨å‘é€æ¶ˆæ¯ï¼š"æµ‹è¯•"
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ¥æ”¶åˆ°çš„æ¶ˆæ¯

### æµ‹è¯•3ï¼šæµ‹è¯•å¿«æ·å‘½ä»¤
åœ¨ä¼ä¸šå¾®ä¿¡ä¸­å‘é€ï¼š
```
#è®°å½•å®¢æˆ· æ‰‹æœºå·13800138000 æ„å‘äº§å“ç©ºè°ƒ
```

ç³»ç»Ÿåº”è¯¥è¿”å›ï¼š
```
å·²è®°å½•å®¢æˆ· 13800138000ï¼Œåˆ›å»ºå”®å‰é¡¹ç›®ID: 1
```

### æµ‹è¯•4ï¼šæŸ¥è¯¢é¡¹ç›®è¿›åº¦
å‘é€ï¼š
```
#æŸ¥è¯¢è¿›åº¦ æ‰‹æœºå·13800138000
```

ç³»ç»Ÿè¿”å›å®¢æˆ·çš„æ‰€æœ‰é¡¹ç›®ä¿¡æ¯ã€‚

---

## 6. å¸¸è§APIåœºæ™¯

### åœºæ™¯1ï¼šå‘˜å·¥æ·»åŠ å®¢æˆ·åè‡ªåŠ¨è®°å½•
å½“ä¼ä¸šå¾®ä¿¡å‘˜å·¥æ·»åŠ å¤–éƒ¨å®¢æˆ·æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ï¼š
1. æ¥æ”¶ã€Œæ·»åŠ å¤–éƒ¨è”ç³»äººã€äº‹ä»¶
2. å°è¯•é€šè¿‡æ‰‹æœºå·åŒ¹é…å®¢æˆ·
3. å»ºç«‹ç»‘å®šå…³ç³»

### åœºæ™¯2ï¼šå®¢æˆ·å’¨è¯¢è‡ªåŠ¨åˆ†é…
1. å®¢æˆ·åœ¨ä¼ä¸šå¾®ä¿¡å‘é€æ¶ˆæ¯
2. AIè¯†åˆ«æ„å›¾ï¼ˆå”®å‰/å”®åï¼‰
3. è‡ªåŠ¨åˆ›å»ºå·¥å•å¹¶åˆ†é…ç»™å¯¹åº”å‘˜å·¥

### åœºæ™¯3ï¼šå·¥å•è½¬æ¥
1. é”€å”®è¾“å…¥ï¼š`#è½¬æ¥å·¥ç¨‹å¸ˆ é¡¹ç›®ID123 é—®é¢˜æè¿°ç©ºè°ƒä¸åˆ¶å†·`
2. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - æ›´æ–°é¡¹ç›®çŠ¶æ€
   - åˆ†é…ç»™å·¥ç¨‹å¸ˆ
   - åœ¨å†…éƒ¨ç¾¤é€šçŸ¥

---

## 7. è¿›é˜¶åŠŸèƒ½

### é…ç½®ä¾§è¾¹æ åº”ç”¨
åœ¨ä¼ä¸šå¾®ä¿¡åå° â†’ åº”ç”¨è¯¦æƒ… â†’ ã€Œå·¥ä½œå°åº”ç”¨ä¸»é¡µã€

è®¾ç½®ä¸»é¡µURLï¼š
```
https://your-domain.com/wechat/sidebar?customer_id=${EXTERNAL_USERID}
```

### é…ç½®ç¾¤æœºå™¨äºº
1. åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤ä¸­æ·»åŠ æœºå™¨äºº
2. è·å–Webhook URL
3. é…ç½®åˆ°ç¯å¢ƒå˜é‡ï¼š
```env
GROUP_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
```

---

## 8. APIè°ƒç”¨ç¤ºä¾‹

### è·å–Access Token
```python
import httpx

async def get_access_token(corp_id: str, secret: str) -> str:
    url = "https://qyapi.weixin.qq.com/cgi-bin/gettoken"
    params = {
        "corpid": corp_id,
        "corpsecret": secret
    }
    async with httpx.AsyncClient() as client:
        response = await client.get(url, params=params)
        data = response.json()
        return data["access_token"]
```

### å‘é€æ–‡æœ¬æ¶ˆæ¯
```python
async def send_text_message(access_token: str, user_id: str, content: str):
    url = f"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}"
    data = {
        "touser": user_id,
        "msgtype": "text",
        "agentid": AGENT_ID,
        "text": {
            "content": content
        }
    }
    async with httpx.AsyncClient() as client:
        response = await client.post(url, json=data)
        return response.json()
```

### å‘é€å¡ç‰‡æ¶ˆæ¯
```python
async def send_card_message(access_token: str, user_id: str, title: str, description: str, url: str):
    api_url = f"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}"
    data = {
        "touser": user_id,
        "msgtype": "textcard",
        "agentid": AGENT_ID,
        "textcard": {
            "title": title,
            "description": description,
            "url": url,
            "btntxt": "æŸ¥çœ‹è¯¦æƒ…"
        }
    }
    async with httpx.AsyncClient() as client:
        response = await client.post(api_url, json=data)
        return response.json()
```

---

## 9. å®‰å…¨å»ºè®®

1. **HTTPSå¿…é¡»**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
2. **éªŒè¯ç­¾å**ï¼šéªŒè¯ä¼ä¸šå¾®ä¿¡å‘é€çš„æ¶ˆæ¯ç­¾å
3. **Tokenä¿å¯†**ï¼šä¸è¦å°†Tokenå’ŒSecretæäº¤åˆ°ä»£ç ä»“åº“
4. **IPç™½åå•**ï¼šé…ç½®ä¼ä¸šå¾®ä¿¡çš„å¯ä¿¡IP
5. **æ¶ˆæ¯åŠ å¯†**ï¼šä½¿ç”¨EncodingAESKeyåŠ å¯†æ¶ˆæ¯å†…å®¹

---

## 10. æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šURLéªŒè¯å¤±è´¥
- æ£€æŸ¥URLæ˜¯å¦å¯å…¬ç½‘è®¿é—®
- æ£€æŸ¥Tokené…ç½®æ˜¯å¦ä¸€è‡´
- æŸ¥çœ‹åç«¯æ—¥å¿—æ˜¯å¦æ”¶åˆ°è¯·æ±‚

### é—®é¢˜2ï¼šæ¶ˆæ¯æ”¶ä¸åˆ°
- æ£€æŸ¥åº”ç”¨å¯è§èŒƒå›´
- éªŒè¯æ¶ˆæ¯æ¥æ”¶URLé…ç½®
- æŸ¥çœ‹åº”ç”¨æ˜¯å¦è¢«ç¦ç”¨

### é—®é¢˜3ï¼šå‘é€æ¶ˆæ¯å¤±è´¥
- æ£€æŸ¥Access Tokenæ˜¯å¦è¿‡æœŸ
- éªŒè¯ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹ä¼ä¸šå¾®ä¿¡APIè¿”å›çš„é”™è¯¯ç 

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [ä¼ä¸šå¾®ä¿¡APIæ–‡æ¡£](https://developer.work.weixin.qq.com/document/)
- [æ¶ˆæ¯æ¥æ”¶æŒ‡å—](https://developer.work.weixin.qq.com/document/path/90930)
- [å‘é€æ¶ˆæ¯API](https://developer.work.weixin.qq.com/document/path/90236)
- [ä¾§è¾¹æ å¼€å‘](https://developer.work.weixin.qq.com/document/path/90792)

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹æ¸…å•

- [ ] åˆ›å»ºä¼ä¸šå¾®ä¿¡è‡ªå»ºåº”ç”¨
- [ ] è·å–CorpIdã€AgentIdã€Secret
- [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ.envæ–‡ä»¶ï¼‰
- [ ] é…ç½®æ¶ˆæ¯æ¥æ”¶URL
- [ ] ä½¿ç”¨ngrokè¿›è¡Œæœ¬åœ°æµ‹è¯•
- [ ] å‘é€æµ‹è¯•æ¶ˆæ¯éªŒè¯
- [ ] æµ‹è¯•å¿«æ·å‘½ä»¤åŠŸèƒ½
- [ ] é…ç½®ä¾§è¾¹æ åº”ç”¨
- [ ] é…ç½®ç¾¤æœºå™¨äºº
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**ä¸‹ä¸€æ­¥**ï¼šæ ¹æ®æ­¤æŒ‡å—é…ç½®æ‚¨çš„ä¼ä¸šå¾®ä¿¡åº”ç”¨ï¼Œå¦‚æœ‰é—®é¢˜éšæ—¶è¯¢é—®ï¼
