# ğŸ—ï¸ æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€æ¶æ„è®¾è®¡

## ğŸ“‹ å½“å‰é—®é¢˜è¯Šæ–­

### âŒ ç°å­˜çš„æ··ä¹±ç‚¹

1. **å‘é€æ¸ é“ä¸ç»Ÿä¸€**
   - âŒ æ¶ˆæ¯æ¨¡å—æœ‰ï¼šSMSã€EMAILã€GROUP_BOTã€AIã€WORK_WECHATã€WECHAT
   - âŒ ä½†å®é™…é…ç½®ä¸­å¿ƒåªæœ‰ï¼šä¼ä¸šå¾®ä¿¡é…ç½®ã€å¾®ä¿¡å…¬ä¼—å·é…ç½®
   - âŒ ç¼ºå°‘ï¼šçŸ­ä¿¡é…ç½®ã€é‚®ä»¶é…ç½®

2. **æ¥æ”¶è€…èº«ä»½ä¸æ˜ç¡®**
   - âŒ æ‰‹æœºå·ã€é‚®ç®±ã€UserIDã€OpenIDã€ExternalUserID æ··ç”¨
   - âŒ ä¸åŒæ¸ é“éœ€è¦ä¸åŒçš„æ¥æ”¶è€…æ ‡è¯†ç¬¦
   - âŒ æ²¡æœ‰ç»Ÿä¸€çš„æ¥æ”¶è€…ç®¡ç†æœºåˆ¶

3. **ç»‘å®šå…³ç³»ç¼ºå¤±**
   - âŒ ç¾¤æœºå™¨äººé…ç½®å’Œæ¨¡æ¿ç®¡ç†æ²¡æœ‰ç»‘å®š
   - âŒ å¾®ä¿¡å…¬ä¼—å·é…ç½®å’Œæ¨¡æ¿ç®¡ç†æ²¡æœ‰ç»‘å®š
   - âŒ @æ™ºèƒ½åŠ©æ‰‹å’Œç¾¤æœºå™¨äººé…ç½®æ²¡æœ‰ç»‘å®š

4. **messagesè¡¨åˆ©ç”¨ä¸è¶³**
   - âŒ åªå­˜å‚¨äº†åŸºæœ¬æ¶ˆæ¯å†…å®¹
   - âŒ æ²¡æœ‰å’Œæ¶ˆæ¯æ¨¡æ¿ã€å‘é€è®°å½•å…³è”
   - âŒ ç¼ºå°‘æ¶ˆæ¯è¿½è¸ªå’ŒçŠ¶æ€ç®¡ç†

---

## âœ… ç»Ÿä¸€æ¶æ„è®¾è®¡

### 1ï¸âƒ£ å‘é€æ¸ é“ç»Ÿä¸€å®šä¹‰

```python
# å…­å¤§å‘é€æ¸ é“
class ChannelType(str, Enum):
    SMS = "SMS"                # çŸ­ä¿¡ï¼ˆéœ€è¦æ‰‹æœºå·ï¼‰
    EMAIL = "EMAIL"            # é‚®ä»¶ï¼ˆéœ€è¦é‚®ç®±ï¼‰
    GROUP_BOT = "GROUP_BOT"    # ç¾¤æœºå™¨äººï¼ˆéœ€è¦ç¾¤ID + webhookï¼‰
    AI = "AI"                  # @æ™ºèƒ½åŠ©æ‰‹ï¼ˆéœ€è¦ç¾¤ID + åº”ç”¨é…ç½®ï¼‰
    WORK_WECHAT = "WORK_WECHAT"  # ä¼ä¸šå¾®ä¿¡å®¢æœï¼ˆéœ€è¦ExternalUserIDï¼‰
    WECHAT = "WECHAT"          # å¾®ä¿¡å…¬ä¼—å·ï¼ˆéœ€è¦OpenIDï¼‰

# æ¯ä¸ªæ¸ é“éœ€è¦çš„æ¥æ”¶è€…æ ‡è¯†
CHANNEL_RECIPIENT_TYPE = {
    "SMS": "phone",           # æ‰‹æœºå·
    "EMAIL": "email",         # é‚®ç®±
    "GROUP_BOT": "group_id",  # ç¾¤ID
    "AI": "group_id",         # ç¾¤IDï¼ˆ@æ™ºèƒ½åŠ©æ‰‹åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤ï¼‰
    "WORK_WECHAT": "external_user_id",  # ä¼ä¸šå¾®ä¿¡å¤–éƒ¨è”ç³»äººID
    "WECHAT": "openid"        # å¾®ä¿¡å…¬ä¼—å·OpenID
}
```

---

### 2ï¸âƒ£ ç»Ÿä¸€çš„æ¥æ”¶è€…ç®¡ç†

```python
# å®¢æˆ·çš„å¤šæ¸ é“æ ‡è¯†ç¬¦
class CustomerIdentifiers(BaseModel):
    customer_id: int          # å®¢æˆ·IDï¼ˆä¸»é”®ï¼‰
    phone: Optional[str]      # æ‰‹æœºå· â†’ SMS
    email: Optional[str]      # é‚®ç®± â†’ EMAIL
    wechat_openid: Optional[str]  # å¾®ä¿¡å…¬ä¼—å·OpenID â†’ WECHAT
    wework_external_id: Optional[str]  # ä¼ä¸šå¾®ä¿¡å¤–éƒ¨è”ç³»äººID â†’ WORK_WECHAT
    
    # ç¾¤æœºå™¨äººå’Œ@æ™ºèƒ½åŠ©æ‰‹ä½¿ç”¨ç¾¤IDï¼Œä¸æ˜¯å®¢æˆ·çº§åˆ«çš„

# æ–°å¢æ•°æ®è¡¨ï¼šcustomer_channel_identifiers
CREATE TABLE customer_channel_identifiers (
    id SERIAL PRIMARY KEY,
    customer_id INT NOT NULL,
    channel_type VARCHAR(20) NOT NULL,  -- SMS/EMAIL/WECHAT/WORK_WECHAT
    identifier_value VARCHAR(200) NOT NULL,  -- å…·ä½“çš„æ ‡è¯†ç¬¦
    is_verified BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦å·²éªŒè¯
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(customer_id, channel_type)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO customer_channel_identifiers VALUES
(1, 123, 'SMS', '13800138000', TRUE),
(2, 123, 'EMAIL', 'zhangsan@example.com', TRUE),
(3, 123, 'WECHAT', 'oXXXXXXXXXXXXXXX', TRUE),
(4, 123, 'WORK_WECHAT', 'wmXXXXXXXXXXXXXX', TRUE);

-- å®¢æˆ·123çš„æ‰€æœ‰å¯ç”¨å‘é€æ¸ é“
```

---

### 3ï¸âƒ£ é…ç½®ä¸­å¿ƒç»Ÿä¸€æ‰©å±•

```sql
-- æ–°å¢è¡¨ï¼šchannel_configsï¼ˆæ¸ é“é…ç½®ï¼‰
CREATE TABLE channel_configs (
    id SERIAL PRIMARY KEY,
    channel_type VARCHAR(20) NOT NULL UNIQUE,  -- SMS/EMAIL/GROUP_BOT/AI/WORK_WECHAT/WECHAT
    config_name VARCHAR(100) NOT NULL,
    config_data JSONB NOT NULL,  -- å­˜å‚¨å„æ¸ é“çš„é…ç½®ä¿¡æ¯
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- é…ç½®æ•°æ®ç¤ºä¾‹
-- 1. çŸ­ä¿¡é…ç½®
{
    "provider": "aliyun",  -- aliyun/tencent/huawei
    "access_key": "LTAI5tXXXXXXXXXX",
    "access_secret": "xxxxxxxxxxxxxxxx",
    "sign_name": "XXå…¬å¸",
    "templates": {
        "verification": "SMS_123456789",
        "notification": "SMS_987654321"
    }
}

-- 2. é‚®ä»¶é…ç½®
{
    "smtp_host": "smtp.exmail.qq.com",
    "smtp_port": 465,
    "username": "noreply@example.com",
    "password": "xxxxxxxxxxxxxxxx",
    "from_name": "XXå…¬å¸",
    "from_email": "noreply@example.com"
}

-- 3. ç¾¤æœºå™¨äººé…ç½®ï¼ˆæ”¯æŒå¤šä¸ªç¾¤ï¼‰
{
    "bots": [
        {
            "bot_id": "bot_001",
            "bot_name": "å”®åæœåŠ¡ç¾¤æœºå™¨äºº",
            "group_id": "wrXXXXXXXXXXXXXX",
            "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx"
        },
        {
            "bot_id": "bot_002",
            "bot_name": "é”€å”®å›¢é˜Ÿç¾¤æœºå™¨äºº",
            "group_id": "wrYYYYYYYYYYYYYY",
            "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=yyyyy"
        }
    ]
}

-- 4. @æ™ºèƒ½åŠ©æ‰‹é…ç½®
{
    "corp_id": "wwXXXXXXXXXXXXXX",
    "agent_id": "1000002",
    "agent_secret": "xxxxxxxxxxxxxxxx",
    "token": "xxxxxx",
    "encoding_aes_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "target_groups": [
        "wrXXXXXXXXXXXXXX",  -- å†…éƒ¨å®¢æœç¾¤
        "wrYYYYYYYYYYYYYY"   -- é”€å”®å›¢é˜Ÿç¾¤
    ]
}

-- 5. ä¼ä¸šå¾®ä¿¡å®¢æœé…ç½®
{
    "corp_id": "wwXXXXXXXXXXXXXX",
    "contact_secret": "xxxxxxxxxxxxxxxx",
    "customer_service_secret": "yyyyyyyyyyyyyyyy"
}

-- 6. å¾®ä¿¡å…¬ä¼—å·é…ç½®ï¼ˆä»é…ç½®ä¸­å¿ƒè¿ç§»ï¼‰
{
    "app_id": "wxXXXXXXXXXXXXXX",
    "app_secret": "xxxxxxxxxxxxxxxx",
    "qrcode_url": "https://example.com/qrcode.jpg",
    "generate_user_on_follow": false,
    "promotion_type": "mall"
}
```

---

### 4ï¸âƒ£ æ¶ˆæ¯æ¨¡æ¿ç»‘å®šé…ç½®

```sql
-- æ‰©å±• message_templates è¡¨
ALTER TABLE message_templates ADD COLUMN channel_config_id INT;
ALTER TABLE message_templates ADD COLUMN target_config JSONB;

-- target_config ç¤ºä¾‹ï¼ˆé’ˆå¯¹ä¸åŒæ¨¡å—ï¼‰
-- GROUP_BOTï¼šé€‰æ‹©å…·ä½“çš„ç¾¤æœºå™¨äºº
{
    "bot_id": "bot_001",  -- ç»‘å®šåˆ°"å”®åæœåŠ¡ç¾¤æœºå™¨äºº"
    "group_id": "wrXXXXXXXXXXXXXX"
}

-- AIï¼šé€‰æ‹©@æ™ºèƒ½åŠ©æ‰‹çš„ç›®æ ‡ç¾¤
{
    "target_groups": ["wrXXXXXXXXXXXXXX", "wrYYYYYYYYYYYYYY"]
}

-- WORK_WECHATï¼šé€‰æ‹©å‘é€ç›®æ ‡ç±»å‹
{
    "target_type": "external_contact",  -- external_contact/department/tag
    "department_ids": [1, 2, 3],
    "tag_ids": [101, 102]
}

-- WECHATï¼šé€‰æ‹©å‘é€ç›®æ ‡ç±»å‹
{
    "target_type": "fans",  -- fans/tag/all
    "tag_ids": [201, 202]
}

-- SMS/EMAILï¼šä½¿ç”¨å®¢æˆ·æ‰‹æœºå·/é‚®ç®±ï¼Œæ— éœ€é¢å¤–é…ç½®
{
    "filter": {
        "customer_type": "customer",  -- åªå‘ç»™æ­£å¼å®¢æˆ·
        "has_active_order": true
    }
}
```

---

### 5ï¸âƒ£ messagesè¡¨é‡æ–°è®¾è®¡

```sql
-- é‡æ–°è®¾è®¡ messages è¡¨ï¼Œä½œä¸ºç»Ÿä¸€çš„æ¶ˆæ¯è®°å½•
DROP TABLE IF EXISTS messages;

CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    
    -- æ¶ˆæ¯åŸºç¡€ä¿¡æ¯
    message_no VARCHAR(50) UNIQUE NOT NULL,  -- æ¶ˆæ¯ç¼–å· MSG20240203001
    template_id INT,  -- å…³è”æ¶ˆæ¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
    channel_type VARCHAR(20) NOT NULL,  -- SMS/EMAIL/GROUP_BOT/AI/WORK_WECHAT/WECHAT
    
    -- å‘é€è€…ä¿¡æ¯
    sender_type VARCHAR(20),  -- system/user/bot
    sender_id INT,  -- å‘é€è€…IDï¼ˆç³»ç»Ÿ/ç”¨æˆ·/æœºå™¨äººï¼‰
    
    -- æ¥æ”¶è€…ä¿¡æ¯
    recipient_type VARCHAR(50) NOT NULL,  -- phone/email/group_id/openid/external_user_id
    recipient_value VARCHAR(200) NOT NULL,  -- å…·ä½“çš„æ¥æ”¶è€…æ ‡è¯†
    customer_id INT,  -- å…³è”å®¢æˆ·IDï¼ˆå¦‚æœæ˜¯å‘ç»™å®¢æˆ·çš„ï¼‰
    
    -- æ¶ˆæ¯å†…å®¹
    subject VARCHAR(200),  -- ä¸»é¢˜ï¼ˆé‚®ä»¶/é€šçŸ¥æ ‡é¢˜ï¼‰
    content TEXT NOT NULL,  -- æ¶ˆæ¯å†…å®¹
    content_type VARCHAR(20) DEFAULT 'text',  -- text/markdown/html/card
    
    -- å‘é€çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending',  -- pending/sending/sent/failed
    send_mode VARCHAR(20),  -- realtime/scheduled
    scheduled_time TIMESTAMP,  -- å®šæ—¶å‘é€æ—¶é—´
    sent_at TIMESTAMP,  -- å®é™…å‘é€æ—¶é—´
    
    -- å¤±è´¥é‡è¯•
    retry_count INT DEFAULT 0,
    max_retries INT DEFAULT 3,
    error_message TEXT,
    
    -- æ‰©å±•ä¿¡æ¯
    metadata JSONB,  -- é¢å¤–æ•°æ®ï¼ˆå¦‚ï¼šé¡¹ç›®IDã€å·¥å•IDç­‰ï¼‰
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_messages_no ON messages(message_no);
CREATE INDEX idx_messages_template ON messages(template_id);
CREATE INDEX idx_messages_channel ON messages(channel_type);
CREATE INDEX idx_messages_status ON messages(status);
CREATE INDEX idx_messages_customer ON messages(customer_id);
CREATE INDEX idx_messages_scheduled ON messages(scheduled_time) WHERE status = 'pending';
```

---

### 6ï¸âƒ£ ç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æœåŠ¡

```python
# backend/app/services/message_sender.py

class UnifiedMessageSender:
    """ç»Ÿä¸€æ¶ˆæ¯å‘é€æœåŠ¡"""
    
    def __init__(self):
        self.sms_sender = SMSSender()
        self.email_sender = EmailSender()
        self.group_bot_sender = GroupBotSender()
        self.ai_bot_sender = AIBotSender()
        self.work_wechat_sender = WorkWechatSender()
        self.wechat_sender = WechatSender()
        
        self.sender_map = {
            "SMS": self.sms_sender,
            "EMAIL": self.email_sender,
            "GROUP_BOT": self.group_bot_sender,
            "AI": self.ai_bot_sender,
            "WORK_WECHAT": self.work_wechat_sender,
            "WECHAT": self.wechat_sender
        }
    
    async def send_message(self, message_record: dict) -> dict:
        """
        ç»Ÿä¸€å‘é€æ¥å£
        
        Args:
            message_record: messagesè¡¨çš„è®°å½•
        
        Returns:
            {
                "success": True/False,
                "message_id": "MSG20240203001",
                "sent_at": "2024-02-03T10:30:00",
                "error": None
            }
        """
        channel_type = message_record["channel_type"]
        sender = self.sender_map.get(channel_type)
        
        if not sender:
            raise ValueError(f"ä¸æ”¯æŒçš„æ¸ é“ç±»å‹: {channel_type}")
        
        try:
            # 1. è·å–æ¸ é“é…ç½®
            config = await self.get_channel_config(channel_type)
            
            # 2. éªŒè¯æ¥æ”¶è€…
            await self.validate_recipient(
                channel_type,
                message_record["recipient_value"]
            )
            
            # 3. å‘é€æ¶ˆæ¯
            result = await sender.send(
                config=config,
                recipient=message_record["recipient_value"],
                content=message_record["content"],
                subject=message_record.get("subject"),
                metadata=message_record.get("metadata")
            )
            
            # 4. æ›´æ–°æ¶ˆæ¯è®°å½•
            await self.update_message_status(
                message_record["id"],
                status="sent",
                sent_at=datetime.now()
            )
            
            return {
                "success": True,
                "message_id": message_record["message_no"],
                "sent_at": datetime.now().isoformat()
            }
            
        except Exception as e:
            # è®°å½•é”™è¯¯
            await self.update_message_status(
                message_record["id"],
                status="failed",
                error_message=str(e)
            )
            
            # åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
            if message_record["retry_count"] < message_record["max_retries"]:
                await self.schedule_retry(message_record["id"])
            
            return {
                "success": False,
                "message_id": message_record["message_no"],
                "error": str(e)
            }
    
    async def send_from_template(
        self,
        template_id: int,
        recipients: list,  # æ¥æ”¶è€…åˆ—è¡¨
        variables: dict,   # å˜é‡æ›¿æ¢
        send_mode: str = "realtime",  # realtime/scheduled
        scheduled_time: datetime = None
    ) -> list:
        """
        ä½¿ç”¨æ¨¡æ¿æ‰¹é‡å‘é€
        
        Args:
            template_id: æ¨¡æ¿ID
            recipients: [
                {"customer_id": 123, "identifier": "13800138000"},
                {"customer_id": 124, "identifier": "openid_xxx"}
            ]
            variables: {"customer_name": "å¼ ä¸‰", "project_id": "123"}
            send_mode: realtime/scheduled
            scheduled_time: å®šæ—¶å‘é€æ—¶é—´
        
        Returns:
            [
                {"customer_id": 123, "message_id": "MSG001", "success": True},
                {"customer_id": 124, "message_id": "MSG002", "success": False, "error": "xxx"}
            ]
        """
        # 1. åŠ è½½æ¨¡æ¿
        template = await self.get_template(template_id)
        
        # 2. æ¸²æŸ“å†…å®¹
        rendered_content = self.render_template(template.content, variables)
        
        # 3. æ‰¹é‡åˆ›å»ºæ¶ˆæ¯è®°å½•
        messages = []
        for recipient in recipients:
            message_record = await self.create_message_record(
                template_id=template_id,
                channel_type=template.module_type,
                recipient_value=recipient["identifier"],
                customer_id=recipient.get("customer_id"),
                content=rendered_content,
                send_mode=send_mode,
                scheduled_time=scheduled_time
            )
            messages.append(message_record)
        
        # 4. å‘é€æ¶ˆæ¯
        results = []
        for message in messages:
            if send_mode == "realtime":
                # ç«‹å³å‘é€
                result = await self.send_message(message)
            else:
                # åŠ å…¥å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—
                await self.queue_scheduled_message(message)
                result = {
                    "success": True,
                    "message_id": message["message_no"],
                    "scheduled": True
                }
            
            results.append({
                "customer_id": message["customer_id"],
                **result
            })
        
        return results
```

---

### 7ï¸âƒ£ é…ç½®ä¸­å¿ƒå‰ç«¯ä¿®æ”¹

#### æ–°å¢æ¸ é“é…ç½®é¡µé¢

```
é…ç½®ä¸­å¿ƒ
â”œâ”€â”€ ä¼ä¸šå¾®ä¿¡é…ç½®
â”‚   â”œâ”€â”€ åŸºç¡€é…ç½®ï¼ˆCorpIDã€Secretï¼‰
â”‚   â”œâ”€â”€ å®¢æœé…ç½®ï¼ˆContactSecretï¼‰
â”‚   â””â”€â”€ @æ™ºèƒ½åŠ©æ‰‹é…ç½®ï¼ˆAgentIDã€AgentSecretã€ç›®æ ‡ç¾¤ï¼‰
â”‚
â”œâ”€â”€ å¾®ä¿¡å…¬ä¼—å·é…ç½®ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ AppIDã€AppSecret
â”‚   â”œâ”€â”€ å…³æ³¨äºŒç»´ç 
â”‚   â””â”€â”€ æ¨å¹¿ç ç±»å‹
â”‚
â”œâ”€â”€ ç¾¤æœºå™¨äººé…ç½®ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ æœºå™¨äººåˆ—è¡¨
â”‚   â”œâ”€â”€ æ·»åŠ æœºå™¨äººï¼ˆåç§°ã€GroupIDã€WebhookURLï¼‰
â”‚   â””â”€â”€ ç¼–è¾‘/åˆ é™¤æœºå™¨äºº
â”‚
â”œâ”€â”€ çŸ­ä¿¡é…ç½®ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ æœåŠ¡å•†é€‰æ‹©ï¼ˆé˜¿é‡Œäº‘/è…¾è®¯äº‘/åä¸ºäº‘ï¼‰
â”‚   â”œâ”€â”€ AccessKeyã€AccessSecret
â”‚   â”œâ”€â”€ ç­¾åé…ç½®
â”‚   â””â”€â”€ æ¨¡æ¿IDé…ç½®
â”‚
â””â”€â”€ é‚®ä»¶é…ç½®ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ SMTPæœåŠ¡å™¨é…ç½®
    â”œâ”€â”€ å‘é€è´¦å·é…ç½®
    â””â”€â”€ å‘ä»¶äººä¿¡æ¯
```

#### æ¨¡æ¿ç®¡ç†é¡µé¢ä¿®æ”¹

```vue
<!-- æ¨¡å—ç±»å‹é€‰æ‹©åï¼Œæ˜¾ç¤ºå¯¹åº”çš„ç›®æ ‡é…ç½® -->

<!-- GROUP_BOTï¼šé€‰æ‹©å…·ä½“çš„ç¾¤æœºå™¨äºº -->
<el-form-item label="ç›®æ ‡ç¾¤æœºå™¨äºº" v-if="templateForm.module_type === 'GROUP_BOT'">
  <el-select v-model="templateForm.target_config.bot_id">
    <el-option
      v-for="bot in groupBots"
      :key="bot.bot_id"
      :label="bot.bot_name"
      :value="bot.bot_id">
      <span>{{ bot.bot_name }}</span>
      <span style="color: #8492a6; font-size: 12px">{{ bot.group_id }}</span>
    </el-option>
  </el-select>
</el-form-item>

<!-- AIï¼šé€‰æ‹©@æ™ºèƒ½åŠ©æ‰‹çš„ç›®æ ‡ç¾¤ -->
<el-form-item label="ç›®æ ‡ç¾¤" v-if="templateForm.module_type === 'AI'">
  <el-select v-model="templateForm.target_config.target_groups" multiple>
    <el-option
      v-for="group in aiTargetGroups"
      :key="group.group_id"
      :label="group.group_name"
      :value="group.group_id">
    </el-option>
  </el-select>
</el-form-item>

<!-- WORK_WECHATï¼šé€‰æ‹©å‘é€ç›®æ ‡ -->
<el-form-item label="å‘é€ç›®æ ‡" v-if="templateForm.module_type === 'WORK_WECHAT'">
  <el-radio-group v-model="templateForm.target_config.target_type">
    <el-radio label="external_contact">å¤–éƒ¨è”ç³»äºº</el-radio>
    <el-radio label="department">éƒ¨é—¨</el-radio>
    <el-radio label="tag">æ ‡ç­¾</el-radio>
  </el-radio-group>
</el-form-item>

<!-- WECHATï¼šé€‰æ‹©å‘é€ç›®æ ‡ -->
<el-form-item label="å‘é€ç›®æ ‡" v-if="templateForm.module_type === 'WECHAT'">
  <el-radio-group v-model="templateForm.target_config.target_type">
    <el-radio label="fans">æ‰€æœ‰ç²‰ä¸</el-radio>
    <el-radio label="tag">æ ‡ç­¾ç²‰ä¸</el-radio>
  </el-radio-group>
</el-form-item>
```

---

## ğŸ”— ç»‘å®šå…³ç³»æ¢³ç†

### 1. ç¾¤æœºå™¨äºº â†” æ¶ˆæ¯æ¨¡æ¿

```
é…ç½®ä¸­å¿ƒ â†’ ç¾¤æœºå™¨äººé…ç½®
æ·»åŠ æœºå™¨äººï¼š
- bot_id: "bot_001"
- bot_name: "å”®åæœåŠ¡ç¾¤"
- group_id: "wrXXXXXXXXXXXXXX"
- webhook_url: "https://..."

â†“ ä¿å­˜åˆ° channel_configs è¡¨

æ¨¡æ¿ç®¡ç† â†’ æ–°å»ºGROUP_BOTæ¨¡æ¿
- é€‰æ‹©ç›®æ ‡ç¾¤æœºå™¨äººï¼šå”®åæœåŠ¡ç¾¤ï¼ˆbot_001ï¼‰
- ä¿å­˜åˆ° message_templates.target_config

â†“ å‘é€æ—¶

UnifiedMessageSender
- è¯»å– target_config.bot_id
- åŠ è½½ channel_configs è·å– webhook_url
- è°ƒç”¨ç¾¤æœºå™¨äºº webhook å‘é€
```

### 2. @æ™ºèƒ½åŠ©æ‰‹ â†” ç¾¤æœºå™¨äºº

```
@æ™ºèƒ½åŠ©æ‰‹ â‰  ç¾¤æœºå™¨äºº

@æ™ºèƒ½åŠ©æ‰‹ï¼š
- ä¼ä¸šå¾®ä¿¡è‡ªå»ºåº”ç”¨
- å¯ä»¥æ¥æ”¶æ¶ˆæ¯ã€å¤„ç†å‘½ä»¤
- å¯ä»¥ä¸»åŠ¨æ¨é€æ¶ˆæ¯åˆ°ç¾¤
- éœ€è¦AgentID + AgentSecret

ç¾¤æœºå™¨äººï¼š
- ä¼ä¸šå¾®ä¿¡ç¾¤çš„webhookæœºå™¨äºº
- åªèƒ½æ¥æ”¶webhookæ¨é€
- ä¸èƒ½æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
- åªéœ€è¦webhook_url

ä¸¤è€…å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼š
- @æ™ºèƒ½åŠ©æ‰‹ï¼šç”¨äºäº¤äº’å¼å‘½ä»¤å¤„ç†
- ç¾¤æœºå™¨äººï¼šç”¨äºå•å‘æ¶ˆæ¯æ¨é€
```

### 3. å¾®ä¿¡å…¬ä¼—å· â†” å®¢æˆ·èº«ä»½

```
é…ç½®ä¸­å¿ƒ â†’ å¾®ä¿¡å…¬ä¼—å·é…ç½®
- AppIDã€AppSecret
- ç”¨äºè·å–AccessToken

â†“ å®¢æˆ·å…³æ³¨å…¬ä¼—å·

è‡ªåŠ¨è®°å½•åˆ° customer_channel_identifiers
- customer_id: 123
- channel_type: 'WECHAT'
- identifier_value: 'oXXXXXXXXXXXXXXX'  ï¼ˆOpenIDï¼‰

â†“ å‘é€å…¬ä¼—å·æ¶ˆæ¯æ—¶

1. æŸ¥è¯¢å®¢æˆ·çš„OpenID
2. ä½¿ç”¨å…¬ä¼—å·AccessToken
3. è°ƒç”¨å¾®ä¿¡APIå‘é€æ¨¡æ¿æ¶ˆæ¯/å®¢æœæ¶ˆæ¯
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµ

```
ã€åœºæ™¯ã€‘é¡¹ç›®è¿›åº¦é€šçŸ¥ - å‘é€ç»™å®¢æˆ·

1. è§¦å‘å™¨ï¼ˆå®šæ—¶ä»»åŠ¡/æ‰‹åŠ¨è§¦å‘ï¼‰
   â†“
2. é€‰æ‹©æ¨¡æ¿ï¼ˆtemplate_id = 10, æ¨¡å—ç±»å‹ = WORK_WECHATï¼‰
   â†“
3. æŸ¥è¯¢æ¥æ”¶è€…
   - å®¢æˆ·ID: 123
   - ä» customer_channel_identifiers æŸ¥è¯¢ WORK_WECHAT æ ‡è¯†
   - identifier_value: "wmXXXXXXXXXXXX"
   â†“
4. æ¸²æŸ“æ¨¡æ¿
   - å˜é‡æ›¿æ¢ï¼š{customer_name: "å¼ ä¸‰", project_name: "XXé¡¹ç›®"}
   â†“
5. åˆ›å»ºæ¶ˆæ¯è®°å½•ï¼ˆmessagesè¡¨ï¼‰
   - message_no: "MSG20240203001"
   - channel_type: "WORK_WECHAT"
   - recipient_value: "wmXXXXXXXXXXXX"
   - status: "pending"
   â†“
6. å‘é€æ¶ˆæ¯
   - åŠ è½½ channel_configsï¼ˆWORK_WECHATé…ç½®ï¼‰
   - è·å–AccessToken
   - è°ƒç”¨ä¼ä¸šå¾®ä¿¡API
   â†“
7. æ›´æ–°çŠ¶æ€
   - status: "sent"
   - sent_at: NOW()
```

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ï¼ˆ1-2å¤©ï¼‰
âœ… åˆ›å»º `customer_channel_identifiers` è¡¨  
âœ… åˆ›å»º `channel_configs` è¡¨  
âœ… é‡æ–°è®¾è®¡ `messages` è¡¨  
âœ… æ‰©å±• `message_templates` è¡¨

### ç¬¬äºŒé˜¶æ®µï¼šé…ç½®ä¸­å¿ƒï¼ˆ1å¤©ï¼‰
âœ… æ–°å¢çŸ­ä¿¡é…ç½®é¡µé¢  
âœ… æ–°å¢é‚®ä»¶é…ç½®é¡µé¢  
âœ… å®Œå–„ç¾¤æœºå™¨äººé…ç½®  
âœ… å®Œå–„@æ™ºèƒ½åŠ©æ‰‹é…ç½®

### ç¬¬ä¸‰é˜¶æ®µï¼šç»Ÿä¸€å‘é€æœåŠ¡ï¼ˆ2-3å¤©ï¼‰
âœ… å®ç° `UnifiedMessageSender`  
âœ… å®ç°å„æ¸ é“çš„ Senderï¼ˆSMSSenderã€EmailSenderç­‰ï¼‰  
âœ… å®ç°æ¨¡æ¿æ¸²æŸ“å¼•æ“  
âœ… å®ç°å¤±è´¥é‡è¯•æœºåˆ¶

### ç¬¬å››é˜¶æ®µï¼šå®šæ—¶ä»»åŠ¡ï¼ˆ1å¤©ï¼‰
âœ… å®ç° APScheduler è°ƒåº¦å™¨  
âœ… å®ç°å®šæ—¶æ¶ˆæ¯é˜Ÿåˆ—  
âœ… å®ç°æ¶ˆæ¯å‘é€ç›‘æ§

### ç¬¬äº”é˜¶æ®µï¼šAPIæ¥å£ï¼ˆ1å¤©ï¼‰
âœ… æ¨¡æ¿ç®¡ç†APIï¼ˆCRUDï¼‰  
âœ… æµ‹è¯•å‘é€API  
âœ… å‘é€è®°å½•æŸ¥è¯¢API

---

## â“ æ‚¨çš„é—®é¢˜è§£ç­”

### Q1: æ¶ˆæ¯æ¨¡å—å’Œæ–°å®æ–½çš„åŠŸèƒ½æœ‰é‡å¤å—ï¼Ÿ
A: ä¸é‡å¤ã€‚`messages` è¡¨æ˜¯ç»Ÿä¸€çš„æ¶ˆæ¯è®°å½•è¡¨ï¼Œè®°å½•æ‰€æœ‰é€šè¿‡ç³»ç»Ÿå‘é€çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯æ¨¡æ¿ç®¡ç†æ˜¯å®šä¹‰å¯é‡å¤ä½¿ç”¨çš„æ¨¡æ¿ã€‚ä¸¤è€…æ˜¯**ä½¿ç”¨å…³ç³»**ï¼Œä¸æ˜¯é‡å¤å…³ç³»ã€‚

### Q2: æ¥æ”¶è€…ä¸ä¼šå˜åŒ–æ€ä¹ˆåŠï¼Ÿ
A: é€šè¿‡ `customer_channel_identifiers` è¡¨ç»Ÿä¸€ç®¡ç†ã€‚æ¯ä¸ªå®¢æˆ·å¯ä»¥æœ‰å¤šä¸ªæ¸ é“çš„æ ‡è¯†ç¬¦ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ã€OpenIDã€ExternalUserIDï¼‰ã€‚

### Q3: ç¾¤æœºå™¨äººé…ç½®æ€ä¹ˆå’Œæ¶ˆæ¯æ¨¡æ¿ç»‘å®šï¼Ÿ
A: æ¨¡æ¿çš„ `target_config.bot_id` å¼•ç”¨ç¾¤æœºå™¨äººé…ç½®çš„ `bot_id`ã€‚å‘é€æ—¶æ ¹æ® bot_id æŸ¥æ‰¾å¯¹åº”çš„ webhook_urlã€‚

### Q4: @æ™ºèƒ½åŠ©æ‰‹æ€ä¹ˆç»‘å®šï¼Ÿ
A: @æ™ºèƒ½åŠ©æ‰‹æ˜¯ä¼ä¸šå¾®ä¿¡åº”ç”¨ï¼Œé…ç½®åœ¨ `channel_configs` çš„ AI ç±»å‹ä¸­ã€‚å‘é€æ—¶ä½¿ç”¨åº”ç”¨çš„ AgentID å’Œ Secret è°ƒç”¨ä¼ä¸šå¾®ä¿¡ APIã€‚

### Q5: å¾®ä¿¡å…¬ä¼—å·çš„è®¾ç½®åœ¨å“ªé‡Œï¼Ÿ
A: å·²ç»åœ¨é…ç½®ä¸­å¿ƒäº†ï¼ˆæ‚¨æä¾›çš„HTMLä»£ç ï¼‰ã€‚æˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªé…ç½®æ•°æ®è¿ç§»åˆ° `channel_configs` è¡¨çš„ WECHAT ç±»å‹ä¸­ã€‚

### Q6: æ¨¡å—ç®¡ç†é‡Œçš„å‘é€å¯¹è±¡å¯ä»¥ç¼–è¾‘ã€æ–°å¢å—ï¼Ÿ
A: å¯ä»¥ã€‚æ¯ä¸ªæ¨¡æ¿çš„ `target_config` å¯ä»¥ç¼–è¾‘ï¼Œé€‰æ‹©ä¸åŒçš„å‘é€ç›®æ ‡ï¼ˆç¾¤ã€éƒ¨é—¨ã€æ ‡ç­¾ã€ç²‰ä¸ç­‰ï¼‰ã€‚

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

æˆ‘å·²ç»ç†æ¸…äº†æ•´ä¸ªæ¶æ„ï¼Œç°åœ¨å¯ä»¥å¼€å§‹å®æ–½ï¼š

1. âœ… **æ‚¨ç¡®è®¤æ¶æ„è®¾è®¡**ï¼ˆæ˜¯å¦éœ€è¦è°ƒæ•´ï¼Ÿï¼‰
2. ğŸ”¨ **æˆ‘å¼€å§‹åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬**
3. ğŸ”¨ **æˆ‘å¼€å§‹å®æ–½ç»Ÿä¸€æ¶ˆæ¯å‘é€æœåŠ¡**
4. ğŸ”¨ **æˆ‘å¼€å§‹å®æ–½æ¨¡æ¿ç®¡ç†API**
5. ğŸ”¨ **æˆ‘å¼€å§‹å®æ–½å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨**

**è¯·ç¡®è®¤æ˜¯å¦åŒæ„æ­¤æ¶æ„ï¼Œç„¶åæˆ‘ç«‹å³å¼€å§‹ç¼–å†™ä»£ç ï¼** ğŸš€
