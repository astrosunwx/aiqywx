# 🚀 快速启动指南 - 安全链接功能

## ⚡ 5分钟快速体验

### 步骤1：启动后端服务

```powershell
# 进入后端目录
cd G:\aiqywx\customer-system\customer-system\backend

# 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 启动服务
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**预期输出**：
```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

---

### 步骤2：运行测试脚本

**打开新的PowerShell窗口**，运行：

```powershell
cd G:\aiqywx\customer-system\customer-system\backend
.\venv\Scripts\Activate.ps1
python test_secure_link.py
```

**预期输出**：
```
✅ 客户链接（1小时有效）：
   http://localhost:8000/view/project-detail?token=eyJhbGci...
   
✅ 所有测试完成！
```

---

### 步骤3：访问项目详情页面

1. **复制测试脚本输出的链接**
2. **粘贴到浏览器地址栏**
3. **观察效果**：
   - 渐变紫色背景
   - 项目进度条动画
   - 右上角绿色脉冲指示器
   - 打开浏览器控制台（F12），查看定时器日志

---

### 步骤4：查看API文档

浏览器访问：http://localhost:8000/docs

找到以下端点：
- `GET /view/project-detail` - 项目详情页面
- `GET /view/api/project/progress` - 增量数据更新
- `POST /view/api/project/invalidate-cache` - 清除缓存

---

## 🎯 快速测试场景

### 场景1：测试令牌过期

1. 运行测试脚本生成链接
2. **等待1小时后**访问该链接
3. 应该看到"链接已过期"的403错误页面

**不想等1小时？** 修改 `secure_link_service.py`：
```python
# 改为1分钟过期
expiry_hours = 1 / 60  # 1分钟
```

---

### 场景2：测试篡改令牌

1. 复制正常的链接
2. 手动修改 `token=` 后面的任意字符
3. 访问修改后的链接
4. 应该看到"无效的访问链接"错误页面

---

### 场景3：测试定时更新

1. 打开项目详情页面
2. 打开浏览器控制台（F12 → Console）
3. 等待3秒，观察首次更新日志
4. 等待30分钟（或修改 `UPDATE_INTERVAL` 为更短时间）
5. 观察定时更新日志：`✅ 数据更新成功 (来自缓存)`

**快速测试**：修改 `project_detail.html`：
```javascript
// 改为1分钟更新一次
const UPDATE_INTERVAL = 1 * 60 * 1000;
```

---

### 场景4：测试Redis缓存

**前提**：需要安装并启动Redis

```powershell
# 安装Redis（Windows）
# 下载：https://github.com/microsoftarchive/redis/releases
# 启动：redis-server.exe

# 配置环境变量
$env:REDIS_URL = "redis://localhost:6379/0"

# 重启后端服务
```

**测试步骤**：
1. 访问项目详情页面
2. 查看后端日志：应该看到"写入Redis缓存"
3. 刷新页面
4. 查看后端日志：应该看到"缓存命中"

---

## 📝 常用命令速查

### 查看已注册的路由

```powershell
cd backend
.\venv\Scripts\Activate.ps1
python verify_routes.py
```

### 更新依赖

```powershell
pip freeze > requirements.txt
```

### 清除所有缓存

```powershell
# 方法1：调用API
Invoke-RestMethod -Uri "http://localhost:8000/view/api/project/invalidate-cache?project_id=1" -Method POST

# 方法2：重启Redis
redis-cli FLUSHALL
```

### 生成新的JWT密钥

```powershell
# 生成32位随机字符串
-join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | ForEach-Object {[char]$_})
```

---

## 🔧 调试技巧

### 查看JWT令牌内容

访问：https://jwt.io/

粘贴token，查看解码后的Payload（不要泄露SECRET_KEY）

### 查看Redis缓存

```bash
redis-cli
> KEYS project_*
> GET project_progress:123
```

### 查看后端日志

观察终端输出，关注：
- `✅ 缓存命中`
- `⚠️  Redis连接失败`
- `INFO: 127.0.0.1:xxxx - "GET /view/project-detail?token=..."`

---

## 🎨 自定义配置

### 修改页面样式

编辑：`backend/app/templates/project_detail.html`

```css
/* 修改主题色 */
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
/* 改为绿色主题 */
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
```

### 修改更新频率

```javascript
// 改为10分钟
const UPDATE_INTERVAL = 10 * 60 * 1000;
```

### 修改缓存过期时间

编辑：`backend/app/routers/view.py`

```python
# 改为5分钟
cache_service.set_project_progress(project_id, progress_data, expire_seconds=300)
```

---

## 🚨 故障排除

### 问题1：导入错误

```
ModuleNotFoundError: No module named 'PyJWT'
```

**解决**：
```powershell
pip install PyJWT redis jinja2
```

### 问题2：Redis连接失败

```
⚠️  Redis连接失败，缓存功能不可用
```

**解决**：
- 这是预期行为，系统会自动降级
- 如需启用缓存：安装并启动Redis服务

### 问题3：模板未找到

```
TemplateNotFound: project_detail.html
```

**解决**：
检查文件路径：`backend/app/templates/project_detail.html` 是否存在

### 问题4：链接403错误

```
访问受限：链接已过期，请重新申请
```

**解决**：
- 检查系统时间是否正确
- 重新生成链接
- 确认令牌未被篡改

---

## 📚 下一步学习

1. **阅读完整文档**：
   - [使用指南](./安全链接与缓存策略-使用指南.md)
   - [技术架构图](./安全链接与缓存策略-技术架构图.md)
   - [实现报告](./安全链接与缓存策略-实现报告.md)

2. **集成到企业微信**：
   - 配置企业微信应用
   - 发送消息时包含安全链接
   - 测试在手机端访问

3. **生产部署**：
   - 修改JWT密钥
   - 启用HTTPS
   - 配置Redis
   - 限制CORS

---

**🎉 开始探索吧！所有功能已就绪！**

如遇问题，请查阅完整文档或提Issue。
